<!DOCTYPE html>
<html lang="en">
<head>
  <script src="/about-blank-wrapper.js" data-ab-wrapper="true"></script>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uklz62a91n");
  </script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nebulo - Voice Chat</title>
<meta name="description" content="Nebulo Voice Chat - Connect with voice and screen sharing.">
<link rel="icon" type="image/png" href="../images/logoshs.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="../styles.css">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    color: #f1f5f9;
    overflow: hidden;
    height: 100vh;
  }

  .voice-chat-container {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  /* Left Sidebar - Participants */
  .participants-sidebar {
    width: 320px;
    min-width: 280px;
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.92));
    backdrop-filter: blur(20px);
    border-right: 2px solid rgba(255, 215, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 2px solid rgba(255, 215, 0, 0.15);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
  }

  .sidebar-header h2 {
    font-size: 20px;
    font-weight: 700;
    color: #FFD700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sidebar-header .back-btn {
    padding: 8px 12px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .sidebar-header .back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .participants-list {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }


  /* Main Content Area */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: rgba(2, 6, 23, 0.6);
    position: relative;
    overflow: hidden;
  }

  .content-header {
    padding: 20px 24px;
    border-bottom: 2px solid rgba(255, 215, 0, 0.15);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 165, 0, 0.04));
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .content-header h3 {
    font-size: 18px;
    font-weight: 700;
    color: #FFD700;
  }

  .voice-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .control-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .control-btn.join {
    background: linear-gradient(135deg, #10b981, #06b6d4);
    color: #07121a;
  }

  .control-btn.leave {
    background: rgba(248, 113, 113, 0.2);
    color: #fecaca;
    border: 1px solid rgba(248, 113, 113, 0.4);
  }

  .control-btn.mute {
    background: rgba(255, 255, 255, 0.1);
    color: #e5e7eb;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* Screen sharing button removed - no longer needed */

  .control-btn.reports {
    background: rgba(59, 130, 246, 0.2);
    color: #bfdbfe;
    border: 1px solid rgba(59, 130, 246, 0.4);
  }

  .control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* Screen Share Area */
  .screen-share-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  #joinButtonContainer {
    z-index: 5;
  }

  .screen-share-video {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 16px;
    background: #000;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    display: none;
  }

  .screen-share-video.active {
    display: block;
  }

  /* Empty state removed - no longer needed */

  /* Participant Grid (Alternative view when no screen share) */
  .participant-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  .participant-grid-item {
    aspect-ratio: 16/9;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .participant-grid-item.speaking {
    border-color: rgba(34, 197, 94, 0.5);
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
  }

  .participant-grid-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  .participant-grid-item video.active {
    display: block;
  }

  .grid-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B5CF6, #6366F1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    border: 3px solid rgba(255, 255, 255, 0.2);
  }

  .grid-name {
    font-weight: 600;
    font-size: 16px;
    color: #f1f5f9;
  }

  /* Status Bar */
  .status-bar {
    padding: 12px 24px;
    background: rgba(15, 23, 42, 0.8);
    border-top: 1px solid rgba(255, 215, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .participants-sidebar {
      width: 100%;
      position: absolute;
      z-index: 10;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .participants-sidebar.open {
      transform: translateX(0);
    }

    .main-content {
      width: 100%;
    }
  }

  /* Scrollbar */
  .participants-list::-webkit-scrollbar {
    width: 8px;
  }

  .participants-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  .participants-list::-webkit-scrollbar-thumb {
    background: rgba(255, 215, 0, 0.3);
    border-radius: 4px;
  }

  .participants-list::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 215, 0, 0.5);
  }
</style>
</head>
<body>
  <div class="voice-chat-container">
    <!-- Left Sidebar - Participants -->
    <div class="participants-sidebar">
      <div class="sidebar-header">
        <h2>
          <button class="back-btn" onclick="window.close() || (window.location.href = '../index.html')">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <span><i class="fas fa-headset"></i> Voice Chat</span>
        </h2>
      </div>
      <div class="participants-list" id="participantsList">
        <!-- Participants will be dynamically added here -->
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <div class="content-header">
        <h3><i class="fas fa-users"></i> Voice Chat Room</h3>
        <div id="visitorCounter" style="display: none; font-size: 13px; color: rgba(255, 255, 255, 0.7); padding: 6px 12px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.2);">
          <i class="fas fa-users"></i> <span id="visitorCountText">Loading...</span>
        </div>
        <div class="voice-controls">
          <button class="control-btn leave" id="leaveBtn" style="display: none;">
            <i class="fas fa-phone-slash"></i> Leave
          </button>
          <button class="control-btn mute" id="muteBtn" style="display: none;">
            <i class="fas fa-microphone"></i> Mute
          </button>
          <button class="control-btn reports" id="reportsBtn" style="display: none; background: rgba(59,130,246,0.2); color: #bfdbfe; border: 1px solid rgba(59,130,246,0.4);">
            <i class="fas fa-flag"></i> Reports
          </button>
        </div>
      </div>

      <!-- Screen Share Area -->
      <div class="screen-share-area" id="screenShareArea">
        <!-- Screen share video will appear here -->
        <video id="screenShareVideo" class="screen-share-video" autoplay playsinline></video>
        
        <!-- Join button in center when not joined -->
        <div id="joinButtonContainer" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
          <button class="control-btn join" id="joinBtnCenter" style="padding: 24px 60px; font-size: 24px; min-width: 300px;">
            <i class="fas fa-phone"></i> Join Voice Chat
          </button>
        </div>

        <!-- Participant grid (alternative view) -->
        <div class="participant-grid" id="participantGrid" style="display: none;">
          <!-- Grid items will be dynamically added -->
        </div>
      </div>

      <!-- Voice Meter Section -->
      <div style="padding: 16px 24px; border-top: 1px solid rgba(255, 215, 0, 0.15); background: rgba(15, 23, 42, 0.6);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 12px;">
          <div style="font-size: 13px; color: rgba(255, 255, 255, 0.75); font-weight: 700;">
            <i class="fas fa-microphone"></i> Microphone Level
          </div>
        </div>
        <canvas id="voiceMeter" width="400" height="30" style="width: 100%; max-width: 500px; height: 30px; border-radius: 999px; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.10);"></canvas>
      </div>

      <!-- Volume Control Section -->
      <div style="padding: 16px 24px; border-top: 1px solid rgba(255, 215, 0, 0.15); background: rgba(15, 23, 42, 0.6);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 12px;">
          <div style="font-size: 13px; color: rgba(255, 255, 255, 0.75); font-weight: 700;">
            <i class="fas fa-volume-up"></i> Remote Audio Volume
          </div>
          <div id="volumeValue" style="font-size: 12px; color: rgba(255, 215, 0, 0.9); font-weight: 700; min-width: 50px; text-align: right;">
            100%
          </div>
        </div>
        <input type="range" id="voiceVolumeSlider" min="0" max="200" value="100" step="5" style="width: 100%; max-width: 500px; height: 8px; border-radius: 999px; background: rgba(255, 255, 255, 0.1); outline: none; cursor: pointer;">
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-indicator">
          <span id="statusText">Not connected</span>
        </div>
        <div class="status-indicator">
          <span id="participantCount">0 participants</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase initialization for voice chat -->
  <script type="module" src="../firebase-init-modular.js"></script>
  <script>
    // Wait for Firebase to be initialized
    (function waitForFirebase() {
      if (window.firebaseDb) {
        console.log('✅ Firebase Database is available on voice chat page');
        return;
      }
      setTimeout(waitForFirebase, 100);
    })();
    
    // Listen for firebaseReady event
    window.addEventListener('firebaseReady', function() {
      console.log('✅ Firebase ready on voice chat page');
    }, { once: true });
  </script>
  <script src="../script.js"></script>
  <script>
    // Voice chat page specific code
    let voiceChatPageInitialized = false;

    function initVoiceChatPage() {
      if (voiceChatPageInitialized) return;
      voiceChatPageInitialized = true;

      // Wait for main script to load
      if (typeof ensureVoiceUi === 'undefined') {
        setTimeout(initVoiceChatPage, 100);
        return;
      }

      // Initialize voice UI
      ensureVoiceUi();

      // Ensure observer channel is active to see participants before joining
      if (typeof VOICE_DISCOVERY_ENABLED !== 'undefined' && VOICE_DISCOVERY_ENABLED) {
        if (typeof ensureVoiceDiscoveryObserver === 'function') {
          try { ensureVoiceDiscoveryObserver(); } catch (_) {}
        }
      } else {
        if (typeof initGlobalChatClient === 'function') {
          initGlobalChatClient().then((client) => {
            if (typeof ensureVoiceObserverChannel === 'function') {
              try { ensureVoiceObserverChannel(client); } catch (_) {}
            }
          });
        }
      }

      // Connect voice meter from this page to the voice UI
      const voiceMeterCanvas = document.getElementById('voiceMeter');
      if (voiceMeterCanvas && typeof voiceUi !== 'undefined') {
        voiceUi.meterCanvas = voiceMeterCanvas;
      }

      // Override render function to update this page
      const originalRender = renderVoiceParticipants;
      if (typeof renderVoiceParticipants !== 'undefined') {
        renderVoiceParticipants = function() {
          originalRender();
          updateVoiceChatPage();
        };
      }

      // Set up button handlers
      const joinBtn = document.getElementById('joinBtn');
      const joinBtnCenter = document.getElementById('joinBtnCenter');
      const leaveBtn = document.getElementById('leaveBtn');
      const muteBtn = document.getElementById('muteBtn');
      const shareBtn = document.getElementById('shareScreenBtn');

      const handleJoinClick = () => {
        // Check if user has set a name
        if (typeof globalChatUsername === 'undefined' || !globalChatUsername || globalChatUsername.trim() === '') {
          if (typeof showChatNotice === 'function') {
            showChatNotice('Please set your chat name before joining voice chat.', true);
          } else {
            alert('Please set your chat name before joining voice chat.');
          }
          // Try to open chat name changer if available
          const nameBtn = document.getElementById('globalChatNameBtn') || document.getElementById('changeNameBtn');
          if (nameBtn) {
            try { nameBtn.click(); } catch (_) {}
          }
          return;
        }
        if (typeof joinVoiceChat === 'function') {
          joinVoiceChat();
        }
      };

      if (joinBtn) {
        joinBtn.addEventListener('click', handleJoinClick);
      }
      if (joinBtnCenter) {
        joinBtnCenter.addEventListener('click', handleJoinClick);
      }

      if (leaveBtn) {
        leaveBtn.addEventListener('click', () => {
          if (typeof leaveVoiceChat === 'function') {
            leaveVoiceChat();
          }
        });
      }

      if (muteBtn) {
        muteBtn.addEventListener('click', () => {
          if (typeof toggleVoiceMute === 'function') {
            toggleVoiceMute();
          }
        });
      }

      // Screen sharing removed - no longer needed

      const reportsBtn = document.getElementById('reportsBtn');
      if (reportsBtn) {
        reportsBtn.addEventListener('click', () => {
          if (typeof openVoiceReportsInbox === 'function') {
            openVoiceReportsInbox();
          }
        });
      }

      // Set up remote stream monitoring
      setupRemoteStreamMonitoring();

      // Hook into setParticipantLevel to update meters on this page
      if (typeof setParticipantLevel !== 'undefined') {
        const originalSetLevel = setParticipantLevel;
        setParticipantLevel = function(peerId, level01, ts) {
          originalSetLevel(peerId, level01, ts);
          // Update meter on this page
          const card = document.querySelector(`[data-peer-id="${peerId}"]`);
          if (card) {
            const fill = card.querySelector('[data-peer-meter-fill="1"]');
            if (fill && typeof voiceParticipants !== 'undefined') {
              const info = voiceParticipants.get(peerId);
              if (info) {
                const lvl = Math.max(0, Math.min(1, Number(level01) || 0));
                fill.style.width = `${Math.round(lvl * 100)}%`;
                const muted = !!info.muted;
                const speaking = !!info.speaking;
                fill.style.background = muted
                  ? 'rgba(239, 68, 68, 0.95)'
                  : (speaking ? 'rgba(34, 197, 94, 0.95)' : 'rgba(99, 102, 241, 0.9)');
              }
            }
          }
        };
      }

      // Update UI periodically
      setInterval(() => {
        updateVoiceChatPage();
      }, 1000);
      updateVoiceChatPage();
    }

    function updateVoiceChatPage() {
      // Update participants list
      const participantsList = document.getElementById('participantsList');
      if (!participantsList) return;

      if (typeof voiceParticipants === 'undefined') return;

      const participants = Array.from(voiceParticipants.entries());
      
      // Show empty state if no participants and not loading
      if (participants.length === 0) {
        if (typeof voiceParticipantsLoading !== 'undefined' && voiceParticipantsLoading) {
          participantsList.innerHTML = `
            <div style="padding: 20px; text-align: center; color: rgba(226,232,240,0.8);">
              <div style="display: inline-block; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; border: 3px solid rgba(16,185,129,0.3); border-top-color: rgba(16,185,129,0.9); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
              </div>
              <div style="font-size: 13px; font-weight: 800; color: rgba(226,232,240,0.9);">Loading participants...</div>
            </div>
            <style>
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          `;
          return;
        } else {
          participantsList.innerHTML = `
            <div style="padding: 20px; text-align: center; color: rgba(226,232,240,0.6);">
              <div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">No participants yet</div>
              <div style="font-size: 12px;">Join to be the first!</div>
            </div>
          `;
          return;
        }
      }
      
      participantsList.innerHTML = '';

      participants.forEach(([peerId, info]) => {
        const chip = document.createElement('div');
        chip.dataset.peerId = peerId;
        chip.style.display = 'flex';
        chip.style.flexDirection = 'column';
        chip.style.gap = '6px';
        chip.style.padding = '7px 10px';
        chip.style.borderRadius = '14px';
        const speaking = !!info?.speaking;
        const connected = !!info?.connected;
        const muted = !!info?.muted;
        chip.style.background = speaking
            ? 'linear-gradient(135deg, rgba(34,197,94,0.28), rgba(16,185,129,0.16))'
            : 'rgba(255,255,255,0.08)';
        chip.style.border = speaking ? '1px solid rgba(34,197,94,0.85)' : '1px solid rgba(255,255,255,0.10)';
        chip.style.minWidth = '190px';
        chip.style.boxShadow = speaking ? '0 0 0 3px rgba(34,197,94,0.10)' : 'none';

        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.gap = '8px';
        topRow.style.justifyContent = 'space-between';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';

        // Avatar
        const avatar = document.createElement('div');
        avatar.style.width = '32px';
        avatar.style.height = '32px';
        avatar.style.borderRadius = '50%';
        avatar.style.background = 'linear-gradient(135deg, #8B5CF6, #6366F1)';
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.fontSize = '14px';
        avatar.style.fontWeight = '700';
        avatar.style.color = '#fff';
        avatar.style.flexShrink = '0';
        avatar.style.border = '2px solid rgba(255, 255, 255, 0.2)';
        avatar.style.position = 'relative';
        avatar.textContent = (info?.userId || 'User')[0].toUpperCase();
        
        // Add crown for %Owner%
        const isOwner = (info?.userId === '%Owner%');
        if (isOwner) {
          avatar.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
          avatar.style.border = '2px solid #FFD700';
          avatar.style.boxShadow = '0 0 0 2px rgba(255, 215, 0, 0.3), 0 0 8px rgba(255, 215, 0, 0.4)';
          const crown = document.createElement('i');
          crown.className = 'fas fa-crown';
          crown.style.cssText = 'position: absolute; top: -6px; right: -6px; font-size: 14px; color: #FFD700; text-shadow: 0 0 4px rgba(255, 215, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.5); z-index: 10;';
          avatar.appendChild(crown);
        }

        const dot = document.createElement('span');
        dot.dataset.peerDot = '1';
        dot.style.width = '8px';
        dot.style.height = '8px';
        dot.style.borderRadius = '999px';
        dot.style.background = connected ? 'rgba(34,197,94,0.95)' : 'rgba(148,163,184,0.75)';
        dot.style.boxShadow = connected ? '0 0 0 3px rgba(34,197,94,0.14)' : 'none';

        const name = document.createElement('span');
        // Use getDisplayName to show "Owner" instead of "%Owner%" in participant list
        const displayName = (typeof getDisplayName !== 'undefined') 
          ? getDisplayName(info?.userId || peerId.slice(0, 8))
          : (info?.userId || peerId.slice(0, 8));
        name.textContent = displayName;
        name.style.fontSize = '12px';
        name.style.fontWeight = '900';
        name.style.color = speaking ? '#bbf7d0' : 'rgba(226,232,240,0.92)';
        name.style.whiteSpace = 'nowrap';
        name.style.overflow = 'hidden';
        name.style.textOverflow = 'ellipsis';
        name.style.maxWidth = '130px';

        left.appendChild(avatar);
        left.appendChild(dot);
        left.appendChild(name);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';

        // Local-only mute toggle (doesn't affect others)
        if (typeof voicePeerId !== 'undefined' && voicePeerId && peerId !== voicePeerId) {
          const localMuted = (typeof isPeerLocallyMuted !== 'undefined' && isPeerLocallyMuted(peerId));
          const muteBtn = document.createElement('button');
          muteBtn.type = 'button';
          muteBtn.textContent = localMuted ? 'Unmute' : 'Mute';
          muteBtn.style.cssText = 'padding: 6px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.10); background: ' + (localMuted ? 'rgba(239,68,68,0.18)' : 'rgba(255,255,255,0.06)') + '; color: ' + (localMuted ? '#fecaca' : 'rgba(226,232,240,0.92)') + '; font-weight: 900; cursor: pointer; font-size: 11px;';
          muteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (typeof toggleLocalMutePeer === 'function') {
              toggleLocalMutePeer(peerId);
            }
          });
          right.appendChild(muteBtn);
        }

        // Report button (everyone, except self)
        if (typeof voicePeerId !== 'undefined' && voicePeerId && peerId !== voicePeerId) {
          const reportBtn = document.createElement('button');
          reportBtn.type = 'button';
          reportBtn.textContent = 'Report';
          reportBtn.style.cssText = 'padding: 6px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.10); background: rgba(59,130,246,0.14); color: #bfdbfe; font-weight: 900; cursor: pointer; font-size: 11px;';
          reportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (typeof openVoiceReportModal === 'function') {
              openVoiceReportModal(String(info?.userId || ''));
            }
          });
          right.appendChild(reportBtn);
        }

        // Status text
        const statusText = document.createElement('span');
        statusText.style.fontSize = '10px';
        statusText.style.color = 'rgba(226,232,240,0.6)';
        statusText.textContent = connected ? 'Connected' : 'Disconnected';
        if (muted) {
          statusText.textContent += ' • Muted';
          statusText.style.color = 'rgba(239,68,68,0.8)';
        }
        right.appendChild(statusText);

        topRow.appendChild(left);
        topRow.appendChild(right);
        chip.appendChild(topRow);

        // Voice meter bar below
        const meterOuter = document.createElement('div');
        meterOuter.dataset.peerMeter = '1';
        meterOuter.style.width = '100%';
        meterOuter.style.height = '5px';
        meterOuter.style.borderRadius = '999px';
        meterOuter.style.background = 'rgba(15,23,42,0.55)';
        meterOuter.style.border = '1px solid rgba(255,255,255,0.10)';
        meterOuter.style.overflow = 'hidden';

        const meterFill = document.createElement('div');
        meterFill.dataset.peerMeterFill = '1';
        meterFill.style.height = '100%';
        meterFill.style.width = '0%';
        meterFill.style.borderRadius = '999px';
        const level = info?.level || 0;
        meterFill.style.width = `${Math.round(level * 100)}%`;
        meterFill.style.background = muted
            ? 'rgba(239,68,68,0.95)'
            : (speaking ? 'rgba(34,197,94,0.95)' : 'rgba(99,102,241,0.9)');
        meterFill.style.transition = 'width 80ms linear';
        meterOuter.appendChild(meterFill);

        chip.appendChild(meterOuter);
        participantsList.appendChild(chip);
      });

      // Update controls
      const joinBtn = document.getElementById('joinBtn');
      const joinBtnCenter = document.getElementById('joinBtnCenter');
      const joinButtonContainer = document.getElementById('joinButtonContainer');
      const leaveBtn = document.getElementById('leaveBtn');
      const muteBtn = document.getElementById('muteBtn');
      const reportsBtn = document.getElementById('reportsBtn');

      if (typeof voiceJoined !== 'undefined') {
        // Show Join button when not joined, hide all in-call controls
        if (joinBtn) joinBtn.style.display = voiceJoined ? 'none' : 'flex';
        if (joinBtnCenter) joinBtnCenter.style.display = voiceJoined ? 'none' : 'flex';
        if (joinButtonContainer) joinButtonContainer.style.display = voiceJoined ? 'none' : 'flex';
        
        // Hide all in-call controls when not joined
        if (leaveBtn) leaveBtn.style.display = voiceJoined ? 'flex' : 'none';
        if (muteBtn) muteBtn.style.display = voiceJoined ? 'flex' : 'none';
        if (reportsBtn) {
          const isOwner = (typeof globalChatUsername !== 'undefined' && globalChatUsername === '%Owner%');
          reportsBtn.style.display = (voiceJoined && isOwner) ? 'flex' : 'none';
        }

        if (muteBtn && typeof voiceMuted !== 'undefined') {
          muteBtn.innerHTML = voiceMuted ? '<i class="fas fa-microphone-slash"></i> Unmute' : '<i class="fas fa-microphone"></i> Mute';
        }
      } else {
        // Ensure pre-join state: show Join, hide all controls
        if (joinBtnCenter) joinBtnCenter.style.display = 'flex';
        if (joinButtonContainer) joinButtonContainer.style.display = 'flex';
        if (leaveBtn) leaveBtn.style.display = 'none';
        if (muteBtn) muteBtn.style.display = 'none';
        if (reportsBtn) reportsBtn.style.display = 'none';
      }

      // Update status
      const statusText = document.getElementById('statusText');
      if (statusText && typeof voiceUi !== 'undefined' && voiceUi.statusEl) {
        statusText.textContent = voiceUi.statusEl.textContent || 'Not connected';
      }

      // Update participant count
      const participantCount = document.getElementById('participantCount');
      if (participantCount && typeof voiceParticipants !== 'undefined') {
        const count = voiceParticipants.size;
        participantCount.textContent = `${count} participant${count !== 1 ? 's' : ''}`;
      }

      // Update visitor counter display
      const visitorCounterEl = document.getElementById('visitorCounter');
      const visitorCountText = document.getElementById('visitorCountText');
      if (visitorCounterEl && visitorCountText && typeof window !== 'undefined') {
        if (typeof window.visitorCount !== 'undefined' && window.visitorCount > 0) {
          visitorCounterEl.style.display = 'flex';
          visitorCountText.textContent = `${window.visitorCount} visitor${window.visitorCount !== 1 ? 's' : ''}`;
        } else {
          visitorCounterEl.style.display = 'none';
        }
      }

      // Screen sharing removed - no longer needed
    }
    
    // Screen sharing indicator removed - no longer needed

    // Screen sharing monitoring removed - no longer needed
    function setupRemoteStreamMonitoring() {
      // Screen sharing removed - no longer needed
    }

      // Initialize visitor counter
      if (typeof ensureVisitorCounter === 'function') {
        ensureVisitorCounter();
        // Update counter display on science page
        const visitorCounterEl = document.getElementById('visitorCounter');
        const visitorCountText = document.getElementById('visitorCountText');
        if (visitorCounterEl && visitorCountText) {
          const updateVisitorCount = () => {
            if (typeof window.visitorCount !== 'undefined') {
              visitorCounterEl.style.display = 'flex';
              visitorCountText.textContent = `${window.visitorCount} visitor${window.visitorCount !== 1 ? 's' : ''}`;
            } else {
              visitorCounterEl.style.display = 'none';
            }
          };
          updateVisitorCount();
          setInterval(updateVisitorCount, 2000);
        }
      }

      // Initialize volume slider
      const volumeSlider = document.getElementById('voiceVolumeSlider');
      const volumeValue = document.getElementById('volumeValue');
      if (volumeSlider && volumeValue) {
        // Load saved volume or default to 100%
        const savedVolume = typeof localStorage !== 'undefined' ? localStorage.getItem('voice_volume_v1') : null;
        const initialVolume = savedVolume ? parseFloat(savedVolume) * 100 : 100;
        volumeSlider.value = initialVolume;
        volumeValue.textContent = `${Math.round(initialVolume)}%`;
        
        volumeSlider.addEventListener('input', (e) => {
          const volumePercent = parseFloat(e.target.value);
          const volumeDecimal = volumePercent / 100;
          
          // Update display
          volumeValue.textContent = `${Math.round(volumePercent)}%`;
          
          // Update global volume
          if (typeof window.voiceVolume !== 'undefined') {
            window.voiceVolume = volumeDecimal;
          }
          
          // Save to localStorage
          if (typeof localStorage !== 'undefined') {
            localStorage.setItem('voice_volume_v1', volumeDecimal.toString());
          }
          
          // Update all remote audio elements
          if (typeof voiceUi !== 'undefined' && voiceUi.audioBucket) {
            const audioElements = voiceUi.audioBucket.querySelectorAll('audio[data-peer-id]');
            audioElements.forEach(audio => {
              const peerId = audio.dataset.peerId;
              if (peerId) {
                // Check if this peer is locally muted
                const isMuted = typeof isPeerLocallyMuted === 'function' && isPeerLocallyMuted(peerId);
                // Update volume (limited to 1.0 for <audio> element)
                // If muted, volume should be 0, otherwise use the slider value
                audio.volume = isMuted ? 0 : Math.min(1.0, volumeDecimal);
                console.log('Volume updated for', peerId, 'to', audio.volume, '(muted:', isMuted, ')');
              }
            });
          }
          
          // Also update module-level voiceVolume for future audio attachments
          if (typeof window.voiceVolume !== 'undefined') {
            window.voiceVolume = volumeDecimal;
          }
        });
      }

      // Initialize when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initVoiceChatPage);
    } else {
      initVoiceChatPage();
    }
  </script>
</body>
</html>

