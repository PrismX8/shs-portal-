(()=>{var t,e={8839:(t,e,i)=>{var s={"./gamestats-pixi.module.js":[6014,881]};function n(t){if(!i.o(s,t))return Promise.resolve().then((()=>{var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}));var e=s[t],n=e[0];return i.e(e[1]).then((()=>i(n)))}n.keys=()=>Object.keys(s),n.id=8839,t.exports=n},289:(t,e,i)=>{"use strict";var s=i(6490),n=i(9089),a=i(603),r=i(3627),o=i(2467),h=i(8538),l=i(5122),c=i(3245),d=i(4661),u=i(2860),p=i(6437),m=i(8652),y=i(2067),w=i(8199);const g="Rise of Kingdom";var f=i(4103);const v=i.p+"coin9e281868c5c3a84f870d.png",b=i.p+"coins3eb3ef10685684af92ae.png",T=i.p+"crossing-swordsc900c725ef0ea30c2e25.png",k=i.p+"at318283d2273131c600d1.png",x=i.p+"bea924d4e5adc8638d2498.png",C=i.p+"br01cd21308554d11ff23e.png",E=i.p+"ca334c21850af3913c76e4.png",S=i.p+"ch295cf8f4970c1a7d4499.png",M=i.p+"cn0bd24b5fba58f480bc03.png",P=i.p+"deb6de2b36bb90fe6b2ec7.png",I=i.p+"dkab91db556c0812f81b19.png",A=i.p+"es5a6d838e05d30e808f72.png",O=i.p+"fr5453291928b94a655c0c.png",R=i.p+"gb8331c57d9e8ae3158563.png",_=i.p+"ild74877d2b86bcd979ea5.png",B=i.p+"ir7919cd23c7cc577eb763.png",L=i.p+"it56ee6ce020cc66b7ce04.png",D=i.p+"jp43fdaf5d057e3ef7261a.png",V=i.p+"mx7abc183e4c6c9a922638.png",H=i.p+"nl162b50090ff4df06e78e.png",F=i.p+"pla996a65da4b26752a516.png",N=i.p+"pride4146ddfeb2d6429a7a22.png",U=i.p+"pt5cde79c6d0707c56f59b.png",W=i.p+"ru1e314a3096f319a5ef8c.png",X=i.p+"se754ce6e6be6dd15c219a.png",G=i.p+"tr6734491b9d84a047561a.png",z=i.p+"trans5a408d547e07e339093d.png",K=i.p+"us728015f0c4b014c96b23.png",Y=i.p+"fogaf9b746769127d98f2d3.png",q=i.p+"gauge-borderaa6cc65bb0a4df84b5eb.png",j=i.p+"gauge-contente1a4dbd34460a88a154e.png",$=i.p+"gemfdd4a074d473a69e20ec.png",J=i.p+"circle32d41e92cfe7136ccaa3.png",Z=i.p+"cross5e22c84780238b481d33.png",Q=i.p+"question-marka364dd44fe90a8ce8667.png",tt=i.p+"ruby0ebeb1d4469e36ac7ad0.png",et=i.p+"circle-200x200e72884489c92b958130c.png",it=i.p+"shop2f9f5445691e528d5164e.png",st=i.p+"speech-bubble-exclamationd82f88d4309e64bd6e7d.png",nt=i.p+"speech-bubble4caa2b854424dad42208b.png",at=i.p+"standc4e1c2206ac315c7dd9e.png";function rt(t,e,i,s,n=null){return{path:t,width:e,height:i,size:s,spriteData:n}}function ot(t){return{coin:t(rt(v,50,50,5310)),coins:t(rt(b,64,64,6636)),crossingSwords:t(rt(T,128,128,7290)),flags:{at:t(rt(k,100,100,360)),be:t(rt(x,100,100,361)),br:t(rt(C,100,100,3734)),ca:t(rt(E,100,100,2038)),ch:t(rt(S,100,100,474)),cn:t(rt(M,100,100,1481)),de:t(rt(P,100,100,354)),dk:t(rt(I,100,100,463)),es:t(rt(A,100,100,3573)),fr:t(rt(O,100,100,356)),gb:t(rt(R,100,100,3853)),il:t(rt(_,100,100,2222)),ir:t(rt(B,100,100,3632)),it:t(rt(L,100,100,362)),jp:t(rt(D,100,100,1627)),mx:t(rt(V,100,100,2026)),nl:t(rt(H,100,100,367)),pl:t(rt(F,100,100,338)),pride:t(rt(N,100,100,392)),pt:t(rt(U,100,100,4060)),ru:t(rt(W,100,100,368)),se:t(rt(X,100,100,378)),tr:t(rt(G,100,100,2225)),trans:t(rt(z,100,100,357)),us:t(rt(K,100,100,3655))},fog:t(rt(Y,412,413,45419)),gaugeBorder:t(rt(q,200,20,1010)),gaugeContent:t(rt(j,200,20,1123)),gem:t(rt($,50,50,5373)),particles:{circle:t(rt(J,32,32,5172)),cross:t(rt(Z,50,50,4277))},questionMark:t(rt(Q,128,128,6512)),ruby:t(rt(tt,50,50,5238)),shapes:{circle200x200:t(rt(et,200,200,3821))},shop2:t(rt(it,128,128,7380)),speechBubbleExclamation:t(rt(st,512,512,26567)),speechBubble4:t(rt(nt,512,512,12658)),stand:t(rt(at,80,80,765))}}class ht{constructor(){this.unloadedTextures=[],this.textureCount=0;const t=new Map;this.textures=ot((e=>{const i=this.fromCatalogItem(e);return t.set(e.path,i),i})),this.catalog=ot((({path:e})=>t.get(e).texture))}fromCatalogItem(t){const e={texture:f.Texture.from(t.path),src:t.path,width:t.width,height:t.height,size:t.size};return this.unloadedTextures.push(e),e}loadAll(){const t=this.unloadedTextures;return this.unloadedTextures=[],t.map((t=>{const e=t.texture.baseTexture.resource.url;return{label:null==e?void 0:e.replace(document.location.href,""),load:()=>this.loadTexture(t),size:t.size,mandatory:!0}}))}async loadTexture(t){await t.texture.baseTexture.resource.load()}}const lt=!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1);function ct(){return lt}const dt={ok:{en:"Okay",es:"Bueno",fr:"OK",pt:"OK",tr:"Tamam",de:"Okay",it:"OK"},submit:{en:"Submit",fr:"Envoyer",es:"Entregar",pt:"Enviar",tr:"Göndermek",de:"Einreichen",it:"Invia"},send:{en:"Send",fr:"Envoyer",es:"Enviar",pt:"Enviar",tr:"Göndermek",de:"Schicken",it:"Inviare"},continue:{en:"Continue",es:"Continuar",fr:"Continuer",pt:"Continuar",tr:"Devam Et",de:"Fortsetzen",it:"Continua"},confirm:{en:"Confirm",es:"Confirmar",fr:"Confirmer",pt:"Confirmar",tr:"Onayla",de:"Bestätigen",it:"Conferma"},cancel:{en:"Cancel",es:"Cancelar",fr:"Annuler",pt:"Cancelar",tr:"İptal",de:"Abbrechen",it:"Cancella"},back:{en:"Back",es:"Volver",fr:"Retour",pt:"Atrás",tr:"Geri",de:"Zurück",it:"Indietro"},play:{en:"Play",es:"Jugar",fr:"Jouer",pt:"Jogar",tr:"Oyna",de:"Spielen",it:"Gioca"},newGame:{en:"New Game",fr:"Nouvelle Partie",es:"Juego nuevo",pt:"Novo Jogo",tr:"Yeni Oyun",de:"Neues Spiel",it:"Nuova partita"},time:{en:"Time",es:"Tiempo",fr:"Temps",pt:"Tempo",tr:"Süre",de:"Zeit",it:"Tempo"},share:{en:"Share",es:"Compartir",fr:"Partager",pt:"Compartilhar",tr:"Paylaş",de:"Teilen",it:"Condividi"},resume:{en:"Resume",fr:"Reprendre",es:"Reanudar juego",pt:"Retomar jogo",tr:"Oyuna devam et",de:"Spiel fortsetzen",it:"Riprendi il gioco"},bestTime:{en:"Best time",es:"Mejor tiempo",fr:"Meilleur temps",pt:"Melhor tempo",tr:"En iyi zaman",de:"Beste Zeit",it:"Miglior tempo"},level:{en:"Level",es:"Nivel",fr:"Niveau",pt:"Nível",tr:"Seviye",de:"Level",it:"Livello"},gamePaused:{en:"Game Paused",es:"Juego pausado",fr:"Jeu en pause",pt:"Jogo pausado",tr:"Oyun duraklatıldı",de:"Das Spiel pausiert",it:"Gioco in pausa"},help:{en:"Help",es:"Ayuda",fr:"Aide",pt:"Ajuda",tr:"Yardım",de:"Hilfe",it:"Aiuto"},mainMenu:{en:"Main Menu",es:"Menú principal",fr:"Menu principal",pt:"Menu Principal",tr:"Ana Menü",de:"Hauptmenü",it:"Menu principale"},backToMainMenu:{en:"Back To Main Menu",es:"Regresar al menú principal",fr:"Retour au menu principal",pt:"Voltar ao menu principal",tr:"Ana menüye dön",de:"Zurück zum Hauptmenü",it:"Indietro al menù principale"},credits:{en:"Credits",es:"Créditos",fr:"Remerciements",pt:"Créditos",tr:"Künye",de:"Credits",it:"Crediti"},select:{en:"Select",es:"Seleccionar",fr:"Sélectionner",pt:"Selecione",tr:"Seçme",de:"Wählen",it:"Selezionare"},watchAdTochangeAppearance:{en:"Watch an ad to change appearance?",es:"¿Ver un anuncio para cambiar de apariencia?",fr:"Regarder une publicité pour changer d'apparence ?",pt:"Assistir a um anúncio para mudar a aparência?",tr:"Görünümü değiştirmek için bir reklam mı izlediniz?",de:"Eine Anzeige ansehen, um das Erscheinungsbild zu ändern?",it:"Guardare un annuncio per cambiare aspetto?"},congratulations:{en:"Congratulations",es:"Felicidades",fr:"Toutes nos félicitations",pt:"Parabéns",tr:"Tebrikler",de:"Glückwunsch",it:"Congratulazioni"},areYouSure:{en:"Are you sure?",es:"¿Estás seguro?",fr:"Êtes-vous certain ?",pt:"Você tem a certeza?",tr:"Emin misiniz?",de:"Bist du sicher?",it:"Sei sicuro?"},yourProgressWontBeSaved:{en:"Your progress won't be saved",es:"Tu progreso no se guardará",fr:"Votre progression ne sera pas enregistrée",pt:"Seu progresso não será salvo",tr:"İlerlemeniz kaydedilmeyecek",de:"Ihr Fortschritt wird nicht gespeichert",it:"I tuoi progressi non verranno salvati"},enterANameForTheLeaderboard:{en:"Enter a name for the leaderboard:",fr:"Saisissez un nom pour le classement:",es:"Ingrese un nombre para la tabla de clasificación:",pt:"Insira um nome para a tabela de classificação:",tr:"Skor tablosu için bir ad girin:",de:"Geben Sie einen Namen für die Bestenliste ein:",it:"Inserisci un nome per la classifica:"},restart:{en:"Restart",fr:"Recommencer",es:"Reanudar",pt:"Reiniciar",tr:"Tekrar başlat",de:"Neu starten",it:"Ricomincia"},restartLevel:{en:"Restart Level",fr:"Recommencer Niveau",es:"Volver a empersar el nivel",pt:"Recomeçar nível",tr:"Bölümü tekrarla",de:"Level neustarten",it:"Riavvia il livello"},you:{en:"You",fr:"Vous",es:"Tú",pt:"Você",tr:"Sen",de:"Du",it:"Voi"},tryAgain:{en:"Try Again",fr:"Réessayer",es:"Intentar otra vez",pt:"Tente novamente",tr:"Tekrar deneyin",de:"Versuchen Sie es erneut",it:"Riprova"},skip:{en:"Skip",fr:"Passer",es:"Saltar",pt:"Saltar",tr:"Atla",de:"Replay überspringen",it:"Salta"},leave:{en:"Leave",fr:"Quitter",es:"Dejar",pt:"Deixar",tr:"Ayrılmak",de:"Verlassen",it:"Partire"},"leave?":{en:"Leave?",fr:"Quitter?",es:"¿Dejar?",pt:"Deixar?",tr:"Ayrılmak?",de:"Verlassen?",it:"Partire?"},stay:{en:"Stay",fr:"Rester",es:"Permanecer",pt:"Ficar",tr:"Kalmak",de:"Bleiben",it:"Rimanere"},"goBackToMainMenu?":{en:"Go back to main menu?",fr:"Retourner au menu principal?",es:"¿Volver al menú principal?",pt:"Voltar ao menu principal?",tr:"Ana menüye dönülsün mü?",de:"Zurück zum Hauptmenü?",it:"Tornare al menu principale?"},error:{en:"Error",fr:"Erreur",es:"Error",pt:"Erro",tr:"Hata",de:"Fehler",it:"Errore"},campaign:{en:"Campaign",fr:"Campagne",es:"Campaña",pt:"Campanha",tr:"Kampanya",de:"Kampagne",it:"Campagna"},settings:{en:"Settings",fr:"Options",es:"Ajustes",pt:"Configurações",tr:"Ayarlar",de:"Einstellungen",it:"Impostazioni"},quit:{en:"Quit",fr:"Quitter",es:"Cerrar",pt:"Sair",tr:"Oyunu Kapat",de:"Beenden",it:"Esci"},apply:{en:"Apply",fr:"Appliquer",es:"Aplicar",pt:"Aplicar",tr:"Uygula",de:"Anwenden",it:"Fare domanda a"},graphics:{en:"Graphics",fr:"Graphismes",es:"Gráficos",pt:"Gráficos",tr:"Grafikler",de:"Grafik",it:"Grafica"},audio:{en:"Audio",fr:"Audio",es:"Audio",pt:"Áudio",tr:"Ses",de:"Audio",it:"Audio"},mouseKeyboard:{en:"Mouse/Keyboard",fr:"Souris/Clavier",es:"Ratón/teclado",pt:"Rato/Teclado",tr:"Fare/Klavye",de:"Maus/Tastatur",it:"Mouse/tastiera"},gamepad:{en:"Gamepad",fr:"Manette",es:"Mando",pt:"Comando",tr:"Oyun Kumandası",de:"Gamepad",it:"Controller"},gameplay:{en:"Gameplay",fr:"Gameplay",es:"Como se Juega",pt:"Jogabilidade",tr:"Oynanış",de:"Spielweise",it:"Gioco"},yourName:{en:"Your name:",fr:"Votre nom:",es:"Su nombre:",pt:"Seu nome:",tr:"Adınız:",de:"Ihr Name:",it:"Il tuo nome:"},loading:{en:"Loading...",fr:"Chargement...",es:"Cargando...",pt:"A carregar...",tr:"Yükleniyor...",de:"Lädt...",it:"Caricamento..."},pressAnyKeyToStart:{en:"Press any key to start",fr:"Appuyez sur une touche pour commencer",es:"Presione cualquier tecla para comenzar",pt:"Pressione qualquer tecla para iniciar",tr:"Başlamak için herhangi bir tuşa basın",de:"Drücken Sie zum Starten eine beliebige Taste",it:"Premere un tasto qualsiasi per iniziare"},activate:{en:"Activate",fr:"Activer",es:"Activar",pt:"Ativar",tr:"Etkinleştir",de:"aktivieren Sie",it:"Attivare"},levelComplete:{en:"Level Complete",fr:"Niveau Terminé",es:"Nivel completado",pt:"Nível completo",tr:"Seviye Tamamlandı",de:"Level geschafft",it:"Livello completato"},levelFailed:{en:"Level Failed",fr:"Échec",es:"Nivel fracasado",pt:"Nível falhado",tr:"Seviye geçilemedi",de:"Level gescheitert",it:"Livello fallito"},deaths:{en:"Deaths",fr:"Morts",es:"Muertes",pt:"Mortes",tr:"Ölümler",de:"Tode",it:"Morti"},unlock:{en:"Unlock",fr:"Débloquer",es:"Desbloquear",pt:"Desbloquear",tr:"Kilidini Aç",de:"Freischalten",it:"Sblocca"},equip:{en:"Equip",fr:"Equiper",es:"Equipar",pt:"Equipar",tr:"Donatmak",de:"Ausrüsten",it:"Equipaggiare"},changeName:{en:"Change name",fr:"Changement de nom",es:"Cambiar nombre",pt:"Mude o nome",tr:"İsmini değiştir",de:"Namen ändern",it:"Cambia nome"},whatNameWouldYouLikeToUse:{en:"What is the name of your knight?",fr:"Quel est le nom de ton chevalier?",es:"¿Cómo se llama tu caballero?",pt:"Qual é o nome do seu cavaleiro?",tr:"Şövalyenizin adı nedir?",de:"Wie heißt dein Ritter?",it:"Come si chiama il tuo cavaliere?"},youDied:{en:"You died",fr:"Vous avez péri",es:"moriste",pt:"Você morreu",tr:"Öldün",de:"Du bist gestorben",it:"Sei morto"},campaignMenu:{en:"Campaign Menu",fr:"Menu de campagne",es:"Menú de campaña",pt:"Menu da campanha",tr:"Kampanya Menüsü",de:"Kampagnenmenü",it:"Menù della campagna"},theJoystick:{en:"the joystick",es:"la palanca de mando",fr:"le joystick",pt:"o joystick",tr:"oyun çubuğu",de:"der Joystick",it:"il joystick"},tutorialMovement:{en:"Use <binding:movement> to move",es:"Utilice <binding:movement> para moverse",fr:"Utilisez <binding:movement> pour vous déplacer",pt:"Use <binding:movement> para mover",tr:"Hareket etmek için <binding:movement> kullanın",de:"Verwenden Sie zum Bewegen <binding:movement>.",it:"Utilizzare <binding:movement> per spostarsi"},tutorialLightStrike:{en:"<binding:tool> to strike an enemy",es:"<binding:tool> para golpear a un enemigo",fr:"<binding:tool> pour frapper un ennemi",pt:"<binding:tool> para atacar um inimigo",tr:"<binding:tool> bir düşmana saldırmak için",de:"<binding:tool>, um einen Feind anzugreifen",it:"<binding:tool> per colpire un nemico"},tutorialHeavyStrike:{en:"**Hold** <binding:tool> to charge a heavy strike",es:"**Mantén pulsado** <binding:tool> para cargar un golpe fuerte.",fr:"**Maintenez** <binding:tool> pour charger une frappe lourde",pt:"**Segure** <binding:tool> para atacar com força",tr:"Ağır bir saldırı gerçekleştirmek için **basılı tutun** <binding:tool>",de:"**Halten** <binding:tool> gedrückt, um einen schweren Schlag auszuführen",it:"**Tieni premuto** <binding:tool> per caricare un colpo pesante"},tutorialDash:{en:"Double tap <binding:movement> to dash",es:"Toca dos veces <binding:movement> para correr",fr:"Appuyez deux fois sur <binding:movement> pour vous précipiter",pt:"Toque duas vezes em <binding:movement> para correr",tr:"Kısa çizgi için <binding:movement> öğesine iki kez dokunun",de:"Tippen Sie zweimal auf <binding:movement>, um zu sprinten",it:"Tocca due volte <binding:movement> per scattare"},tutorialSlayThem:{en:"Now slay them!",es:"¡Ahora mátalos!",fr:"Maintenant, tuez-les !",pt:"Agora mate-os!",tr:"Şimdi onları öldürün!",de:"Jetzt tötet sie!",it:"Adesso uccidili!"},tutorialShield:{en:"**Hold** <binding:shield> to block attacks",es:"**Mantén pulsado** <binding:shield> para bloquear ataques.",fr:"**Maintenez** <binding:shield> pour bloquer les attaques",pt:"**Segure** <binding:shield> para bloquear ataques",tr:"Saldırıları engellemek için** <binding:shield> tuşunu basılı tutun",de:"**Halten** <binding:shield>, um Angriffe abzuwehren",it:"**Tieni premuto** <binding:shield> per bloccare gli attacchi"},tutorialBuySwordFromMerchant:{en:"Buy a sword from the merchant",es:"Compra una espada al comerciante.",fr:"Achetez une épée chez le marchand",pt:"Compre uma espada do comerciante",tr:"Tüccardan bir kılıç satın al",de:"Kaufen Sie ein Schwert beim Händler",it:"Acquista una spada dal commerciante"},tutorialFollowPath:{en:"Follow the path",es:"Sigue el camino",fr:"Suivez le chemin",pt:"Siga o caminho",tr:"Yolu takip et",de:"Folge dem Pfad",it:"Segui il percorso"},tutorialSkip:{en:"Skip Tutorial",es:"Saltar tutorial",fr:"Passer le tutoriel",pt:"Pular tuturial",tr:"Eğiticiyi Atla",de:"Lernprogramm überspringen",it:"Salta il tutorial"},inventory:{en:"Inventory",es:"Inventario",fr:"Inventaire",pt:"Inventário",tr:"Depo",de:"Inventar",it:"Inventario"},shop:{en:"Shop",es:"Comercio",fr:"Boutique",pt:"Comprar",tr:"Mağaza",de:"Geschäft",it:"Negozio"},weapons:{en:"Weapons",es:"Armas",fr:"Armes",pt:"Armas",tr:"Silahlar",de:"Waffen",it:"Armi"},weapon:{en:"Weapon",fr:"Arme",es:"Arma",pt:"Arma",tr:"Silah",de:"Waffe",it:"Arma"},armors:{en:"Armors",es:"Armaduras",fr:"Armures",pt:"Armaduras",tr:"Zırhlar",de:"Rüstungen",it:"Armature"},armor:{en:"Armor",fr:"Armure",es:"Armadura",pt:"Armadura",tr:"Zırh",de:"Rüstung",it:"Armatura"},shields:{en:"Shields",es:"Escudos",fr:"Boucliers",pt:"Escudos",tr:"Kalkanlar",de:"Schilder",it:"Scudi"},shield:{en:"Shield",fr:"Bouclier",es:"Escudo",pt:"Escudo",tr:"Kalkan",de:"Schild",it:"Scudo"},helmets:{en:"Helmets",es:"Cascos",fr:"Casques",pt:"Capacetes",tr:"Kasklar",de:"Helme",it:"Caschi"},helmet:{en:"Helmet",fr:"Casque",es:"Casco",pt:"Capacete",tr:"Kafalık",de:"Helm",it:"Elmo"},buy:{en:"Buy",es:"Comprar",fr:"Acheter",pt:"Comprar",tr:"Satın Al",de:"Kaufen",it:"Compra"},"buyX?":{en:"Buy {{x}}?",es:"¿Comprar {{x}}?",fr:"Acheter {{x}} ?",pt:"Comprar {{x}}?",tr:"{{x}} satın alınsın mı?",de:"{{x}} kaufen?",it:"Acquistare {{x}}?"},exit:{en:"Exit",es:"Salir",fr:"Sortir",pt:"Sair",tr:"Çıkış",de:"Beenden",it:"Esci"},keepTrying:{en:"Keep trying",es:"sigue intentándolo",fr:"Continue d'essayer",pt:"Continue tentando",tr:"Denemeye devam et",de:"Weiter versuchen",it:"Continua a provare"},"exitChallenge?":{en:"Exit Challenge?",es:"¿Salir del desafío?",fr:"Quitter le défi ?",pt:"Sair do desafio?",tr:"Challenge'dan çıkılsın mı?",de:"Exit-Challenge?",it:"Uscire dalla sfida?"},youWontGetTheReward:{en:"You won't get the reward",es:"no obtendrás la recompensa",fr:"Vous n'obtiendrez pas la récompense",pt:"Você não receberá a recompensa",tr:"Ödülü alamayacaksın",de:"Du wirst die Belohnung nicht bekommen",it:"Non riceverai la ricompensa"},"reward:":{en:"Reward:",es:"Premio:",fr:"Récompense:",pt:"Recompensa:",tr:"Ödül:",de:"Belohnen:",it:"Ricompensa:"},"acceptChallenge?":{en:"Accept Challenge?",es:"¿Aceptar el desafío?",fr:"Accepter le défi ?",pt:"Aceitar desafio?",tr:"Mücadeleyi kabul ediyor musun?",de:"Herausforderung annehmen?",it:"Accetti la sfida?"},accept:{en:"Accept",es:"Aceptar",fr:"Accepter",pt:"Aceitar",tr:"Kabul etmek",de:"Akzeptieren",it:"Accettare"},decline:{en:"Decline",es:"Rechazar",fr:"Déclin",pt:"Declínio",tr:"Reddetmek",de:"Abfall",it:"Declino"},challenge:{en:"Challenge",es:"Desafío",fr:"Défi",pt:"Desafio",tr:"Meydan Okuma",de:"Herausforderung",it:"Sfida"},imReady:{en:"I'm Ready",es:"Estoy listo",fr:"Je suis prêt",pt:"Estou pronto",tr:"Ben hazırım",de:"Ich bin bereit",it:"Sono pronto"},revive:{en:"Revive",es:"Reanimar",fr:"Revivre",pt:"Reviver",tr:"Canlandırmak",de:"Beleben",it:"Ravvivare"},yes:{en:"Yes",es:"Sí",fr:"Oui",pt:"Sim",tr:"Evet",de:"Ja",it:"Sì"},no:{en:"No",es:"No",fr:"Non",pt:"Não",tr:"Hayır",de:"Nein",it:"No"},equipped:{en:"Equipped",es:"Equipado",fr:"Équipé",pt:"Equipado",tr:"Donanımlı",de:"Ausgestattet",it:"Attrezzato"},premiumItems:{en:"Premium Items",es:"Artículos premium",fr:"Articles premium",pt:"Itens Premium",tr:"Premium Öğeler",de:"Premium-Artikel",it:"Articoli premium"},upgradeAll:{en:"Upgrade all",es:"Actualizar todo",fr:"Mettre à niveau tous",pt:"Atualizar tudo",tr:"Hepsini yükselt",de:"Alles Aktualisieren",it:"Aggiorna tutto"},"startANewGame?":{en:"Start a new game?",es:"¿Empezar un nuevo juego?",fr:"Commencer une nouvelle partie ?",pt:"Iniciar um novo jogo?",tr:"Yeni bir oyun mu başlatacaksınız?",de:"Ein neues Spiel starten?",it:"Iniziare un nuovo gioco?"},yourProgressWillBeLost:{en:"Your progress will be lost",es:"Tu progreso se perderá",fr:"Votre progression sera perdue",pt:"Seu progresso será perdido",tr:"İlerlemeniz kaybolacak",de:"Ihr Fortschritt geht verloren",it:"I tuoi progressi andranno persi"},waveCleared:{en:"Wave Cleared",es:"Ola despejada",fr:"Vague Terminée",pt:"Onda limpa",tr:"Dalga Temizlendi",de:"Welle gelöscht",it:"Onda cancellata"},pressInteractToTalk:{en:"Press <binding:interact> to talk",es:"Presione <binding:interact> para hablar",fr:"Appuyez sur <binding:interact> pour parler",pt:"Pressione <binding:interact> para falar",tr:"Konuşmak için <binding:interact> tuşuna basın",de:"Drücken Sie <binding:interact>, um zu sprechen",it:"Premi <binding:interact> per parlare"},pressInteractToOpenShop:{en:"Press <binding:interact> to enter the shop",es:"Pulsa <binding:interact> para entrar a la tienda.",fr:"Appuyez sur <binding:interact> pour entrer dans la boutique",pt:"Pressione <binding:interact> para entrar na loja",tr:"Mağazaya girmek için <binding:interact> tuşuna basın",de:"Drücken Sie <binding:interact>, um den Shop zu betreten",it:"Premi <binding:interact> per entrare nel negozio"},or:{en:" or ",es:" o ",fr:" ou ",pt:" ou ",tr:" veya ",de:" oder ",it:" O "},itemUnlocked:{en:"Item unlocked!",es:"¡Artículo desbloqueado!",fr:"Objet débloqué !",pt:"Item desbloqueado!",tr:"Öğenin kilidi açıldı!",de:"Artikel freigeschaltet!",it:"Oggetto sbloccato!"},notEnoughMoney:{en:"You don't have enough gold for this item",es:"No tienes suficiente oro para este artículo.",fr:"Vous n'avez pas assez d'or pour cet objet",pt:"Você não tem ouro suficiente para este item",tr:"Bu eşya için yeterli altınınız yok",de:"Du hast nicht genug Gold für diesen Gegenstand",it:"Non hai abbastanza oro per questo oggetto"},tooltipDamage:{en:"Strength: how much damage you inflict to enemies",es:"Fuerza: cuánto daño infliges a los enemigos.",fr:"Force : combien de dégâts vous infligez aux ennemis",pt:"Força: quanto dano você causa aos inimigos",tr:"Güç: düşmanlara ne kadar hasar verdiğiniz",de:"Stärke: Wie viel Schaden fügst du Feinden zu?",it:"Forza: quanti danni infliggi ai nemici"},tooltipDefense:{en:"Defense: how much health you have",es:"Defensa: cuánta salud tienes",fr:"Défense : quel est votre niveau de santé",pt:"Defesa: quanta saúde você tem",tr:"Savunma: ne kadar sağlığınız var",de:"Verteidigung: Wie viel Gesundheit hast du?",it:"Difesa: quanta salute hai"},tooltipMobility:{en:"Mobility: how fast you can run",es:"Movilidad: qué tan rápido puedes correr",fr:"Mobilité : à quelle vitesse pouvez-vous courir",pt:"Mobilidade: quão rápido você pode correr",tr:"Hareketlilik: ne kadar hızlı koşabilirsiniz",de:"Mobilität: Wie schnell Sie laufen können",it:"Mobilità: quanto velocemente puoi correre"},"go!":{en:"Go!",fr:"C'est parti !",es:"¡Ir!",pt:"Ir!",tr:"Gitmek!",de:"Gehen!",it:"Andare!"},"nextWaveIn:":{en:"Next Wave In:",fr:"Prochaine Vague:",es:"Próxima ola en:",pt:"Próxima onda:",tr:"Sonraki Dalga Girişi:",de:"Nächste Welle in:",it:"Prossima ondata in arrivo:"},survival:{en:"Survival",fr:"Survie",es:"Supervivencia",pt:"Sobrevivência",tr:"Hayatta kalma",de:"Überleben",it:"Sopravvivenza"},totalTime:{en:"Total time",fr:"Durée totale",es:"Tiempo Total",pt:"Tempo total",tr:"Toplam zaman",de:"Gesamtzeit",it:"Tempo totale"},killedEnemies:{en:"Killed enemies",fr:"Enemis tués",es:"Enemigos asesinados",pt:"Inimigos mortos",tr:"Öldürülen düşmanlar",de:"Feinde getötet",it:"Nemici uccisi"},maxCombo:{en:"Max combo",fr:"Combo max",es:"combinación máxima",pt:"Combinação máxima",tr:"Maksimum kombinasyon",de:"Maximale Kombination",it:"Combinazione massima"},collectedMoney:{en:"Collected money",fr:"Argent récupéré",es:"dinero recaudado",pt:"Dinheiro arrecadado",tr:"Toplanan para",de:"Geld gesammelt",it:"Soldi raccolti"},waveX:{en:"Wave {{x}}",fr:"Vague {{x}}",es:"Saluda {{x}}",pt:"Onda {{x}}",tr:"Dalga {{x}}",de:"Winke {{x}}",it:"Onda {{x}}"},clearedWaves:{en:"Cleared Waves",fr:"Vagues éliminées",es:"Olas despejadas",pt:"Ondas Limpas",tr:"Temizlenmiş Dalgalar",de:"Wellen gelöscht",it:"Onde purificate"},achievementUnlocked:{en:"Trophy Unlocked!",fr:"Trophée Déverrouillé!",es:"¡Trofeo desbloqueado!",pt:"Troféu desbloqueado!",tr:"Kupa Kilidi Açıldı!",de:"Trophäe freigeschaltet!",it:"Trofeo sbloccato!"},achievements:{en:"Trophies",fr:"Trophées",es:"Trofeos",pt:"Troféus",tr:"Kupalar",de:"Trophäen",it:"Trofei"},achievementBuySomething:{en:"Buy something from a merchant",es:"Comprar algo a un comerciante",fr:"Acheter quelque chose chez un commerçant",pt:"Compre algo de um comerciante",tr:"Bir tüccardan bir şey satın almak",de:"Kaufen Sie etwas bei einem Händler",it:"Compra qualcosa da un commerciante"},achievementPerfectParry:{en:"Perform a perfect parry",es:"Realiza una parada perfecta",fr:"Réalisez une parade parfaite",pt:"Execute um parry perfeito",tr:"Mükemmel bir savuşturma gerçekleştirin",de:"Führe eine perfekte Parade aus",it:"Esegui una parata perfetta"},achievementLevelUp:{en:"Level up your character",es:"Sube de nivel a tu personaje",fr:"Améliorez votre personnage",pt:"Aumente o nível do seu personagem",tr:"Karakterinizin seviyesini yükseltin",de:"Verbessere deinen Charakter",it:"Aumenta il livello del tuo personaggio"},achievementKillWizard:{en:"Eliminate a wizard",es:"Eliminar a un mago",fr:"Éliminer un sorcier",pt:"Elimine um mago",tr:"Bir sihirbazı ortadan kaldırın",de:"Eliminiere einen Zauberer",it:"Elimina un mago"},achievementKillKing:{en:"Eliminate the King",es:"eliminar al rey",fr:"Éliminer le roi",pt:"Elimine o Rei",tr:"Kralı ortadan kaldır",de:"Eliminiere den König",it:"Elimina il Re"},achievementKnockOffHorse:{en:"Knock an enemy off their horse",es:"Derriba a un enemigo de su caballo",fr:"Faire tomber un ennemi de son cheval",pt:"Derrube um inimigo do cavalo",tr:"Bir düşmanı atından düşürün",de:"Schlage einen Feind vom Pferd",it:"Fai cadere un nemico da cavallo"},achievementReturnAxe:{en:"Parry a thrown axe to hit an enemy",es:"Parar un hacha arrojada para golpear a un enemigo",fr:"Parez une hache lancée pour frapper un ennemi",pt:"Desvie um machado lançado para atingir um inimigo",tr:"Bir düşmana vurmak için fırlatılan baltayı savuşturun",de:"Pariere eine geworfene Axt, um einen Feind zu treffen",it:"Para un'ascia lanciata per colpire un nemico"},achievementCancelBurn:{en:"Perform a roll dash to stop burning",es:"Realiza una carrera rodante para dejar de quemarte.",fr:"Effectuez un roulis pour arrêter de brûler",pt:"Execute um roll dash para parar de queimar",tr:"Yanmayı durdurmak için yuvarlanma çizgisi gerçekleştirin",de:"Führen Sie einen Rollsprint aus, um das Brennen zu stoppen",it:"Esegui uno scatto in rollio per smettere di bruciare"},achievementComboX:{en:"Perform a {{x}}X combo",es:"Realiza un combo {{x}}X",fr:"Effectuez un combo {{x}}X",pt:"Execute um combo {{x}}X",tr:"Bir {{x}}X kombosu gerçekleştir",de:"Führe eine {{x}}X-Combo aus",it:"Esegui una combo di {{x}}X"},achievementLevelX:{en:"Reach level {{x}}",es:"Alcanza el nivel {{x}}",fr:"Atteindre le niveau {{x}}",pt:"Alcance o nível {{x}}",tr:"{{x}}. seviyeye ulaşın",de:"Erreiche Level {{x}}",it:"Raggiungi il livello {{x}}"},achievementCustomizeAllCategories:{en:"Customize your weapon, armor, shield and helmet",es:"Personaliza tu arma, armadura, escudo y casco.",fr:"Personnalisez votre arme, armure, bouclier et casque",pt:"Personalize sua arma, armadura, escudo e capacete",tr:"Silahınızı, zırhınızı, kalkanınızı ve kaskınızı kişiselleştirin",de:"Passen Sie Ihre Waffe, Rüstung, Ihren Schild und Ihren Helm individuell an",it:"Personalizza la tua arma, armatura, scudo ed elmo"},killXEnemies:{en:"Eliminate {{x}} enemies",fr:"Eliminez {{x}} ennemis",es:"Elimina {{x}} enemigos",pt:"Elimine {{x}} inimigos",tr:"{{x}} düşmanı yok et",de:"Eliminiere {{x}} Feinde",it:"Elimina {{x}} nemici"},reachWaveXInSurvival:{en:"Clear {{x}} waves in survival mode",fr:"Eliminez {{x}} vagues en mode survie",es:"Elimina {{x}} oleadas en modo supervivencia.",pt:"Limpe {{x}} ondas no modo de sobrevivência",tr:"Hayatta kalma modunda {{x}} dalgayı temizleyin",de:"Bewältige {{x}} Wellen im Überlebensmodus",it:"Elimina {{x}} ondate in modalità sopravvivenza"},gameCompleteDescription:{en:"You slayed the King! But a new King has risen, with a stronger army. The cycle continues...",es:"¡Mataste al Rey! Pero ha surgido un nuevo rey, con un ejército más fuerte. El ciclo continúa...",fr:"Vous avez tué le roi ! Mais un nouveau roi est apparu, doté d’une armée plus forte. Le cycle continue...",pt:"Você matou o rei! Mas um novo Rei surgiu, com um exército mais forte. O ciclo continua...",tr:"Kralı öldürdün! Ancak daha güçlü bir orduya sahip yeni bir Kral yükseldi. Döngü devam ediyor...",de:"Du hast den König getötet! Aber ein neuer König ist aufgestanden, mit einer stärkeren Armee. Der Zyklus geht weiter...",it:"Hai ucciso il re! Ma è sorto un nuovo re, con un esercito più forte. Il ciclo continua..."},kingSlain:{en:"King Slain!",es:"¡Rey asesinado!",fr:"Roi tué !",pt:"Rei morto!",tr:"Kral Öldürüldü!",de:"König getötet!",it:"Re ucciso!"},leaderboardTitle:{en:"Best Knights Of The Week",fr:"Meilleurs chevaliers de la semaine",es:"Los mejores caballeros de la semana",pt:"Melhores Cavaleiros da Semana",tr:"Haftanın En İyi Şövalyeleri",de:"Beste Ritter der Woche",it:"I migliori cavalieri della settimana"},leaderboardWaves:{en:"Waves",fr:"Vagues",es:"Ondas",pt:"Ondas",tr:"Dalgalar",de:"Wellen",it:"Onde"},leaderboardKills:{en:"Kills",fr:"Enemies",es:"Asesinatos",pt:"Mortes",tr:"Leş",de:"Kills",it:"Uccisioni"},leaderboardMaxCombo:{en:"Max Combo",fr:"Combo Max",es:"Combinación máxima",pt:"Combinação máxima",tr:"Maksimum Kombo",de:"Max Combo",it:"Combinazione massima"},joinTheFight:{en:"Join The Fight",fr:"Rejoindre La Bataille",es:"Únete a la lucha",pt:"Junte-se à luta",tr:"Mücadeleye Katılın",de:"Treten Sie dem Kampf bei",it:"Unisciti alla lotta"}};let ut="en";function pt(t){const e=dt[t];return e?e[ut]||e.en:t}const mt=JSON.parse('{"current":{"dateString":"2024-10-05","message":"Version bump","commitHash":"91ad8f2","version":"1.0.1"},"changelog":[{"dateString":"2024-10-05","message":"Version bump","commitHash":"91ad8f2"}]}'),yt=(mt.current.version,mt.changelog,mt);var wt=i(6588);function gt(t,e,i,s=(t=>t)){return s(Math.min(1,Math.max(0,i)))*(e-t)+t}var ft=i(3717);const vt=.1,bt=[30,150,300];function Tt(t){return 0|t}function kt(t){const e=[t.damage,t.defense,t.mobility].reduce(((t,e)=>t+Math.max(0,e)),0);return Math.max(500,(0,ft.wx)(5e4*e,100))}function xt(t,e){return 1===e?.2:gt(1/15,.2,(t-e)/5)}function Ct(t){const e=2+t/4,i=4+t/3;return Math.ceil(Math.abs(Math.sin(2*t))*(i-e)+e)}function Et(t){return gt(1,2,(t-9)/20)}const St=["mobility","damage","defense"];class Mt{constructor(t={}){this.mobility=0,this.damage=0,this.defense=0,this.mobility=(null==t?void 0:t.mobility)||0,this.damage=(null==t?void 0:t.damage)||0,this.defense=(null==t?void 0:t.defense)||0}reset(){return this.mobility=0,this.damage=0,this.defense=0,this}setStat(t,e){this[t]=e}addStat(t,e){return this[t]+=e,this}multiplyStat(t,e){return this[t]*=e,this}add(t){return this.mobility+=t.mobility,this.damage+=t.damage,this.defense+=t.defense,this}clone(){return(new Mt).add(this)}normalized(){const t=new Mt,e=Math.max(this.mobility,this.damage,this.defense);if(e<=0)return t;for(const i of St)t[i]=this[i]/e;return t}maxHealth(){return gt(50,200,this.defense)}appliedDamage(t,e){const i=t.charged?70:25+5*t.consecutiveAttackCount,s=Et(t.comboCount);return gt(2,i,this.damage)*(e?2:1)*s}strikeStaminaLoss(t){return t.charged?gt(.4,0,this.damage):0}receivedAttackConstitutionLoss(t,e){return this.appliedDamage(t,!1)/this.maxHealth()*gt(3,0,this.defense)}shieldBlockStaminaLoss(t){return gt(t.charged?.8:.25,t.charged?.3:.1,this.defense)}walkingSpeed(){return gt(100,300,this.mobility)}dashDistance(){return gt(50,200,this.mobility)}rollDistance(){return gt(150,250,this.mobility)}dashStaminaLoss(){return.05}rollStaminaLoss(){return.1}lungeDistance(){return gt(50,250,this.mobility)}toJSON(){return{mobility:this.mobility,damage:this.damage,defense:this.defense}}}class Pt{constructor(t){this.id=t.id,this.stats=t.stats||new Mt,this.description=t.description}clone(){return new Pt({id:this.id,stats:this.stats.clone(),description:this.description})}}class It{constructor(){this.isMetal=!0}}class At extends It{}class Ot extends It{constructor(t,e,i){super(),this.outlineColor=t,this.mainColor=e,this.texturePath=i}}class Rt extends It{constructor(t,e){super(),this.outlineColor=t,this.mainColor=e}}class _t{constructor(t){this.item=t.item,this.priceOverride=t.price,this.minLevel=t.minLevel||0,this.rewardedBreak=!!t.rewardedBreak}get price(){return void 0!==this.priceOverride?this.priceOverride:kt(this.item.stats)}}const Bt=[new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-pride",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.pride")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-trans",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.trans")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-fr",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.fr")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-es",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.es")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-us",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.us")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-pl",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.pl")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-it",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.it")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-gb",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.gb")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-ir",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.ir")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-de",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.de")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-ca",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.ca")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-be",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.be")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-mx",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.mx")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-tr",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.tr")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-pt",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.pt")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-nl",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.nl")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-se",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.se")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-ch",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.ch")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-at",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.at")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-dk",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.dk")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-ru",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.ru")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-cn",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.cn")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-jp",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.jp")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-br",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.br")})}),new _t({rewardedBreak:!0,item:new Pt({id:"pointy-shield-country-il",stats:new Mt({defense:.3,mobility:-.1}),description:new Ot(4210752,16777215,"flags.il")})})];class Lt{constructor(){this.chestColor=0,this.legsColor=0,this.armsColor=0}}class Dt{constructor(){this.color=null}}class Vt{}class Ht extends Vt{}class Ft extends Vt{}class Nt extends Vt{constructor(){super(...arguments),this.broomColor=void 0}}class Ut extends Vt{}class Wt extends Vt{}class Xt extends Vt{}class Gt extends Vt{}class zt{}class Kt extends zt{constructor(){super(...arguments),this.color=0,this.handleColor=0,this.consecutiveAttackCount=3,this.lightChargeTime=.3,this.heavyChargeTime=.3,this.isMetal=!0}}class Yt extends zt{constructor(){super(...arguments),this.color=0,this.handleColor=0,this.consecutiveAttackCount=1,this.lightChargeTime=.4,this.heavyChargeTime=.4,this.isMetal=!0}}class qt extends zt{constructor(){super(...arguments),this.color=0,this.handleColor=0,this.consecutiveAttackCount=1,this.lightChargeTime=.4,this.heavyChargeTime=.4,this.isMetal=!0}}class jt extends zt{constructor(){super(...arguments),this.color=0,this.handleColor=0,this.consecutiveAttackCount=1,this.lightChargeTime=.5,this.heavyChargeTime=.5,this.isMetal=!1}}class $t extends zt{constructor(){super(...arguments),this.color=0,this.consecutiveAttackCount=5,this.lightChargeTime=.2,this.heavyChargeTime=.2,this.isMetal=!1}}class Jt extends zt{constructor(){super(...arguments),this.consecutiveAttackCount=3,this.lightChargeTime=.2,this.heavyChargeTime=.2,this.isMetal=!1}}class Zt extends zt{constructor(){super(...arguments),this.consecutiveAttackCount=1,this.lightChargeTime=.4,this.heavyChargeTime=.8,this.isMetal=!1}}class Qt extends zt{constructor(){super(...arguments),this.tipColor=0,this.handleColor=0,this.lightChargeTime=.4,this.heavyChargeTime=.8,this.isMetal=!1}}class te{constructor(t={}){this.money=0,this.reusableStats=new Mt,this.elements={tool:null,helmet:null,armor:null,shield:null,cape:null},this.tool=t.tool,this.helmet=t.helmet,this.armor=t.armor,this.shield=t.shield,this.cape=t.cape,this.money=t.money||0}get tool(){return this.elements.tool}set tool(t){this.elements.tool=t,this.updateStats()}get armor(){return this.elements.armor}set armor(t){this.elements.armor=t,this.updateStats()}get helmet(){return this.elements.helmet}set helmet(t){this.elements.helmet=t,this.updateStats()}get shield(){return this.elements.shield}set shield(t){this.elements.shield=t,this.updateStats()}get cape(){return this.elements.cape}set cape(t){this.elements.cape=t,this.updateStats()}clone(){return new te({tool:this.tool,helmet:this.helmet,armor:this.armor,shield:this.shield,cape:this.cape,money:this.money})}itemIds(){var t,e,i,s,n;return new Set([null===(t=this.tool)||void 0===t?void 0:t.id,null===(e=this.helmet)||void 0===e?void 0:e.id,null===(i=this.armor)||void 0===i?void 0:i.id,null===(s=this.shield)||void 0===s?void 0:s.id,null===(n=this.cape)||void 0===n?void 0:n.id])}equip(t){const e=t.description;if(e instanceof zt)this.tool=t;else if(e instanceof It)this.shield=t;else if(e instanceof Lt)this.armor=t;else if(e instanceof Vt)this.helmet=t;else{if(!(e instanceof Dt))throw new Error("Unsupported item type");this.cape=t}}updateStats(){this.reusableStats.reset();for(const t of[this.tool,this.helmet,this.armor,this.shield,this.cape])t&&this.reusableStats.add(t.stats)}stats(){return this.reusableStats}}function ee(t,e){return ie((t>>16)%256*e,(t>>8)%256*e,(0|t)%256*e)}function ie(t,e,i){return(t=Math.min(t,255))<<16|(e=Math.min(e,255))<<8|Math.min(i,255)}function se(t,e){return ie((t>>16)%256+(e>>16)%256,(t>>8)%256+(e>>8)%256,(0|t)%256+(0|e)%256)}function ne(t){t.items.forEach(((e,i,s)=>{const n=i/(s.length-1);e.item.stats[t.statKey]=gt(t.worstItemValue,t.bestItemValue,n),t.updateMinLevel&&(e.minLevel=Math.floor(i/2))}))}const ae=new _t({price:0,item:new Pt({id:"naked-chest-armor",description:(()=>{const t=new Lt;return t.chestColor=15786176,t.armsColor=ee(15786176,.9),t.legsColor=6316128,t})()})}),re=new _t({item:new Pt({id:"leather-armor",description:(()=>{const t=new Lt;return t.chestColor=ee(10510416,.9),t.armsColor=15786176,t.legsColor=6316128,t})()})}),oe=new _t({price:1600,item:new Pt({id:"basic-armor",description:(()=>{const t=new Lt;return t.chestColor=12632256,t.legsColor=6316128,t.armsColor=6316128,t})()})}),he=new _t({item:new Pt({id:"dark-armor",description:(()=>{const t=new Lt;return t.chestColor=3158064,t.legsColor=4210752,t.armsColor=4210752,t})()})}),le=new _t({item:new Pt({id:"red-armor",description:(()=>{const t=new Lt;return t.chestColor=12582912,t.legsColor=8388608,t.armsColor=8388608,t})()})}),ce=new _t({item:new Pt({id:"red-king-armor",description:(()=>{const t=new Lt;return t.chestColor=12582912,t.legsColor=8388608,t.armsColor=8388608,t})()})}),de=new _t({item:new Pt({id:"blue-armor",description:(()=>{const t=new Lt;return t.chestColor=54523,t.legsColor=ee(54523,.8),t.armsColor=ee(54523,.8),t})()})}),ue=new _t({item:new Pt({id:"purple-armor",description:(()=>{const t=new Lt;return t.chestColor=11534512,t.legsColor=ee(11534512,.8),t.armsColor=ee(11534512,.8),t})()})}),pe=new _t({item:new Pt({id:"golden-armor",description:(()=>{const t=new Lt;return t.chestColor=16775993,t.legsColor=15443456,t.armsColor=15443456,t})()})}),me=(new _t({item:new Pt({id:"black-wizard-armor",description:(()=>{const t=new Lt;return t.chestColor=0,t.legsColor=2105376,t.armsColor=0,t})()})}),new _t({item:new Pt({id:"orange-wizard-armor",description:(()=>{const t=new Lt;return t.chestColor=9764864,t.legsColor=ee(9764864,.9),t.armsColor=ee(9764864,.9),t})()})})),ye=new _t({item:new Pt({id:"orange-wizard-armor",description:(()=>{const t=new Lt;return t.chestColor=3350865,t.chestColor=3483223,t.legsColor=ee(3483223,.8),t.armsColor=ee(3483223,.9),t})()})}),we=new _t({item:new Pt({id:"green-wizard-armor",description:(()=>{const t=new Lt;return t.chestColor=33832,t.chestColor=33832,t.legsColor=ee(33832,.8),t.armsColor=ee(33832,.9),t})()})});ne({items:[ae,re,oe,he,le,pe,de,ue],statKey:"defense",worstItemValue:0,bestItemValue:.3,updateMinLevel:!0}),ne({items:[he,pe,oe,le,de,ue,re,ae],statKey:"mobility",worstItemValue:-.1,bestItemValue:.3,updateMinLevel:!1});const ge=[ae,re,oe,he,le,pe,de,ue],fe=new _t({price:0,item:new Pt({id:"no-cape",description:(()=>{const t=new Dt;return t.color=null,t})()})}),ve=new _t({item:new Pt({id:"leather-cape",description:(()=>{const t=new Dt;return t.color=10510416,t})()})}),be=new _t({item:new Pt({id:"red-cape",description:(()=>{const t=new Dt;return t.color=8388608,t})()})}),Te=new _t({item:new Pt({id:"purple-cape",description:(()=>{const t=new Dt;return t.color=11534512,t})()})}),ke=new _t({item:new Pt({id:"golden-cape",description:(()=>{const t=new Dt;return t.color=16775993,t})()})}),xe=new _t({item:new Pt({id:"black-cape",description:(()=>{const t=new Dt;return t.color=1052688,t})()})}),Ce=new _t({item:new Pt({id:"green-cape",description:(()=>{const t=new Dt;return t.color=32768,t})()})}),Ee=new _t({item:new Pt({id:"blue-cape",description:(()=>{const t=new Dt;return t.color=128,t})()})}),Se=new _t({item:new Pt({id:"white-cape",description:(()=>{const t=new Dt;return t.color=13421772,t})()})}),Me=new _t({item:new Pt({id:"green-wizard-cape",description:(()=>{const t=new Dt;return t.color=ee(33832,.8),t})()})}),Pe=(new _t({item:new Pt({id:"black-wizard-cape",description:(()=>{const t=new Dt;return t.color=4210752,t})()})}),new _t({item:new Pt({id:"orange-wizard-cape",description:(()=>{const t=new Dt;return t.color=9764864,t})()})})),Ie=new _t({item:new Pt({id:"purple-wizard-cape",description:(()=>{const t=new Dt;return t.color=ee(3350865,.8),t})()})});ne({items:[fe,be,Ee,Ce,ve,Te,ke,Se,xe],statKey:"mobility",worstItemValue:-.1,bestItemValue:.1,updateMinLevel:!1});const Ae=[fe,ve,be,Ee,Ce,Te,ke,Se,xe],Oe=new _t({price:0,item:new Pt({id:"no-helmet",description:new Ht})}),Re=new _t({item:new Pt({id:"red-feathered-hat",description:(()=>{const t=new Gt;return t.mainColor=9764864,t.featherColor=4194304,t})()})}),_e=new _t({item:new Pt({id:"basic-helmet",description:(()=>{const t=new Ft;return t.mainColor=4210752,t})()})}),Be=new _t({item:new Pt({id:"basic-leather-helmet",description:(()=>{const t=new Ft;return t.mainColor=10510416,t})()})}),Le=new _t({item:new Pt({id:"basic-tee-helmet",description:(()=>{const t=new Nt;return t.mainColor=6316128,t.teeColor=0,t})()})}),De=new _t({item:new Pt({id:"basic-tee-helmet-broom",description:(()=>{const t=new Nt;return t.mainColor=6316128,t.teeColor=0,t.broomColor=0,t})()})}),Ve=new _t({item:new Pt({id:"heavy-tee-helmet",description:(()=>{const t=new Nt;return t.mainColor=4210752,t.teeColor=16711680,t})()})}),He=new _t({item:new Pt({id:"heavy-tee-helmet-broom",description:(()=>{const t=new Nt;return t.mainColor=4210752,t.teeColor=16711680,t.broomColor=16711680,t})()})}),Fe=new _t({item:new Pt({id:"basic-bucket-helmet",description:(()=>{const t=new Xt;return t.mainColor=4210752,t.slitColor=0,t})()})}),Ne=new _t({item:new Pt({id:"golden-tee-helmet",description:(()=>{const t=new Nt;return t.mainColor=16776960,t.teeColor=0,t})()})}),Ue=new _t({item:new Pt({id:"golden-tee-helmet-broom",description:(()=>{const t=new Nt;return t.mainColor=16776960,t.teeColor=0,t.broomColor=t.mainColor,t})()})}),We=new _t({item:new Pt({id:"purple-tee-helmet",description:(()=>{const t=new Nt;return t.mainColor=8388736,t.teeColor=0,t})()})}),Xe=new _t({item:new Pt({id:"red-tee-helmet",description:(()=>{const t=new Nt;return t.mainColor=12582912,t.teeColor=0,t})()})}),Ge=(new _t({item:new Pt({id:"black-witch-hat",description:(()=>{const t=new Ut;return t.mainColor=0,t})()})}),new _t({item:new Pt({id:"purple-witch-hat",description:(()=>{const t=new Ut;return t.mainColor=3350865,t})()})})),ze=new _t({item:new Pt({id:"orange-witch-hat",description:(()=>{const t=new Ut;return t.mainColor=9764864,t})()})}),Ke=new _t({item:new Pt({id:"green-witch-hat",description:(()=>{const t=new Ut;return t.mainColor=33832,t})()})}),Ye=new _t({item:new Pt({id:"golden-crown",description:(()=>{const t=new Wt;return t.mainColor=16776960,t})()})});ne({items:[Re,Oe,Be,_e,Fe,Le,Ve,Xe,De,Ne,He,Ue,We],statKey:"defense",worstItemValue:0,bestItemValue:.3,updateMinLevel:!0}),ne({items:[Fe,Ne,Ve,Le,De,We,Xe,He,Ue,_e,Be,Oe,Re],statKey:"mobility",worstItemValue:-.1,bestItemValue:.2,updateMinLevel:!1});const qe=[Oe,Re,Ve,Ne,Xe,_e,Be,We,Fe,He,Ue,De],je=new _t({price:-1,item:new Pt({id:"no-shield",description:new At})}),$e=new _t({price:0,item:new Pt({id:"wooden-shield",description:(()=>{const t=new Rt(10510416,6958883);return t.isMetal=!1,t})()})}),Je=new _t({price:1400,item:new Pt({id:"basic-pointy-shield",description:new Ot(16777215,8421504)})}),Ze=new _t({item:new Pt({id:"dark-pointy-shield",description:new Ot(6316128,4210752)})}),Qe=new _t({item:new Pt({id:"red-pointy-shield",description:new Ot(12582912,8388608)})}),ti=new _t({item:new Pt({id:"golden-pointy-shield",description:new Ot(16775993,15443456)})}),ei=new _t({item:new Pt({id:"basic-square-shield",description:new Rt(16777215,8421504)})}),ii=new _t({item:new Pt({id:"golden-square-shield",description:new Rt(16775993,15443456)})});ne({items:[$e,Je,ei,Ze,Qe,ii,ti],statKey:"defense",worstItemValue:.1,bestItemValue:.4,updateMinLevel:!0}),ne({items:[ei,Je,$e,Ze,ii,ti,Qe],statKey:"mobility",worstItemValue:-.15,bestItemValue:-.05,updateMinLevel:!1});const si=[je,$e,Je,Ze,Qe,ti,ei,ii],ni=new _t({price:-1,item:new Pt({id:"wooden-stick",description:(()=>{const t=new $t;return t.color=10510416,t})()})}),ai=new _t({price:0,item:new Pt({id:"wooden-sword",description:(()=>{const t=new Kt;return t.color=10510416,t.handleColor=10510416,t.isMetal=!1,t})()})}),ri=new _t({price:1e3,item:new Pt({id:"basic-sword",description:(()=>{const t=new Kt;return t.color=16777215,t.handleColor=4210752,t})()})}),oi=new _t({item:new Pt({id:"dark-sword",description:(()=>{const t=new Kt;return t.color=0,t.handleColor=4210752,t})()})}),hi=new _t({item:new Pt({id:"blue-sword",description:(()=>{const t=new Kt;return t.color=54523,t.handleColor=4210752,t})()})}),li=new _t({item:new Pt({id:"golden-sword",description:(()=>{const t=new Kt;return t.color=16775993,t.handleColor=15443456,t})()})}),ci=new _t({item:new Pt({id:"red-sword",description:(()=>{const t=new Kt;return t.color=12582912,t.handleColor=8388608,t})()})}),di=new _t({item:new Pt({id:"metal-axe",description:(()=>{const t=new Yt;return t.color=16777215,t.handleColor=10510416,t})()})}),ui=new _t({item:new Pt({id:"small-metal-axe",description:(()=>{const t=new qt;return t.color=16777215,t.handleColor=10510416,t})()})}),pi=new _t({item:new Pt({id:"golden-axe",description:(()=>{const t=new Yt;return t.color=16775993,t.handleColor=15443456,t})()})}),mi=new _t({item:new Pt({id:"wooden-hammer",description:(()=>{const t=new jt;return t.color=10510416,t.handleColor=10510416,t})()})}),yi=new _t({item:new Pt({id:"metal-hammer",description:(()=>{const t=new jt;return t.color=3158064,t.handleColor=10510416,t})()})}),wi=new _t({item:new Pt({id:"golden-hammer",description:(()=>{const t=new jt;return t.color=16775993,t.handleColor=15443456,t})()})}),gi=new _t({item:new Pt({id:"yellow-tip-staff",description:(()=>{const t=new Qt;return t.handleColor=10510416,t.tipColor=16776960,t})()})}),fi=new _t({item:new Pt({id:"yellow-tip-staff",description:(()=>{const t=new Qt;return t.handleColor=10510416,t.tipColor=65280,t})()})}),vi=new _t({item:new Pt({id:"purple-tip-staff",description:(()=>{const t=new Qt;return t.handleColor=10510416,t.tipColor=9485553,t})()})});ne({items:[ni,ai,mi,ui,ri,di,yi,hi,ci,li,wi,pi,oi],statKey:"damage",worstItemValue:0,bestItemValue:.4,updateMinLevel:!0}),ne({items:[wi,yi,ri,di,ui,pi,li,ai,mi,oi,ci,hi,ni],statKey:"mobility",worstItemValue:-.2,bestItemValue:0,updateMinLevel:!1});const bi=[ni,ai,ri,oi,hi,li,ci,di,pi,mi,yi,wi];class Ti{constructor(){this.itemMap=new Map}add(...t){for(const e of t)this.itemMap.set(e.item.id,e)}item(t){return this.itemMap.get(t)}items(){return this.itemMap.values()}}class ki{constructor(...t){this.tools=new Ti,this.shields=new Ti,this.armors=new Ti,this.helmets=new Ti,this.capes=new Ti,this.add(...t)}add(...t){for(const e of t){let t;e.item.description instanceof zt&&(t=this.tools),e.item.description instanceof It&&(t=this.shields),e.item.description instanceof Lt&&(t=this.armors),e.item.description instanceof Vt&&(t=this.helmets),e.item.description instanceof Dt&&(t=this.capes),t.add(e)}}*items(){yield*this.tools.items(),yield*this.shields.items(),yield*this.armors.items(),yield*this.helmets.items(),yield*this.capes.items()}}function xi(){const t=new ki;return t.add(...bi),t.add(...ge),t.add(...si),t.add(...qe),t.add(...Ae),t.add(...Bt),t}function Ci(){const t=new ki;return t.add(...bi),t.add(...ge),t.add(...si),t.add(...qe),t.add(...Ae),t}function Ei(t,e,i){const s=Array.from(t.items()).filter((t=>t.price>0)).filter((t=>t.minLevel<=i)),n=new Ti;return s.length>0&&n.add((0,wt.F5)(s)),n}function Si(){const t=new te;return t.armor=ae.item,t.tool=ai.item,t.helmet=Oe.item,t.shield=$e.item,t.cape=fe.item,t.money=1.8*ri.price,t}var Mi;!function(t){t.NONE="none",t.MENU="menu",t.GAMEPLAY="gameplay",t.INTRO="intro",t.INTRO_LOGO="intro-logo"}(Mi||(Mi={}));var Pi,Ii=i(5460),Ai=i(5505);function Oi(t){if(!t)return null;if(t.values)return Oi(t.values());if(t.next)return t.next().value||null;if(!isNaN(t.length))return t[0]||null;for(const e of t)return e;return null}class Ri{}class _i extends Ri{constructor(t){super(),this.id=t.id,this.label=t.label,this.eventLabel=t.eventLabel,this.eventCount=t.eventCount}}class Bi extends Ri{constructor(t){super(),this.id=t.id,this.label=t.label,this.isAchieved=t.isAchieved}}class Li extends Ri{constructor(t){super(),this.id=t.id,this.label=t.label,this.matcher=t.matcher,this.eventCount=void 0===t.eventCount?1:t.eventCount}}class Di{}class Vi{constructor(t){this.killerId=t}}class Hi{}class Fi{constructor(t){this.level=t}}class Ni{constructor(t,e){this.baseStats=t,this.resolve=e}}class Ui{constructor(t){this.statKey=t}}class Wi{constructor(t,e){this.attack=t,this.isPerfect=e}}class Xi{constructor(t,e){this.parrier=t,this.isPerfect=e}}class Gi{constructor(t){this.waveId=t}apply(t){}}!function(t){t.BUY="buy",t.KILL="kill"}(Pi||(Pi={}));var zi=i(7193);class Ki extends zi.X{constructor(){super(...arguments),this.key=Ki.key}}Ki.key="enemy";class Yi{constructor(){this.amount=0}}var qi=i(5148),ji=i(9945);class $i{constructor(t){this.receiver=t}}var Ji=i(1205),Zi=i(8880);class Qi extends zi.X{constructor(){super(...arguments),this.key=Qi.key,this.shakeDuration=0,this.shakePower=0,this.nextShakeUpdate=0,this.shakeOffset=new Zi.I}cycle(t){this.shakeDuration-=t,this.nextShakeUpdate-=t,this.shakeDuration>0&&this.nextShakeUpdate<0?(this.nextShakeUpdate=1/60,this.shakeOffset.x+=(0,wt.YR)(-this.shakePower,this.shakePower),this.shakeOffset.y+=(0,wt.YR)(-this.shakePower,this.shakePower)):(this.shakeOffset.x=0,this.shakeOffset.y=0),this.entity.position.x+=this.shakeOffset.x,this.entity.position.y+=this.shakeOffset.y}shake(t,e){this.shakePower=Math.max(this.shakePower,t),this.shakeDuration=Math.max(this.shakeDuration,e)}}Qi.key="shakable";class ts{constructor(){this.source=null,this.position=new Zi.I}apply(t){var e;const i=Oi(t.entities.bucket(ln.key));if(i){const s=Oi(t.entities.bucket(Ji.O.key)),{visibleRectangle:n}=s.traitOfType(Ji.O),a=(0,ft.cK)(0,0,n.width,n.height)/4,r=gt(10,0,(0,ft.Io)(i.position,this.position)/a);null===(e=s.traitOfType(Qi))||void 0===e||e.shake(r,.5)}}}class es{}var is,ss,ns=i(5378),as=i(2711);class rs{constructor(t=""){this.reason=t,this.key=rs.key}apply(t){}static registryEntry(){return(0,ns.a)((t=>{t.eventClass(rs),t.simpleProp("reason",as.Ut.str())}))}}rs.key="level-complete";class os{constructor(t=""){this.reason=t,this.key=os.key}apply(t){}static registryEntry(){return(0,ns.a)((t=>{t.eventClass(os),t.simpleProp("reason",as.Ut.str())}))}}os.key="level-failed",function(t){t[t.FAILED=0]="FAILED",t[t.COMPLETED=1]="COMPLETED"}(is||(is={}));class hs{constructor(t){this.outcome=t}apply(t){}}function ls(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}class cs{constructor(){this.tokens=new Map,this.totalAggression=0,this.nextTokenId=1,this.age=0,this.aggressionsStartAge=0,this.maxAggression=4}getToken(t){const e=this.nextTokenId++;return this.tokens.set(e,{aggression:t,token:e,aggressive:!1}),e}isAggressive(t){const e=this.tokens.get(t);return!0===(null==e?void 0:e.aggressive)}requestAggression(t){if(this.age<this.aggressionsStartAge)return!1;const e=this.tokens.get(t);return!!e.aggressive||!(this.totalAggression+e.aggression>this.maxAggression)&&(e.aggressive=!0,this.totalAggression+=e.aggression,!0)}releaseAggression(t){const e=this.tokens.get(t);e.aggressive&&(e.aggressive=!1,this.totalAggression-=e.aggression)}releaseToken(t){this.releaseAggression(t),this.tokens.delete(t)}preventAggressions(t){this.aggressionsStartAge=this.age+t}cycle(t){this.age+=t}}class ds extends zi.X{constructor(){super(...arguments),this.key=ds.key,this.disableChunking=!0,this.tracker=new cs}cycle(t){this.tracker.cycle(t)}}ds.key="aggression-tracker";class us extends zi.X{constructor(t){super(),this.shouldRevive=t,this.key=us.key}}us.key="revive-resolver";class ps{constructor(t,e,i,s){this.damager=t,this.amount=e,this.color=i,this.type=s}}class ms{constructor(t){this.victimId=t}}class ys{}!function(t){t[t.HIT=0]="HIT",t[t.SLASH=1]="SLASH",t[t.FIRE=2]="FIRE"}(ss||(ss={}));class ws extends zi.X{constructor(){super(...arguments),this.key=ws.key,this.health=1,this.maxHealth=1,this.lastDamaged=-99,this.lastHealed=-99,this.reusableDamageEvent=new ps(null,0,16777215,ss.HIT),this.reusableHealEvent=new ys}get healthRatio(){return this.health/this.maxHealth}heal(t,e){this.health=Math.min(this.maxHealth,this.health+e),this.lastHealed=this.entity.age,this.entity.addEvent(this.reusableHealEvent)}damage(t,e,i,s){this.health=Math.max(0,this.health-e),this.lastDamaged=this.entity.age,this.reusableDamageEvent.damager=t,this.reusableDamageEvent.amount=e,this.reusableDamageEvent.color=i,this.reusableDamageEvent.type=s,this.entity.addEvent(this.reusableDamageEvent),this.health<=0&&(this.entity.addEvent(new Vi(t.id)),t.addEvent(new ms(this.entity.id)))}recentlyDamaged(t){return this.entity.age-this.lastDamaged<t}recentlyHealed(t){return this.entity.age-this.lastHealed<t}processEvent(t,e){t instanceof Vi&&this.entity.remove()}}ws.key="health";var gs=i(1086);class fs extends zi.X{constructor(t=Mi.GAMEPLAY,e=!0){super(),this.soundtrackType=t,this.enableSoundEffects=e,this.key=fs.key}static registryEntry(){return(0,gs.W)((t=>{t.traitClass(fs),t.category("sound"),t.simpleProp("enableSoundEffects",as.Ut.bool()),t.simpleProp("soundtrackType",as.Ut.enum(Object.values(Mi)))}))}}fs.key="sound-settings";class vs extends zi.X{constructor(){super(...arguments),this.key=vs.key,this.baseZoom=1.5,this.zoomEndAge=null}postBind(){super.postBind(),this.cameraTrait=this.dependency(Ji.O.key)}cycle(t){null!==this.zoomEndAge&&this.entity.age>this.zoomEndAge&&(this.zoomEndAge=null,this.cameraTrait.zoomTo(this.baseZoom,.3))}setZoom(t,e){this.cameraTrait.zoomTo(t*this.baseZoom,.3),this.zoomEndAge=this.entity.age+e}}vs.key="temporary-zoom";class bs extends zi.X{constructor(){super(...arguments),this.key=bs.key}}bs.key="announcement";class Ts extends zi.X{constructor(){super(...arguments),this.key=Ts.key,this.resolved=!1,this.failed=!1}}Ts.key="instruction";class ks extends zi.X{constructor(t){super(),this.radius=t,this.key=ks.key}}ks.key="melee-victim";class xs extends zi.X{constructor(t){super(),this.team=t,this.key=xs.key}}xs.key="team-member";class Cs{}const Es=new Cs;class Ss extends zi.X{constructor(t,e,i,s,n=!1){super(),this.ownerId=t,this.ownerTeam=e,this.attack=i,this.speed=s,this.hitSameTeam=n,this.key=Ss.key,this.radius=10,this.readjustedHitPoint=new Zi.I}cycle(t){var e;this.entity.position.x+=Math.cos(this.entity.angle)*this.speed*t,this.entity.position.y+=Math.sin(this.entity.angle)*this.speed*t;const i=this.world.entity(this.ownerId);if(i)for(const t of this.world.traitsOfType(ks)){if(!t.enabled)continue;if(t.entity.id===this.ownerId)continue;if(this.readjustedHitPoint.x=t.entity.position.x,this.readjustedHitPoint.y=t.entity.position.y-30,Math.min((0,ft.Io)(t.entity.position,this.entity.position),(0,ft.Io)(this.readjustedHitPoint,this.entity.position))>t.radius+this.radius)continue;const s=(null===(e=t.entity.traitOfType(xs))||void 0===e?void 0:e.team)===this.ownerTeam;s&&!this.hitSameTeam||!s&&this.hitSameTeam||(Es.owner=i,Es.victim=t.entity,this.entity.addEvent(Es))}}processEvent(t,e){t instanceof Cs&&this.entity.remove()}}Ss.key="projectile";class Ms extends zi.X{constructor(){super(...arguments),this.key=Ms.key,this.currentTimeFactor=1,this.timeFactorEndAge=0,this.playerFactor=1}timeFactor(t){if(!t)return 1;if(this.entity.age>this.timeFactorEndAge)return 1;if(t===this.entity)return 1;if(t.traitOfType(ln))return this.playerFactor;if(t.traitOfType(Ss)){const e=this.world.entity(t.traitOfType(Ss).ownerId);if(null==e?void 0:e.traitOfType(ln))return this.playerFactor}return t.traitOfType(Ji.O)||t.traitOfType(bs)||t.traitOfType(Ts)?1:this.currentTimeFactor}setTimeFactor(t,e,i){this.currentTimeFactor=t,this.timeFactorEndAge=this.entity.age+i,this.playerFactor=e}}Ms.key="time-factor";var Ps,Is,As,Os=i(4862);!function(t){t.MOVEMENT="movement",t.ATTACK="attack",t.ATTACK_CHARGED="attack-charged",t.DASH="dash",t.DOUBLE_DASH="double-dash",t.SHIELD="shield"}(Ps||(Ps={})),function(t){t.INDEPENDENT="independent",t.MOVEMENT_BASED="movement-based"}(Is||(Is={})),function(t){t.INDEPENDENT="independent",t.DOUBLE_MOVEMENT_TAP="double-movement-tap"}(As||(As={}));class Rs extends zi.X{constructor(){super(...arguments),this.key=Rs.key,this.aimMode=Is.INDEPENDENT,this.dashMode=As.INDEPENDENT,this.enabledInputs={movement:{force:0,angle:0},aim:new Zi.I,mouse:new Zi.I,dash:!1,shield:!1,heavyStrike:!1,lightStrike:!1,interact:!1},this.lastMovementForce=0,this.movementForceTime=0,this.highlight=null}get inputs(){return this.enabled||(this.enabledInputs.movement.force=0),this.enabledInputs}cycle(t){this.inputs.movement.force&&(this.lastMovementForce=this.entity.age,this.highlight===Ps.MOVEMENT&&(this.highlight=null)),this.dashMode===As.DOUBLE_MOVEMENT_TAP&&(this.inputs.movement.force?(this.lastMovementTap&&0===this.movementForceTime&&this.entity.age-this.lastMovementTap.age<.1&&(this.inputs.dash=!0),this.movementForceTime+=t):(this.movementForceTime>0&&(this.movementForceTime<=.1?this.lastMovementTap={age:this.entity.age,angle:this.inputs.movement.angle}:this.lastMovementTap=null),this.movementForceTime=0)),this.aimMode===Is.MOVEMENT_BASED&&(this.inputs.aim.x=this.entity.position.x+100*Math.cos(this.inputs.movement.angle),this.inputs.aim.y=this.entity.position.y+100*Math.sin(this.inputs.movement.angle)),!this.highlight&&this.entity.age-this.lastMovementForce>3&&(this.highlight=Ps.MOVEMENT)}static registryEntry(){return{traitType:Rs,properties:[(0,Os.f2)(Rs,"movementAngle",as.Ut.num(),(t=>t.inputs.movement.angle),((t,e)=>t.inputs.movement.angle=e)),(0,Os.f2)(Rs,"movementForce",as.Ut.num(),(t=>t.inputs.movement.force),((t,e)=>t.inputs.movement.force=e))]}}}Rs.key="controllable";var _s,Bs,Ls,Ds,Vs=i(7842),Hs=i(5169);class Fs extends zi.X{constructor(){super(...arguments),this.key=Fs.key,this.isMud=!1,this.surfaceProvider=Fs.surfaceProvider}contains(t){const e=t.x-this.entity.position.x,i=t.y-this.entity.position.y,s=e*Math.cos(this.entity.angle)+i*Math.sin(this.entity.angle),n=-e*Math.sin(this.entity.angle)+i*Math.cos(this.entity.angle);return Math.abs(s)<this.width/2&&Math.abs(n)<this.height/2}}Fs.key="pond",Fs.surfaceProvider=(0,Hs.z)(((t,e)=>{const i=Math.cos(t.entity.angle)*t.width/2+Math.cos(t.entity.angle+Math.PI/2)*t.height/2,s=Math.sin(t.entity.angle)*t.width/2+Math.sin(t.entity.angle+Math.PI/2)*t.height/2,n=Math.cos(t.entity.angle)*t.width/2+Math.cos(t.entity.angle-Math.PI/2)*t.height/2,a=Math.sin(t.entity.angle)*t.width/2+Math.sin(t.entity.angle-Math.PI/2)*t.height/2,r=Math.max(Math.abs(i),Math.abs(n)),o=Math.max(Math.abs(s),Math.abs(a));e.centerAround(t.entity.x,t.entity.y,2*r,2*o)}));class Ns extends zi.X{constructor(){super(...arguments),this.key=Ns.key,this.offset=2e3*Math.random()}seaY(t){return 100*Math.sin((t+this.offset)*Math.PI*2/2e3)+50*Math.sin((t+this.offset)*Math.PI*2/1e3)+this.entity.position.y}contains(t){return t.y>this.seaY(t.x)}}Ns.key="sea";class Us extends zi.X{constructor(){super(...arguments),this.key=Us.key,this.lastCheckPosition=new Zi.I,this.seaCache=new Vs.w(100,(()=>this.entity.age),(()=>{if(!this.entity.world)return null;for(const t of this.entity.world.traitsOfType(Ns))if(t.contains(this.entity.position))return t;return null})).earlyExpireIf((t=>t&&(!t.world||!t.contains(this.entity.position)))).keepCachedValueIf((t=>null==t?void 0:t.contains(this.entity.position))),this.pondCache=new Vs.w(100,(()=>this.entity.age),(()=>{if(!this.entity.world)return null;for(const t of this.entity.world.traitsOfType(Fs))if(t.contains(this.entity.position))return t;return null})).earlyExpireIf((t=>t&&(!t.world||!t.contains(this.entity.position)))).keepCachedValueIf((t=>null==t?void 0:t.contains(this.entity.position)))}get inWater(){this.entity.position.x===this.lastCheckPosition.x&&this.entity.position.y===this.lastCheckPosition.y||(this.pondCache.reset(),this.seaCache.reset(),this.lastCheckPosition.x=this.entity.position.x,this.lastCheckPosition.y=this.entity.position.y);const t=this.pondCache.get(),e=this.seaCache.get();return!!t||!!e}}Us.key="water-affected";class Ws extends zi.X{constructor(){super(...arguments),this.key=Ws.key,this.speed=250,this.speedRatio=1,this.walking=!1,this.facing=1}get effectiveSpeed(){return this.enabled?this.speed*this.speedRatio:0}postBind(){super.postBind(),this.controllableTrait=this.dependency(Rs.key),this.waterAffectedTrait=this.dependency(Us.key)}cycle(t){const{inputs:e}=this.controllableTrait;if(this.walking=e.movement.force>0,!this.walking)return;const i=this.waterAffectedTrait.inWater?.5:1,s=this.speed*this.speedRatio*i;this.entity.position.x+=Math.cos(e.movement.angle)*t*s,this.entity.position.y+=Math.sin(e.movement.angle)*t*s}}Ws.key="walker";class Xs extends zi.X{constructor(){super(...arguments),this.key=Xs.key,this.experience=0}get levelRatio(){return this.experience%1}get level(){return Math.floor(this.experience)+1}gain(t,e){if(!this.enabled)return;const{level:i}=this;this.experience+=t,this.level>i&&this.entity.addEvent(new Fi(this.level))}}Xs.key="experience-holder";class Gs{constructor(t,e){this.attack=t,this.attacker=e}}class zs{}class Ks{}class Ys extends zi.X{constructor(){super(...arguments),this.key=Ys.key,this.stamina=1,this.exhausted=!1,this.recoveryDelay=1,this.lastLoss=-99,this.lastChange=-99,this.reusableExhaustedEvent=new Ks}loseStamina(t){this.exhausted||t<=0||(this.stamina=Math.max(0,this.stamina-t),this.lastLoss=this.lastChange=this.entity.age,this.stamina<=0&&(this.exhausted=!0,this.entity.addEvent(this.reusableExhaustedEvent)))}gainStamina(t){this.stamina>=1||(this.stamina=Math.min(1,this.stamina+t),this.lastChange=this.entity.age,this.exhausted&&this.stamina>=1&&(this.exhausted=!1))}recentlyChanged(t){return this.entity.age-this.lastChange<t}cycle(t){this.entity.age-this.lastLoss>this.recoveryDelay&&this.gainStamina(.4*t)}processEvent(t,e){t instanceof Wi?t.isPerfect&&(this.stamina=1):t instanceof es&&(this.stamina=1)}}Ys.key="stamina";class qs extends zi.X{constructor(){super(...arguments),this.key=qs.key,this.pushes=[]}cancelAllPushes(){this.pushes.splice(0,this.pushes.length)}isPushing(t){return t&&t.end>this.entity.age}push(t,e,i){const s={angle:t,speed:e/i,end:this.entity.age+i};return this.pushes.push(s),s}cycle(t){let e=0;for(;e<this.pushes.length;){const i=this.pushes[e];this.entity.age>i.end?this.pushes.splice(e,1):(this.entity.position.x+=Math.cos(i.angle)*t*i.speed,this.entity.position.y+=Math.sin(i.angle)*t*i.speed,e++)}}}qs.key="pushable";class js extends zi.X{constructor(){super(...arguments),this.key=js.key,this.isHoldingShield=!1,this.blockCount=0}postBind(){super.postBind(),this.pushableTrait=this.entity.traitOfType(qs),this.characterTrait=this.entity.traitOfType(hn),this.staminaTrait=this.entity.traitOfType(Ys)}processEvent(t,e){var i,s;if(t instanceof Gs){const e=ls(t.attacker,this.entity);null===(i=this.pushableTrait)||void 0===i||i.push(e,10,.05),null===(s=this.staminaTrait)||void 0===s||s.loseStamina(this.characterTrait.stats.shieldBlockStaminaLoss(t.attack)),this.blockCount++}}}js.key="shieldable";class $s extends zi.X{constructor(){super(...arguments),this.key=$s.key,this.lastParrier=-999,this.shieldTime=0}postBind(){super.postBind(),this.shieldableTrait=this.dependency(js.key),this.healthTrait=this.dependency(ws.key)}cycle(t){this.shieldableTrait.isHoldingShield?this.shieldTime+=t:this.shieldTime=0}get canParry(){return this.shieldTime>0&&this.shieldTime<.2&&!this.healthTrait.recentlyDamaged(.2)}get canPerfectParry(){return this.canParry&&this.shieldTime<.1}recentlyBlockedPerfectly(t){return this.entity.age-this.lastParrier<t}processEvent(t,e){if(t instanceof Wi&&(this.lastParrier=this.entity.age,t.isPerfect)){for(const t of e.entities.bucket(qs.key))t!==this.entity&&(0,ft.Io)(this.entity,t)<200&&t.traitOfType(qs).push(ls(this.entity,t),100,.1);Oi(e.traitsOfType(vs)).setZoom(1.5,3),Oi(e.traitsOfType(Ms)).setTimeFactor(.1,.8,3)}}}$s.key="parrier";class Js{constructor(t,e){this.attacker=t,this.attack=e}}class Zs{constructor(t){this.attacker=t}}class Qs extends zi.X{constructor(){super(...arguments),this.key=Qs.key,this.constitution=1,this.recoveryDelay=8,this.staggerRecoveryDelay=1,this.staggerRecoveryDuration=.5,this.staggered=!1,this.lastLoss=-99,this.lastChange=-99}postBind(){super.postBind(),this.characterTrait=this.entity.traitOfType(hn)}get staggeredAge(){return this.staggered?this.entity.age-this.lastLoss:0}get recoveryProgress(){return this.constitution}stagger(t){this.constitution=0,this.staggered=!0,this.lastLoss=this.lastChange=this.entity.age,this.entity.addEvent(new Zs(t))}loseConstitution(t,e){var i;if(this.staggered)return;const s=null===(i=null==e?void 0:e.traitOfType(hn))||void 0===i?void 0:i.stats,n=s?this.characterTrait.stats.receivedAttackConstitutionLoss(t,s):0;this.constitution=Math.max(0,this.constitution-n),this.lastLoss=this.lastChange=this.entity.age,this.constitution<=0&&this.stagger(e)}gainConstitution(t){this.constitution>=1||(this.constitution=Math.min(1,this.constitution+t),this.lastChange=this.entity.age)}recentlyChanged(t){return this.entity.age-this.lastChange<t}cycle(t){(this.staggered&&this.entity.age-this.lastLoss>this.staggerRecoveryDelay||this.entity.age-this.lastLoss>this.recoveryDelay)&&this.gainConstitution(t/this.staggerRecoveryDuration),this.constitution>=1&&(this.staggered=!1)}processEvent(t,e){t instanceof Js||t instanceof Gs?this.loseConstitution(t.attack,t.attacker):t instanceof es&&this.gainConstitution(1)}}Qs.key="staggerable",(Ds=_s||(_s={}))[Ds.HOLD=0]="HOLD",Ds[Ds.EXCLUSIVE=1]="EXCLUSIVE",function(t){t[t.MISSED=0]="MISSED",t[t.STRUCK=1]="STRUCK",t[t.PARRIED=2]="PARRIED",t[t.BLOCKED=3]="BLOCKED"}(Bs||(Bs={})),function(t){t[t.NONE=0]="NONE",t[t.HEAVY=1]="HEAVY",t[t.LIGHT=2]="LIGHT"}(Ls||(Ls={}));class tn extends zi.X{constructor(){super(...arguments),this.key=tn.key,this.lastFailedAttack=-99,this.fov=Math.PI/2,this.magnetRadius=250,this.strikeRadiusX=80,this.strikeRadiusY=40,this.preparingAttack=Ls.NONE,this.preparationRatio=0,this.heavyStrikeMode=_s.EXCLUSIVE,this.aimAngle=0,this.strikeCount=0,this.strikeSuccessCount=0,this.heavyStrikeCount=0,this.heavyStrikeSuccessCount=0,this.lungeVictimsCache=new Vs.w(.2,(()=>this.entity.age),(()=>this.pickVictims(this.magnetRadius,this.magnetRadius,this.fov).sort(((t,e)=>{const i=this.strikability(t,this.magnetRadius,this.magnetRadius,this.fov);return this.strikability(e,this.magnetRadius,this.magnetRadius,this.fov)-i}))))}get lightStrikeChargeTime(){var t,e;return(null===(e=null===(t=this.inventoryTrait.inventory.tool)||void 0===t?void 0:t.description)||void 0===e?void 0:e.lightChargeTime)||.3}get heavyStrikeChargeTime(){var t,e;return this.heavyStrikeMode===_s.HOLD?.5:(null===(e=null===(t=this.inventoryTrait.inventory.tool)||void 0===t?void 0:t.description)||void 0===e?void 0:e.heavyChargeTime)||.3}postBind(){super.postBind(),this.pushableTrait=this.dependency(qs.key),this.staminaTrait=this.entity.traitOfType(Ys),this.teamMemberTrait=this.dependency(xs.key),this.characterTrait=this.dependency(hn.key),this.inventoryTrait=this.dependency(mn.key)}strikability(t,e,i,s){var n;if(t===this.entity||!e||!i)return 0;if((null===(n=t.traitOfType(xs))||void 0===n?void 0:n.team)===this.teamMemberTrait.team)return 0;if(!t.traitOfType(ks).enabled)return 0;const a=ls(this.entity,t),r=this.aimAngle,o=1-Math.abs((0,ft.n0)(a-r))/(s/2),h=Math.abs(this.entity.position.x-t.position.x),l=Math.abs(this.entity.position.y-t.position.y)/(i/e),c=1-Math.hypot(h,l)/e;return c<0||o<0?0:c+Math.pow(o,3)}pickVictims(t,e,i){return Array.from(this.world.entities.bucket(ks.key)).filter((s=>this.strikability(s,t,e,i)>0))}get lungeVictim(){return this.lungeVictimsCache.value[0]}pickVictim(t,e,i){return this.pickVictims(t,e,i).reduce(((s,n)=>s?this.strikability(n,t,t,i)>this.strikability(s,t,e,i)?n:s:n),null)}strike(t){var e,i,s,n,a,r,o,h,l;const{stats:c}=this.characterTrait;null===(e=this.staminaTrait)||void 0===e||e.loseStamina(c.strikeStaminaLoss(t));let d=!1,u=!1,p=!1;this.strikeCount++,t.charged&&this.heavyStrikeCount++;for(const e of this.pickVictims(this.strikeRadiusX,this.strikeRadiusY,2*Math.PI)){const c=ls(this.entity,e),m=e.traitOfType($s);if(null==m?void 0:m.canParry){const{canPerfectParry:n}=m;e.addEvent(new Wi(t,n)),this.entity.addEvent(new Xi(e,n)),n?null===(i=this.staminaTrait)||void 0===i||i.loseStamina(this.staminaTrait.stamina):(this.pushableTrait.push(c+Math.PI,40,.05),null===(s=this.staminaTrait)||void 0===s||s.loseStamina(.5)),d=!0}else if(null===(n=e.traitOfType(js))||void 0===n?void 0:n.isHoldingShield)this.pushableTrait.push(c+Math.PI,40,.05),e.addEvent(new Gs(t,this.entity)),p=!0;else{const i=(null===(a=e.traitOfType(Ys))||void 0===a?void 0:a.stamina)<=0,s=null===(r=e.traitOfType(Qs))||void 0===r?void 0:r.staggered,n=this.characterTrait.stats.appliedDamage(t,i||s);e.traitOfType(ws).damage(this.entity,n,Et(t.comboCount)>1?16744448:16777215,(null===(h=null===(o=this.inventoryTrait.inventory.tool)||void 0===o?void 0:o.description)||void 0===h?void 0:h.isMetal)?ss.SLASH:ss.HIT),null===(l=e.traitOfType(qs))||void 0===l||l.push(c,t.charged?60:30,t.charged?.1:.05),this.entity.addEvent(new zs),e.addEvent(new Js(this.entity,t)),u=!0}}return(d||p)&&(this.lastFailedAttack=this.entity.age),p?Bs.BLOCKED:d?Bs.PARRIED:u?(this.strikeSuccessCount++,t.charged&&this.heavyStrikeSuccessCount++,Bs.STRUCK):Bs.MISSED}recentlyParriedOrBlocked(t){return this.entity.age-this.lastFailedAttack<t}}tn.key="melee-attacker";var en=i(8705);class sn{constructor(t){this.heavy=t}}class nn{constructor(t){this.attack=t}}function an(t,e,i){var s,n,a;const{victim:r}=e,o=null===(s=r.traitOfType($s))||void 0===s?void 0:s.canParry,h=null===(n=r.traitOfType($s))||void 0===n?void 0:n.canPerfectParry;if(!o)return!1;const l=t.traitOfType(Ss);let c={x:t.position.x+200*Math.cos(t.angle+Math.PI),y:t.position.y+200*Math.sin(t.angle+Math.PI)};const d=h?0:Math.PI/5;r.addEvent(new Wi(l.attack,h)),t.addEvent(new Xi(r,h));const u=i.entity(l.ownerId),p=[];for(const t of i.entities.bucket(xs.key)){if(t===u)continue;if(t.traitOfType(xs).team!==l.ownerTeam)continue;if((0,ft.Io)(t.position,t.position)>500)continue;const e=(0,ft.n0)(t.angle+Math.PI),i=ls(t.position,t.position);Math.abs((0,ft.n0)(i-e))>Math.PI/2||p.push(t)}return p.length&&(c=(0,wt.F5)(p.filter((t=>!!t))).position),l.ownerId=r.id,l.ownerTeam=null===(a=r.traitOfType(xs))||void 0===a?void 0:a.team,t.angle=ls(t.position,c)+(0,wt.YR)(-d,d),i.entities.add(t),!0}class rn extends zi.X{constructor(t){super(),this.description=t,this.key=rn.key}postBind(){super.postBind(),this.projectileTrait=this.dependency(Ss.key)}processEvent(t,e){var i,s,n,a;if(t instanceof Cs){const{victim:r,owner:o}=t,h=null==o?void 0:o.traitOfType(hn),l=ls(o,r);if(an(this.entity,t,e))return;if(null===(i=r.traitOfType(js))||void 0===i?void 0:i.isHoldingShield)r.addEvent(new Gs(this.projectileTrait.attack,this.entity));else{const t=(null===(s=r.traitOfType(Ys))||void 0===s?void 0:s.stamina)<=0,e=null===(n=r.traitOfType(Qs))||void 0===n?void 0:n.staggered,i=h.stats.appliedDamage(this.projectileTrait.attack,t||e);r.traitOfType(ws).damage(this.entity,i,Et(this.projectileTrait.attack.comboCount)>1?16744448:16777215,ss.HIT),null===(a=r.traitOfType(qs))||void 0===a||a.push(l,this.projectileTrait.attack.charged?60:30,this.projectileTrait.attack.charged?.1:.05),r.addEvent(new Js(o,this.projectileTrait.attack))}}}}rn.key="tool-projectile-trait";class on extends zi.X{constructor(){super(...arguments),this.key=on.key}postBind(){super.postBind(),this.inventoryTrait=this.dependency(mn.key),this.meleeAttackerTrait=this.dependency(tn.key),this.teamMemberTrait=this.dependency(xs.key)}processEvent(t,e){var i;if(t instanceof nn){const e=this.meleeAttackerTrait.aimAngle,s=new qi.wC(void 0,[new en.K(3),new Ss(this.entity.id,null===(i=this.teamMemberTrait)||void 0===i?void 0:i.team,t.attack,t.attack.charged?600:400),new rn(this.inventoryTrait.inventory.tool.description)]);s.position.x=this.entity.position.x+20*Math.cos(e),s.position.y=this.entity.position.y+20*Math.sin(e),s.angle=e,this.entity.world.entities.add(s)}}}on.key="tool-thrower";class hn extends zi.X{constructor(){super(...arguments),this.key=hn.key,this.baseStats=new Mt,this.reusableStats=new Mt}postBind(){super.postBind(),this.inventoryTrait=this.entity.traitOfType(mn),this.walkerTrait=this.entity.traitOfType(Ws),this.healthTrait=this.entity.traitOfType(ws),this.experienceHolderTrait=this.entity.traitOfType(Xs),this.meleeAttackerTrait=this.entity.traitOfType(tn),this.toolThrowerTrait=this.entity.traitOfType(on)}updateStats(){return this.reusableStats.reset(),this.reusableStats.add(this.baseStats),this.inventoryTrait&&this.reusableStats.add(this.inventoryTrait.inventory.stats()),this.reusableStats}get stats(){return this.updateStats(),this.reusableStats}cycle(t){const{stats:e}=this;if(this.walkerTrait&&(this.walkerTrait.speed=e.walkingSpeed()),this.healthTrait){const t=e.maxHealth();t!==this.healthTrait.maxHealth&&(this.healthTrait.health=t,this.healthTrait.maxHealth=t)}this.meleeAttackerTrait&&(this.meleeAttackerTrait.magnetRadius=this.toolThrowerTrait?0:e.lungeDistance())}processEvent(t,e){if(t instanceof Vi){if(!this.experienceHolderTrait)return;const t=Oi(e.entities.bucket(ln.key)),i=null==t?void 0:t.traitOfType(Xs);if(i){const t=xt(this.experienceHolderTrait.level,i.level);i.gain(t,"Slain enemy")}}}}hn.key="character";class ln extends zi.X{constructor(){super(...arguments),this.key=ln.key,this.canInteract=!1}processEvent(t,e){if(t instanceof Vi){Oi(e.traitsOfType(Ms)).setTimeFactor(.2,.2,3);const t=Oi(e.traitsOfType(fs)),{soundtrackType:i}=t;t.soundtrackType=Mi.NONE,(async()=>{const s=Oi(e.traitsOfType(us));let n=!1;if(s&&(n=await s.shouldRevive()),n){t.soundtrackType=i;const s=this.entity.traitOfType(ws);s.health=s.maxHealth,e.entities.add(this.entity),this.entity.addEvent(new es)}else e.addEvent(new os("u ded"))})()}else if(t instanceof Fi){const{world:t}=this.entity,e=1e-6;Oi(t.traitsOfType(vs)).setZoom(1.5,3),Oi(t.traitsOfType(Ms)).setTimeFactor(e,.1,3),t.entities.add(new qi.wC(void 0,[new ji.H(2*e,(()=>{const e=this.entity.traitOfType(hn).baseStats.clone(),i=new Ni(e,(e=>{this.entity.traitOfType(hn).baseStats.add(e);const i=new ts;i.position.x=this.entity.position.x,i.position.y=this.entity.position.y,t.addEvent(i);let s=0;for(const i of St)e[i]<=0||(t.entities.add((0,qi.EG)([new ji.H(s,(()=>{this.entity.addEvent(new Ui(i))}))])),s+=1)}));this.entity.addEvent(i)}))]))}else if(t instanceof es){const t=new ts;t.position.x=this.entity.position.x,t.position.y=this.entity.position.y,e.addEvent(t);for(const t of e.traitsOfType(qs)){if((0,ft.Io)(this.entity.position,t.entity.position)>200)continue;const e=ls(this.entity.position,t.entity.position);t.push(e,200,.2)}Oi(e.traitsOfType(ds)).tracker.preventAggressions(2)}}}ln.key="player";class cn extends zi.X{constructor(){super(...arguments),this.key=cn.type}cycle(t){if(!(this.entity.age<.5))for(const t of this.world.entities.bucket(ln.key))if((0,ft.Io)(t.position,this.entity.position)<100){this.entity.addEvent(new $i(t)),this.entity.remove();break}}}cn.type="item";class dn extends zi.X{constructor(t){super(),this.amount=t,this.key=dn.key,this.delay=(0,wt.YR)(.5,1.5)}processEvent(t,e){t instanceof $i&&e.entities.add(new qi.wC(void 0,[new ji.H(this.delay,(()=>{t.receiver.traitOfType(mn).receiveMoney(this.amount)}))]))}}function un(t,e,i){let s=i;for(;s>0;){const i=bt.filter((t=>t<=s)),n=i.length?(0,wt.F5)(i):bt[0];s-=n;const a=new qi.wC(void 0,[new cn,new dn(n)]),r=Math.random()*Math.PI*2,o=35*Math.random();a.position.x=e.x+Math.cos(r)*o,a.position.y=e.y+Math.sin(r)*o,t.entities.add(a)}}dn.key="coin-item";const pn=new Yi;class mn extends zi.X{constructor(){super(...arguments),this.key=mn.key,this.inventory=new te,this.lastMoneyReceived=0,this.dropMoneyWhenDying=!0}receiveMoney(t){this.inventory.money+=t,this.lastMoneyReceived=this.entity.age,pn.amount=t,this.entity.addEvent(pn)}processEvent(t,e){if(t instanceof Vi){if(!this.dropMoneyWhenDying)return;un(e,this.entity.position,this.inventory.money)}}}mn.key="inventory";class yn extends zi.X{constructor(){super(...arguments),this.key=yn.key}}yn.key="king";class wn extends zi.X{constructor(){super(...arguments),this.key=wn.key}}wn.key="wizard";class gn{}class fn extends zi.X{constructor(){super(...arguments),this.key=fn.key,this.combo=0,this.lastComboIncrease=0,this.lastComboReset=0,this.reusableComboResetEvent=new gn}cycle(t){this.entity.age-this.lastComboIncrease>3&&this.resetCombo()}increaseCombo(){this.combo++,this.lastComboIncrease=this.entity.age}resetCombo(){this.combo<=0||(this.combo=0,this.lastComboReset=this.entity.age,this.entity.addEvent(this.reusableComboResetEvent))}processEvent(t,e){t instanceof zs||t instanceof Gs?this.increaseCombo():t instanceof ps?this.resetCombo():t instanceof Wi&&this.increaseCombo()}}function vn(t,e){return t instanceof Ii.y&&t.event instanceof e?t.event:null}function bn(t){return Oi(t.entities.bucket(ln.key))}fn.key="combo-tracker";class Tn{constructor(t){this.gameId=t,this.PokiSDK=window.PokiSDK,this.gameplayStarted=!1,this.isPoki&&setInterval((()=>{navigator.sendBeacon("https://leveldata.poki.io/data",this.gameId)}),3e4)}get isPoki(){return!!this.PokiSDK}playtestSetCanvas(t){this.isPoki&&(console.log("playtestSetCanvas"),this.PokiSDK.playtestSetCanvas&&this.PokiSDK.playtestSetCanvas(t))}initialize(){return this.isPoki?(console.log("initialize"),this.PokiSDK.init()):Promise.resolve()}gameLoadingFinished(){if(this.isPoki)return console.log("gameLoadingFinished"),this.PokiSDK.gameLoadingFinished()}gameplayStart(){if(this.isPoki&&!this.gameplayStarted)return this.gameplayStarted=!0,console.log("gameplayStart"),this.PokiSDK.gameplayStart()}gameplayStop(){if(this.isPoki&&this.gameplayStarted)return this.gameplayStarted=!1,console.log("gameplayStop"),this.PokiSDK.gameplayStop()}commercialBreak(t){return this.isPoki?(console.log("commercialBreak"),this.PokiSDK.commercialBreak((()=>{console.log("onCommercialBreakStart"),t()}))):Promise.resolve()}rewardedBreak(t){return this.isPoki?this.PokiSDK.rewardedBreak(t):Promise.resolve(!0)}shareableURL(t={}){if(!this.isPoki){const e=[];for(const[i,s]of Object.entries(t))e.push(`${i}=${encodeURIComponent(s)}`);const i=e.length?"?"+e.join("&"):"";return Promise.resolve(location.protocol+"//"+location.host+location.pathname+i)}return this.PokiSDK.shareableURL(t)}async setUserData(t){const e=await fetch(`https://auds.poki.io/v0/${this.gameId}/userdata/${t.bucket}`,{method:"POST",body:JSON.stringify({data:t.data,values:t.values})});if(!e.ok)throw new Error(`setUserData failed with status code ${e.status}`);return this.parse(await e.text())}async updateUserData(t){const e=await fetch(`https://auds.poki.io/v0/${this.gameId}/userdata/${t.bucket}/${t.id}`,{method:"POST",body:JSON.stringify({data:t.data,values:t.values,secret:t.secret})});if(!e.ok)throw new Error(`updateUserData failed with status code ${e.status}`);return this.parse(await e.text())}async getUserData(t){const e=await fetch(`https://auds.poki.io/v0/${this.gameId}/userdata/${t.bucket}/${t.id}`);if(!e.ok)throw new Error(`getUserData failed with status code ${e.status}`);return this.parse(await e.text())}async listUserData(t){const e=await fetch(`https://auds.poki.io/v0/${this.gameId}/userdata/${t.bucket}?includedata&sort=${t.sort}`);if(!e.ok)throw new Error(`listUserData failed with status code ${e.status}`);return this.parse(await e.text())}parse(t){try{return JSON.parse(t)}catch(e){throw console.error(`Failed to parse JSON: ${e.message} (json: ${t})`),e}}}var kn=i(2002),xn=i(5434);const Cn=(0,xn.R)((()=>new kn.BindingDefinitionSet([new kn.BindingDefinition("movement","left","Left",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.A),(0,kn.keyboard)(kn.Keyboard.LEFT),(0,kn.keyboard)(kn.Keyboard.Q),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_LEFT))),new kn.BindingDefinition("movement","right","Right",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.D),(0,kn.keyboard)(kn.Keyboard.RIGHT),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_RIGHT))),new kn.BindingDefinition("movement","up","Up",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.W),(0,kn.keyboard)(kn.Keyboard.UP),(0,kn.keyboard)(kn.Keyboard.Z),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_UP))),new kn.BindingDefinition("movement","down","Down",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.S),(0,kn.keyboard)(kn.Keyboard.DOWN),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_DOWN))),new kn.BindingDefinition("movement","dash","Dash",!0,(0,kn.set)()),new kn.BindingDefinition("movement","shield","Shield",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.SHIFT),(0,kn.mouse)(kn.MouseButton.RIGHT_BUTTON))),new kn.BindingDefinition("movement","tool","Tool",!0,(0,kn.set)((0,kn.mouse)(kn.MouseButton.LEFT_BUTTON),(0,kn.keyboard)(kn.Keyboard.SPACE))),new kn.BindingDefinition("movement","interact","Interact",!0,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.E))),new kn.BindingDefinition("menus","inventory","inventory",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.I))),new kn.BindingDefinition("menus","menuUp","menuUp",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.UP),(0,kn.keyboard)(kn.Keyboard.W),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_UP))),new kn.BindingDefinition("menus","menuDown","menuDown",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.DOWN),(0,kn.keyboard)(kn.Keyboard.S),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_DOWN))),new kn.BindingDefinition("menus","menuLeft","menuLeft",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.LEFT),(0,kn.keyboard)(kn.Keyboard.A),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_LEFT))),new kn.BindingDefinition("menus","menuRight","menuRight",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.RIGHT),(0,kn.keyboard)(kn.Keyboard.D),(0,kn.gamepadButton)(kn.GamepadButton.DPAD_RIGHT))),new kn.BindingDefinition("menus","menuSelect","menuSelect",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.ENTER),(0,kn.keyboard)(kn.Keyboard.SPACE),(0,kn.gamepadButton)(kn.GamepadButton.A))),new kn.BindingDefinition("menus","menuBack","menuBack",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.ESC),(0,kn.gamepadButton)(kn.GamepadButton.B))),new kn.BindingDefinition("menus","menuSkip","menuSkip",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.ENTER),(0,kn.keyboard)(kn.Keyboard.SPACE),(0,kn.gamepadButton)(kn.GamepadButton.A))),new kn.BindingDefinition("menus","pause","pause",!1,(0,kn.set)((0,kn.keyboard)(kn.Keyboard.ESC),(0,kn.keyboard)(kn.Keyboard.P),(0,kn.gamepadButton)(kn.GamepadButton.START)))])));class En extends kn.KeyBindingsSettings{constructor(){super(Cn.value())}}var Sn=i(1727);async function Mn(t){const e=Pn(t);t.navigator.mainMenu(),await e}async function Pn(t){const{navigator:e,progressionRepository:i}=t;for(;;){const{levelIndex:s}=i.progression;try{await e.gameplay(s)}catch(e){if(e instanceof Sn.r)return void Mn(t)}await e.commercialBreak()}}var In=i(3672),An=i(8468);async function On(t){try{await t.load()}catch(e){if(console.error(`Failed to load ${t.label} (mandatory: ${t.mandatory})`,e),t.mandatory)throw e}}var Rn=i(6318);class _n extends Rn.l{setup(){super.setup(),this.inputs.gamepad.onButtonUp=t=>{(0,kn.gamepadButtonMatches)(t,this.game.keyBindings.binding("menuSkip"))&&this.skip()}}get navigator(){return this.game.navigator}get texturePool(){return this.game.texturePool}keyUp(t){(0,kn.keyCodeMatches)(t,this.game.keyBindings.binding("menuSkip"))&&this.skip()}}class Bn extends u.HTMLScreen{constructor(){super(...arguments),this.cursorType="default"}get navigator(){return this.game.navigator}}class Ln extends y.ReactScreen{constructor(){super(...arguments),this.cursorType="default"}get navigator(){return this.game.navigator}get texturePool(){return this.game.texturePool}get soundPool(){return this.game.soundPool}get progression(){return this.game.progression}setup(){super.setup(),this.inputs.gamepad.onButtonUp=t=>{(0,kn.gamepadButtonMatches)(t,this.game.keyBindings.binding("menuSkip"))&&this.skip()}}keyUp(t){(0,kn.keyCodeMatches)(t,this.game.keyBindings.binding("menuSkip"))&&this.skip()}}const Dn=i.p+"Knights Quest13d8aace09810670ed40.ttf",Vn=i.p+"Rise of Kingdom4d60e3a64e178cfc475f.ttf";class Hn extends An.default.Component{constructor(t){super(t),this.state={progress:0,label:"",resources:[]}}setRemainingResources(t){this.setState({resources:t})}setLabel(t){this.setState({label:t})}setProgress(t){this.setState({progress:t})}render(){return An.default.createElement(n.VerticalCenter,null,An.default.createElement(n.NarrowColumn,{style:{minHeight:"50px"}},An.default.createElement(n.LargeLabel,{style:{textAlign:"center"}},pt("loading"),~~(100*this.state.progress)+"%"),An.default.createElement(n.Gauge,{value:this.state.progress})))}}class Fn extends Ln{constructor(){super(...arguments),this.totalLoaded=0,this.totalLoadable=0,this.remainingResources=new Set,this.id="asset-loading"}async rootComponent(){return An.default.createElement(Hn,{ref:t=>{this.loadingScreenComponent=t,this.onLoadingScreenComponentReady()}})}get progress(){return this.totalLoaded/this.totalLoadable}setup(){super.setup(),Promise.resolve().then((()=>{let t=[].concat(this.textures()).concat(this.fonts());if(this.game.pokiBridge.isPoki)for(const t of this.game.soundPool.loadAll())On(t);else t=t.concat(this.sounds());return this.loadAll(t)})).then((()=>{this.game.pokiBridge.gameLoadingFinished(),this.proceed()})).catch((t=>{this.resolver.reject(t)}))}updateStatus(){var t,e,i;if(!this.loadingScreenComponent)return!1;null===(t=this.loadingScreenComponent)||void 0===t||t.setLabel(`${~~(this.totalLoaded/1e3)}/${~~(this.totalLoadable/1e3)}`),null===(e=this.loadingScreenComponent)||void 0===e||e.setProgress(this.progress),null===(i=this.loadingScreenComponent)||void 0===i||i.setRemainingResources(Array.from(this.remainingResources)),console.log(this.remainingResources)}onLoadingScreenComponentReady(){this.updateStatus()}textures(){return this.game.texturePool.loadAll()}async loadAll(t){this.totalLoadable+=t.reduce(((t,e)=>t+e.size),0);for(const e of t)this.remainingResources.add(e.label);await Promise.all(t.map((t=>(async()=>{await On(t),this.totalLoaded+=t.size,this.remainingResources.delete(t.label),this.updateStatus()})())))}sounds(){return this.game.soundPool.loadAll()}fonts(){return[["Knights Quest",Dn],["Rise of Kingdom",Vn]].map((([t,e])=>this.fontLoadable(t,e)))}fontLoadable(t,e){return{label:t,load:async()=>{const i=new FontFace(t,`url("${e}")`);document.fonts.add(i),await i.load()},mandatory:!1,size:5120}}get absorbCycle(){return!1}proceed(){this.progress<1||this.totalLoaded<0||this.resolver.resolve()}}class Nn extends _n{constructor(){super(...arguments),this.id="commercial"}get absorbCycle(){return!0}get absorbInputs(){return!0}}var Un=i(3904),Wn=i(7163);class Xn extends Ln{constructor(){super(...arguments),this.restoredFocusIndex=0}setup(){super.setup(),this.focusNavigator=new Wn.KeyboardFocusNavigator(this.view),this.focusNavigator.handleKeys({...Wn.KeyboardFocusNavigator.ARROW_KEY_HANDLERS,...Wn.KeyboardFocusNavigator.WASD_HANDLERS}),this.inputs.gamepad.onButtonDown=t=>{const{keyBindings:e}=this.game;(0,kn.gamepadButtonMatches)(t,e.binding("menuBack"))&&this.onBackKeyPressed()}}foreground(){super.foreground(),document.exitPointerLock&&document.exitPointerLock(),this.focusNavigator.setup(),setTimeout((()=>this.focusNavigator.focusIndex=this.restoredFocusIndex),200)}onBackKeyPressed(){}keyDown(t){super.keyDown(t);const{keyBindings:e}=this.game;(0,kn.keyCodeMatches)(t,e.binding("menuBack"))&&this.onBackKeyPressed()}onBackNavigation(){this.onBackKeyPressed()}background(){super.background(),this.view.style.display="block",this.focusNavigator.destroy();const{activeElement:t}=document;t&&this.view.contains(t)&&t.blur()}destroy(){super.destroy(),this.focusNavigator.destroy()}}function Gn(t){const[e,i]=(0,Un.J0)(t.stats),s=["defense","damage","mobility"].map((t=>An.default.createElement(n.HighlightableRow,{key:t},An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.SmallLabel,null,t),An.default.createElement(n.LabelledSlider,{value:100*e[t],min:0,max:100,step:10,label:n.LabelledSlider.rawValue,onChange:s=>{const n=new Mt;n.add(e),n[t]=parseInt(s.target.value)/100,i(n)}})))));return An.default.createElement(n.ScreenColumnLayout,null,An.default.createElement(n.ScreenColumnLayoutMainColumn,null,An.default.createElement(n.ScreenColumnLayoutMainColumnHeader,null,An.default.createElement(n.MainTitle,null,"Stats")),An.default.createElement(n.ScreenColumnLayoutMainColumnContent,null,s),An.default.createElement(n.ScreenColumnLayoutMainColumnFooter,null,An.default.createElement(n.MainButton,{onClick:()=>t.onSaveTapped(e)},"Done"))))}class zn extends Xn{constructor(t){super(),this.character=t,this.id="set-character-stats"}async rootComponent(){const t=this.character.traitOfType(hn),{stats:e}=t;return An.default.createElement(Gn,{stats:e.clone(),onSaveTapped:e=>{t.baseStats=e,this.resolver.resolve()}})}onBackKeyPressed(){this.resolver.resolve()}}function Kn(t){const e=["dialog-layout"];return t.isModal&&e.push("modal"),t.isPacked&&e.push("packed"),An.default.createElement("div",{className:e.join(" ")},t.children)}function Yn(t){return An.default.createElement("div",{className:"dialog-layout-top-bar"},t.children)}function qn(t){return An.default.createElement("div",{className:"dialog-layout-bottom-bar"},t.children)}function jn(t){return An.default.createElement("div",{className:"dialog-layout-top-bar-left"},t.children)}function $n(t){return An.default.createElement("div",{className:"dialog-layout-top-bar-center"},t.children)}function Jn(t){return An.default.createElement("div",{className:"dialog-layout-top-bar-right"},t.children)}function Zn(t){return An.default.createElement("div",{className:"dialog-layout-content"},t.children)}class Qn extends An.default.Component{constructor(t){super(t),this.state={closing:!1,animateOutListener(){}}}animateOut(){return new Promise(((t,e)=>{this.setState({closing:!0,animateOutListener:t}),setTimeout(t,300)}))}render(){return An.default.createElement(n.Dim,{onAnimationEnd:this.state.animateOutListener,className:this.state.closing?"closing":"opening"},this.props.children)}}class ta extends Xn{constructor(t){super(),this.description=t,this.id="challenge-description"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("challenge")))),An.default.createElement(Zn,null,An.default.createElement(n.SmallLabel,{style:{textAlign:"center",marginLeft:n.Spacing.s,marginRight:n.Spacing.s,marginTop:n.Spacing.s,marginBottom:n.Spacing.xl}},this.description)),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!0)},pt("imReady")),An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!1)},pt("leave"))))))}get absorbCycle(){return!1}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}onBackKeyPressed(){this.onOptionCLicked(!1)}}const ea=i.p+"quitb527aca131b0a9483cb2.png",ia=i.p+"restart9904aff9ad519f96115c.png";class sa extends Xn{constructor(){super(...arguments),this.id="challenge-failed"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},"Challenge Failed"))),An.default.createElement(Zn,null),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,"data-positive":!0,onClick:()=>this.onOptionCLicked(!0)},An.default.createElement("img",{src:ia})," Try Again"),An.default.createElement(n.MainButton,{tabIndex:t++,"data-negative":!0,onClick:()=>this.onOptionCLicked(!1)},An.default.createElement("img",{src:ea})," Leave")))))}get absorbCycle(){return!1}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}onBackKeyPressed(){this.onOptionCLicked(!1)}}const na=i.p+"backpack0dd596264d7725eabea5.png",aa=i.p+"resumed81c90b28468446c6bf8.png";var ra;!function(t){t[t.RESUME=0]="RESUME",t[t.INVENTORY=1]="INVENTORY",t[t.EXIT=2]="EXIT"}(ra||(ra={}));class oa extends Xn{constructor(){super(...arguments),this.id="challenge-pause"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,null,An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,null,"Path to Glory"))),An.default.createElement(Zn,null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.resolve(ra.RESUME)},An.default.createElement("img",{src:aa})," ",pt("resume")),An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.resolve(ra.INVENTORY)},An.default.createElement("img",{src:na})," ",pt("inventory")),An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.resolve(ra.EXIT)},An.default.createElement("img",{src:ea})," ",pt("exit"))),An.default.createElement(qn,null)))}async resolve(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}async onBackKeyPressed(){this.resolve(ra.RESUME)}}class ha extends Xn{constructor(t){super(),this.reward=t,this.id="confirm-challenge"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("acceptChallenge?")))),An.default.createElement(Zn,null,An.default.createElement(n.MediumLabel,{style:{textAlign:"center",margin:n.Spacing.l}},pt("reward:"),An.default.createElement("br",null),An.default.createElement("img",{src:b,style:{height:"2em",verticalAlign:"middle",marginRight:n.Spacing.xs}}),this.reward.toLocaleString("en"))),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!0),"data-positive":!0},pt("accept")),An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!1),"data-negative":!0},pt("decline"))))))}get absorbCycle(){return!1}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}onBackKeyPressed(){this.onOptionCLicked(!1)}}const la=i.p+"defense287ce406dcbe670f5771.png",ca=i.p+"speed0c3bb65d2aac0279cbf9.png",da=i.p+"strengthe11c0179ded02ada6271.png";function ua(t){return An.default.createElement("div",{className:"item-card-layout"},t.children)}function pa(t){return An.default.createElement("div",{className:"item-card-layout-preview",style:{backgroundImage:`url(${t.src})`}})}function ma(t){let e;return t.statDiff>0?e=An.default.createElement("span",{style:{display:"block",color:"#0f0"}},"(+",Math.round(100*t.statDiff),")"):t.statDiff<0?e=An.default.createElement("span",{style:{display:"block",color:"#f00"}},"(",Math.round(100*t.statDiff),")"):t.statDiff,An.default.createElement("div",null,An.default.createElement("div",null,An.default.createElement("img",{src:t.icon,style:{width:"20px"},title:t.tooltip})),void 0!==t.itemStat?Math.round(100*t.itemStat):null," ",e)}var ya=i(3511);class wa extends f.Filter{constructor(){super("\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n}\n","\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void)\n{\n    gl_FragColor = vec4(0.1, 0.1, 0.1, texture2D(uSampler, vTextureCoord).a);\n}\n")}}var ga=i(1660);class fa extends f.Container{constructor(){super(),this.blade=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.arc(0,0,10,3*Math.PI/4,3*-Math.PI/4,!1),t.arc(0,-15,10,3*Math.PI/4,Math.PI/4,!0),t.arc(0,0,10,-Math.PI/4,Math.PI/4,!1),t.arc(0,15,10,-Math.PI/4,3*-Math.PI/4,!0),t.endFill(),t})(),this.handle=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.drawRect(-2,-37,4,42),t.endFill(),t})(),this.addChild(this.handle,this.blade),this.blade.position.y=-30}setDescription(t){return this.blade.tint=t.color,this.handle.tint=t.handleColor,this}}class va extends f.Container{constructor(){super(),this.blade=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.moveTo(-5,-3),t.lineTo(10,-5),t.lineTo(10,5),t.lineTo(-5,3),t.endFill(),t})(),this.handle=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.drawRect(-2,-25,4,30),t.endFill(),t})(),this.addChild(this.handle,this.blade),this.blade.position.y=-20}setDescription(t){return this.blade.tint=t.color,this.handle.tint=t.handleColor,this}}class ba extends f.Container{constructor(){super(),this.blade=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=15,t.height=8,t})(),this.handle=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.9),t.width=4,t.height=42,t})(),this.addChild(this.handle,this.blade),this.blade.position.y=-34}setDescription(t){return this.blade.tint=t.color,this.handle.tint=t.handleColor,this}}class Ta extends f.Container{constructor(){super(),this.handle=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.4),t.width=4,t.height=70,t})(),this.tip=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=6,t.height=6,t})(),this.addChild(this.handle,this.tip),this.tip.position.set(0,-this.handle.height*this.handle.anchor.y)}setDescription(t){return this.handle.tint=t.handleColor,this.tip.tint=t.tipColor,this}}class ka extends f.Container{constructor(){super(),this.handle=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.9),t.width=4,t.height=42,t})(),this.addChild(this.handle)}setDescription(t){return this.handle.tint=t.color,this}}class xa extends f.Container{constructor(){super(),this.color=0,this.handleColor=0,this.blade=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.moveTo(-3,-8),t.lineTo(-5,-43),t.lineTo(0,-48),t.lineTo(5,-43),t.lineTo(3,-8),t.endFill(),t})(),this.handle=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.drawRect(-10,-10,20,4),t.drawRect(-3,-8,6,12),t.endFill(),t})(),this.addChild(this.blade,this.handle)}setDescription(t){return this.color=t.color,this.handleColor=t.handleColor,this}setRecentlyHit(t){this.blade.tint=t?16777215:this.color,this.handle.tint=t?16777215:this.handleColor}}class Ca{constructor(){this.sword=new ga.w((()=>new xa)),this.axe=new ga.w((()=>new fa)),this.smallAxe=new ga.w((()=>new va)),this.stick=new ga.w((()=>new ka)),this.hammer=new ga.w((()=>new ba)),this.staff=new ga.w((()=>new Ta))}poolFor(t){return t instanceof Kt?this.sword:t instanceof Yt?this.axe:t instanceof qt?this.smallAxe:t instanceof $t?this.stick:t instanceof jt?this.hammer:t instanceof Qt?this.staff:null}}class Ea extends f.Container{constructor(t){super(),this.texturePool=t,this.currentDescription=null}setShieldDescription(t){if(t===this.currentDescription)return;this.currentDescription=t,this.removeChildren(0,this.children.length);let e=null;t instanceof Ot?e=new Sa(this.texturePool).setDescription(t):t instanceof Rt&&(e=(new Ma).setDescription(t)),e&&this.addChild(e)}setRecentlyHit(t){const e=this.children[0];(null==e?void 0:e.setRecentlyHit)&&e.setRecentlyHit(t)}}class Sa extends f.Container{constructor(t){super(),this.texturePool=t,this.outline=this.createBit(.8),this.main=this.createBit(.55),this.mainTexture=(()=>{const t=new f.Sprite;return t.anchor.set(.5,.5),t.position.set(0,3),t})(),this.outlineColor=0,this.mainColor=0,this.addChild(this.outline,this.main,this.mainTexture)}createBit(t){const e=new f.Graphics;return e.beginFill(16777215),e.moveTo(0,-15*t),e.lineTo(15*t,-10*t),e.lineTo(12*t,10*t),e.lineTo(0*t,25*t),e.lineTo(-12*t,10*t),e.lineTo(-15*t,-10*t),e.endFill(),e}setDescription(t){return this.outlineColor=t.outlineColor,this.mainColor=t.mainColor,t.texturePath?(this.mainTexture.visible=!0,this.mainTexture.texture=function(t,e){let i=t;for(const t of e){if(!(t in i))throw new Error("Unresolvable catalog path: "+e.join("."));i=i[t]}return i}(this.texturePool.textures,t.texturePath.split(".")).texture,this.mainTexture.width=this.main.width,this.mainTexture.height=this.main.height,this.mainTexture.mask=this.main):(this.mainTexture.visible=!1,this.mainTexture.mask=null),this}setRecentlyHit(t){this.outline.tint=t?16777215:this.outlineColor,this.main.tint=t?16777215:this.mainColor}}class Ma extends f.Container{constructor(){super(),this.outline=this.createBit(.8),this.main=this.createBit(.5),this.outlineColor=0,this.mainColor=0,this.addChild(this.outline,this.main)}createBit(t){const e=new f.Sprite(f.Texture.WHITE);return e.anchor.set(.5,.5),e.width=e.height=30*t,e}setDescription(t){return this.outlineColor=t.outlineColor,this.mainColor=t.mainColor,this}setRecentlyHit(t){this.outline.tint=t?16777215:this.outlineColor,this.main.tint=t?16777215:this.mainColor}}class Pa extends f.Container{constructor(t){super(),this.pools=t,this.currentDescription=null}setRecentlyHit(t){const e=this.children[0];(null==e?void 0:e.setRecentlyHit)&&e.setRecentlyHit(t)}setToolDescription(t){var e;if(t===this.currentDescription)return;const i=this.children[0];i&&(i.removeFromParent(),null===(e=this.pools.poolFor(this.currentDescription))||void 0===e||e.give(i)),this.currentDescription=t;const s=function(t,e){var i,s;return null===(s=null===(i=e.poolFor(t))||void 0===i?void 0:i.take())||void 0===s?void 0:s.setDescription(t)}(t,this.pools);s&&this.addChild(s)}}class Ia extends f.Sprite{constructor(){super(f.Texture.WHITE),this.anchor.set(.5,1),this.width=12,this.height=15,this.setRecentlyHit(!1)}setRecentlyHit(t){this.tint=t?16777215:15786176}}class Aa extends f.Container{constructor(){super(),this.mainColor=0,this.teeColor=0,this.broomColor=void 0,this.mainShape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=12,t.height=15,t})(),this.teeBase=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=2,t.height=8,t})(),this.teeTop=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=6,t.height=3,t})(),this.broomBase=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=3,t.height=5,t})(),this.broom=(()=>{const t=new f.Graphics;return t.lineStyle({width:6,color:16777215}),t.arc(0,0,10,-Math.PI/3,Math.PI,!0),t})(),this.teeBase.position.set(2,0),this.teeTop.position.set(this.teeBase.position.x,-this.teeBase.height),this.broomBase.position.set(0,-this.mainShape.height),this.broom.position.set(0,-10),this.addChild(this.mainShape,this.teeBase,this.teeTop,this.broomBase,this.broom),this.setRecentlyHit(!1)}setDescription(t){return this.mainColor=t.mainColor,this.teeColor=t.teeColor,this.broomColor=t.broomColor,this.broom.visible=this.broomBase.visible=void 0!==this.broomColor,this}setRecentlyHit(t){this.mainShape.tint=t?16777215:this.mainColor,this.teeBase.tint=t?16777215:this.teeColor,this.teeTop.tint=t?16777215:this.teeColor,void 0!==this.broomColor&&(this.broomBase.tint=t?16777215:this.mainColor,this.broom.tint=t?16777215:this.broomColor)}}class Oa extends f.Container{constructor(){super(),this.mainColor=0,this.top=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=12,t.height=5,t})(),this.front=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(1,0),t.width=2,t.height=4,t})(),this.back=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,0),t.width=5,t.height=8,t})(),this.head=new Ia,this.addChild(this.head,this.top,this.front,this.back),this.setRecentlyHit(!1),this.top.position.set(0,-this.head.height),this.front.position.set(this.head.width/2-1,-this.head.height+this.top.height),this.back.position.set(-this.head.width/2,-this.head.height+this.top.height)}setDescription(t){return this.mainColor=t.mainColor,this}setRecentlyHit(t){this.top.tint=t?16777215:this.mainColor,this.front.tint=t?16777215:this.mainColor,this.back.tint=t?16777215:this.mainColor,this.head.setRecentlyHit(t)}}class Ra extends f.Container{constructor(){super(),this.mainColor=0,this.top=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.moveTo(-6,0),t.lineTo(-4,-15),t.lineTo(-10,-30),t.lineTo(4,-15),t.lineTo(6,0),t})(),this.round=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.drawEllipse(0,0,15,5),t})(),this.head=new Ia,this.addChild(this.head,this.top,this.round),this.setRecentlyHit(!1),this.top.position.set(0,-this.head.height),this.round.position.copyFrom(this.top.position)}setDescription(t){return this.mainColor=t.mainColor,this}setRecentlyHit(t){this.top.tint=this.round.tint=t?16777215:this.mainColor,this.head.setRecentlyHit(t)}}class _a extends f.Container{constructor(){super(),this.mainColor=0,this.head=new Ia,this.crown=(()=>{const t=new f.Graphics;return t.beginFill(16777215),t.moveTo(-8,0),t.lineTo(8,0),t.lineTo(8,-12),t.lineTo(4,-5),t.lineTo(0,-12),t.lineTo(-4,-5),t.lineTo(-8,-12),t})(),this.addChild(this.head,this.crown),this.crown.position.set(0,-12)}setDescription(t){return this.mainColor=t.mainColor,this}setRecentlyHit(t){this.crown.tint=t?16777215:this.mainColor,this.head.setRecentlyHit(t)}}class Ba extends f.Container{constructor(){super(),this.mainColor=0,this.slitColor=0,this.mainShape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=12,t.height=15,t})(),this.slit=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=6,t.height=3,t})(),this.slit.position.set(2,-8),this.addChild(this.mainShape,this.slit),this.setRecentlyHit(!1)}setDescription(t){return this.mainColor=t.mainColor,this.slitColor=t.slitColor,this}setRecentlyHit(t){this.mainShape.tint=t?16777215:this.mainColor,this.slit.tint=t?16777215:this.slitColor}}class La extends f.Container{constructor(){super(),this.mainColor=0,this.featherColor=0,this.flat=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=20,t.height=8,t.tint=9764864,t})(),this.feather=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=6,t.height=20,t.tint=4194304,t})(),this.head=new Ia,this.addChild(this.head,this.feather,this.flat),this.flat.position.set(0,-this.head.height),this.feather.position.set(this.flat.width/4,-this.head.height)}setDescription(t){return this.mainColor=t.mainColor,this.featherColor=t.featherColor,this}setRecentlyHit(t){this.feather.tint=t?16777215:this.featherColor,this.flat.tint=t?16777215:this.mainColor,this.head.setRecentlyHit(t)}}class Da extends f.Container{constructor(){super(...arguments),this.currentDescription=null}setHelmetDescription(t){if(t===this.currentDescription)return;this.currentDescription=t,this.removeChildren(0,this.children.length);let e=null;t instanceof Ht?e=new Ia:t instanceof Nt?e=(new Aa).setDescription(t):t instanceof Ft?e=(new Oa).setDescription(t):t instanceof Ut?e=(new Ra).setDescription(t):t instanceof Wt?e=(new _a).setDescription(t):t instanceof Xt?e=(new Ba).setDescription(t):t instanceof Gt&&(e=(new La).setDescription(t)),e&&this.addChild(e)}setRecentlyHit(t){const e=this.children[0];(null==e?void 0:e.setRecentlyHit)&&e.setRecentlyHit(t)}}class Va extends f.Graphics{update(t,e,i,s,n){this.clear(),this.beginFill(16777215,1),this.moveTo(-i/2,0);for(let a=1;a<5;a++){const r=a/4,o=Math.sin(t*n*Math.PI*2+4*r)*(10*r);this.lineTo(-i/2+o+r*s,r*e)}for(let a=4;a>=0;a--){const r=a/4,o=Math.sin(t*n*Math.PI*2+4*r)*(10*r);this.lineTo(i/2+o+r*s,r*e)}}}const Ha=ae.item.description,Fa=Oe.item.description,Na=je.item.description;class Ua{progress(t){return Math.min(1,t/this.duration)}}class Wa extends Ua{progress(t){return t%this.duration/this.duration}}class Xa extends Ua{constructor(t){super(),this.animations=t,this.duration=0,this.duration=t.reduce(((t,e)=>t+e.duration),0)}apply(t,e){let i=0;for(;this.animations[i]&&e>this.animations[i].duration;)e-=this.animations[i].duration,i++;if(this.animations[i])this.animations[i].apply(t,e);else{const e=this.animations[this.animations.length-1];this.animations[this.animations.length-1].apply(t,e.duration)}}}class Ga extends f.Container{constructor(t,e){super(),this.texturePool=t,this.toolPools=e,this.center=new f.Container,this.forwardShoulder=new f.Container,this.forwardHand=new f.Container,this.toolContainer=new Pa(this.toolPools),this.shieldContainer=new Ea(this.texturePool),this.cape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=22,t.height=40,t.tint=9764864,t})(),this.newCape=new Va,this.capeForwardShoulder=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=5,t.tint=9764864,t})(),this.capeBackShoulder=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=5,t.tint=9764864,t})(),this.backShoulder=new f.Container,this.backHand=new f.Container,this.waterMask=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=16711680,t.width=150,t.height=100,t.anchor.set(.5,1),t.visible=!1,t})(),this.chest=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=23,t.height=30,t})(),this.forwardLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=7,t.height=20,t})(),this.backLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=7,t.height=20,t})(),this.head=new Da,this.forwardArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.tint=6316128,t.width=20,t.height=6,t})(),this.backArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.tint=6316128,t.width=20,t.height=6,t})(),this.toolCenter=new f.Container,this.reusablePoint=new f.Point,this.reusableToolBounds=new f.Rectangle,this.outPoint=new f.Point,this.addChild(this.center,this.waterMask),this.center.addChild(this.newCape,this.forwardLeg,this.backLeg,this.forwardShoulder,this.head,this.chest,this.capeForwardShoulder,this.capeBackShoulder,this.backShoulder),this.forwardShoulder.addChild(this.forwardArm),this.forwardShoulder.addChild(this.forwardHand),this.backShoulder.addChild(this.backArm),this.backShoulder.addChild(this.backHand),this.forwardHand.position.set(this.forwardArm.width-2,0),this.forwardHand.addChild(this.toolContainer),this.forwardHand.addChild(this.toolCenter),this.backShoulder.position.set(-10,-this.chest.height/2+this.backArm.height/2+2),this.backShoulder.rotation=Math.PI/4,this.backHand.position.set(this.backArm.width-2,0),this.backHand.addChild(this.shieldContainer)}toolCenterPosition(t){const e=this.toolCenter.getGlobalPosition(this.reusablePoint,!1);this.toLocal(e,null,t)}update(t,e,i,s,n,a,r,o,h,l,c,d){Ga.RESET.apply(this,t);const u=(null==o?void 0:o.description)||Ha,p=(null==h?void 0:h.description)||Fa,m=(null==l?void 0:l.description)||Na;this.forwardShoulder.rotation=-i*Math.PI/2,this.backShoulder.rotation=Math.PI/3-s*Math.PI/3,this.backArm.width=10+12*s,this.backHand.position.set(this.backArm.width,0),this.backShoulder.visible=!(m instanceof At),Ga.BREATHING.apply(this,t),e&&Ga.WALKING.apply(this,t),n&&Ga.ROLLING.apply(this,n/Ga.ROLLING.duration);const y=this.toolContainer.getLocalBounds(this.reusableToolBounds);this.toolCenter.position.set(y.x+y.width/2,y.y+y.height/2),this.toolContainer.setToolDescription(null==c?void 0:c.description),this.toolContainer.setRecentlyHit(a),this.head.setHelmetDescription(p),this.head.setRecentlyHit(a),this.shieldContainer.setShieldDescription(m),this.shieldContainer.setRecentlyHit(a),this.cape.visible=this.newCape.visible=this.capeForwardShoulder.visible=this.capeBackShoulder.visible=d&&null!==d.description.color,this.forwardArm.visible=!!(null==c?void 0:c.description),this.chest.tint=a?16777215:u.chestColor,this.forwardLeg.tint=a?16777215:u.legsColor,this.backLeg.tint=a?16777215:u.legsColor,this.forwardArm.tint=a?16777215:u.armsColor,this.backArm.tint=a?16777215:u.armsColor,this.newCape.update(t,40,22,gt(-10,-20,e/200),gt(.2,2,e/200)),this.cape.visible&&(this.cape.tint=a?16777215:d.description.color,this.newCape.tint=this.cape.tint,this.capeBackShoulder.tint=this.cape.tint,this.capeForwardShoulder.tint=this.cape.tint),this.center.mask=r?this.waterMask:null,this.waterMask.visible=r,r&&(this.center.position.y+=10)}rideHorse(t,e){Ga.RIDING.apply(this,e),t.seatCenterPosition(this.outPoint),this.center.position.x=this.outPoint.x,this.center.position.y=this.outPoint.y,this.center.rotation=t.center.rotation,this.center.position.x+=20*Math.cos(this.center.rotation-Math.PI/2),this.center.position.y+=20*Math.sin(this.center.rotation-Math.PI/2),this.forwardLeg.rotation+=t.backLeg.rotation/3}}Ga.RESET=new class extends Ua{constructor(){super(...arguments),this.duration=1}apply(t,e){t.alpha=1,t.center.position.set(0,-t.backLeg.height-t.chest.height/2+2),t.center.rotation=0,t.center.scale.set(1,1),t.backLeg.visible=!0,t.backLeg.position.set(-6,12),t.backLeg.rotation=0,t.forwardLeg.visible=!0,t.forwardLeg.position.set(6,12),t.forwardLeg.rotation=0,t.chest.rotation=0,t.head.rotation=0,t.head.position.set(0,-t.chest.height/2),t.forwardShoulder.rotation=0,t.forwardShoulder.position.set(10,-t.chest.height/2+t.forwardArm.height/2+2),t.backShoulder.rotation=0,t.cape.position.set(0,-t.chest.height/2),t.newCape.position.set(0,-t.chest.height/2),t.newCape.rotation=0,t.cape.rotation=Math.PI/16,t.capeForwardShoulder.position.set(t.chest.width/2-2,-t.chest.height/2-2),t.capeBackShoulder.position.set(-t.chest.width/2+2,-t.chest.height/2-2)}},Ga.WALKING=new class extends Wa{constructor(){super(...arguments),this.duration=1/4}apply(t,e){t.backLeg.rotation=-Math.sin(e*Math.PI*2/this.duration)*Math.PI/16*1,t.forwardLeg.rotation=Math.sin(e*Math.PI*2/this.duration)*Math.PI/16*1,t.chest.rotation+=-Math.sin(e*Math.PI*2*4)*Math.PI/64*1,t.head.rotation+=-Math.sin(e*Math.PI*2*4)*Math.PI/32*1,t.forwardShoulder.rotation+=-Math.sin(e*Math.PI*2*4)*Math.PI/32*1,t.backShoulder.rotation+=Math.sin(e*Math.PI*2*4)*Math.PI/32*1,t.cape.rotation+=Math.sin(e*Math.PI*2*2)*Math.PI/16}},Ga.BREATHING=new class extends Wa{constructor(){super(...arguments),this.duration=2}apply(t,e){t.chest.rotation+=Math.sin(e*Math.PI*2/this.duration)*Math.PI/128,t.forwardShoulder.rotation+=Math.sin(e*Math.PI*2/this.duration)*Math.PI/128,t.backShoulder.rotation+=Math.sin(e*Math.PI*2/this.duration)*Math.PI/128,t.head.rotation+=Math.sin(e*Math.PI*2/this.duration)*Math.PI/128,t.cape.rotation+=Math.sin(e*Math.PI*2)*Math.PI/32}},Ga.ROLLING=new class extends Ua{constructor(){super(...arguments),this.duration=1}apply(t,e){t.center.rotation=this.progress(e)*Math.PI*2}},Ga.FALLING_DOWN=new Xa([new class extends Ua{constructor(){super(...arguments),this.duration=.1}apply(t,e){const i=this.progress(e);t.center.rotation=gt(0,-Math.PI/2,i),t.center.position.y+=gt(0,-15,i),t.backLeg.rotation+=-Math.PI/3,t.forwardLeg.rotation+=-Math.PI/3}},new class extends Ua{constructor(){super(...arguments),this.duration=.1}apply(t,e){const i=this.progress(e);t.center.rotation=-Math.PI/2,t.center.position.y+=gt(-10,15,i),t.backLeg.rotation+=gt(0,-Math.PI/3,1-i),t.forwardLeg.rotation+=gt(0,-Math.PI/3,1-i)}}]),Ga.GETTING_UP=new Xa([new class extends Ua{constructor(){super(...arguments),this.duration=.3}apply(t,e){const i=this.progress(e);t.backLeg.rotation=gt(0,-Math.PI/3,i),t.forwardLeg.rotation=gt(0,-Math.PI/3,i),t.center.rotation=gt(-Math.PI/2,0,i),t.center.position.y+=10}},new class extends Ua{constructor(){super(...arguments),this.duration=.3}apply(t,e){const i=this.progress(e);t.backLeg.rotation=gt(-Math.PI/3,0,i),t.forwardLeg.rotation=gt(-Math.PI/3,0,i),t.center.position.y+=gt(10,0,i)}}]),Ga.RIDING=new class extends Wa{constructor(){super(...arguments),this.duration=1}apply(t,e){t.backLeg.visible=!1,t.forwardLeg.position.x-=5,t.forwardLeg.rotation=-Math.PI/6,t.position.y+=3}};class za{constructor(t,e){this.texturePool=t,this.renderer=e,this.container=new f.Container,this.backgroundView=(()=>{const t=new Ga(this.texturePool,new Ca);return t.filters=[new wa],t})(),this.mainView=(()=>{const t=new Ga(this.texturePool,new Ca),e=new ya.q({distance:15,outerStrength:.5,innerStrength:0,color:16777215});return e.resolution=2,t.filters=[e],t})(),this.reusableRenderParams={resolution:2,region:new f.Rectangle},this.container.addChild(this.backgroundView,this.mainView)}setResolution(t){this.reusableRenderParams.resolution=t}previewFull(t){return this.showTree(this.mainView),this.updateKnightView(t,this.mainView),this.snapshot(this.mainView)}previewInventoryItem(t,e){return this.updateForPreview(t,e),this.snapshot(this.container)}async snapshot(t){const e=this.renderer.extract;t.getBounds(!1,this.reusableRenderParams.region),this.reusableRenderParams.region.pad(10,10);const i=this.renderer.generateTexture(t,this.reusableRenderParams),s=(await e.image(i)).src;return i.destroy(),s}updateKnightView(t,e){const{armor:i,helmet:s,shield:n,tool:a,cape:r}=t;e.update(0,0,0,0,0,!1,!1,i,s,n,a,r)}updateForPreview(t,e){(t=t.clone()).equip(e);let i=[];e.description instanceof zt?i=[this.mainView.toolContainer]:e.description instanceof It?i=[this.mainView.shieldContainer]:e.description instanceof Lt?i=[this.mainView.chest,this.mainView.forwardArm,this.mainView.backLeg,this.mainView.forwardLeg]:e.description instanceof Vt?i=[this.mainView.head]:e.description instanceof Dt&&(i=[this.mainView.cape,this.mainView.newCape,this.mainView.capeBackShoulder,this.mainView.capeForwardShoulder]);for(const e of[this.mainView,this.backgroundView])this.updateKnightView(t,e);this.hideSpritesAndGraphics(this.mainView);for(const t of i)this.showTree(t)}hideSpritesAndGraphics(t){if(t instanceof f.Container)for(const e of t.children)this.hideSpritesAndGraphics(e);t instanceof f.Sprite&&(t.alpha=0),t instanceof f.Graphics&&(t.alpha=0)}showTree(t){if(t.alpha=1,t instanceof f.Container)for(const e of t.children)this.showTree(e)}}function Ka(t){let e=0;const{baseStats:i,shopItem:s,previewMaker:a,inventory:r,onCancelClicked:o,onConfirmClicked:h}=t,l=(0,Un.Kr)((()=>{const t=i.clone();return t.add(r.stats()),t}),[r,i]),c=(0,Un.Kr)((()=>{const e=r.clone();e.equip(t.shopItem.item);const s=i.clone();return s.add(e.stats()),s}),[r,i]),[d,u]=(0,Un.J0)(null);(0,Un.vJ)((()=>{const t=r.clone();t.equip(s.item),(async()=>{const e=await a.previewInventoryItem(t,s.item);u(e)})()}),[s]);let p="";return s.item.description instanceof Lt?p=pt("armor"):s.item.description instanceof Vt?p=pt("helmet"):s.item.description instanceof It?p=pt("shield"):s.item.description instanceof zt&&(p=pt("weapon")),An.default.createElement(Kn,null,An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center",margin:n.Spacing.m}},Ai.A.render(pt("buyX?"),{x:p})))),An.default.createElement(Zn,null,An.default.createElement(n.ScrollableContent,null,An.default.createElement(pa,{src:d}),An.default.createElement(n.BalancedRow,{style:{textAlign:"center",fontSize:n.Typography.m,margin:n.Spacing.m,marginLeft:"auto",marginRight:"auto",width:"200px"}},An.default.createElement(ma,{icon:da,tooltip:pt("tooltipDamage"),itemStat:s.item.stats.damage,statDiff:c.damage-l.damage}),An.default.createElement(ma,{icon:la,tooltip:pt("tooltipDefense"),itemStat:s.item.stats.defense,statDiff:c.defense-l.defense}),An.default.createElement(ma,{icon:ca,tooltip:pt("tooltipMobility"),itemStat:s.item.stats.mobility,statDiff:c.mobility-l.mobility})))),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:h,"data-positive":!0},pt("buy")," ",An.default.createElement("img",{src:b,style:{height:"1.5em",verticalAlign:"middle",margin:0}})," ",s.price.toLocaleString("us")),An.default.createElement(n.MainButton,{tabIndex:e++,onClick:o,"data-negative":!0},pt("cancel")))))}class Ya extends Xn{constructor(t,e,i){super(),this.shopItem=t,this.baseStats=e,this.inventory=i,this.id="confirm-purchase"}async rootComponent(){return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Ka,{shopItem:this.shopItem,inventory:this.inventory,baseStats:this.baseStats.clone(),previewMaker:new za(this.texturePool,this.game.plugin(m.W).renderer),onConfirmClicked:()=>this.onOptionCLicked(!0),onCancelClicked:()=>this.onOptionCLicked(!1)}))}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),t?this.resolver.resolve():this.resolver.reject(new Sn.r)}onBackKeyPressed(){this.onOptionCLicked(!1)}}const qa=i.p+"ad0768b53f8c6e256a0b79.png";class ja extends Xn{constructor(){super(...arguments),this.id="confirm-revive"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("youDied")))),An.default.createElement(Zn,null),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,"data-rewarded":!0,onClick:()=>this.onOptionCLicked(!0)},An.default.createElement("img",{src:qa})," ",pt("revive")),An.default.createElement(n.MainButton,{tabIndex:t++,"data-negative":!0,onClick:()=>this.onOptionCLicked(!1)},An.default.createElement("img",{src:ia})," ",pt("restartLevel"))))))}get absorbCycle(){return!1}async onOptionCLicked(t){var e;t&&!await this.navigator.rewardedBreak()||(await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t))}onBackKeyPressed(){this.onOptionCLicked(!1)}}var $a;!function(t){t[t.NEUTRAL=0]="NEUTRAL",t[t.POSITIVE=1]="POSITIVE",t[t.DESTRUCTIVE=2]="DESTRUCTIVE",t[t.REWARDED=3]="REWARDED"}($a||($a={}));class Ja extends Xn{constructor(t){super(),this.options=t,this.id="confirm"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},this.options.title))),An.default.createElement(Zn,null,this.options.message?An.default.createElement(n.SmallLabel,{style:{textAlign:"center",marginLeft:n.Spacing.s,marginRight:n.Spacing.s,marginTop:n.Spacing.s,marginBottom:n.Spacing.xl}},this.options.message):null),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,this.options.negativeButtonLabel?An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!1),"data-negative":this.options.negativeButtonActionType===$a.DESTRUCTIVE,"data-positive":this.options.negativeButtonActionType===$a.POSITIVE,"data-rewarded":this.options.negativeButtonActionType===$a.REWARDED},this.options.negativeButtonLabel):null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.onOptionCLicked(!0),"data-negative":this.options.positiveButtonActionType===$a.DESTRUCTIVE,"data-positive":this.options.positiveButtonActionType===$a.POSITIVE,"data-rewarded":this.options.positiveButtonActionType===$a.REWARDED},this.options.positiveButtonLabel)))))}get absorbCycle(){return!0}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}onBackKeyPressed(){this.onOptionCLicked(!1)}}var Za=i(6522);const Qa=i.p+"trophy1d0da34fff6deba675ad.png";var tr;!function(t){t[t.RESUME=0]="RESUME",t[t.INVENTORY=1]="INVENTORY",t[t.MAIN_MENU=2]="MAIN_MENU"}(tr||(tr={}));class er extends Xn{constructor(){super(...arguments),this.id="gameplay-pause"}async rootComponent(){const t=(0,Za.Z)((async()=>{await this.navigator.confirm({title:pt("goBackToMainMenu?"),positiveButtonLabel:pt("yes"),positiveButtonActionType:$a.DESTRUCTIVE,negativeButtonLabel:pt("cancel"),negativeButtonActionType:$a.NEUTRAL})&&this.resolver.resolve(tr.MAIN_MENU)}));let e=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,null,An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,null,"Path to Glory"))),An.default.createElement(Zn,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:()=>this.onBackKeyPressed()},An.default.createElement("img",{src:aa})," ",pt("resume")),An.default.createElement(n.MainButton,{tabIndex:e++,onClick:()=>this.resolver.resolve(tr.INVENTORY)},An.default.createElement("img",{src:na})," ",pt("inventory")),An.default.createElement(n.MainButton,{tabIndex:e++,onClick:(0,Za.Z)((()=>this.navigator.achievements()))},An.default.createElement("img",{src:Qa})," ",pt("achievements")),An.default.createElement(n.MainButton,{tabIndex:e++,onClick:t},An.default.createElement("img",{src:ea})," ",pt("mainMenu"))),An.default.createElement(qn,null)))}async onBackKeyPressed(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve(tr.RESUME)}}const ir=i.p+"armor0c7c9d64ade57c2fe024.png",sr=i.p+"helmeta06acd87d65c267d2e94.png",nr=i.p+"shield0cc53e56cba42a399bc9.png",ar=i.p+"cape55946816fd3f8da6b678.png",rr=i.p+"sword33f62fd2bf3335f0b597.png",or=i.p+"closexd7f5f3aea98116c909e4.png";function hr(t){const{equipped:e,owned:i,shopItem:s,money:a,mouseOver:r}=t;let o,h=null;return e?h="equipped":i?r&&(h="equip"):h="price",t.shopItem.price>0&&(o=An.default.createElement("div",{className:"shop-item-status "+("price"===h?"active":"")+(t.money<t.shopItem.price?" too-expensive":"")},An.default.createElement("img",{src:b,style:{height:"1.5em",verticalAlign:"middle",marginRight:n.Spacing.s}}),t.shopItem.price.toLocaleString("en"))),t.shopItem.rewardedBreak&&(o=An.default.createElement("div",{className:"shop-item-status "+("price"===h?"active":""),style:{backgroundColor:"#019cff",color:"white"}},An.default.createElement("img",{src:qa}))),An.default.createElement("div",{className:"shop-item-status-container"},An.default.createElement("div",{className:"shop-item-status "+("equipped"===h?"active":"")},pt("equipped")),An.default.createElement("div",{className:"shop-item-status "+("equip"===h?"active":"")},pt("equip")),o)}function lr(t){const{inventory:e,baseStats:i,shopItem:s,equipped:a,owned:r,previewMaker:o}=t,[h,l]=(0,Un.J0)(!1),[c,d]=(0,Un.J0)(""),u=(0,Un.Kr)((()=>{const t=i.clone();return t.add(e.stats()),t}),[e,i]),p=(0,Un.Kr)((()=>{const s=e.clone();s.equip(t.shopItem.item);const n=i.clone();return n.add(s.stats()),n}),[e,i]);let m;return(0,Un.vJ)((()=>{const t=e.clone();t.equip(s.item),(async()=>{const e=await o.previewInventoryItem(t,s.item);d(e)})()}),[e,s]),s.item.description instanceof Lt?m=ir:s.item.description instanceof zt?m=rr:s.item.description instanceof Vt?m=sr:s.item.description instanceof It?m=nr:s.item.description instanceof Dt&&(m=ar),An.default.createElement(n.Frame,{tabIndex:t.tabIndex,onClick:t.onClick,onFocus:()=>l(!0),onBlur:()=>l(!1),style:{height:"100%",position:"relative",overflow:"hidden",padding:n.Spacing.m}},An.default.createElement("div",{className:"shop-item-cell-icon-background",style:{backgroundImage:`url(${m})`}}),An.default.createElement(hr,{shopItem:s,equipped:a,mouseOver:h,money:e.money,owned:r}),An.default.createElement(ua,null,An.default.createElement(pa,{src:c}),An.default.createElement("div",null,An.default.createElement(n.BalancedRow,{style:{textAlign:"center",fontSize:n.Typography.m}},An.default.createElement(ma,{icon:da,tooltip:pt("tooltipDamage"),itemStat:s.item.stats.damage,statDiff:p.damage-u.damage}),An.default.createElement(ma,{icon:la,tooltip:pt("tooltipDefense"),itemStat:s.item.stats.defense,statDiff:p.defense-u.defense}),An.default.createElement(ma,{icon:ca,tooltip:pt("tooltipMobility"),itemStat:s.item.stats.mobility,statDiff:p.mobility-u.mobility})))))}function cr(t){return An.default.createElement("div",{className:"shop-item-list"},t.children)}function dr(t){const[e,i]=(0,Un.J0)(t.itemStat);return(0,Un.vJ)((()=>{const s=t.itemStat-e;setTimeout((()=>{i(e+(0,ft.Tq)(-.01,s,.01))}),1e3/30)}),[e,t.itemStat]),An.default.createElement(ma,{icon:t.icon,tooltip:t.tooltip,itemStat:e})}function ur(t){var e,i;let s=0;const{baseStats:a,shop:r,previewMaker:o}=t,[h,l]=(0,Un.J0)(t.inventory),[c,d]=(0,Un.J0)(t.ownedItems),[u,p]=(0,Un.J0)(r.tools),[m,y]=(0,Un.J0)("");(0,Un.vJ)((()=>{(async()=>{const t=await o.previewFull(h);y(t)})()}),[h]);const w=(0,Un.Kr)((()=>a.clone().add(h.stats())),[h,a]);return An.default.createElement(Kn,{isModal:!0},An.default.createElement(Yn,null,An.default.createElement(jn,null,An.default.createElement(n.MainButton,{tabIndex:s++,onClick:t.onBackClicked,style:{backgroundImage:`url(${or})`,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"20px 20px",minWidth:"50px",minHeight:"50px"}})),An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},An.default.createElement("img",{src:na}),pt("inventory"))),An.default.createElement(Jn,null,An.default.createElement(n.VerticalCenter,null,An.default.createElement(n.BalancedRow,{style:{textAlign:"center",fontSize:n.Typography.m,gap:n.Spacing.s}},An.default.createElement(dr,{icon:da,tooltip:pt("tooltipDamage"),itemStat:w.damage}),An.default.createElement(dr,{icon:la,tooltip:pt("tooltipDefense"),itemStat:w.defense}),An.default.createElement(dr,{icon:ca,tooltip:pt("tooltipMobility"),itemStat:w.mobility}))))),An.default.createElement(Zn,null,An.default.createElement(n.TabLayout,{style:{textAlign:"center"}},An.default.createElement(n.Tab,{tabIndex:s++,selected:u===r.tools,onClick:()=>p(r.tools)},An.default.createElement("img",{src:rr})),An.default.createElement(n.Tab,{tabIndex:s++,selected:u===r.shields,onClick:()=>p(r.shields)},An.default.createElement("img",{src:nr})),An.default.createElement(n.Tab,{tabIndex:s++,selected:u===r.armors,onClick:()=>p(r.armors)},An.default.createElement("img",{src:ir})),An.default.createElement(n.Tab,{tabIndex:s++,selected:u===r.capes,onClick:()=>p(r.capes)},An.default.createElement("img",{src:ar})),An.default.createElement(n.Tab,{tabIndex:s++,selected:u===r.helmets,onClick:()=>p(r.helmets)},An.default.createElement("img",{src:sr}))),An.default.createElement(n.ScrollableContent,{key:null===(i=null===(e=Oi(u.items()))||void 0===e?void 0:e.item)||void 0===i?void 0:i.id,style:{flex:"1 0 0",padding:n.Spacing.m,background:"#111"}},An.default.createElement(cr,null,Array.from(u.items()).map((e=>c.has(e.item.id)?An.default.createElement("div",{key:e.item.id},An.default.createElement(lr,{baseStats:a.clone(),tabIndex:s++,shopItem:e,inventory:h,owned:c.has(e.item.id),equipped:h.itemIds().has(e.item.id),previewMaker:o,onClick:()=>{const i=h.clone();i.equip(e.item),l(i),t.onInventoryChanged(i)}})):null))))))}class pr extends Xn{constructor(t,e){super(),this.baseStats=t,this.inventory=e,this.id="inventory"}async rootComponent(){const t=xi(),e=new Set(await this.game.storage.ownedItems.get()||[]);return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(ur,{shop:t,baseStats:this.baseStats.clone(),previewMaker:new za(this.texturePool,this.game.plugin(m.W).renderer),inventory:this.inventory,ownedItems:e,onInventoryChanged:t=>this.onInventoryChanged(t),onBackClicked:()=>this.onBackKeyPressed()}))}async onBackKeyPressed(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve(this.inventory)}onInventoryChanged(t){var e;null===(e=this.game.plugin(w.p))||void 0===e||e.playSoundEffect((0,wt.F5)(this.game.soundPool.equipArmor)),this.inventory=t.clone()}}const mr=i.p+"infoac594bec52fc95111764.png";var yr=i(8218);class wr{constructor(t,e){this.shop=t,this.player=e}resolve(t){this.player.traitOfType(mn).inventory=t}}class gr{constructor(t){this.interactor=t}}var fr=i(4321);class vr extends zi.X{constructor(){super(...arguments),this.key=vr.key,this.currentInteractables=new Set,this.reusableInteractEvent=(0,xn.R)((()=>new gr(this.entity))),this.releasedInteract=!1}postBind(){super.postBind(),this.controllableTrait=this.dependency(Rs.key)}interact(){for(const t of this.currentInteractables){const e=this.world.entity(t);null==e||e.addEvent(this.reusableInteractEvent.value())}}cycle(t){const{interact:e}=this.controllableTrait.inputs;e||(this.releasedInteract=!0),e&&this.releasedInteract&&(this.releasedInteract=!1,this.interact())}}vr.key="interactor";class br extends zi.X{constructor(){super(...arguments),this.key=br.key,this.radius=100,this.hasInteractor=!1}cycle(){this.hasInteractor=!1;for(const t of this.world.traitsOfType(vr))(0,ft.Io)(t.entity.position,this.entity.position)<this.radius?(t.currentInteractables.add(this.entity.id),this.hasInteractor=!0):t.currentInteractables.delete(this.entity.id)}processEvent(t,e){if(t instanceof fr.w)for(const t of this.world.traitsOfType(vr))t.currentInteractables.delete(this.entity.id)}}br.key="interactable";class Tr extends zi.X{constructor(){super(...arguments),this.key=Tr.key,this.triggerOnDeath=null}postBind(){super.postBind(),this.instructionTrait=this.entity.traitOfType(Ts),this.interactableTrait=this.entity.traitOfType(br)}cycle(){this.instructionTrait&&(this.instructionTrait.enabled=this.interactableTrait.hasInteractor)}processEvent(t,e){var i;if(t instanceof Vi)this.enabled=!1,null===(i=e.entity(this.triggerOnDeath))||void 0===i||i.addEvent(new yr.V(this.entity.id));else if(t instanceof gr){const e=t.interactor;if(!this.shop){const{inventory:t}=e.traitOfType(mn);this.shop=function(t){const e=Ci(),i=new ki;return i.armors=Ei(e.armors,0,t.playerLevel),i.shields=Ei(e.shields,0,t.playerLevel),i.helmets=Ei(e.helmets,0,t.playerLevel),i.tools=Ei(e.tools,0,t.playerLevel),i.capes=Ei(e.capes,0,t.playerLevel),i.add(...Bt),i}({money:t.money,playerLevel:e.traitOfType(Xs).level})}this.entity.addEvent(new wr(this.shop,e))}}}Tr.key="merchant";class kr extends zi.X{constructor(){super(...arguments),this.key=kr.key}}function xr(t){const e=Math.cos(Math.PI/4)*t.width*.8;t.update(t.x-e,t.y,t.width+e,t.height)}kr.key="dirt-patch";class Cr extends zi.X{constructor(){super(...arguments),this.key=Cr.key,this.surfaceProvider=Cr.surfaceProvider}}function Er(t){return`<localized:${t}>`}Cr.key="merchant-stand",Cr.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));class Sr{constructor(){this.age=0}bind(t){this.entity=t}postBind(){this.controllableTrait=this.entity.traitOfType(Rs)}reset(){this.age=0}cycle(t){this.age+=t}get target(){var t,e,i;return Oi(null===(i=null===(e=null===(t=this.entity)||void 0===t?void 0:t.world)||void 0===e?void 0:e.entities)||void 0===i?void 0:i.bucket(ln.key))}onEvent(t,e){}get description(){return this.constructor.name}}class Mr extends zi.X{constructor(t=new Sr){super(),this.ai=t,this.key=Mr.key}postBind(){super.postBind(),this.ai.bind(this.entity),this.ai.postBind()}setAI(t){this.ai=t,this.entity&&(this.ai.bind(this.entity),this.ai.postBind())}get description(){var t;return null===(t=this.ai)||void 0===t?void 0:t.description}cycle(t){this.ai.cycle(t)}processEvent(t,e){this.ai.onEvent(t,e)}static registryEntry(){return(0,gs.W)((t=>{t.traitClass(Mr)}))}}Mr.key="ai";const Pr=Mr;class Ir extends zi.X{constructor(){super(...arguments),this.key=Ir.key}}Ir.key="ranger";class Ar{constructor(t){this.isRollDash=t}}class Or{}class Rr extends zi.X{constructor(){super(...arguments),this.key=Rr.key,this.lastDamage=0,this.burnEndAge=0,this.reusableBurnDamageEvent=new Or}postBind(){super.postBind(),this.healthTrait=this.dependency(ws.key),this.waterAffectedTrait=this.entity.traitOfType(Us)}get burning(){return this.entity.age<this.burnEndAge}burn(t){this.burnEndAge=Math.max(this.burnEndAge,this.entity.age+t)}cycle(t){this.burning&&(this.entity.age-this.lastDamage>1&&(this.healthTrait.damage(this.entity,5,16777215,ss.FIRE),this.lastDamage=this.entity.age,this.entity.addEvent(this.reusableBurnDamageEvent)),this.waterAffectedTrait.inWater&&(this.burnEndAge-=5*t))}processEvent(t,e){t instanceof Ar?t.isRollDash&&this.burning&&(this.burnEndAge=Math.min(this.burnEndAge,this.entity.age+.3),this.entity.addEvent(new Di)):t instanceof es&&(this.burnEndAge=0)}}Rr.key="burnable";class _r extends zi.X{constructor(t){super(),this.aggression=t,this.key=_r.key}postBind(){super.postBind(),this.token=Oi(this.world.traitsOfType(ds)).tracker.getToken(this.aggression)}processEvent(t,e){t instanceof fr.w&&Oi(this.world.traitsOfType(ds)).tracker.releaseToken(this.token)}}_r.key="aggressor";class Br extends zi.X{constructor(){super(...arguments),this.key=Br.key}}Br.key="brute";class Lr extends zi.X{constructor(){super(...arguments),this.key=Lr.key,this.isRollDash=!1,this.dashTimeLeft=0,this.dashStart=0,this.dashEnd=0,this.dashCount=0,this.rollDashCount=0}get dashing(){return this.dashTimeLeft>0}get rollRatio(){return this.isRollDash&&this.dashing?(this.entity.age-this.dashStart)/(this.dashEnd-this.dashStart):0}postBind(){super.postBind(),this.pushableTrait=this.dependency(qs.key),this.characterTrait=this.dependency(hn.key),this.staminaTrait=this.entity.traitOfType(Ys),this.walkerTrait=this.dependency(Ws.key),this.meleeVictimTrait=this.dependency(ks.key)}simpleDash(t){var e;this.walkerTrait.enabled=!1,this.walkerTrait.walking=!1,this.meleeVictimTrait.enabled=!1,this.isRollDash=!1,this.dashCount++,this.dashStart=this.entity.age,this.dashTimeLeft=.3,this.dashEnd=this.entity.age+this.dashTimeLeft,this.pushableTrait.push(t,this.characterTrait.stats.dashDistance(),.2),null===(e=this.staminaTrait)||void 0===e||e.loseStamina(this.characterTrait.stats.dashStaminaLoss()),this.entity.addEvent(new Ar(!1))}doubleDash(t){var e;this.walkerTrait.enabled=!1,this.walkerTrait.walking=!1,this.meleeVictimTrait.enabled=!1,this.isRollDash=!0,this.rollDashCount++,this.dashStart=this.entity.age,this.dashTimeLeft=.3,this.dashEnd=this.entity.age+this.dashTimeLeft,this.pushableTrait.push(t,this.characterTrait.stats.rollDistance(),.3),null===(e=this.staminaTrait)||void 0===e||e.loseStamina(this.characterTrait.stats.rollStaminaLoss()),this.entity.addEvent(new Ar(!0))}cycle(t){this.dashing&&(this.dashTimeLeft-=t)<=0&&(this.walkerTrait.enabled=!0,this.meleeVictimTrait.enabled=!0,this.isRollDash=!1)}}Lr.key="dasher";class Dr{}class Vr{}class Hr{constructor(){this.charged=!1,this.consecutiveAttackCount=0,this.comboCount=0}}class Fr{constructor(){this.age=0}bind(t){this.stateMachine=t}onEnter(t){this.age=0,this.previousState=t}onExit(){}cycle(t){this.age+=t}transition(t){if(this.stateMachine.currentState===this)return this.stateMachine.transition(t)}}class Nr{constructor(){this.currentState=null,this.currentStateExited=!1}transition(t){const e=this.currentState;e&&!this.currentStateExited&&(this.currentStateExited=!0,null==e||e.onExit()),this.currentState===e&&(this.currentState=t,this.currentStateExited=!1,this.currentState.bind(this),this.currentState.onEnter(e||this.currentState),this.currentState.cycle(0))}cycle(t){var e;null===(e=this.currentState)||void 0===e||e.cycle(t)}}var Ur,Wr=i(7602);class Xr extends zi.X{constructor(){super(...arguments),this.key=Xr.key,this.queriable=!0,this.surfaceProvider=Xr.surfaceProvider}}Xr.key="colliding",Xr.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.position.x,t.entity.position.y,1,1)})),function(t){t[t.CIRCLE=0]="CIRCLE",t[t.RECTANGLE=1]="RECTANGLE"}(Ur||(Ur={}));class Gr extends zi.X{get maxRadius(){return Math.max(this.radiusX,this.radiusY)}constructor(t,e=t,i=Ur.CIRCLE){super(),this.radiusX=t,this.radiusY=e,this.shape=i,this.key=Gr.key,this.nearbyColliders=new Vs.w(1,(()=>this.entity.age),(()=>{const{maxRadius:t}=this;return this.reusableQuery.centerAround(this.entity.position.x,this.entity.position.y,4*t,4*t),Array.from(this.world.sectorSet(Xr.key).query(this.reusableQuery))})),this.reusableQuery=new Wr.M}cycle(){const t=this.nearbyColliders.value;for(const e of t)e!==this.entity&&e.traitOfType(Xr).enabled&&this.handleCollision(e)}handleCollision(t){if(this.shape==Ur.CIRCLE){const e=ls(this.entity.position,t.position),i=Math.abs(Math.cos(e)*this.radiusX),s=Math.abs(Math.sin(e)*this.radiusY);t.position.x=(0,ft.o8)(this.entity.x-i,t.position.x,this.entity.x+i),t.position.y=(0,ft.o8)(this.entity.y-s,t.position.y,this.entity.y+s)}else if(this.shape===Ur.RECTANGLE){if(!(0,ft.Bt)(this.entity.x-this.radiusX,t.position.x,this.entity.x+this.radiusX))return;if(!(0,ft.Bt)(this.entity.y-this.radiusY,t.position.y,this.entity.y+this.radiusY))return;Math.abs(t.position.x-this.entity.x)/this.radiusX>Math.abs(t.position.y-this.entity.y)/this.radiusY?t.position.x=(0,ft.o8)(this.entity.x-this.radiusX,t.position.x,this.entity.x+this.radiusX):t.position.y=(0,ft.o8)(this.entity.y-this.radiusY,t.position.y,this.entity.y+this.radiusY)}}}Gr.key="obstacle";class zr extends Nr{constructor(t){super(),this.entity=t}}class Kr extends Fr{get entity(){return this.stateMachine.entity}bind(t){super.bind(t),this.controllableTrait=this.stateMachine.entity.traitOfType(Rs),this.walkerTrait=this.stateMachine.entity.traitOfType(Ws),this.pushableTrait=this.stateMachine.entity.traitOfType(qs),this.healthTrait=this.stateMachine.entity.traitOfType(ws),this.inventoryTrait=this.stateMachine.entity.traitOfType(mn),this.meleeAttackerTrait=this.stateMachine.entity.traitOfType(tn),this.dasherTrait=this.stateMachine.entity.traitOfType(Lr),this.obstacleTrait=this.stateMachine.entity.traitOfType(Gr),this.horseTrait=this.stateMachine.entity.traitOfType(Qr)}maybeBecomeStunned(){return!!this.healthTrait.recentlyDamaged(.1)&&(this.transition(new jr),!0)}}class Yr extends Kr{cycle(t){super.cycle(t),this.maybeBecomeStunned()||(this.controllableTrait.inputs.lightStrike?this.transition(new $r(!1,0)):this.controllableTrait.inputs.heavyStrike&&this.transition(new $r(!0,0)))}}class qr extends Kr{constructor(){super(...arguments),this.angle=0,this.lastAttack=0}onEnter(t){super.onEnter(t),this.angle=this.meleeAttackerTrait.aimAngle,this.dasherTrait.simpleDash(this.angle)}cycle(t){if(super.cycle(t),this.age-this.lastAttack>.1){const t=new Hr;t.charged=!1,t.comboCount=0,t.consecutiveAttackCount=0,this.meleeAttackerTrait.strike(t),this.lastAttack=this.age}this.dasherTrait.dashing||this.transition(new Zr(this.angle))}}class jr extends Kr{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.age>.3&&this.transition(new Yr)}}class $r extends Kr{constructor(t,e){super(),this.heavy=t,this.consecutiveAttackCount=e,this.releasedCharge=!1}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.meleeAttackerTrait.preparingAttack=this.heavy?Ls.HEAVY:Ls.LIGHT,this.entity.addEvent(new Vr)}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.meleeAttackerTrait.preparingAttack=Ls.NONE}cycle(t){super.cycle(t),this.releasedCharge=this.releasedCharge||!this.controllableTrait.inputs.heavyStrike;const e=this.heavy||this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD&&!this.releasedCharge?this.meleeAttackerTrait.heavyStrikeChargeTime:this.meleeAttackerTrait.lightStrikeChargeTime;this.meleeAttackerTrait.preparationRatio=this.age/e,!this.maybeBecomeStunned()&&this.age>e&&((this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?!this.releasedCharge:this.heavy)?(this.entity.addEvent(new Dr),this.transition(new qr)):this.transition(new Jr))}}class Jr extends Kr{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.entity.addEvent(new sn(!1));const e=this.meleeAttackerTrait.lungeVictim;let i=this.meleeAttackerTrait.aimAngle,s=40;e&&(i=ls(this.entity,e),s=Math.max(0,(0,ft.Io)(this.entity,e)-this.meleeAttackerTrait.strikeRadiusX/3)),this.pushableTrait.push(i,s,.1)}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.meleeAttackerTrait.preparingAttack=Ls.NONE}cycle(t){if(super.cycle(t),this.age>.15){const t=new Hr;t.charged=!1,t.comboCount=0,t.consecutiveAttackCount=0,this.meleeAttackerTrait.strike(t),this.transition(new Yr)}}}class Zr extends Kr{constructor(t){super(),this.angle=t}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.age>.2&&this.transition(new Yr)}}class Qr extends zi.X{constructor(){super(...arguments),this.key=Qr.key}get rider(){return this.entity.world.entity(this.riderId)}postBind(){super.postBind(),this.walkerTrait=this.dependency(Ws.key),this.controllableTrait=this.dependency(Rs.key),this.meleeAttackerTrait=this.dependency(tn.key),this.collidingTrait=this.dependency(Xr.key),this.stateMachine=new zr(this.entity),this.stateMachine.transition(new Yr)}cycle(t){const{rider:e}=this;if(e){const t=this.controllableTrait.inputs,i=e.traitOfType(Rs).inputs;t.movement.angle=i.movement.angle,t.movement.force=i.movement.force,t.dash=i.dash,t.aim.x=i.aim.x,t.aim.y=i.aim.y,t.heavyStrike=i.heavyStrike,t.lightStrike=i.lightStrike,t.shield=i.shield,t.interact=i.interact}else this.collidingTrait.enabled=!1;this.meleeAttackerTrait.aimAngle=ls(this.entity.position,this.controllableTrait.inputs.aim),this.stateMachine.cycle(t),this.walkerTrait.enabled&&(this.walkerTrait.facing=Math.sign(Math.cos(this.meleeAttackerTrait.aimAngle))||this.walkerTrait.facing)}processEvent(t,e){var i;t instanceof Xi&&t.isPerfect&&(null===(i=this.rider)||void 0===i||i.addEvent(t))}}Qr.key="horse";class to extends zi.X{constructor(){super(...arguments),this.key=to.key}postBind(){super.postBind(),this.collidingTrait=this.entity.traitOfType(Xr),this.obstacleTrait=this.entity.traitOfType(Gr),this.healthTrait=this.dependency(ws.key)}get horse(){var t;return null===(t=this.entity.world)||void 0===t?void 0:t.entity(this.horseId)}cycle(t){const{horse:e}=this;this.obstacleTrait&&(this.obstacleTrait.enabled=!e),this.collidingTrait&&(this.collidingTrait.enabled=!e),e&&(e.traitOfType(Qr).riderId=this.entity.id,this.entity.position.x=e.position.x,this.entity.position.y=e.position.y,this.healthTrait.health=this.healthTrait.maxHealth)}processEvent(t,e){var i,s;if(t instanceof fr.w){const t=null===(i=this.horse)||void 0===i?void 0:i.traitOfType(Qr);t&&(t.riderId=null)}else if(t instanceof Zs){const t=null===(s=this.horse)||void 0===s?void 0:s.traitOfType(Qr);t&&(t.riderId=null),this.horseId=null,t&&this.entity.addEvent(new Hi)}else t instanceof Xi&&t.isPerfect&&this.entity.traitOfType(Qs).stagger(this.entity)}}to.key="horse-rider";class eo{}class io extends Nr{constructor(t){super(),this.entity=t}}class so extends Fr{constructor(){super(...arguments),this.toolCharge=0,this.shieldCharge=0,this.striking=!1}get entity(){return this.stateMachine.entity}bind(t){super.bind(t),this.controllableTrait=this.stateMachine.entity.traitOfType(Rs),this.walkerTrait=this.stateMachine.entity.traitOfType(Ws),this.staminaTrait=this.stateMachine.entity.traitOfType(Ys),this.pushableTrait=this.stateMachine.entity.traitOfType(qs),this.healthTrait=this.stateMachine.entity.traitOfType(ws),this.inventoryTrait=this.stateMachine.entity.traitOfType(mn),this.meleeAttackerTrait=this.stateMachine.entity.traitOfType(tn),this.dasherTrait=this.stateMachine.entity.traitOfType(Lr),this.shieldableTrait=this.stateMachine.entity.traitOfType(js),this.staggerableTrait=this.stateMachine.entity.traitOfType(Qs),this.comboTrackerTrait=this.stateMachine.entity.traitOfType(fn),this.horseRiderTrait=this.stateMachine.entity.traitOfType(to),this.waterAffectedTrait=this.stateMachine.entity.traitOfType(Us)}hasShield(){var t,e;return this.inventoryTrait.inventory.shield&&!((null===(t=this.inventoryTrait.inventory.shield)||void 0===t?void 0:t.description)instanceof At)&&!(null===(e=this.horseRiderTrait)||void 0===e?void 0:e.horse)}maybeBecomeExhausted(){return!!this.staminaTrait.exhausted&&(this.transition(new ho),!0)}maybeBecomeStunned(){return!!this.healthTrait.recentlyDamaged(.1)&&(this.transition(new oo),!0)}onEvent(t){}}class no extends so{constructor(){super(...arguments),this.releasedShield=!1}cycle(t){super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.2),this.shieldCharge=gt(this.previousState.shieldCharge,0,this.age/.1),this.releasedShield=this.releasedShield||!this.controllableTrait.inputs.shield,this.maybeBecomeExhausted()||this.maybeBecomeStunned()||(!this.controllableTrait.inputs.dash||this.horseRiderTrait.horse||this.waterAffectedTrait.inWater?this.controllableTrait.inputs.shield&&this.releasedShield&&this.hasShield()?this.transition(new go):this.controllableTrait.inputs.lightStrike?this.transition(new lo(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD,0)):this.controllableTrait.inputs.heavyStrike&&this.transition(new lo(!0,0)):this.transition(new ao))}}class ao extends so{constructor(){super(...arguments),this.releasedDash=!1,this.angle=0}onEnter(t){super.onEnter(t),this.angle=this.controllableTrait.inputs.movement.angle,this.dasherTrait.simpleDash(this.angle)}cycle(t){if(super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,1,.3*this.age/.1),!this.dasherTrait.dashing&&!this.waterAffectedTrait.inWater)return void this.transition(new fo(this.angle));const{dash:e}=this.controllableTrait.inputs;this.releasedDash=this.releasedDash||!e,e&&this.releasedDash&&this.transition(new ro(this.angle))}}class ro extends so{constructor(t){super(),this.angle=t}onEnter(t){super.onEnter(t),this.dasherTrait.doubleDash(this.angle)}cycle(t){super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,1,this.age/.1),this.walkerTrait.facing=Math.sign(Math.cos(this.angle))||1,this.dasherTrait.dashing||this.transition(new vo)}}class oo extends so{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeExhausted()||(this.age>.3?this.transition(new no):this.controllableTrait.inputs.shield&&this.hasShield()&&this.transition(new go))}}class ho extends so{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,-1,this.age/.1),this.shieldCharge=gt(this.previousState.shieldCharge,0,this.age/.1),this.staminaTrait.stamina>=1&&this.transition(new no)}}class lo extends so{constructor(t,e){super(),this.heavy=t,this.consecutiveAttackCount=e}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.meleeAttackerTrait.preparingAttack=this.heavy?Ls.HEAVY:Ls.LIGHT,this.entity.addEvent(new Vr)}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.meleeAttackerTrait.preparingAttack=Ls.NONE}cycle(t){let e;super.cycle(t);let i=this.consecutiveAttackCount>0?this.meleeAttackerTrait.lightStrikeChargeTime:this.meleeAttackerTrait.heavyStrikeChargeTime;e=this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?i:this.heavy&&0===this.consecutiveAttackCount?this.meleeAttackerTrait.heavyStrikeChargeTime:this.meleeAttackerTrait.lightStrikeChargeTime;const s=this.heavy||this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?1:.5,n=gt(0,1,this.age/e*s);this.toolCharge=gt(this.previousState.toolCharge,n,this.age/.1+1),this.meleeAttackerTrait.preparationRatio=this.age/e,this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?this.age>i?this.transition(new co(!0,this.consecutiveAttackCount)):this.controllableTrait.inputs.lightStrike||this.transition(new co(!1,this.consecutiveAttackCount)):this.age>e&&this.transition(new co(this.heavy,this.consecutiveAttackCount)))}}class co extends so{constructor(t,e){super(),this.heavy=t,this.consecutiveAttackCount=e,this.didTryToStrikeAgain=Ls.NONE,this.attack=(()=>{var t;const e=new Hr;return e.charged=this.heavy,e.consecutiveAttackCount=this.consecutiveAttackCount,e.comboCount=(null===(t=this.comboTrackerTrait)||void 0===t?void 0:t.combo)||0,e})()}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.entity.addEvent(new sn(this.heavy)),this.heavy&&this.entity.addEvent(new Dr);const e=this.meleeAttackerTrait.lungeVictim;let i=this.meleeAttackerTrait.aimAngle,s=40;e&&(i=ls(this.entity,e),s=Math.max(0,(0,ft.Io)(this.entity,e)-this.meleeAttackerTrait.strikeRadiusX/3)),this.pushableTrait.push(i,s,.1)}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.entity.addEvent(new nn(this.attack))}cycle(t){var e,i;if(super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted())return;(this.controllableTrait.inputs.lightStrike||this.controllableTrait.inputs.heavyStrike)&&(this.didTryToStrikeAgain=this.controllableTrait.inputs.lightStrike?Ls.LIGHT:Ls.NONE);const s=gt(0,1,this.heavy?1:Math.max(.2+.2*this.consecutiveAttackCount,this.previousState.toolCharge))+.2;if(this.age<.05?(this.toolCharge=gt(this.previousState.toolCharge,s,this.age/.05),this.striking=!1):(this.toolCharge=gt(s,-1,(this.age-.05)/(.15-.05)),this.striking=!0),this.age>.15){if(this.entity.traitOfType(Ir))return void this.transition(new uo);const t=this.meleeAttackerTrait.strike(this.attack);if(t===Bs.BLOCKED)return void this.transition(new mo);if(t===Bs.PARRIED)return void this.transition(new yo);if(this.heavy||this.consecutiveAttackCount>=(null===(i=null===(e=this.inventoryTrait.inventory.tool)||void 0===e?void 0:e.description)||void 0===i?void 0:i.consecutiveAttackCount)-1)this.transition(new wo);else if(this.didTryToStrikeAgain!==Ls.NONE){const t=this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD||this.didTryToStrikeAgain===Ls.HEAVY;this.transition(new lo(t,this.consecutiveAttackCount+1))}else this.transition(new po(this.consecutiveAttackCount))}}}class uo extends so{onEnter(t){super.onEnter(t),this.tool=this.inventoryTrait.inventory.tool,this.entity.traitOfType(on)&&(this.inventoryTrait.inventory.tool=null)}onExit(){super.onExit(),this.inventoryTrait.inventory.equip(this.tool)}cycle(t){super.cycle(t),this.entity.traitOfType(on)?this.toolCharge=gt(this.previousState.toolCharge,-1,this.age/.1):this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.1),this.age>1&&this.transition(new no)}}class po extends so{constructor(t){super(),this.consecutiveAttackCount=t}cycle(t){if(super.cycle(t),!this.maybeBecomeStunned()&&!this.maybeBecomeExhausted())if(this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.05),this.controllableTrait.inputs.lightStrike||this.controllableTrait.inputs.heavyStrike){const t=this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD||this.controllableTrait.inputs.heavyStrike;this.transition(new lo(t,this.consecutiveAttackCount))}else this.controllableTrait.inputs.dash&&!this.waterAffectedTrait.inWater?this.transition(new ao):this.controllableTrait.inputs.shield&&this.hasShield()?this.transition(new go):this.age>.3&&this.transition(new no)}}class mo extends so{cycle(t){super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.2),this.maybeBecomeExhausted()||this.age>.2&&this.transition(new no)}}class yo extends so{onEnter(t){super.onEnter(t),this.walkerTrait.enabled=!1}onExit(){super.onExit(),this.walkerTrait.enabled=!0}cycle(t){super.cycle(t),this.toolCharge=gt(this.previousState.toolCharge,-1.5,this.age/.2),this.maybeBecomeExhausted()||this.age>1&&this.transition(new no)}}class wo extends so{cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.5),this.controllableTrait.inputs.dash&&!this.waterAffectedTrait.inWater?this.transition(new ao):this.controllableTrait.inputs.shield&&this.hasShield()?this.transition(new go):this.age>.5&&this.transition(new no))}}class go extends so{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.shieldableTrait.isHoldingShield=!0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.shieldableTrait.isHoldingShield=!1}cycle(t){super.cycle(t),this.maybeBecomeExhausted()||(this.shieldCharge=gt(this.previousState.shieldCharge,1,this.age/.1),this.toolCharge=gt(this.previousState.toolCharge,1,this.age/.1),this.controllableTrait.inputs.shield||this.transition(new no))}onEvent(t){(t instanceof Gs&&t.attack.charged||t instanceof Wi&&t.attack.charged)&&(this.entity.addEvent(new eo),this.transition(new no))}}class fo extends so{constructor(t){super(),this.angle=t}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.1),this.controllableTrait.inputs.dash||(this.controllableTrait.inputs.shield&&this.hasShield()?this.transition(new go):this.age>.2&&this.transition(new no)))}}class vo extends so{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.toolCharge=gt(this.previousState.toolCharge,0,this.age/.1),this.age>.3?this.transition(new no):this.controllableTrait.inputs.shield&&this.hasShield()&&this.transition(new go))}}class bo extends so{constructor(){super(...arguments),this.triggeredEvent=!1}onEnter(t){super.onEnter(t),this.toolCharge=-1.5,this.walkerTrait.enabled=!1}onExit(){super.onExit(),this.walkerTrait.enabled=!0}cycle(t){super.cycle(t),this.staggerableTrait.staggered||this.transition(new To),this.age>.2&&!this.triggeredEvent&&(this.entity.addEvent(new bo),this.triggeredEvent=!0)}}class To extends so{onEnter(t){super.onEnter(t),this.toolCharge=-1.5,this.walkerTrait.enabled=!1}onExit(){super.onExit(),this.walkerTrait.enabled=!0}get progress(){return Math.min(1,this.age/.3)}cycle(t){super.cycle(t),this.toolCharge=-1.5,this.staggerableTrait.recoveryProgress>=1&&this.transition(new no)}}class ko extends zi.X{constructor(){super(...arguments),this.key=ko.key}postBind(){super.postBind(),this.walkerTrait=this.dependency(Ws.key),this.controllableTrait=this.dependency(Rs.key),this.meleeAttackerTrait=this.dependency(tn.key),this.stateMachine=new io(this.entity),this.stateMachine.transition(new no)}cycle(t){if(this.meleeAttackerTrait.aimAngle=ls(this.entity.position,this.controllableTrait.inputs.aim),this.meleeAttackerTrait.fov=this.controllableTrait.aimMode===Is.INDEPENDENT?Math.PI/2+Math.PI/16:Math.PI,this.walkerTrait.enabled){const t=Math.cos(this.meleeAttackerTrait.aimAngle);Math.abs(t)>.01&&(this.walkerTrait.facing=Math.sign(t)||this.walkerTrait.facing)}this.stateMachine.cycle(t)}processEvent(t,e){if(this.stateMachine.currentState.onEvent(t),t instanceof Zs){const e=ls(t.attacker,this.entity);this.entity.traitOfType(qs).push(e,80,.2),this.stateMachine.currentState.transition(new bo),this.walkerTrait.facing=Math.sign(t.attacker.position.x-this.entity.position.x)||this.walkerTrait.facing}else t instanceof es&&(this.entity.traitOfType(Qs).stagger(this.entity),this.entity.traitOfType(qs).cancelAllPushes(),this.stateMachine.currentState.transition(new To))}}ko.key="knight";class xo extends zi.X{constructor(){super(...arguments),this.key=xo.key,this.bounds=new Wr.M(0,0,2e3,2e3),this.absoluteBounds=new Wr.M(0,0,2e3,2e3)}cycle(t){let{minX:e,minY:i,maxX:s,maxY:n}=this.bounds;e=(0,ft.Tq)(this.absoluteBounds.minX,e,this.absoluteBounds.maxX),s=(0,ft.Tq)(this.absoluteBounds.minX,s,this.absoluteBounds.maxX),i=(0,ft.Tq)(this.absoluteBounds.minY,i,this.absoluteBounds.maxY),n=(0,ft.Tq)(this.absoluteBounds.minY,n,this.absoluteBounds.maxY),this.bounds.update(e,i,s-e,n-i)}}xo.key="world-bounds";class Co extends zi.X{constructor(){super(...arguments),this.key=Co.key,this.paddingX=0,this.paddingY=0,this.reusableRectangle=new Wr.M}cycle(){var t;const e=null===(t=Oi(this.world.traitsOfType(xo)))||void 0===t?void 0:t.bounds;e&&(this.reusableRectangle.copy(e),this.reusableRectangle.pad(this.paddingX,this.paddingY),this.reusableRectangle.containsPoint(this.entity.position)||(this.entity.position.x=(0,ft.Tq)(this.reusableRectangle.minX,this.entity.position.x,this.reusableRectangle.maxX),this.entity.position.y=(0,ft.Tq)(this.reusableRectangle.minY,this.entity.position.y,this.reusableRectangle.maxY)))}}Co.key="within-world-bounds";class Eo extends zi.X{constructor(){super(...arguments),this.key=Eo.key}postBind(){super.postBind(),this.withinWorldBoundsTrait=this.dependency(Co.key)}cycle(t){var e;if(this.withinWorldBoundsTrait.enabled)return;const i=null===(e=Oi(this.world.traitsOfType(xo)))||void 0===e?void 0:e.bounds;i&&i.containsPoint(this.entity.position)&&(this.withinWorldBoundsTrait.enabled=!0)}}Eo.key="keep-within-world-bounds";class So extends Error{}class Mo extends Error{}class Po extends Error{constructor(t){super(),this.attacker=t}}class Io extends Error{}class Ao extends Error{}class Oo{constructor(){this.age=0}get isRelevant(){return!!this.resolve}bind(t){this.entity=t,this.controllableTrait=this.entity.traitOfType(Rs),this.healthTrait=this.entity.traitOfType(ws),this.meleeAttackerTrait=this.entity.traitOfType(tn)}postBind(){}start(){return new Promise(((t,e)=>{this.resolve=t,this.reject=e,this.onStart()}))}finish(t=null){const{resolve:e,reject:i}=this;this.resolve=null,this.reject=null,this.onExit(),t?null==i||i.call(null,t):null==e||e.call(null)}onStart(){}onExit(){}onEvent(t,e){}cycle(t){this.age+=t}get description(){return this.constructor.name}}class Ro extends Oo{constructor(t){super(),this.conditions=t}bind(t){super.bind(t);for(const e of this.conditions)e.bind(t)}postBind(){super.postBind();for(const t of this.conditions)t.postBind()}async onStart(){super.onStart(),Promise.all(this.conditions.map((t=>t.start()))).then((()=>this.finish())).catch((t=>this.finish(t)))}onExit(){super.onExit(),this.conditions.forEach((t=>t.onExit()))}cycle(t){super.cycle(t);for(const e of this.conditions)e.cycle(t)}}class _o extends Oo{constructor(t){super(),this.conditions=t}bind(t){super.bind(t);for(const e of this.conditions)e.bind(t)}postBind(){super.postBind();for(const t of this.conditions)t.postBind()}async onStart(){super.onStart(),Promise.race(this.conditions.map((t=>t.start()))).then((()=>this.finish())).catch((t=>this.finish(t)))}onExit(){super.onExit(),this.conditions.forEach((t=>t.onExit()))}cycle(t){super.cycle(t);for(const e of this.conditions)e.isRelevant&&e.cycle(t)}}class Bo extends Oo{constructor(t){super(),this.conditions=t}bind(t){super.bind(t);for(const e of this.conditions)e.bind(t)}postBind(){super.postBind();for(const t of this.conditions)t.postBind()}async onStart(){super.onStart(),(async()=>{try{for(const t of this.conditions)this.currentCondition=t,await t.start(),this.currentCondition=null;this.finish()}catch(t){this.finish(t)}})()}onExit(){var t;super.onExit(),null===(t=this.currentCondition)||void 0===t||t.onExit(),this.currentCondition=null}cycle(t){super.cycle(t);const{currentCondition:e}=this;(null==e?void 0:e.isRelevant)&&e.cycle(t)}}class Lo extends Oo{constructor(t){super(),this.cycleCallback=t}cycle(t){super.cycle(t);try{this.cycleCallback(this)}catch(t){this.finish(t)}}}function Do(t){return new Lo((({age:e})=>{if(e>t)throw new So("Timeout reached")}))}function Vo(t){return new Lo((e=>{e.age>t&&e.finish()}))}function Ho(){return new Lo((({healthTrait:t})=>{if(t.recentlyDamaged(.1))throw new Mo}))}function Fo(){return new Lo((({entity:t})=>{const e=Oi(t.world.entities.bucket(ln.key));if(e&&e.traitOfType(tn).preparingAttack!==Ls.NONE&&e.traitOfType(tn).lungeVictim===t)throw new Po(e)}))}function No(t){return new Lo((({entity:e})=>{if(!(t.world&&t.traitOfType(ws).health>0))throw new Ao}))}function Uo(){return new Lo((()=>{}))}class Wo extends Oo{constructor(t,e){super(),this.target=t,this.radius=e,this.path=[]}onStart(){super.onStart()}onExit(){super.onExit(),this.controllableTrait.inputs.movement.force=0}cycle(t){super.cycle(t);const e=this.path[0]||this.target,i=ls(this.entity.position,e);this.controllableTrait.inputs.movement.angle=i,this.controllableTrait.inputs.movement.force=1,(0,ft.Io)(this.entity,e)<this.radius&&this.path.shift(),(0,ft.Io)(this.entity,this.target)<this.radius&&this.finish()}}class Xo extends Oo{constructor(t,e){super(),this.target=t,this.radius=e}onExit(){super.onExit(),this.controllableTrait.inputs.movement.force=0}cycle(t){super.cycle(t);const e=ls(this.entity.position,this.target.position);this.controllableTrait.inputs.movement.angle=e+Math.PI,this.controllableTrait.inputs.movement.force=(0,ft.Io)(this.target.position,this.entity.position)<this.radius?1:0}}class Go extends Oo{constructor(t){super(),this.duration=t}cycle(t){super.cycle(t),this.age>this.duration&&this.finish()}}class zo extends Oo{constructor(t){super(),this.target=t}cycle(t){super.cycle(t);const e=ls(this.entity,this.target);this.controllableTrait.inputs.aim.x=this.entity.position.x+999*Math.cos(e),this.controllableTrait.inputs.aim.y=this.entity.position.y+999*Math.sin(e),this.finish()}}function Ko(t){return new Lo((({controllableTrait:e,entity:i})=>{const s=ls(i,t);e.inputs.aim.x=i.position.x+999*Math.cos(s),e.inputs.aim.y=i.position.y+999*Math.sin(s)}))}function Yo(...t){return new Ro(t)}function qo(...t){return new _o(t)}function jo(...t){return new Bo(t)}class $o extends Oo{constructor(t){super(),this.target=t,this.didDash=!1}postBind(){super.postBind(),this.dasherTrait=this.entity.traitOfType(Lr)}onExit(){super.onExit(),this.controllableTrait.inputs.dash=!1,this.controllableTrait.inputs.movement.force=0}cycle(t){super.cycle(t);const{dashing:e}=this.dasherTrait;if(this.didDash=this.didDash||e,this.didDash&&!e)this.finish();else{const t=ls(this.entity,this.target);this.controllableTrait.inputs.movement.angle=t,this.controllableTrait.inputs.movement.force=1,this.controllableTrait.inputs.dash=!0}}}class Jo extends Oo{cycle(t){super.cycle(t);const e=Oi(this.entity.world.traitsOfType(ds));if(!e)return;const{token:i}=this.entity.traitOfType(_r);e.tracker.requestAggression(i)&&this.finish()}}class Zo extends Oo{cycle(t){super.cycle(t);const e=Oi(this.entity.world.traitsOfType(ds));if(!e)return;const{token:i}=this.entity.traitOfType(_r);e.tracker.releaseAggression(i),this.finish()}}class Qo extends Oo{constructor(t){super(),this.heavy=t,this.didPrepareAttack=!1}cycle(t){super.cycle(t);const e=this.meleeAttackerTrait.preparingAttack!==Ls.NONE;this.didPrepareAttack||(e?(this.didPrepareAttack=!0,this.controllableTrait.inputs.lightStrike=!1,this.controllableTrait.inputs.heavyStrike=!1):this.heavy?this.controllableTrait.inputs.heavyStrike=!0:this.controllableTrait.inputs.lightStrike=!0),this.didPrepareAttack&&!e&&this.finish()}onExit(){super.onExit(),this.controllableTrait.inputs.lightStrike=!1,this.controllableTrait.inputs.heavyStrike=!1}}class th extends Oo{onStart(){super.onStart(),this.controllableTrait.inputs.shield=!0}onExit(){super.onExit(),this.controllableTrait.inputs.shield=!1}}class eh extends Oo{constructor(t,e){super(),this.target=t,this.radius=e}cycle(t){super.cycle(t),this.controllableTrait.inputs.shield=(0,ft.Io)(this.entity,this.target)<this.radius}onExit(){super.onExit(),this.controllableTrait.inputs.shield=!1}}class ih extends Sr{constructor(t){super(),this.script=t,this.conditions=[]}postBind(){super.postBind(),this.script(this)}async start(t){try{t.bind(this.entity),t.postBind(),this.conditions.push(t),await t.start()}finally{this.removeCondition(t)}}removeCondition(t){const e=this.conditions.indexOf(t);e>=0&&this.conditions.splice(e,1)}cycle(t){super.cycle(t);for(const e of Array.from(this.conditions))e.cycle(t)}onEvent(t,e){for(const i of Array.from(this.conditions))i.onEvent(t,e)}get description(){return this.conditions.map((t=>t.description)).join("\n")}}function sh(t){const e=t.reduce(((t,[e])=>t+e),0),i=Math.random()*e;let s=0;for(const[e,n]of t)if(s+=e,i<s)return n;return t[t.length-1][1]}function nh(){return new ih((async t=>{const{entity:e}=t;function i(){return gt(1,.1,e.traitOfType(hn).stats.normalized().defense)}async function s(e){await t.start(new Go(i())),await t.start(qo(new eh(e.attacker,200),Vo(1)))}function n(){return gt(0,.5,e.traitOfType(hn).stats.normalized().mobility)}async function a(i){e.traitOfType(Lr)&&(0,wt.sI)(n())&&await t.start(qo(new $o(i),Vo(.2))),await t.start(qo(Do(4),new Wo(i,80),Ko(i),No(i)))}async function r(){await t.start(new Go(i())),await t.start(qo(new th,Vo(1)))}async function o(i){const s=function(){if(e.traitOfType(Br))return[Ls.HEAVY];const{tool:t}=e.traitOfType(mn).inventory,i=e.traitOfType(hn).stats,s=[];for(let e=0;e<t.description.consecutiveAttackCount;e++)s.push(Ls.LIGHT);const n=[];for(let e=0;e<t.description.consecutiveAttackCount-1;e++)n.push(Ls.LIGHT);n.push(Ls.HEAVY);const a=[Ls.HEAVY],r=[Ls.LIGHT];return sh([[1-i.damage,r],[1-i.damage+i.mobility,s],[i.damage,a],[i.damage+i.mobility,n]])}(),n=e.traitOfType(hn).stats.normalized(),a=[];for(const t of s)a.push(new zo(i)),a.push(new Qo(t===Ls.HEAVY));const r=gt(0,1,n.defense),o=(0,wt.sI)(r);await t.start(qo(jo(...a),No(i),o?Ho():Uo(),o?new Lo((({meleeAttackerTrait:t})=>{if(t.recentlyParriedOrBlocked(.1))throw new Io})):Uo())),await t.start(new Zo);const h=gt(1,.2,n.defense);await t.start(new Go(h))}async function h(i){const s=e.traitOfType(Lr)&&(0,wt.sI)(n()),a=ls(e.position,i.position),r=new Zi.I(e.x+200*Math.cos(a+Math.PI),e.y+200*Math.sin(a+Math.PI)),{bounds:o}=Oi(e.world.traitsOfType(xo));o.containsPoint(r)||(r.x=e.x+200*Math.cos(a),r.y=e.y+200*Math.sin(a)),s?(await t.start(qo(new $o(r),Vo(.2))),await t.start(qo(new Go(1),Ho()))):await t.start(qo(Ko(i),Yo(new eh(i,150),Vo(2)),qo(new Wo(r,10),Do(4)),Fo()))}for(;;){await t.start(new Zo),await t.start(new Go(1));const{target:e}=t;if(e){try{await t.start(qo(new Wo(e,300),Ko(e),Do(4),Fo()))}catch(t){if(!(t instanceof Po)){if(t instanceof So)continue;continue}await s(t)}try{await t.start(qo(Do(3),new Jo))}catch(t){if(t instanceof Po){await s(t);continue}if(t instanceof So)continue;continue}try{await a(e)}catch(t){continue}try{await o(e)}catch(t){if(t instanceof Mo)await r();else{if(!(t instanceof Io))continue;await r()}}try{await h(e)}catch(t){t instanceof Po&&await s(t)}}}}))}function ah(){const t=new Ws,e=new tn;e.magnetRadius=0;const i=new Ys;i.recoveryDelay=1;const s=new Co;return s.enabled=!1,[t,new Rs,new Xr,new ko,e,new ks(10),new Gr(15),new ws,i,new Qs,new qs,new xs("enemy"),new _r(1),new hn,new Ki,new Us,new Lr,new js,new mn,new Xs,new Pr(nh()),new Rr,new to,new Eo,s]}function rh(){return ah().filter((t=>!(t instanceof Lr))).concat([new Br])}function oh(){return new ih((async t=>{const{entity:e}=t;function i(){return gt(1,.1,e.traitOfType(hn).stats.normalized().defense)}async function s(e){await t.start(new Go(i())),await t.start(qo(new eh(e.attacker,200),Vo(1)))}async function n(){await t.start(new Go(i())),await t.start(qo(new th,Vo(1)))}async function a(i){const s=(0,wt.F5)([[Ls.LIGHT],[Ls.HEAVY]]),n=e.traitOfType(hn).stats.normalized(),a=[];for(const t of s)a.push(qo(Ko(i),new Qo(t===Ls.HEAVY)));await t.start(jo(...a)),await t.start(new Zo);const r=gt(1,.2,n.defense);await t.start(new Go(r))}async function r(e){await t.start(qo(Ko(e),Yo(new eh(e,150),Vo(2)),qo(new Xo(e,200),Do(2)),Fo()))}for(;;){await t.start(new Zo),await t.start(new Go(1));const{target:e}=t;if(e){try{await t.start(qo(new Wo(e,300),Ko(e),Do(4),Fo()))}catch(t){if(!(t instanceof Po)){if(t instanceof So)continue;continue}await s(t)}try{await t.start(qo(Do(3),new Jo))}catch(t){if(t instanceof Po){await s(t);continue}if(t instanceof So)continue;continue}try{await a(e)}catch(t){if(t instanceof Mo)await n();else{if(!(t instanceof Io))continue;await n()}}try{await r(e)}catch(t){t instanceof Po&&await s(t)}}}}))}class hh{shopping(t,e){const i=t.traitOfType(mn);return this.equipRandomItem(i,e.tools.items()),this.equipRandomItem(i,e.armors.items()),this.equipRandomItem(i,e.shields.items()),this.equipRandomItem(i,e.helmets.items()),this.equipRandomItem(i,e.capes.items()),t}equipRandomItem(t,e){const i=Array.from(e).map((t=>t.item));i.length&&t.inventory.equip((0,wt.F5)(i))}get description(){return this.constructor.name}hasKing(){return!1}}class lh extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,je,$e,ni,ai,di,mi)}createEntities(){return[this.shopping(new qi.wC(void 0,ah()),this.shop)]}}class ch extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,je,ni,ai,di,mi)}createEntities(){return[this.shopping(new qi.wC(void 0,ah()),this.shop)]}}class dh extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,$e,ni,ai,di,mi)}createEntities(){return[this.shopping(new qi.wC(void 0,ah()),this.shop)]}}class uh extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,je,$e,ui)}createEntities(){const t=this.shopping(new qi.wC(void 0,ah().concat([new Ir,new on])),this.shop);return t.traitOfType(Pr).setAI(oh()),[t]}}class ph extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,je,$e,ni,ai,di,mi)}createEntities(){return[this.shopping(new qi.wC(void 0,rh()),this.shop)]}}class mh extends zi.X{constructor(){super(...arguments),this.key=mh.key}postBind(){super.postBind(),this.healthTrait=this.dependency(ws.key)}cycle(t){this.healthTrait.health=this.healthTrait.maxHealth}}mh.key="invincible";const yh=new Wr.M;class wh extends zi.X{constructor(t=0){super(),this.padding=t,this.key=wh.key}cycle(){const{bounds:t}=Oi(this.world.traitsOfType(xo));yh.copy(t),yh.pad(this.padding,this.padding),yh.containsPoint(this.entity.position)||this.entity.remove()}}wh.key="self-removing";class gh extends Error{}function fh(){const t=new Ws;(new tn).magnetRadius=500;const e=new mn;e.inventory.tool=new Pt({id:"",stats:new Mt({damage:.2,mobility:.2,defense:0}),description:new Zt}),e.dropMoneyWhenDying=!1;const i=new Qs;return i.staggerRecoveryDuration=9999,[t,new Rs,new Xr,new Qr,new ks(10),new Gr(15),new ws,i,new qs,new xs("enemy"),new tn,new Lr,new hn,new Us,new Xs,new Rr,e,new Pr(new ih((async t=>{try{await t.start(new Lo((t=>{if(!t.entity.traitOfType(Qr).riderId)throw new gh})))}catch(e){if(!(e instanceof gh))throw e;await t.start(new Go(1));const{bounds:i,absoluteBounds:s}=Oi(t.entity.world.traitsOfType(xo)),n=new Zi.I((0,wt.XU)(i.minX,i.maxX),t.entity.position.x<i.midY?s.minY-400:s.maxY+400);await t.start(qo(new Wo(n,10),Ko(n)))}}))),new wh(200),new mh,new Ki]}class vh extends hh{createEntities(){return[new qi.wC(void 0,fh())]}}class bh extends hh{constructor(t,e){super(),this.characterFactory=t,this.horseFactory=e}hasKing(){return this.characterFactory.hasKing()}createEntities(){const[t]=this.characterFactory.createEntities(),[e]=this.horseFactory.createEntities();return function(t,e){t.traitOfType(to).horseId=e.id,e.traitOfType(xs).team=t.traitOfType(xs).team}(t,e),[t,e]}get description(){return`${this.characterFactory.description} riding ${this.horseFactory.description}`}}class Th extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,Le,_e,ri,di,je,ei,Je,oe)}createEntities(){return[this.shopping(new qi.wC(void 0,ah()),this.shop)]}}class kh extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,Ve,ri,di,ei,Je,he)}createEntities(){return[this.shopping(new qi.wC(void 0,ah()),this.shop)]}}class xh extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,Ve,Le,_e,ri,di,je,ei,Je,oe,he)}createEntities(){return[this.shopping(new qi.wC(void 0,rh()),this.shop)]}}class Ch extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,Ve,ri,di,ei,Je,he)}createEntities(){return[this.shopping(new qi.wC(void 0,rh()),this.shop)]}}class Eh extends zi.X{constructor(){super(...arguments),this.key=Eh.key}postBind(){super.postBind(),this.projectileTrait=this.dependency(Ss.key)}processEvent(t,e){var i;if(t instanceof Cs){const{victim:s}=t;if(an(this.entity,t,e))return;if(null===(i=s.traitOfType(js))||void 0===i?void 0:i.isHoldingShield){const t=new Hr;return t.charged=!1,t.comboCount=0,t.consecutiveAttackCount=0,void s.addEvent(new Gs(t,this.entity))}const n=s.traitOfType(Rr);null==n||n.burn(2)}}}Eh.key="fireball-projectile-trait";class Sh extends zi.X{constructor(){super(...arguments),this.key=Sh.key}postBind(){super.postBind(),this.meleeAttackerTrait=this.dependency(tn.key),this.teamMemberTrait=this.dependency(xs.key)}processEvent(t,e){var i;if(t instanceof nn){const s=this.meleeAttackerTrait.aimAngle,n=t.attack.charged?[s,s-Math.PI/16,s+Math.PI/16]:[s];for(const s of n){const n=new qi.wC(void 0,[new en.K(3),new Ss(this.entity.id,null===(i=this.teamMemberTrait)||void 0===i?void 0:i.team,t.attack,600),new Eh]);n.position.x=this.entity.position.x+20*Math.cos(s),n.position.y=this.entity.position.y+20*Math.sin(s),n.angle=s,e.entities.add(n)}}}}Sh.key="fireball-thrower";class Mh extends zi.X{constructor(){super(...arguments),this.key=Mh.key}processEvent(t,e){if(t instanceof Cs){const{victim:e}=t,i=e.traitOfType(ws);i.heal(this.entity,.3*i.maxHealth)}}}Mh.key="healing-projectile-trait";class Ph extends zi.X{constructor(t){super(),this.targetId=t,this.key="homing"}cycle(t){const e=this.world.entity(this.targetId);if(!e)return;const i=ls(this.entity,e);this.entity.angle=i}}Ph.key="homing";class Ih extends zi.X{constructor(){super(...arguments),this.key=Ih.key,this.radius=500}postBind(){super.postBind(),this.teamMemberTrait=this.dependency(xs.key)}*findTargets(t){var e;for(const i of this.world.entities.bucket(hn.key))i!==this.entity&&(null===(e=i.traitOfType(xs))||void 0===e?void 0:e.team)===this.teamMemberTrait.team&&(i.traitOfType(ws).healthRatio>=1||(0,ft.Io)(i.position,this.entity.position)>t||(yield i))}processEvent(t,e){var i,s;if(t instanceof nn)for(const n of this.findTargets(this.radius)){if(n===this.entity)continue;if((null===(i=n.traitOfType(xs))||void 0===i?void 0:i.team)!==this.teamMemberTrait.team)continue;if(n.traitOfType(ws).healthRatio>=1)continue;if((0,ft.Io)(n.position,this.entity.position)>500)continue;const a=ls(this.entity.position,n.position),r=new qi.wC(void 0,[new en.K(3),new Ss(this.entity.id,null===(s=this.teamMemberTrait)||void 0===s?void 0:s.team,t.attack,200,!0),new Mh,new Ph(n.id)]);r.position.x=this.entity.position.x+20*Math.cos(a),r.position.y=this.entity.position.y+20*Math.sin(a),r.angle=a,e.entities.add(r)}}}Ih.key="healer";class Ah extends zi.X{constructor(){super(...arguments),this.key=Ah.key,this.radiusX=50,this.radiusY=25,this.lastCheck=0}contains(t){const e=ls(this.entity.position,t),i=Math.abs(Math.cos(e)*this.radiusX),s=Math.abs(Math.sin(e)*this.radiusY);return!(Math.abs(t.x-this.entity.position.x)>i||Math.abs(t.y-this.entity.position.y)>s)}cycle(t){if(!(this.entity.age-this.lastCheck<1/30)){this.lastCheck=this.entity.age;for(const t of this.world.traitsOfType(Rr))this.contains(t.entity.position)&&t.burn(2)}}}Ah.key="fire";class Oh extends zi.X{constructor(){super(...arguments),this.key=Oh.key,this.lastAttackPosition=new Zi.I}postBind(){super.postBind(),this.meleeAttackerTrait=this.dependency(tn.key),this.teamMemberTrait=this.dependency(xs.key)}processEvent(t,e){var i,s;if(t instanceof sn){const t=Oi(e.entities.bucket(ln.key));if(!t)return;this.lastAttackPosition.x=t.position.x,this.lastAttackPosition.y=t.position.y}else if(t instanceof nn){const t=new ts;t.source=new Zi.I(this.entity.position.x,this.entity.position.y),t.position.x=this.lastAttackPosition.x,t.position.y=this.lastAttackPosition.y,e.addEvent(t);const n=new qi.wC(void 0,[new Ah,new en.K(10)]);n.position.x=this.lastAttackPosition.x,n.position.y=this.lastAttackPosition.y,e.entities.add(n);const a=new Hr;a.charged=!1,a.comboCount=0,a.consecutiveAttackCount=0;const r=Oi(e.entities.bucket(ln.key));if(r&&n.traitOfType(Ah).contains(r)&&(null===(i=r.traitOfType(js))||void 0===i?void 0:i.isHoldingShield)){if(null===(s=r.traitOfType($s))||void 0===s?void 0:s.canParry){const t=ls(this.entity.position,r.position)+Math.PI+(0,wt.YR)(Math.PI/3,Math.PI/5)*(0,wt.F5)([-1,1]),i={x:r.position.x+200*Math.cos(t),y:r.position.y+200*Math.sin(t)},s=[];for(const t of e.entities.bucket(xs.key)){if(t===this.entity)continue;if(t.traitOfType(xs).team!==this.teamMemberTrait.team)continue;if((0,ft.Io)(t.position,t.position)>500)continue;const e=(0,ft.n0)(t.angle+Math.PI),i=ls(t.position,t.position);Math.abs((0,ft.n0)(i-e))>Math.PI/2||s.push(t)}if(s.length){const t=(0,wt.F5)(s);i.x=t.position.x,i.y=t.position.y}const o=new ts;o.source=new Zi.I(r.position.x,r.position.y),o.position.x=i.x,o.position.y=i.y,e.addEvent(o),n.position.x=o.position.x,n.position.y=o.position.y;const h=r.traitOfType($s).canPerfectParry;return r.addEvent(new Wi(a,h)),void this.entity.addEvent(new Xi(r,h))}const t=new Gs(a,this.entity);r.addEvent(t),n.remove()}}}}Oh.key="thunder-wizard";class Rh extends hh{constructor(){super(...arguments),this.shop=new ki(Ke,we,fi,je,Me)}createEntities(){const t=this.shopping(new qi.wC(void 0,ah().concat([new wn,new Ir,new Ih])),this.shop);return t.traitOfType(Pr).setAI(new ih((async t=>{const{entity:e}=t;function i(){return gt(1,.1,e.traitOfType(hn).stats.normalized().defense)}async function s(e){await t.start(new Go(i())),await t.start(qo(new eh(e.attacker,200),Vo(1)))}async function n(){await t.start(new Go(i())),await t.start(qo(new th,Vo(1)))}async function a(e){const i=t.entity.traitOfType(Ih);console.log("gonna approach ",.8*i.radius),await t.start(qo(Do(4),new Wo(e.position,.8*i.radius),Ko(e)))}async function r(e){await t.start(qo(Ko(e),Yo(new eh(e,150),Vo(2)),qo(new Xo(e,200),Do(2)),Fo()))}for(;;){await t.start(new Go(1));const{target:e}=t;if(!e)continue;try{await t.start(qo(new Xo(e,300),Ko(e),Vo(4),Fo()))}catch(t){if(!(t instanceof Po))continue;await s(t)}const i=Oi(t.entity.traitOfType(Ih).findTargets(1e3));if(i){try{await a(i)}catch(t){if(t instanceof So)continue;throw t}try{await t.start(new Qo(!1)),await t.start(new Go(1))}catch(t){if(t instanceof Mo)await n();else{if(!(t instanceof Io))continue;await n()}}try{await r(e)}catch(t){t instanceof Po&&await s(t)}}}}))),[t]}}class _h extends hh{constructor(){super(...arguments),this.shop=new ki(ze,me,gi,je,Pe)}createEntities(){const t=this.shopping(new qi.wC(void 0,ah().concat([new wn,new Ir,new Sh])),this.shop);return t.traitOfType(Pr).setAI(oh()),[t]}}class Bh extends hh{constructor(){super(...arguments),this.shop=new ki(Ge,ye,vi,je,Ie)}createEntities(){const t=this.shopping(new qi.wC(void 0,ah().concat([new wn,new Ir,new Oh])),this.shop);return t.traitOfType(Pr).setAI(oh()),[t]}}class Lh extends Nr{constructor(t){super(),this.entity=t}}class Dh extends Fr{get entity(){return this.stateMachine.entity}bind(t){super.bind(t),this.controllableTrait=this.stateMachine.entity.traitOfType(Rs),this.walkerTrait=this.stateMachine.entity.traitOfType(Ws),this.staminaTrait=this.stateMachine.entity.traitOfType(Ys),this.pushableTrait=this.stateMachine.entity.traitOfType(qs),this.healthTrait=this.stateMachine.entity.traitOfType(ws),this.inventoryTrait=this.stateMachine.entity.traitOfType(mn),this.meleeAttackerTrait=this.stateMachine.entity.traitOfType(tn),this.dasherTrait=this.stateMachine.entity.traitOfType(Lr),this.shieldableTrait=this.stateMachine.entity.traitOfType(js),this.obstacleTrait=this.stateMachine.entity.traitOfType(Gr),this.staggerableTrait=this.stateMachine.entity.traitOfType(Qs)}maybeBecomeExhausted(){return this.staminaTrait.stamina<=0&&(this.transition(new Nh),!0)}maybeBecomeStunned(){return!!this.healthTrait.recentlyDamaged(.1)&&(this.transition(new Fh),!0)}}class Vh extends Dh{cycle(t){super.cycle(t),this.maybeBecomeExhausted()||this.maybeBecomeStunned()||(this.controllableTrait.inputs.dash?this.transition(new Hh):this.controllableTrait.inputs.shield?this.transition(new Kh):this.controllableTrait.inputs.lightStrike?this.transition(new Uh(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD,0)):this.controllableTrait.inputs.heavyStrike&&this.transition(new Uh(!0,0)))}}class Hh extends Dh{constructor(){super(...arguments),this.releasedDash=!1,this.angle=0}onEnter(t){super.onEnter(t),this.angle=this.controllableTrait.inputs.movement.angle,this.dasherTrait.simpleDash(this.angle)}cycle(t){super.cycle(t),this.dasherTrait.dashing||this.transition(new Yh(this.angle))}}class Fh extends Dh{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeExhausted()||(this.age>.3?this.transition(new Vh):this.controllableTrait.inputs.shield&&this.transition(new Kh))}}class Nh extends Dh{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.staminaTrait.stamina>=1&&this.transition(new Vh)}}class Uh extends Dh{constructor(t,e){super(),this.heavy=t,this.consecutiveAttackCount=e}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.meleeAttackerTrait.preparingAttack=this.heavy?Ls.HEAVY:Ls.LIGHT}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.meleeAttackerTrait.preparingAttack=Ls.NONE}cycle(t){super.cycle(t);const e=this.heavy||this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?this.meleeAttackerTrait.heavyStrikeChargeTime:this.meleeAttackerTrait.lightStrikeChargeTime;this.meleeAttackerTrait.preparationRatio=this.age/e,this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD?this.age>this.meleeAttackerTrait.heavyStrikeChargeTime?this.transition(new Wh(!0,this.consecutiveAttackCount)):this.controllableTrait.inputs.lightStrike||this.transition(new Wh(!1,this.consecutiveAttackCount)):this.age>e&&this.transition(new Wh(this.heavy,this.consecutiveAttackCount)))}}class Wh extends Dh{constructor(t,e){super(),this.heavy=t,this.consecutiveAttackCount=e,this.didTryToStrikeAgain=!1,this.attack=(()=>{const t=new Hr;return t.charged=this.heavy,t.consecutiveAttackCount=this.consecutiveAttackCount,t.comboCount=0,t})()}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.didTryToStrikeAgain=!1,this.entity.addEvent(new sn(this.heavy)),this.heavy&&this.entity.addEvent(new Dr);const e=this.meleeAttackerTrait.lungeVictim;let i=this.meleeAttackerTrait.aimAngle,s=40;e&&(i=ls(this.entity,e),s=Math.max(0,(0,ft.Io)(this.entity,e)-this.meleeAttackerTrait.strikeRadiusX/3)),this.pushableTrait.push(i,s,.1)}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.entity.addEvent(new nn(this.attack))}cycle(t){var e,i;if(super.cycle(t),!this.maybeBecomeStunned()&&!this.maybeBecomeExhausted()&&(this.controllableTrait.inputs.lightStrike&&(this.didTryToStrikeAgain=!0),this.age>.15)){if(this.meleeAttackerTrait.strike(this.attack)===Bs.PARRIED)return void this.transition(new Gh);this.heavy||this.consecutiveAttackCount>=(null===(i=null===(e=this.inventoryTrait.inventory.tool)||void 0===e?void 0:e.description)||void 0===i?void 0:i.consecutiveAttackCount)-1?this.transition(new zh):this.didTryToStrikeAgain?this.transition(new Uh(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD,this.consecutiveAttackCount+1)):this.transition(new Xh(this.consecutiveAttackCount))}}}class Xh extends Dh{constructor(t){super(),this.consecutiveAttackCount=t,this.didTryToStrikeAgain=!1}cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||(this.controllableTrait.inputs.lightStrike&&(this.didTryToStrikeAgain=!0),this.age>.3&&(this.didTryToStrikeAgain?this.transition(new Uh(this.meleeAttackerTrait.heavyStrikeMode===_s.HOLD,this.consecutiveAttackCount)):this.transition(new Vh)))}}class Gh extends Dh{onEnter(t){super.onEnter(t),this.walkerTrait.enabled=!1,this.obstacleTrait.enabled=!1,this.pushableTrait.push(this.meleeAttackerTrait.aimAngle+Math.PI,50,.2)}onExit(){super.onExit(),this.walkerTrait.enabled=!0,this.obstacleTrait.enabled=!0}cycle(t){super.cycle(t),this.maybeBecomeExhausted()||this.age>.5&&this.transition(new Vh)}}class zh extends Dh{cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||this.age>.5&&this.transition(new Vh)}}class Kh extends Dh{onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=.5,this.shieldableTrait.isHoldingShield=!0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1,this.shieldableTrait.isHoldingShield=!1}cycle(t){super.cycle(t),this.maybeBecomeExhausted()||this.controllableTrait.inputs.shield||this.transition(new Vh)}}class Yh extends Dh{constructor(t){super(),this.angle=t}onEnter(t){super.onEnter(t),this.walkerTrait.speedRatio=0}onExit(){super.onExit(),this.walkerTrait.speedRatio=1}cycle(t){super.cycle(t),this.maybeBecomeStunned()||this.maybeBecomeExhausted()||this.controllableTrait.inputs.dash||this.age>.2&&this.transition(new Vh)}}class qh extends Dh{constructor(){super(...arguments),this.triggeredEvent=!1}onEnter(t){super.onEnter(t),this.walkerTrait.enabled=!1}onExit(){super.onExit(),this.walkerTrait.enabled=!0}cycle(t){super.cycle(t),this.staggerableTrait.staggered||this.transition(new jh),this.age>.2&&!this.triggeredEvent&&(this.entity.addEvent(new qh),this.triggeredEvent=!0)}}class jh extends Dh{onEnter(t){super.onEnter(t),this.walkerTrait.enabled=!1}onExit(){super.onExit(),this.walkerTrait.enabled=!0}get progress(){return Math.min(1,this.age/.3)}cycle(t){super.cycle(t),this.staggerableTrait.recoveryProgress>=1&&this.transition(new Vh)}}class $h extends zi.X{constructor(){super(...arguments),this.key=$h.key}postBind(){super.postBind(),this.walkerTrait=this.dependency(Ws.key),this.controllableTrait=this.dependency(Rs.key),this.meleeAttackerTrait=this.dependency(tn.key),this.staggerableTrait=this.dependency(Qs.key),this.stateMachine=new Lh(this.entity),this.stateMachine.transition(new Vh)}cycle(t){this.meleeAttackerTrait.aimAngle=ls(this.entity.position,this.controllableTrait.inputs.aim),this.stateMachine.cycle(t),this.walkerTrait.enabled&&(this.walkerTrait.facing=Math.sign(Math.cos(this.meleeAttackerTrait.aimAngle))||this.walkerTrait.facing)}processEvent(t,e){if(t instanceof Zs){const e=ls(t.attacker,this.entity);this.entity.traitOfType(qs).push(e,80,.2),this.stateMachine.currentState.transition(new qh),this.walkerTrait.facing=Math.sign(t.attacker.position.x-this.entity.position.x)||this.walkerTrait.facing}else t instanceof Xi&&this.staggerableTrait.stagger(t.parrier)}}function Jh(){const t=new Ws,e=new $h;(new tn).magnetRadius=500;const i=new mn;i.inventory.tool=new Pt({id:"",stats:new Mt({damage:.2,mobility:.2,defense:0}),description:new Jt}),i.dropMoneyWhenDying=!1;const s=new Qs;return s.staggerRecoveryDuration=.2,[t,new Rs,new Xr,e,new ks(10),new Gr(15),new ws,new Ys,s,new qs,new xs("enemy"),new _r(1),new tn,new Lr,new hn,new Ki,new Us,new Xs,new Rr,i,new Pr(new ih((async t=>{for(;;){await t.start(new Zo),await t.start(new Go(1));const{target:e}=t;if(e){try{await t.start(qo(Do(4),Ko(e),new Wo(e,300)))}catch(t){continue}try{await t.start(qo(Do(5),new Jo)),t.entity.addEvent(new Vr)}catch(t){continue}try{await t.start(qo(Do(4),new Wo(e,t.entity.traitOfType(tn).magnetRadius),Ko(e)))}catch(t){continue}try{const{tool:i}=t.entity.traitOfType(mn).inventory;for(let s=0;s<i.description.consecutiveAttackCount;s++)await t.start(qo(new Qo(!1),Ko(e),Ho()));await t.start(new Zo)}catch(t){}try{const i=ls(t.entity.position,e.position),s=new Zi.I(t.entity.x+200*Math.cos(i+Math.PI),t.entity.y+200*Math.sin(i+Math.PI));await t.start(qo(Vo(4),Ko(s),new Wo(s,10))),await t.start(new zo(e))}catch(e){e instanceof Mo&&await t.start(new Go(1))}}}})))]}$h.key="wolf";class Zh extends hh{createEntities(){return[new qi.wC(void 0,Jh())]}}class Qh{get description(){return this.constructor.name}reduced(){return this}}class tl extends Qh{constructor(t){super(),this.name=t}async start(t,e){const i=(0,qi.EG)([new bs,new en.K(5)]);i.traitOfType(bs).message=this.name,t.world.entities.add(i)}get description(){return`Announce: ${this.name}`}}class el extends Qh{constructor(t,e){super(),this.width=t,this.height=e}async start(t,e){t.waitFor((()=>{const{bounds:e,absoluteBounds:i}=Oi(t.world.traitsOfType(xo)),{player:s}=t;return!!s&&(e.centerAround(s.position.x,s.position.y,this.width,this.height),i.copy(e),!1)}))}get description(){return`Bounds follow player ${this.width}x${this.height}`}}class il extends zi.X{constructor(t){super(),this.confirm=t,this.key=il.key}}il.key="challenge-confirmation-resolver";class sl extends zi.X{constructor(t){super(),this.openChallenge=t,this.key=sl.key}}sl.key="challenge-resolver";class nl{}class al extends zi.X{constructor(t){super(),this.configuration=t,this.key=al.key}postBind(){super.postBind(),this.instructionTrait=this.entity.traitOfType(Ts),this.interactableTrait=this.entity.traitOfType(br)}cycle(){this.instructionTrait&&(this.instructionTrait.enabled=this.interactableTrait.hasInteractor)}processEvent(t,e){t instanceof gr&&(async()=>{const t=Oi(e.traitsOfType(il));if(!await t.confirm(2e3))return;const i=Oi(e.traitsOfType(sl));await i.openChallenge(this.configuration)&&(this.enabled=!1,e.entities.add((0,qi.EG)([new ji.H(1,(()=>{un(e,this.entity.position,2e3),this.entity.addEvent(new nl),this.entity.remove()}))])))})()}}al.key="npc";class rl extends Qh{constructor(t){super(),this.configuration=t}async start(t,e){const{world:i}=t,{absoluteBounds:s}=Oi(i.traitsOfType(xo)),n=t.spawnEntity(function(t){const e=new mn;e.inventory.money=1e3;const i=new Ts;return i.message=Er("pressInteractToTalk"),[new Gr(15),new hn,new ws,new ks(10),new xs("merchant"),new al(t.configuration),new wh,new br,t.instruction?i:null,e,new mh].filter((t=>!!t))}({instruction:!1,configuration:this.configuration}));n.position.x=e.currentX,n.position.y=(0,wt.XU)(s.minY+200,s.maxY-200)}}class ol extends Qh{constructor(t){super(),this.bucketKey=t}async start(t,e){for(const e of Array.from(t.world.entities.bucket(this.bucketKey)))e.remove()}get description(){return"Clear bucket "+this.bucketKey}}class hl{apply(t){}}class ll extends Qh{async start(t,e){t.world.addEvent(new hl)}}function cl(t,e){t.traitOfType(ko)?function(t,e){t.traitOfType(Xs).experience=e;const i=new Mt;i.mobility=-1;for(let t=0;t<e;t++){const t=sh([[2,"mobility"],[4,"damage"],[3,"defense"]]);i.addStat(t,vt)}if(t.traitOfType(Br))for(let t=0;t<e;t++){const t=sh([[1,"mobility"],[4,"defense"],[2,"damage"]]);i.addStat(t,.020000000000000004)}t.traitOfType(hn).baseStats=i,t.traitOfType(mn).inventory.money=kt(t.traitOfType(hn).stats)/20}(t,e):t.traitOfType($h)?function(t,e){t.traitOfType(Xs).experience=e;const i=new Mt;for(let t=0;t<e;t++){const t=sh([[2,"mobility"],[4,"damage"],[1,"defense"]]);i.addStat(t,.08000000000000002)}t.traitOfType(hn).baseStats=i}(t,e):t.traitOfType(Qr)&&function(t,e){t.traitOfType(Xs).experience=e;const i=new Mt;for(let t=0;t<e;t++){const t=sh([[4,"mobility"],[4,"damage"],[2,"defense"]]);i.addStat(t,.08000000000000002)}t.traitOfType(hn).baseStats=i}(t,e)}class dl extends Qh{constructor(t){super(),this.waveDefinition=t}get description(){return`Enemy wave: ${this.waveDefinition.description}`}async start(t,e){const{world:i}=t;for(const t of Array.from(i.entities.bucket(Tr.key)))t.remove();for(const t of Array.from(i.entities.bucket(al.key)))t.remove();const{composition:s,enemyMinLevel:n,enemyMaxLevel:a,enemyCount:r}=this.waveDefinition,o=Oi(i.traitsOfType(Ji.O)),{visibleRectangle:h}=o,{bounds:l,absoluteBounds:c}=Oi(i.traitsOfType(xo));l.setBounds(h.minX-h.width,h.minY-h.height,h.maxX+h.width,h.maxY+h.height),c.update(l.x,c.y,c.width,c.height);const d=new Wr.M,u=new Set;for(const e of s.entities(r)){let s,r;u.add(e.id),await t.wait(.1),d.centerAround(h.midX,h.midY,h.width+200,h.height+200),(0,wt.sI)(.5)?(s=1,r=(0,wt.YR)(0,1)):(s=(0,wt.YR)(.5,1),r=(0,wt.F5)([-1,1])),e.position.x=gt(d.minX,d.maxX,s),e.position.y=gt(d.minY,d.maxY,r),i.entities.add(e),cl(e,(0,wt.XU)(n,a))}}}class ul extends Qh{async start(t,e){t.world.addEvent(new rs)}}class pl extends Qh{constructor(t){super(),this.event=t}async start(t,e){t.world.addEvent(this.event)}}class ml extends Qh{constructor(t,e){super(),this.width=t,this.height=e}async start(t,e){const{absoluteBounds:i,bounds:s}=Oi(t.world.traitsOfType(xo));i.centerAround(0,0,this.width,this.height),s.copy(i)}get description(){return`Initialize bounds rectangle ${this.width}*${this.height}`}}class yl extends zi.X{constructor(){super(...arguments),this.key=yl.key,this.offset=2e3*Math.random()}pathY(t){return 200*Math.sin((t+this.offset)*Math.PI*2/2e3)+100*Math.sin((t+this.offset)*Math.PI*2/1e3)+this.entity.position.y}}var wl;yl.key="path",function(t){t.ON_PATH="ON_PATH",t.NEAR_PLAYER="NEAR_PLAYER"}(wl||(wl={}));class gl extends Qh{constructor(t,e,i){super(),this.id=t,this.shop=e,this.position=i}async start(t,e){const{world:i}=t,s=Oi(i.traitsOfType(yl)),n=(0,qi.EG)(this.id,function(t){const e=new mn;e.inventory.money=1e3,e.inventory.equip(be.item),e.inventory.equip(le.item),e.inventory.equip(Re.item);const i=new Ts;return i.message=Er("pressInteractToOpenShop"),[new Gr(15),new hn,new ws,new ks(10),new xs("merchant"),new Tr,new wh,new br,null,e,new mh].filter((t=>!!t))}());switch(this.position){case wl.ON_PATH:n.position.x=e.currentX,n.position.y=s.pathY(n.position.x)-100;break;case wl.NEAR_PLAYER:const{player:i}=t,a=(0,wt.YR)(-Math.PI/4,Math.PI/4),r=(0,wt.XU)(200,400);n.position.x=i.position.x+Math.cos(a)*r,n.position.y=i.position.y+Math.sin(a)*r;break;default:throw new Error(`Unsupported position: ${this.position}`)}this.shop&&(n.traitOfType(Tr).shop=this.shop),t.world.entities.add(n);const a=t.spawnEntity([new Cr,new wh(500)]);a.position.x=n.position.x+80,a.position.y=n.position.y;const r=t.spawnEntity([new kr,new wh(500)]);r.position.x=a.position.x,r.position.y=a.position.y,r.angle=Math.random()*Math.PI/4,r.traitOfType(kr).width=(0,wt.XU)(200,300),r.traitOfType(kr).height=(0,wt.XU)(150,300)}get description(){return`Spawn merchant ${this.id} ${this.position}`}}function fl(t,e="  "){return t.split("\n").map((t=>e+t)).join("\n")}class vl extends Qh{constructor(t){super(),this.scenario=t}async start(t,e){this.scenario.start(t,e)}get description(){return`Optionally:\n${fl(this.scenario.description)}`}reduced(){const t=this.scenario.reduced();return t instanceof vl?t.scenario:new vl(t)}}class bl extends Qh{constructor(t){super(),this.scenarios=t}async start(t,e){await Promise.all(this.scenarios.map((i=>i.start(t,e))))}get description(){return["Simultaneously:",this.scenarios.map((t=>fl(t.description))).join("\n")].join("\n")}reduced(){const t=this.scenarios.map((t=>t.reduced())).flatMap((t=>t instanceof bl?t.scenarios:t));return 1===t.length?t[0]:new bl(t)}}class Tl extends Qh{constructor(t){super(),this.entityId=t}async start(t,e){await t.waitFor((()=>{const{player:e}=t,i=t.world.entity(this.entityId);return!(!e||!i)&&e.position.x>=i.position.x}))}get description(){return`Wait for player to pass entity ${this.entityId}`}}class kl extends Qh{constructor(t){super(),this.scenarios=t}async start(t,e){await Promise.race(this.scenarios.map((i=>i.start(t,e))))}get description(){return"Wait for completion of either of:\n"+this.scenarios.map((t=>fl(`Or: \n${fl(t.description)}`))).join("\n")}reduced(){return 1===this.scenarios.length?this.scenarios[0]:new kl(this.scenarios)}}class xl extends zi.X{constructor(){super(...arguments),this.key=xl.key,this.radiusX=0,this.radiusY=0}}xl.key="objective";class Cl extends Qh{async start(t,e){const{world:i}=t;for(const t of Array.from(i.entities.bucket(xl.key)))t.remove()}get description(){return"Remove the objective marker"}}class El extends Qh{constructor(t){super(),this.scenarios=t}async start(t,e){for(const i of this.scenarios)await i.start(t,e)}get description(){return this.scenarios.map((t=>`Then: \n${fl(t.description)}`)).join("\n")}reduced(){const t=this.scenarios.map((t=>t.reduced())).flatMap((t=>t instanceof El?t.scenarios:t));return 1===t.length?t[0]:new El(t)}}class Sl extends Qh{async start(t,e){const{world:i}=t,s=Oi(i.traitsOfType(yl)),n=t.spawnEntity([new xl]);n.position.x=e.currentX,n.position.y=s.pathY(n.position.x)}get description(){return"Set the objective marker"}}class Ml extends Qh{constructor(t){super(),this.environment=t}async start(t,e){this.environment.setup(t.world)}get description(){return`Set environment to ${this.environment.description}`}}class Pl{constructor(t,e){this.fromProgress=t,this.toProgress=e}apply(t){}}class Il extends Qh{constructor(t,e){super(),this.fromProgress=t,this.toProgress=e}async start(t,e){t.world.addEvent(new Pl(this.fromProgress,this.toProgress))}get description(){return`Show progress from ${Math.round(100*this.fromProgress)}% to ${Math.round(100*this.toProgress)}%`}}class Al extends zi.X{constructor(){super(...arguments),this.key=Al.key}postBind(){super.postBind(),this.healthTrait=this.dependency(ws.key)}processEvent(t,e){t instanceof ms&&this.healthTrait.healthRatio<1&&this.healthTrait.heal(this.entity,3)}}Al.key="heal-when-kill";class Ol{}class Rl{constructor(){this.totalTime=0,this.killedEnemies=0,this.clearedWaves=0,this.maxCombo=0,this.maxLevel=0,this.collectedMoney=0}}class _l extends zi.X{constructor(){super(...arguments),this.key=_l.key,this.stats=new Rl}}_l.key="run-stats-holder";class Bl extends zi.X{constructor(){super(...arguments),this.key=Bl.key,this.runStats=(0,xn.R)((()=>Oi(this.entity.world.traitsOfType(_l)).stats))}postBind(){super.postBind(),this.comboTrackerTrait=this.dependency(fn.key),this.experienceHolderTrait=this.dependency(Xs.key)}cycle(t){const e=this.runStats.get();e.totalTime+=t,e.maxCombo=Math.max(e.maxCombo,this.comboTrackerTrait.combo),e.maxLevel=Math.max(e.maxLevel,this.experienceHolderTrait.level)}processEvent(t,e){t instanceof ms?this.runStats.get().killedEnemies++:t instanceof Yi?this.runStats.get().collectedMoney+=t.amount:t instanceof Ol&&this.runStats.get().clearedWaves++}}Bl.key="run-tracker";const Ll=new Mt;function Dl(){const t=new hn;t.baseStats.add(Ll);const e=new Kt;e.color=16777215,e.handleColor=4210752;const i=new Yt;i.color=16777215,i.handleColor=10510416,(new $t).color=10510416;const s=new mn;s.dropMoneyWhenDying=!1;const n=new tn;n.heavyStrikeMode=_s.HOLD;const a=new Rs;return a.dashMode=As.DOUBLE_MOVEMENT_TAP,[new ln,new Ws,t,a,new Xr,n,new ko,new ks(10),new ws,new Ys,new qs,new Us,new xs("player"),new Co,new fn,new Xs,new $s,new Lr,new js,new vr,s,new Rr,new to,new Qs,new Al,new Bl]}Ll.damage=.1,Ll.defense=.1,Ll.mobility=.5;class Vl extends Qh{async start(t,e){const i=(0,qi.EG)(Dl());i.traitOfType(mn).inventory=t.progression.inventory.clone(),i.traitOfType(Xs).experience=t.progression.experience,t.world.entities.add(i)}get description(){return"Spawn the player"}}class Hl extends zi.X{constructor(t,e){super(),this.delay=t,this.duration=e,this.key=Hl.key}postBind(){super.postBind(),this.startAge=this.entity.age+this.delay,this.endAge=this.entity.age+this.delay+this.duration}get started(){return this.startAge<=this.entity.age}get countdown(){return(this.startAge-this.entity.age)/.5}get timeLeft(){return this.endAge-this.entity.age}get elapsed(){return this.entity.age-this.startAge}}Hl.key="timer-trait";class Fl extends Qh{constructor(t,e){super(),this.instruction=t,this.duration=e}async start(t,e){const i=new Ts;i.message=this.instruction;const s=new Hl(0,this.duration),n=(0,qi.EG)([s,i]);t.world.entities.add(n),await t.waitFor((()=>s.timeLeft<=0))}get description(){return`Wait ${this.duration}s`}}class Nl{constructor(t){this.groundColor=void 0!==(null==t?void 0:t.groundColor)?t.groundColor:9474144,this.grassColor=void 0!==(null==t?void 0:t.grassColor)?t.grassColor:10530944,this.bushColor=void 0!==(null==t?void 0:t.bushColor)?t.bushColor:24576,this.treeTrunkColor=void 0!==(null==t?void 0:t.treeTrunkColor)?t.treeTrunkColor:10510416,this.treeLeavesColor=void 0!==(null==t?void 0:t.treeLeavesColor)?t.treeLeavesColor:24576,this.flowerDensity=void 0!==(null==t?void 0:t.flowerDensity)?t.flowerDensity:0}clone(){const t=new Nl;return t.groundColor=this.groundColor,t.grassColor=this.grassColor,t.bushColor=this.bushColor,t.treeTrunkColor=this.treeTrunkColor,t.treeLeavesColor=this.treeLeavesColor,t.flowerDensity=this.flowerDensity,t}}Nl.SPRING=(()=>{const t=new Nl;return t.groundColor=9474144,t.grassColor=10530944,t.bushColor=24576,t.treeTrunkColor=10510416,t.treeLeavesColor=24576,t.flowerDensity=0,t})(),Nl.SUMMER=(()=>{const t=new Nl;return t.groundColor=9487945,t.treeLeavesColor=5808412,t.bushColor=5739801,t.grassColor=5542938,t.flowerDensity=.5,t})(),Nl.FALL=(()=>{const t=new Nl;return t.groundColor=13221195,t.treeLeavesColor=11546143,t.bushColor=16745995,t.grassColor=16756040,t.flowerDensity=0,t})(),Nl.WINTER=(()=>{const t=new Nl;return t.groundColor=12632256,t.treeLeavesColor=14737632,t.treeTrunkColor=3084830,t.bushColor=15461355,t.grassColor=16777215,t.flowerDensity=0,t})();class Ul extends zi.X{constructor(){super(...arguments),this.key=Ul.key,this.season=new Nl}}Ul.key="season";class Wl extends zi.X{constructor(t,e){super(),this.duration=t,this.targetSeason=e,this.key=Wl.key}postBind(){super.postBind(),this.initialSeason=Oi(this.entity.world.traitsOfType(Ul)).season.clone()}cycle(t){var e;const i=null===(e=Oi(this.entity.world.traitsOfType(Ul)))||void 0===e?void 0:e.season,s=Math.min(1,this.entity.age/this.duration);i.bushColor=se(ee(this.initialSeason.bushColor,1-s),ee(this.targetSeason.bushColor,s)),i.grassColor=se(ee(this.initialSeason.grassColor,1-s),ee(this.targetSeason.grassColor,s)),i.groundColor=se(ee(this.initialSeason.groundColor,1-s),ee(this.targetSeason.groundColor,s)),i.treeLeavesColor=se(ee(this.initialSeason.treeLeavesColor,1-s),ee(this.targetSeason.treeLeavesColor,s)),i.treeTrunkColor=se(ee(this.initialSeason.treeTrunkColor,1-s),ee(this.targetSeason.treeTrunkColor,s)),i.flowerDensity=gt(this.initialSeason.flowerDensity,i.flowerDensity,s),s>=1&&this.entity.remove()}}Wl.key="season-transition";class Xl extends Qh{constructor(t){super(),this.season=t}async start(t,e){const i=t.spawnEntity([new Wl(2,this.season)]);await t.waitFor((()=>!t.world.entity(i.id)))}}class Gl extends Qh{constructor(t){super(),this.wrapped=t}async start(t,e){let i=!1;return this.wrapped.start(t,e).then((()=>i=!0)),t.waitFor((()=>(this.updateBounds(t.world),i)))}updateBounds(t){var e,i;if(!Oi(t.traitsOfType(ln)))return;const s=(null===(i=null===(e=Oi(t.traitsOfType(yl)))||void 0===e?void 0:e.entity)||void 0===i?void 0:i.y)||0,{absoluteBounds:n,bounds:a}=Oi(t.traitsOfType(xo)),{visibleRectangle:r}=Oi(t.traitsOfType(Ji.O)),o=Math.max(r.minX-r.width,n.minX);n.setBounds(o,s-2*r.height,o+3*r.width,s+2*r.height),a.copy(n)}get description(){return`While always going right: \n${fl(this.wrapped.description)}`}reduced(){return new Gl(this.wrapped.reduced())}}class zl extends Qh{constructor(t){super(),this.highlight=t}async start(t,e){var i;const s=null===(i=t.player)||void 0===i?void 0:i.traitOfType(Rs);s&&(s.highlight=this.highlight||null)}get description(){return`Highlight control ${this.highlight}`}}class Kl extends Qh{constructor(t,e){super(),this.instructionId=t,this.message=e}async start(t,e){for(const e of Array.from(t.world.entities.bucket(Ts.key)))e.remove();const i=(0,qi.EG)(this.instructionId,[new Ts]);i.traitOfType(Ts).message=this.message,t.world.entities.add(i)}get description(){return`Show instruction (${this.instructionId}): ${this.message}`}}class Yl extends Qh{constructor(t){super(),this.instructionId=t}async start(t,e){const i=t.world.entity(this.instructionId);i&&(i.traitOfType(Ts).resolved=!0,await t.wait(2),i.remove())}get description(){return`Mark instruction ${this.instructionId} as resolved then remove it`}}class ql extends Qh{constructor(t){super(),this.entityId=t}async start(t,e){var i;null===(i=t.world.entity(this.entityId))||void 0===i||i.remove()}get description(){return`Remove entity ${this.entityId}`}}class jl extends Qh{constructor(t,e,i){super(),this.instructionId=t,this.message=e,this.taskCount=i}async start(t,e){const i=(0,qi.EG)(this.instructionId,[new Ts]);t.world.entities.add(i);for(let e=0;e<this.taskCount;e++)i.traitOfType(Ts).message=`${this.message} (${e}/${this.taskCount})`,await this.taskStep(t);i.traitOfType(Ts).message=`${this.message} (${this.taskCount}/${this.taskCount})`}get description(){return`${this.taskCount} times (${this.instructionId}): ${this.message}`}}class $l extends jl{taskStep(t){const e=Oi(t.world.entities.bucket(ln.key)).traitOfType(Lr),{dashCount:i}=e;return t.waitFor((()=>e.dashCount>i))}}class Jl extends jl{taskStep(t){const e=Oi(t.world.entities.bucket(ln.key)).traitOfType(tn),{strikeSuccessCount:i}=e;return t.waitFor((()=>e.strikeSuccessCount>i))}}class Zl extends jl{taskStep(t){const e=Oi(t.world.entities.bucket(ln.key)).traitOfType(tn),{heavyStrikeSuccessCount:i}=e;return t.waitFor((()=>e.heavyStrikeSuccessCount>i))}}class Ql extends jl{taskStep(t){const e=Oi(t.world.entities.bucket(ln.key)).traitOfType(js),{blockCount:i}=e;return t.waitFor((()=>e.blockCount>i))}}class tc extends Qh{async start(t,e){const{player:i}=t,s=t.spawnEntity([new yl]);s.position.y=i.position.y-s.traitOfType(yl).pathY(i.position.x)}get description(){return"Spawn the path"}}class ec extends Qh{constructor(t){super(),this.distance=t}async start(t,e){const i={x:t.player.position.x,y:t.player.position.y};await t.waitFor((()=>(0,ft.Io)(t.player.position,i)>this.distance))}get description(){return`Walk ${this.distance} units`}}class ic extends Qh{start(t,e){return t.waitFor((()=>0===t.world.entities.bucketSize(Ki.key)))}get description(){return"Wait until all enemies are gone"}}class sc extends Qh{constructor(t){super(),this.duration=t}start(t,e){return t.wait(this.duration)}get description(){return`Wait ${this.duration}s`}}class nc extends zi.X{constructor(){super(...arguments),this.key=nc.key,this.inFocus=!1,this.totalFocusTime=0}cycle(t){this.inFocus&&(this.totalFocusTime+=t)}}nc.key="focus-counter";class ac extends Qh{async start(t,e){await t.waitFor((()=>Oi(t.world.traitsOfType(nc)).totalFocusTime>0)),await t.wait(1)}}class rc extends Qh{constructor(t=500){super(),this.distance=t}async start(t,e){const i=e.advancedByAtLeast(this.distance);await t.waitFor((()=>{var e,s;return(null===(s=null===(e=t.player)||void 0===e?void 0:e.position)||void 0===s?void 0:s.x)>=i}))}get description(){return`Walk right by ${this.distance}`}}class oc extends Qh{constructor(t){super(),this.announcement=t}async start(t,e){const{world:i}=t,s=Oi(i.traitsOfType(Ms)),n=Oi(i.entities.bucket(ln.key));null==n||n.addEvent(new Ol),s.timeFactor(n)>.1&&(Oi(i.traitsOfType(vs)).setZoom(1.5,3),Oi(i.traitsOfType(Ms)).setTimeFactor(.1,.1,3));const a=new qi.wC(void 0,[new bs,new en.K(5)]);a.traitOfType(bs).message=this.announcement,i.entities.add(a),await t.wait(3)}get description(){return`Announce wave cleared (${this.announcement})`}}class hc extends Qh{constructor(t){super(),this.zoom=t}async start(t,e){Oi(t.world.traitsOfType(vs)).setZoom(this.zoom,Number.MAX_SAFE_INTEGER)}get description(){return`Set zoom to ${this.zoom}`}}class lc{constructor(){this.waves=[]}description(){return[`${this.levelId} - ${this.name}`,this.environment.description,this.waves.map((t=>t.description)).join("\n")].join("\n")}}class cc{get description(){return[`Wave ${this.waveId} (lvl: ${this.enemyMinLevel}-${this.enemyMaxLevel}) (${this.enemyCount} enemies):`,this.composition.description(this.enemyCount)].join(" ")}}function dc(t){let e=t.length;for(;0!=e;){let i=Math.floor(Math.random()*e);e--,[t[e],t[i]]=[t[i],t[e]]}}class uc extends zi.X{constructor(t=200){super(),this.padding=t,this.key=uc.key,this.maxY=Number.MAX_SAFE_INTEGER,this.cameraTrait=(0,xn.R)((()=>Oi(this.world.traitsOfType(Ji.O)))),this.reusableRect=new Wr.M}withMaxY(t){return this.maxY=t,this}cycle(t){const e=this.cameraTrait.value();if(!this.cameraTrait)return;this.reusableRect.centerAround(e.entity.position.x,e.entity.position.y,e.width,e.height).pad(this.padding,this.padding);const{minX:i,minY:s,maxX:n,maxY:a,midX:r,midY:o,width:h,height:l}=this.reusableRect;for(;!(0,ft.Bt)(i,this.entity.position.x,n);)this.entity.position.x+=Math.sign(r-this.entity.position.x)*h;for(;!(0,ft.Bt)(s,this.entity.position.y,a);){const t=this.entity.position.y+Math.sign(o-this.entity.position.y)*l;if(t>this.maxY)break;this.entity.position.y=t}}}uc.key="renewing-position";class pc extends zi.X{constructor(t=20){super(),this.density=t,this.key=pc.key,this.disableChunking=!0}static registryEntry(){return(0,gs.W)((t=>{t.traitClass(pc),t.simpleProp("density",as.Ut.num(0,400,1))}))}}pc.key="fog";class mc extends zi.X{constructor(t=20){super(),this.density=t,this.key=mc.key,this.disableChunking=!0}static registryEntry(){return(0,gs.W)((t=>{t.traitClass(mc),t.simpleProp("density",as.Ut.num(0,400,1))}))}}mc.key="rain";class yc extends zi.X{constructor(t=20){super(),this.density=t,this.key=yc.key,this.disableChunking=!0}static registryEntry(){return(0,gs.W)((t=>{t.traitClass(yc),t.simpleProp("density",as.Ut.num(0,400,1))}))}}yc.key="snow";class wc{}class gc extends zi.X{constructor(){super(...arguments),this.key=gc.key,this.nextThunder=1,this.reusableThunderEvent=new wc}cycle(t){this.nextThunder-=t,this.nextThunder<=0&&(this.nextThunder=10*Math.random()+5,this.entity.addEvent(this.reusableThunderEvent))}}gc.key="thunder";class fc extends zi.X{constructor(){super(...arguments),this.key=fc.key,this.surfaceProvider=fc.surfaceProvider}}fc.key="bush",fc.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));class vc extends zi.X{constructor(){super(...arguments),this.key=vc.key,this.surfaceProvider=vc.surfaceProvider}}vc.key="grass",vc.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));var bc=i(433);class Tc extends zi.X{constructor(){super(...arguments),this.key=Tc.key,this.inWaterChange=new bc.u}postBind(){super.postBind(),this.waterAffectedTrait=this.dependency(Us.key)}get inWater(){return this.waterAffectedTrait.inWater}cycle(t){const{inWater:e}=this;if(this.inWaterChange.requiresUpdate(e))for(const t of this.entity.traits.items())t===this||t instanceof uc||(t.enabled=!e)}}Tc.key="out-of-water";class kc extends zi.X{constructor(){super(...arguments),this.key=kc.key,this.surfaceProvider=kc.surfaceProvider}}kc.key="rock",kc.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));class xc extends zi.X{constructor(){super(...arguments),this.key=xc.key,this.surfaceProvider=xc.surfaceProvider}}xc.key="tree",xc.surfaceProvider=(0,Hs.z)(((t,e)=>{e.update(t.entity.position.x-100,t.entity.position.y-300,200,300),xr(e)}));class Cc extends zi.X{constructor(){super(...arguments),this.key=Cc.key,this.surfaceProvider=Cc.surfaceProvider}}function Ec(){return[new xc,new Gr(20),new Us,new Tc]}function Sc(){return[new vc,new Us,new Tc]}function Mc(){return[new fc,new Us,new Tc]}function Pc(){return[new kc,new Gr(40,10,Ur.RECTANGLE)]}Cc.key="tall-grass",Cc.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));class Ic extends zi.X{constructor(){super(...arguments),this.key=Ic.key,this.offset=2e3*Math.random()}sandY(t){return 100*Math.sin((t+this.offset)*Math.PI*2/2e3)+50*Math.sin((t+this.offset)*Math.PI*2/1e3)+this.entity.position.y}contains(t){return t.y>this.sandY(t.x)}}Ic.key="beach";class Ac{get description(){return this.constructor.name}generateFoliage(t,e,i){const{absoluteBounds:s}=Oi(t.traitsOfType(xo)),n=s.width*s.height,a=[];for(let t=0;t<s.width/i;t++)for(let e=0;e<s.height/i;e++)a.push([e,t]);dc(a);let r=0;const o=Oi(t.traitsOfType(yl));for(const{surface:h,traits:l,setupEntity:c}of e){const e=n/h;for(let n=0;n<e&&r<a.length;n++){const[e,n]=a[r++],h=new qi.wC(void 0,l());if(c&&c(h),h.position.x=s.minX+n*i+(0,wt.XU)(0,i),h.position.y=s.minY+e*i+(0,wt.XU)(0,i),o){const t=o.pathY(h.position.x);h.position.y=(0,ft.o8)(t-100,h.position.y,t+100)}t.entities.add(h)}}}generateFoliageForRectangle(t,e,i,s){const n=e.width*e.height,a=[];for(let t=0;t<e.width/s;t++)for(let i=0;i<e.height/s;i++)a.push([i,t]);dc(a);let r=0;const o=Oi(t.traitsOfType(yl));for(const{surface:h,traits:l,setupEntity:c}of i){const i=n/h;for(let n=0;n<i&&r<a.length;n++){const[i,n]=a[r++],h=new qi.wC(void 0,l());if(c&&c(h),h.position.x=e.minX+n*s+(0,wt.XU)(0,s),h.position.y=e.minY+i*s+(0,wt.XU)(0,s),o){const t=o.pathY(h.position.x);h.position.y=(0,ft.o8)(t-100,h.position.y,t+100)}t.entities.add(h)}}}generateRenewingFoliage(t,e,i){this.generateFoliageForRectangle(t,new Wr.M(0,0,2e3,2e3),e.map((({surface:t,traits:e,setupEntity:i})=>({surface:t,setupEntity:i,traits:()=>e().concat([new uc(400)])}))),i)}}class Oc extends Ac{constructor(t){super(),this.wrapped=t}get description(){return this.wrapped.map((t=>t.description)).join(" + ")}setup(t){for(const e of this.wrapped)e.setup(t)}}class Rc extends Ac{setup(t){}}class _c extends Ac{setup(t){t.entities.add(new qi.wC(void 0,[new mc(50),new gc]))}}class Bc extends Ac{setup(t){t.entities.add(new qi.wC(void 0,[new yc(100)]))}}class Lc extends Ac{setup(t){this.generateRenewingFoliage(t,[{surface:16e4,traits:()=>Ec()},{surface:16e4,traits:()=>Pc()},{surface:9e4,traits:()=>Mc()},{surface:22500,traits:()=>Sc()}],100)}}class Dc extends Ac{setup(t){Oi(t.traitsOfType(Ul)).season=this.season.clone()}}class Vc extends Dc{constructor(){super(...arguments),this.season=Nl.SUMMER.clone(),this.weatherTypes=[new Rc,new _c]}}class Hc extends Ac{setup(t){this.generateRenewingFoliage(t,[{surface:16e4,traits:()=>Ec()},{surface:36e4,traits:()=>Pc()},{surface:16e4,traits:()=>Mc()},{surface:22500,traits:()=>Sc()}],100)}}class Fc extends Ac{setup(t){const e=(0,qi.EG)([new Ns]);e.position.y=200,t.entities.add(e);const i=(0,qi.EG)([new Ic]);i.position.y=-200,t.entities.add(i),this.generateRenewingFoliage(t,[{surface:25e4,traits:()=>Ec().concat([new uc(400).withMaxY(-400)])},{surface:16e4,traits:()=>Pc()},{surface:4e4,traits:()=>Mc()},{surface:22500,traits:()=>Sc()}],100)}}class Nc extends Ac{setup(t){this.generateRenewingFoliage(t,[{surface:25e4,traits:()=>Ec()},{surface:16e4,traits:()=>Pc()},{surface:1e4,traits:()=>[new Cc,new Us,new Tc]},{surface:4e4,traits:()=>Mc()},{surface:1e4,traits:()=>Sc()}],100)}}class Uc extends Ac{setup(t){this.generateRenewingFoliage(t,[{surface:25e4,traits(){const t=new Fs;return t.width=(0,wt.XU)(100,300),t.height=(0,wt.XU)(100,300),[t]},setupEntity(t){t.angle=(0,wt.YR)(0,2*Math.PI)}},{surface:36e4,traits:()=>Ec()},{surface:16e4,traits:()=>Mc()},{surface:4e4,traits:()=>Sc()}],100)}}class Wc extends Ac{constructor(){super(...arguments),this.mainOffset=(0,wt.XU)(0,2e3),this.wiggleOffset=(0,wt.XU)(0,1e3),this.pathShift=(0,wt.F5)([-1,1])*(0,wt.XU)(100,200)}pathY(t){return 200*Math.sin((t+this.mainOffset)*Math.PI*2/2e3)+100*Math.sin((t+this.wiggleOffset)*Math.PI*2/1e3)+this.pathShift}setup(t){const{absoluteBounds:e}=Oi(t.traitsOfType(xo));for(let i=e.minX-800;i<e.maxX;i+=500){const e=this.pathY(i),s=new qi.wC(void 0,[new Fs,new wh]),n=i+500,a=this.pathY(n);s.position.x=(i+n)/2,s.position.y=(e+a)/2,s.angle=ls({x:i,y:e},{x:n,y:a}),s.traitOfType(Fs).width=(0,ft.Io)({x:i,y:e},{x:n,y:a})+100,s.traitOfType(Fs).height=(0,wt.XU)(100,200),t.entities.add(s)}this.generateRenewingFoliage(t,[{surface:4e4,traits:()=>Pc()},{surface:16e4,traits:()=>Mc()},{surface:1e4,traits:()=>Sc()},{surface:36e4,traits:()=>Ec()}],100)}}class Xc extends Ac{setup(t){const{absoluteBounds:e,bounds:i}=Oi(t.traitsOfType(xo));e.centerAround(0,0,1600,1600),i.copy(e);for(let i=0;i<1;i+=1/30){const s=i*Math.PI*2,n=.4*e.width,a=new qi.wC(void 0,Ec());a.position.x=e.midX+Math.cos(s)*n+(0,wt.XU)(-50,50),a.position.y=e.midY+Math.sin(s)*n+(0,wt.XU)(-50,50),t.entities.add(a)}for(let e=0;e<100;e++){const e=new qi.wC(void 0,Sc());e.position.x=(0,wt.XU)(-1e3,1e3),e.position.y=(0,wt.XU)(-1e3,1e3),t.entities.add(e)}for(let e=0;e<10;e++){const e=new qi.wC(void 0,Mc());e.position.x=(0,wt.XU)(-1e3,1e3),e.position.y=(0,wt.XU)(-1e3,1e3),t.entities.add(e)}}}const Gc=[new Vc,new class extends Dc{constructor(){super(...arguments),this.season=Nl.FALL.clone(),this.weatherTypes=[new Rc,new _c]}},new class extends Dc{constructor(){super(...arguments),this.season=Nl.WINTER.clone(),this.weatherTypes=[new Bc]}},new class extends Dc{constructor(){super(...arguments),this.season=Nl.SPRING.clone(),this.weatherTypes=[new Rc,new _c]}}],zc=["Egelund","Dyblev","Kalnu","Palmme","Kokhava","Keravesi","Vopnatanes","Seyðisður","Tupils","Sagda","Drusšciai","Kudirpole","Arenland","Haugekim","Ålhälla","Örehättan"];class Kc{constructor(t){this.compositions=t,this.totalWeight=0;for(const[t,e]of this.compositions)this.totalWeight+=e;this.compositions.sort(((t,e)=>t[1]-e[1]))}hasKing(){return this.compositions.some((([t,e])=>t.hasKing()))}description(t){const e=[];for(const[i,s]of this.compositions){const n=Math.min(t,Math.ceil(t*s/this.totalWeight));e.push(`${i.description} x ${n}`),t-=n}return e.join(", ")}*entityGroups(t){for(const[e,i]of this.compositions){const s=Math.min(t,Math.ceil(t*i/this.totalWeight));for(let t=0;t<s;t++)yield e.createEntities();t-=s}}*entities(t){for(const e of this.entityGroups(t))yield*e}}class Yc extends Qh{start(t,e){return t.waitFor((()=>0===t.world.entities.bucketSize(yn.key)))}get description(){return"Wait until all kings are gone"}}const qc=[new Kc([[new ch,1]]),new Kc([[new ch,1],[new dh,1]]),new Kc([[new class extends hh{constructor(){super(...arguments),this.shop=new ki(Oe,re,ae,je,ui)}createEntities(){const t=this.shopping(new qi.wC(void 0,ah().concat([new Ir,new on])),this.shop);return t.traitOfType(Pr).setAI(oh()),[t]}},1],[new ch,2],[new dh,2]])],jc=[new Kc([[new lh,3],[new Zh,1]]),new Kc([[new lh,3],[new uh,1]]),new Kc([[new lh,4],[new uh,4],[new ph,1]])],$c=[new Kc([[new uh,2],[new lh,1]]),new Kc([[new uh,1],[new lh,1],[new Zh,2]]),new Kc([[new uh,2],[new lh,4],[new uh,4],[new ph,1]])],Jc=[new Kc([[new Th,3]]),new Kc([[new Th,2],[new kh,3]]),new Kc([[new xh,1],[new Th,3],[new kh,3]])],Zc=[new Kc([[new Th,3],[new Zh,1]]),new Kc([[new Th,5],[new bh(new Th,new vh),1]]),new Kc([[new Th,5],[new Zh,1],[new bh(new Th,new vh),1]])],Qc=[new Kc([[new Zh,2],[new Th,4],[new kh,1]]),new Kc([[new Zh,2],[new Th,3],[new kh,2],[new bh(new kh,new vh),1]]),new Kc([[new Zh,1],[new Th,4],[new kh,2],[new Ch,1]])],td=[new Kc([[new Th,1],[new lh,1]]),new Kc([[new Th,1],[new lh,1],[new Zh,1]]),new Kc([[new Th,2],[new lh,2],[new Ch,1]])],ed=[new Kc([[new Rh,1],[new Th,6]]),new Kc([[new Th,2],[new kh,2]]),new Kc([[new Th,4],[new kh,2],[new Ch,1]])],id=[new Kc([[new Bh,1],[new lh,6]]),new Kc([[new Zh,4],[new lh,1]]),new Kc([[new Bh,1],[new lh,4],[new Zh,1]])],sd=[new Kc([[new lh,4],[new Zh,1],[new _h,1]]),new Kc([[new lh,1],[new Zh,4],[new _h,1]]),new Kc([[new lh,4],[new Zh,2],[new _h,2]])],nd=[new Kc([[new Th,4],[new Zh,1],[new bh(new Th,new vh),1]]),new Kc([[new Th,4],[new kh,4],[new Zh,4],[new bh(new Th,new vh),3]]),new Kc([[new Ch,1],[new Th,5],[new bh(new Th,new vh),2],[new bh(new kh,new vh),2]])],ad=[new Kc([[new xh,1],[new Ch,1],[new kh,2],[new Th,2]]),new Kc([[new lh,1],[new Ch,1],[new _h,1],[new Bh,1],[new kh,2],[new Th,2],[new Zh,4]]),new Kc([[new bh(new class extends hh{constructor(){super(...arguments),this.shop=new ki(Ye,ri,di,ti,ce,Ee)}hasKing(){return!0}createEntities(){return[this.shopping(new qi.wC(void 0,ah().concat([new yn])),this.shop)]}},new vh),1e-4],[new xh,1],[new Rh,1],[new Ch,1],[new kh,4],[new Th,4],[new Zh,2]])],rd=[];function od(t){if(!rd[t]){const e=ld(t+1);for(const t of e)rd[t.levelId]=t}return rd[t]}function hd(){return ld().length}function ld(t){const e=[];let i=0,s=0,n=0;const a=new Map,r=[qc,Jc,jc,Zc,id,nd,ed,$c,sd,td,Qc,ad];t=void 0===t?r.length:t;for(let o=0;o<t;o++){const t=r[o%r.length],h=Gc[i%Gc.length],l=a.get(h)||0,c=h.weatherTypes[l%h.weatherTypes.length];a.set(h,l+1);const d=zc[i%zc.length],u=[[`${d}'s road`,new Hc],[`Forest of ${d}`,new Lc],[`${d} beach`,new Fc],[`${d} river`,new Wc],[`${d} swamps`,new Uc],[`${d} fields`,new Nc]],[p,m]=u[i%u.length],y=new lc;y.levelId=i,y.name=p,y.season=h.season,y.environment=new Oc([h,m,c].filter((t=>!!t)));for(const e of t){const t=new cc;t.waveId=s,t.composition=e,t.enemyCount=Ct(s),t.enemyMinLevel=Tt(n),t.enemyMaxLevel=t.enemyMinLevel+3,0===i&&(t.enemyMaxLevel=t.enemyMinLevel),y.waves.push(t),n+=t.enemyCount*xt(Math.round(gt(t.enemyMinLevel,t.enemyMaxLevel,.75)),Tt(n)),s++}e.push(y),i++}return e}var cd=i(1166),dd=i(9856),ud=i(9251);class pd extends zi.X{constructor(){super(...arguments),this.key=pd.key,this.isExpanded=!1,this.area=null,this.entities=[],this.surfaceProvider=pd.surfaceProvider}add(t){const e=new Wr.M;for(const i of t.traits.items())i.surfaceProvider.surface(i,e),this.area?this.area.combineBounds(e):this.area=e.clone();this.entities.push(t),this.isExpanded?this.world.entities.add(t):t.remove()}cycle(){var t,e;const i=Oi(null===(e=null===(t=this.entity)||void 0===t?void 0:t.world)||void 0===e?void 0:e.traitsOfType(Ji.O));if(!i)return;const{visibleRectangle:s}=i,n=s.intersects(this.area);if(n!==this.isExpanded){this.isExpanded=n;for(const t of this.entities)n?this.world.entities.add(t):t.remove()}}static chunkify(t,e){for(const i of Array.from(t)){if(i.traitOfType(uc))continue;const{world:t}=i,s=`${Math.floor(i.position.x/e)},${Math.floor(i.position.y/e)}`;let n=t.entity(s);n||(n=new qi.wC(s,[new pd]),t.entities.add(n)),n.traitOfType(pd).add(i)}}}pd.key="area-chunk",pd.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100)}));class md extends zi.X{constructor(){super(...arguments),this.key=md.key,this.speed=300}postBind(){super.postBind(),this.newTrajectory()}newTrajectory(){var t,e;this.entity.angle=(0,wt.YR)(Math.PI/4,3*Math.PI/4),this.speed=(0,wt.XU)(200,300);const i=Oi(null===(e=null===(t=this.entity)||void 0===t?void 0:t.world)||void 0===e?void 0:e.traitsOfType(Ji.O));if(!i)return;const{visibleRectangle:s}=i;this.entity.position.x=(0,wt.XU)(s.minX,s.maxX),this.entity.position.y=s.minY}cycle(t){const e=Oi(this.entity.world.traitsOfType(Ji.O));if(!e)return;const{visibleRectangle:i}=e;(this.entity.position.y>i.maxY+50||this.entity.position.x<i.minX-.5*i.width||this.entity.position.x>i.maxX+.5*i.width)&&this.newTrajectory(),this.entity.x+=Math.cos(this.entity.angle)*this.speed*t,this.entity.y+=Math.sin(this.entity.angle)*this.speed*t}}md.key="bird";class yd extends zi.X{constructor(){super(...arguments),this.key=yd.key,this.surfaceProvider=yd.surfaceProvider}}yd.key="spike",yd.surfaceProvider=(0,Hs.z)(((t,e)=>{e.centerAround(t.entity.x,t.entity.y,100,100),xr(e)}));class wd{constructor(){this.progression={inventory:Si(),experience:0,baseStats:new Mt,ownedItems:new Set,levelIndex:0},this.conditions=[],this.age=0,this.mobile=!1}createWorld(){const t=new cd.H,e=new Ms;t.entities.add((0,qi.EG)([e])),t.entities.add((0,qi.EG)([new _l])),t.entityTimeFactorProvider=t=>e.timeFactor(t),t.events.pipe((0,ud.p)((t=>t instanceof os))).subscribe((t=>this.triggerEnd(is.FAILED,2,t.reason))),t.events.pipe((0,ud.p)((t=>t instanceof rs))).subscribe((t=>this.triggerEnd(is.COMPLETED,0,t.reason)));const i=(this.mobile,2),s=new Ji.O,n=(0,qi.EG)([s,new dd.F,new vs,new Qi]);return n.traitOfType(dd.F).targetTraitKeys=[ln.key],n.traitOfType(dd.F).offset.y=-30,n.traitOfType(Ji.O).width=1600,n.traitOfType(Ji.O).height=900,n.traitOfType(Ji.O).zoom=i,n.traitOfType(vs).baseZoom=i,t.entities.add(n),t.entities.add((0,qi.EG)([new Ul])),t.entities.add((0,qi.EG)([new xo])),t.entities.add((0,qi.EG)([new ds])),t.entities.add((0,qi.EG)([new fs])),t.entities.add((0,qi.EG)([new nc])),t}bind(t){this.world=this.createWorld();for(let t=0;t<2;t++)this.world.entities.add((0,qi.EG)([new md]));this.achievementWatcher=t,this.achievementWatcher.bind(this.world)}postBind(){this.achievementWatcher.postBind()}triggerStart(){pd.chunkify(this.world.entities.bucket(vc.key),400),pd.chunkify(this.world.entities.bucket(xc.key),400),pd.chunkify(this.world.entities.bucket(kc.key),400),pd.chunkify(this.world.entities.bucket(fc.key),400),pd.chunkify(this.world.entities.bucket(Fs.key),400),pd.chunkify(this.world.entities.bucket(yd.key),400)}triggerEnd(t,e,i){this.world.entity("level-end")||(this.world.entities.add((0,qi.EG)("level-end",[])),this.world.entities.add((0,qi.EG)([new ji.H(e,(e=>{e.addEvent(new hs(t))}))])))}spawnEntity(t){const e=new qi.wC(void 0,t);return this.world.entities.add(e),e}get player(){var t,e;return Oi(null===(e=null===(t=this.world)||void 0===t?void 0:t.entities)||void 0===e?void 0:e.bucket(ln.key))}cycle(t){this.age+=t,this.world.cycle(t);let e=0;for(;this.conditions[e];){const{condition:t,resolve:i,reject:s}=this.conditions[e];t()?(i(),this.conditions.splice(e,1)):e++}}cycleSafe(t){let e=t;for(;e>0;){const t=Math.min(e,1/120);e-=t,this.cycle(t)}this.achievementWatcher.update();const{player:i}=this;i&&(this.progression.inventory=i.traitOfType(mn).inventory,this.progression.experience=i.traitOfType(Xs).experience,this.progression.baseStats=i.traitOfType(hn).baseStats)}wait(t){const e=this.age+t;return this.waitFor((()=>this.age>=e))}waitFor(t){return new Promise(((e,i)=>{this.conditions.push({resolve:e,reject:i,condition:t})}))}async instructedTask(t,e,i=(()=>{})){const s=new qi.wC(void 0,[new Ts]);s.traitOfType(Ts).message=t,this.world.entities.add(s),await this.waitFor(e),s.traitOfType(Ts).resolved=!0,i(),await this.wait(2),s.remove()}async repeatedTask(t,e,i){for(const t of this.world.traitsOfType(Ts))t.enabled=!1;const s=(0,qi.EG)([new Ts]);this.world.entities.add(s);for(let n=0;n<e;n++)s.traitOfType(Ts).message=`${t} (${n}/${e})`,await i();s.traitOfType(Ts).message=`${t} (${e}/${e})`,s.traitOfType(Ts).resolved=!0,await this.wait(2),s.remove()}async waveCleared(){const t=Oi(this.world.traitsOfType(Ms)),e=Oi(this.world.entities.bucket(ln.key));t.timeFactor(e)<.1&&(Oi(this.world.traitsOfType(vs)).setZoom(1.5,3),Oi(this.world.traitsOfType(Ms)).setTimeFactor(.1,.1,3));const i=new qi.wC(void 0,[new bs,new en.K(5)]);i.traitOfType(bs).message=pt("waveCleared"),this.world.entities.add(i)}}class gd{constructor(t){this.world=t,this.x=0}get currentX(){return this.x}advancedByAtLeast(t){const{visibleRectangle:e}=Oi(this.world.traitsOfType(Ji.O));return this.x=Math.max(this.x,e.maxX)+t,this.x}}class fd extends wd{constructor(t){super(),this.scenario=t}triggerStart(){super.triggerStart(),(async()=>{const t=new gd(this.world);await this.scenario.start(this,t)})()}}var vd,bd=i(5270),Td=i(9974),kd=i(8294),xd=i(2911),Cd=i(6920);!function(t){t.BACKGROUND_FILL="background-fill",t.OVER_HUD_UI="over-hud-ui",t.PATH="path",t.WATER="water",t.UNDER_WORLD_UI="under-world-ui",t.SHADOWS="shadows",t.WORLD="world",t.OBSCURED_OUTLINES="obscured-outlines",t.PARTICLES="particles",t.WORLD_AERIAL="world-aerial",t.OVER_WORLD_UI="world-ui",t.WEATHER="weather",t.HUD_INDICATORS="hud-indicators",t.HUD_UI="hud-ui",t.DEATH_OVERLAY="death-overlay",t.DEBUG_FOREGROUND="debug-foreground"}(vd||(vd={}));class Ed extends f.Container{constructor(){super();for(const t of[Math.PI/4,-Math.PI/4]){const e=new f.Sprite(f.Texture.WHITE);e.width=30,e.height=10,e.rotation=t,e.tint=0,e.anchor.set(.5,.5),this.addChild(e)}}}Cd.z;class Sd extends f.Container{constructor(){super(),this.head=(()=>{const t=new Da,e=new Nt;return e.mainColor=Ve.item.description.mainColor,e.teeColor=0,t.setHelmetDescription(e),t})(),this.chest=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=20,t.height=30,t})(),this.shoulders=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=35,t.height=5,t})(),this.pillar=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=4,t.height=20,t})(),this.addChild(this.pillar,this.shoulders,this.head,this.chest)}update(t){this.chest.position.set(0,-this.pillar.height),this.head.position.set(0,this.chest.position.y-this.chest.height),this.shoulders.position.set(0,this.chest.position.y-this.chest.height+5),this.head.setRecentlyHit(t),this.chest.tint=t?16777215:7166783,this.pillar.tint=t?16777215:6303808,this.shoulders.tint=t?16777215:6303808}}class Md extends f.Container{constructor(){super(),this.center=new f.Container,this.chest=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=20,t.height=30,t})(),this.cape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=22,t.height=40,t})(),this.forwardLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=20,t})(),this.backLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=20,t})(),this.head=new Ia,this.addChild(this.center),this.center.addChild(this.cape,this.forwardLeg,this.backLeg,this.head,this.chest),this.backLeg.position.set(-6,12),this.forwardLeg.position.set(6,12),this.head.position.set(0,-this.chest.height/2),this.cape.position.set(0,-this.chest.height/2)}update(t,e,i){const s=e>0,n=e/300;this.cape.rotation=Math.sin(t*Math.PI*2)*Math.PI/64+Math.PI/32,s?(this.backLeg.rotation=-Math.sin(t*Math.PI*2*4)*Math.PI/16*n,this.forwardLeg.rotation=Math.sin(t*Math.PI*2*4)*Math.PI/16*n):(this.backLeg.rotation=0,this.forwardLeg.rotation=0),this.chest.rotation=s?-Math.sin(t*Math.PI*2*4)*Math.PI/64*n:Math.sin(t*Math.PI*2/5)*Math.PI/128,this.head.rotation=s?-Math.sin(t*Math.PI*2*4)*Math.PI/32*n:0,this.head.setRecentlyHit(i),this.chest.tint=i?16777215:ee(10510416,.9),this.forwardLeg.tint=i?16777215:4194304,this.backLeg.tint=i?16777215:4194304,this.cape.tint=i?16777215:ee(10510416,.7),this.center.position.set(0,-this.backLeg.height-this.chest.height/2+5)}}class Pd extends f.Graphics{constructor(){super(),this.lineStyle({width:10,color:16777215}),this.moveTo(-20,-20),this.lineTo(0,0),this.lineTo(-20,20)}}class Id extends f.Container{constructor(){super(),this.pointer=new Pd,this.sprite=(()=>{const t=new f.Sprite;return t.position.set(-50,0),t.anchor.set(.5,.5),t.width=25,t.scale.y=t.scale.x,t})(),this.addChild(this.pointer,this.sprite)}setup(t,e){this.pointer.tint=t,this.sprite.tint=t,this.sprite.texture=e,this.sprite.width=25,this.sprite.scale.y=this.sprite.scale.x}setOrientation(t){this.rotation=t,this.sprite.rotation=-t}}class Ad extends f.Container{constructor(t){super(),this.texturePool=t,this.sprite=(()=>{const t=new f.Sprite;return t.anchor.set(.5,.5),t})(),this.addChild(this.sprite)}setValue(t,e){const i=bt.indexOf(t),s=[this.texturePool.catalog.coin,this.texturePool.catalog.gem,this.texturePool.catalog.ruby];this.sprite.texture=s[Math.min(i,s.length-1)],this.sprite.width=10,this.sprite.scale.y=this.sprite.scale.x,this.sprite.rotation=0===i?0:e}}const Od=Math.PI/4;class Rd extends Cd.z{}class _d extends Cd.z{constructor(){super(...arguments),this.layerId=vd.SHADOWS,this.lastShadowUpdate=0,this.updateInterval=0}forViewController(t,e=1/60){return this.original=t,this.updateInterval=e,this}postBind(){super.postBind(),this.outOfWaterTrait=this.entity.traitOfType(Tc),this.lastShadowUpdate=-9999}createView(){const t=this.original.createView();return function(t){t.skew.x=Od,t.scale.y=1/Math.cos(t.skew.x)/2}(t),t.cacheAsBitmap=!1,t}updateView(t,e){if(this.worldViewController.age-this.lastShadowUpdate<this.updateInterval)return;this.lastShadowUpdate=this.worldViewController.age;const i=this.original;i.updateFoliageView?i.updateFoliageView(t,e):i.updateView(t,e),t.alpha=1,t.position.y-=.01}removeEmitter(){return this.original.removeEmitter()}destroyView(t){super.destroyView(t),t.skew.x=0,t.scale.y=1}updateVisibilityRectangle(){const t=Math.cos(Od)*this.original.visibilityRectangle.width*.8;this.visibilityRectangle.update(this.original.visibilityRectangle.x-t,this.original.visibilityRectangle.y,this.original.visibilityRectangle.width+t,this.original.visibilityRectangle.height)}isVisible(){var t;return!(null===(t=this.outOfWaterTrait)||void 0===t?void 0:t.inWater)&&super.isVisible()}}class Bd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws)}createView(){return this.viewPool.take()}updateView(t){!function(t,e){t.position.set(e.entity.position.x,e.entity.position.y),t.update((null==e?void 0:e.recentlyDamaged(.1))||!1)}(t,this.healthTrait)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}function Ld(t,e,i,s,n,a=9999){t.position.set(e.entity.position.x,e.entity.position.y),t.update(e.entity.age,(null==e?void 0:e.walking)?e.effectiveSpeed:0,(null==i?void 0:i.recentlyDamaged(.1))||!1,null==s?void 0:s.inWater);const r=e.facing,o=(0,ft.Tq)(1*-a/.05,r-t.scale.x,1*a/.05);t.scale.set(t.scale.x+o,1),n&&n.preparingAttack!==Ls.NONE&&Fd.CHARGING.apply(t,Fd.CHARGING.duration*n.preparationRatio)}class Dd{progress(t){return Math.min(1,t/this.duration)}}class Vd extends Dd{progress(t){return t%this.duration/this.duration}}class Hd extends Vd{constructor(){super(...arguments),this.duration=.5}apply(t,e){const i=this.progress(e);t.center.rotation+=-Math.PI/4*i,t.center.position.y+=-20*i,t.backLeg.rotation-=-Math.PI/4*i,t.frontLeg.rotation-=-Math.PI/4*i,t.frontArm.rotation+=-Math.PI/4*i,t.backArm.rotation+=-Math.PI/4*i}}class Fd extends f.Container{constructor(){super(),this.body=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.width=50,t.height=25,t.anchor.set(.5,.5),t.tint=3158064,t})(),this.frontLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=30,t.tint=3158064,t})(),this.backLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=30,t.tint=0,t})(),this.frontArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=30,t.tint=3158064,t})(),this.backArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=6,t.height=30,t.tint=0,t})(),this.seatCenter=new f.Container,this.reusablePoint=new f.Point,this.neck=new f.Container,this.neckShape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.width=30,t.height=15,t.tint=3158064,t})(),this.neckHair=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.width=20,t.height=5,t.tint=3158064,t.position.set(5,-5),t})(),this.head=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.2,.5),t.width=30,t.height=12,t.tint=3158064,t})(),this.tail=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.width=40,t.height=5,t.tint=0,t})(),this.frontEar=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=2,t.height=10,t.tint=3158064,t})(),this.backEar=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=2,t.height=10,t.tint=0,t})(),this.waterMask=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=16711680,t.width=150,t.height=100,t.anchor.set(.5,1),t.visible=!1,t})(),this.center=new f.Container,this.reusableBounds=new f.Rectangle,this.addChild(this.center,this.waterMask),this.center.addChild(this.backLeg,this.backArm,this.frontLeg,this.frontArm,this.tail,this.neck,this.body),this.neck.addChild(this.neckShape,this.head,this.neckHair),this.head.addChild(this.backEar,this.frontEar),this.center.addChild(this.seatCenter)}seatCenterPosition(t){const e=this.seatCenter.getGlobalPosition(this.reusablePoint,!1);this.toLocal(e,null,t)}update(t,e,i,s){Fd.RESET.apply(this,t),Fd.BREATHING.apply(this,t),e>0&&Fd.WALKING.apply(this,t),this.center.mask=s?this.waterMask:null,this.waterMask.visible=s,this.tail.tint=i?16777215:0;const n=i?16777215:6042921,a=i?16777215:ee(n,.8);this.body.tint=n,this.frontLeg.tint=n,this.frontArm.tint=n,this.backLeg.tint=a,this.backArm.tint=a,this.neckShape.tint=n,this.head.tint=n,this.frontEar.tint=n,this.neckHair.tint=a,s&&(this.center.position.y+=10)}}Fd.RESET=new class extends Dd{constructor(){super(...arguments),this.duration=1/4}apply(t,e){t.alpha=1,t.frontLeg.position.set(-22,11),t.backLeg.position.set(t.frontLeg.position.x+4,t.frontLeg.position.y-2),t.frontArm.position.set(22,11),t.backArm.position.set(t.frontArm.position.x-4,t.frontArm.position.y-2),t.frontLeg.rotation=0,t.backLeg.rotation=0,t.frontArm.rotation=0,t.backArm.rotation=0,t.neck.position.set(18,-6),t.head.position.set(24,0),t.frontEar.position.set(-3,-6),t.backEar.position.set(t.frontEar.position.x+2,t.frontEar.position.y),t.tail.position.set(-22,-10),t.tail.rotation=0,t.head.rotation=Math.PI/2+Math.PI/16,t.center.position.set(5,-40),t.center.scale.set(1,1),t.center.rotation=0,t.tail.rotation=Math.PI/2+Math.PI/6,t.neck.rotation=-Math.PI/4,t.body.rotation=0,t.seatCenter.position.set(0,-8)}},Fd.BREATHING=new class extends Vd{constructor(){super(...arguments),this.duration=8}apply(t,e){t.tail.rotation=Math.PI/2+Math.PI/8+Math.sin(this.progress(e)*Math.PI*2)*Math.PI/16,t.neck.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/32}},Fd.WALKING=new class extends Vd{constructor(){super(...arguments),this.duration=.5}apply(t,e){t.neck.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/16,t.tail.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/16,t.frontLeg.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/8,t.backLeg.rotation=-t.frontLeg.rotation,t.frontArm.rotation=t.frontLeg.rotation,t.backArm.rotation=-t.frontArm.rotation,t.body.rotation=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/64}},Fd.CHARGING=new class extends Dd{constructor(t){super(),this.animations=t,this.duration=0,this.duration=t.reduce(((t,e)=>t+e.duration),0)}apply(t,e){let i=0;for(;this.animations[i]&&e>this.animations[i].duration;)e-=this.animations[i].duration,i++;if(this.animations[i])this.animations[i].apply(t,e);else{const e=this.animations[this.animations.length-1];this.animations[this.animations.length-1].apply(t,e.duration)}}}([new Hd,new class extends Vd{constructor(){super(...arguments),this.duration=.5,this.charge=new Hd}apply(t,e){const i=this.progress(e);this.charge.apply(t,this.charge.duration*(1-i))}}]);class Nd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws),this.healthTrait=this.entity.traitOfType(ws),this.waterAffectedTrait=this.entity.traitOfType(Us)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),Ld(t,this.walkerTrait,this.healthTrait,this.waterAffectedTrait,this.entity.traitOfType(tn),e)}}const Ud=new Fd;function Wd(t,e,i,s,n,a,r,o,h,l,c,d=9999){var u,p,m,y,w,g;const f=i||n;t.position.set(f.entity.position.x,f.entity.position.y);const{age:v}=f.entity,b=null===(u=null==i?void 0:i.stateMachine)||void 0===u?void 0:u.currentState;t.update(f.entity.age,(null==s?void 0:s.walking)?s.effectiveSpeed:0,(null==b?void 0:b.toolCharge)||0,(null==b?void 0:b.shieldCharge)||0,(null==o?void 0:o.rollRatio)||0,(null==n?void 0:n.recentlyDamaged(.1))||!1,null==a?void 0:a.inWater,null===(p=null==r?void 0:r.inventory)||void 0===p?void 0:p.armor,null===(m=null==r?void 0:r.inventory)||void 0===m?void 0:m.helmet,null===(y=null==r?void 0:r.inventory)||void 0===y?void 0:y.shield,null===(w=null==r?void 0:r.inventory)||void 0===w?void 0:w.tool,null===(g=null==r?void 0:r.inventory)||void 0===g?void 0:g.cape);let T=(null==s?void 0:s.facing)||1,k=1;if(l&&(T*=1.4,k*=1.4),null==o?void 0:o.rollRatio)t.scale.set(T,k);else{const e=(0,ft.Tq)(1*-d/.05,T-t.scale.x,1*d/.05);t.scale.set(t.scale.x+e,k)}if((null==h?void 0:h.staggered)&&(h.recoveryProgress>0?Ga.GETTING_UP.apply(t,Ga.GETTING_UP.duration*h.recoveryProgress):Ga.FALLING_DOWN.apply(t,h.staggeredAge)),c){const{horse:e}=c;e&&(Ld(Ud,e.traitOfType(Ws),null,e.traitOfType(Us),e.traitOfType(tn)),t.rideHorse(Ud,v))}if(i){let n=e.inputs.aim.x-i.entity.position.x,a=e.inputs.aim.y-i.entity.position.y;-1===s.facing&&(n*=-1),t.forwardShoulder.rotation+=(0,ft.Tq)(-(Math.PI/2-Math.PI/6),Math.atan2(.5*a,n),Math.PI/2-Math.PI/6)}}class Xd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.controllableTrait=this.entity.traitOfType(Rs),this.walkerTrait=this.entity.traitOfType(Ws),this.knightTrait=this.entity.traitOfType(ko),this.healthTrait=this.entity.traitOfType(ws),this.waterAffectedTrait=this.entity.traitOfType(Us),this.inventoryTrait=this.entity.traitOfType(mn),this.dasherTrait=this.entity.traitOfType(Lr),this.bruteTrait=this.entity.traitOfType(Br),this.staggerableTrait=this.entity.traitOfType(Qs),this.horseRiderTrait=this.entity.traitOfType(to)}createView(){return this.viewPool.take()}updateView(t,e){Wd(t,this.controllableTrait,this.knightTrait,this.walkerTrait,this.healthTrait,this.waterAffectedTrait,this.inventoryTrait,this.dasherTrait,this.staggerableTrait,this.bruteTrait,this.horseRiderTrait,e)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}class Gd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws),this.inventoryTrait=this.entity.traitOfType(mn)}createView(){return this.viewPool.take()}updateView(t,e){Wd(t,null,null,null,this.healthTrait,null,this.inventoryTrait,null,null,null,null,e)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}class zd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws),this.npcTrait=this.entity.traitOfType(al),this.healthTrait=this.entity.traitOfType(ws)}createView(){return this.viewPool.take()}updateView(t){!function(t,e,i,s){t.position.set(e.entity.position.x,e.entity.position.y),t.update(e.entity.age,(null==i?void 0:i.walking)?i.effectiveSpeed:0,(null==s?void 0:s.recentlyDamaged(.1))||!1)}(t,this.npcTrait,this.walkerTrait,this.healthTrait)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}var Kd=i(2359);class Yd extends Cd.z{constructor(){super(...arguments),this.layerId=vd.OVER_WORLD_UI,this.outlineFilter=(()=>{const t=new Kd.f(2,9437184,.5,1,!0);return t.resolution=1,t})(),this.firstFrame=!0}for(t){return this.original=t,this}postBind(){super.postBind(),this.firstFrame=!0}tearDown(){super.tearDown(),this.original=null}createView(){const t=this.original.createView();return t.filters=[this.outlineFilter],this.outlineFilter.color=this.entity.traitOfType(Ki)?9437184:65280,t}destroyView(t){super.destroyView(t),t.filters=null}updateView(t,e){this.original.updateView(t,this.firstFrame?99:e),this.firstFrame=!1}removeEmitter(){return this.original.removeEmitter()}isVisible(){var t;const e=Oi(this.worldViewController.world.entities.bucket(ln.key));return(null===(t=null==e?void 0:e.traitOfType(tn))||void 0===t?void 0:t.lungeVictim)===this.entity}}function qd(t,e,i,s,n,a=9999){t.position.set(e.entity.position.x,e.entity.position.y),t.update(e.entity.age,(null==e?void 0:e.walking)?e.effectiveSpeed:0,(null==i?void 0:i.recentlyDamaged(.1))||!1,null==s?void 0:s.inWater);const r=e.facing,o=(0,ft.Tq)(1*-a/.05,r-t.scale.x,1*a/.05);t.scale.set(t.scale.x+o,1),(null==n?void 0:n.staggered)&&(n.recoveryProgress>0?Jd.GETTING_UP.apply(t,Jd.GETTING_UP.duration*n.recoveryProgress):Jd.FALLING_DOWN.apply(t,n.staggeredAge))}class jd{progress(t){return Math.min(1,t/this.duration)}}class $d extends jd{progress(t){return t%this.duration/this.duration}}class Jd extends f.Container{constructor(){super(),this.body=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.width=30,t.height=15,t.anchor.set(.5,.5),t.tint=3158064,t})(),this.frontLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=4,t.height=15,t.tint=3158064,t})(),this.backLeg=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=4,t.height=15,t.tint=0,t})(),this.frontArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=4,t.height=15,t.tint=3158064,t})(),this.backArm=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,0),t.width=4,t.height=15,t.tint=0,t})(),this.neck=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.width=10,t.height=10,t.tint=3158064,t})(),this.head=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.3,.5),t.width=25,t.height=10,t.tint=3158064,t})(),this.tail=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(0,.5),t.width=20,t.height=3,t.tint=3158064,t})(),this.frontEar=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=3,t.height=15,t.tint=3158064,t})(),this.backEar=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=3,t.height=15,t.tint=0,t})(),this.waterMask=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=16711680,t.width=150,t.height=100,t.anchor.set(.5,1),t.visible=!1,t})(),this.center=new f.Container,this.addChild(this.center,this.waterMask),this.center.addChild(this.backLeg,this.backArm,this.frontLeg,this.frontArm,this.tail,this.neck,this.body),this.neck.addChild(this.head),this.head.addChild(this.backEar,this.frontEar)}update(t,e,i,s){Jd.RESET.apply(this,t),Jd.BREATHING.apply(this,t),e>0&&Jd.WALKING.apply(this,t),this.center.mask=s?this.waterMask:null,this.waterMask.visible=s,s&&(this.center.position.y+=10)}}Jd.RESET=new class extends jd{constructor(){super(...arguments),this.duration=1/4}apply(t,e){t.alpha=1,t.frontLeg.position.set(-13,2),t.backLeg.position.set(t.frontLeg.position.x+2,t.frontLeg.position.y),t.frontArm.position.set(13,2),t.backArm.position.set(t.frontArm.position.x-2,t.frontArm.position.y),t.frontLeg.rotation=0,t.backLeg.rotation=0,t.frontArm.rotation=0,t.backArm.rotation=0,t.neck.position.set(12,-2),t.head.position.set(15,0),t.frontEar.position.set(-3,-8),t.backEar.position.set(t.frontEar.position.x+2,t.frontEar.position.y),t.tail.position.set(-13,-5),t.tail.rotation=0,t.head.rotation=Math.PI/2,t.center.position.set(0,-20),t.center.scale.set(1,1),t.center.rotation=0,t.tail.rotation=3*-Math.PI/4+Math.sin(this.progress(e)*Math.PI*2)*Math.PI/8,t.neck.rotation=-Math.PI/3}},Jd.BREATHING=new class extends $d{constructor(){super(...arguments),this.duration=4}apply(t,e){t.tail.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/8,t.neck.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/32}},Jd.WALKING=new class extends $d{constructor(){super(...arguments),this.duration=.5}apply(t,e){t.neck.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/32,t.tail.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/8,t.frontLeg.rotation+=Math.sin(this.progress(e)*Math.PI*2)*Math.PI/8,t.backLeg.rotation=-t.frontLeg.rotation,t.frontArm.rotation=t.frontLeg.rotation,t.backArm.rotation=-t.frontArm.rotation}},Jd.FALLING_DOWN=new class extends jd{constructor(t){super(),this.animations=t,this.duration=0,this.duration=t.reduce(((t,e)=>t+e.duration),0)}apply(t,e){let i=0;for(;this.animations[i]&&e>this.animations[i].duration;)e-=this.animations[i].duration,i++;if(this.animations[i])this.animations[i].apply(t,e);else{const e=this.animations[this.animations.length-1];this.animations[this.animations.length-1].apply(t,e.duration)}}}([new class extends jd{constructor(){super(...arguments),this.duration=.1}apply(t,e){const i=this.progress(e);t.center.position.y+=gt(0,-30,i),t.center.rotation=gt(0,-Math.PI,i)}},new class extends jd{constructor(){super(...arguments),this.duration=.1}apply(t,e){const i=this.progress(e);t.center.position.y+=gt(-30,0,i),t.center.rotation=Math.PI}},new class extends jd{constructor(){super(...arguments),this.duration=2}apply(t,e){const i=this.progress(e);t.center.rotation=Math.PI,t.frontLeg.rotation+=Math.sin(2*Math.PI*i*8)*Math.PI/8,t.backLeg.rotation=-t.frontLeg.rotation,t.frontArm.rotation=t.frontLeg.rotation,t.backArm.rotation=-t.frontArm.rotation,t.tail.rotation=Math.PI-Math.PI/8,t.neck.rotation=0}}]),Jd.GETTING_UP=new class extends jd{constructor(){super(...arguments),this.duration=.1}apply(t,e){const i=this.progress(e);t.center.scale.y=gt(-1,1,i)}};class Zd extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws),this.healthTrait=this.entity.traitOfType(ws),this.waterAffectedTrait=this.entity.traitOfType(Us),this.staggerableTrait=this.entity.traitOfType(Qs)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),qd(t,this.walkerTrait,this.healthTrait,this.waterAffectedTrait,this.staggerableTrait,e)}}class Qd{constructor(t,e=20){this.index=0,this.elements=[];for(let t=0;t<e;t++)this.elements.push(Math.random())}next(t=0,e=1){return this.elements[this.index++%this.elements.length]*(e-t)+t}reset(){this.index=0}}class tu extends f.Container{constructor(t){super(),this.createParticle=t}setParticleCount(t){for(;this.children.length>t;)this.removeChildAt(0);for(;this.children.length<t;)this.addChild(this.createParticle())}get particles(){return this.children}}class eu extends f.ParticleContainer{constructor(t){super(),this.createParticle=t}setParticleCount(t){for(;this.children.length>t;)this.removeChildAt(0);for(;this.children.length<t;)this.addChild(this.createParticle())}get particles(){return this.children}}class iu extends f.Sprite{constructor(t){super(t.textures.fog.texture),this.anchor.set(.5,.5),this.anchor.set(.5,.5),this.tint=0}update(t,e,i){this.width=2*e,this.height=2*i}}class su extends f.Container{constructor(){super(),this.particles=new eu((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.rotation=Math.PI/4,t.tint=(0,wt.F5)([16711680,16776960,16744448]),t})),this.rng=new Qd("fire",400),this.addChild(this.particles)}update(t,e,i){this.particles.setParticleCount(50),this.rng.reset();for(const s of this.particles.particles){const n=this.rng.next(0,2*Math.PI),a=this.rng.next(0,1),r=Math.cos(n)*a*e*.8,o=Math.sin(n)*a*i*.8;s.position.set(r,o);const h=r+this.rng.next(-10,10),l=this.rng.next(.8,1.5),c=this.rng.next(0,l),d=200*this.rng.next(.25,1),u=(t+c)/l%1;s.alpha=1-u,s.position.set(r+u*(h-r),o-u*d),s.width=s.height=10*(1-u)}}}class nu extends Cd.z{static pool(){return Vu(nu,(()=>new su))}constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.fireTrait=this.entity.traitOfType(Ah),this.disappearingTrait=this.entity.traitOfType(en.K)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),t.update(this.age,this.fireTrait.radiusX,this.fireTrait.radiusY),this.disappearingTrait&&(t.alpha=gt(0,1,(this.disappearingTrait.maxAge-this.entity.age)/.3))}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,3*this.fireTrait.radiusX,3*this.fireTrait.radiusX)}}class au extends Cd.z{static pool(t){return Vu(au,(()=>new iu(t)))}constructor(t){super(),this.viewPool=t,this.layerId=vd.UNDER_WORLD_UI}postBind(){super.postBind(),this.fireTrait=this.entity.traitOfType(Ah),this.disappearingTrait=this.entity.traitOfType(en.K)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),t.update(this.age,this.fireTrait.radiusX,this.fireTrait.radiusY),this.disappearingTrait&&(t.alpha=gt(0,1,(this.disappearingTrait.maxAge-this.entity.age)/.3))}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,2*this.fireTrait.radiusX,2*this.fireTrait.radiusY)}}class ru extends f.Graphics{constructor(){super(),this.age=Math.random(),this.lineStyle({width:2,color:16777215}),this.drawCircle(0,0,20),this.scale.y=.5}}class ou extends f.Container{constructor(){super(),this.water=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=32928,t.anchor.set(.5,.5),t})(),this.waterMask=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=16711680,t.anchor.set(.5,.5),t})(),this.ripples=new tu((()=>new ru)),this.ripples.mask=this.waterMask,this.addChild(this.water,this.ripples,this.waterMask)}}class hu extends Cd.z{constructor(t){super(),this.viewPool=t,this.layerId=vd.WATER}postBind(){super.postBind(),this.pondTrait=this.entity.traitOfType(Fs)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),t.rotation=this.entity.angle,t.water.tint=this.pondTrait.isMud?12620658:32928,t.water.width=t.waterMask.width=this.pondTrait.width,t.water.height=t.waterMask.height=this.pondTrait.height,t.ripples.setParticleCount(this.entity.world.entities.bucketSize(mc.key)>0?2:0);let i=this.entity.id.charCodeAt(0);for(const e of t.ripples.particles){i+=this.entity.id.charCodeAt(0)/255;const s=this.entity.age+i,n=s%1/1;e.alpha=1-n,e.scale.set(n,n/2);const a=Math.floor(s/1)+i;e.position.x=20*a%this.pondTrait.width-this.pondTrait.width/2,e.position.y=150*a%this.pondTrait.height-this.pondTrait.height/2,e.rotation=-t.rotation,e.tint=this.pondTrait.isMud?7361598:16777215}}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,2*Math.max(this.pondTrait.width,this.pondTrait.height),2*Math.max(this.pondTrait.width,this.pondTrait.height))}}class lu extends Rd{constructor(){super(...arguments),this.layerId=vd.WORLD,this.lastViewUpdate=0}postBind(){super.postBind(),this.outOfWaterTrait=this.entity.traitOfType(Tc),this.seasonTrait=Oi(this.worldViewController.world.traitsOfType(Ul)),this.rng=new Qd(this.entity.id,20),this.lastViewUpdate=-9999}isVisible(){var t;return super.isVisible()&&!(null===(t=this.outOfWaterTrait)||void 0===t?void 0:t.inWater)}updateView(t,e){let i=ct()?1/30:1/45;this.entity.world.entities.bucketSize(Ki.key)>0&&(i*=3),this.worldViewController.age-this.lastViewUpdate<i||(this.lastViewUpdate=this.worldViewController.age,this.updateFoliageView(t,e))}updateFoliageView(t,e){this.rng.reset(),this.doUpdateView(t,e)}}class cu extends f.Container{constructor(){super(),this.blades=new tu((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.tint=24576,t.width=20,t})),this.addChild(this.blades)}shadowize(){return this.skew.x=Math.PI/4,this.scale.y=1/Math.cos(this.skew.x)/2,this}}class du extends lu{constructor(t){super(),this.viewPool=t}createView(){return this.viewPool.take()}doUpdateView(t){t.position.set(this.entity.position.x,this.entity.position.y),t.blades.setParticleCount(5);let e=0;for(const i of t.blades.particles)i.rotation=Math.sin((this.age+this.rng.next(0,5))*Math.PI*2/this.rng.next(4,8))*this.rng.next(Math.PI/32,Math.PI/16),i.position.x=e,i.height=this.rng.next(20,60),i.tint=ee(this.seasonTrait.season.bushColor,this.rng.next(.8,1)),e+=this.rng.next(5,15)}updateVisibilityRectangle(){this.visibilityRectangle.update(this.entity.position.x-15,this.entity.position.y-60,100,70)}}class uu extends f.Container{constructor(){super(),this.blade=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.tint=10530944,t.width=4,t})(),this.flower=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=(0,wt.F5)([16776960,16777215,9437184]),t.anchor.set(.5,.5),t.width=t.height=5,t.visible=(0,wt.sI)(.5),t})(),this.addChild(this.blade,this.flower)}}class pu extends f.Container{constructor(){super(),this.blades=new tu((()=>new uu)),this.addChild(this.blades)}shadowize(){return this.skew.x=Math.PI/4,this.scale.y=1/Math.cos(this.skew.x)/2,this}}class mu extends lu{constructor(t){super(),this.viewPool=t}createView(){return this.viewPool.take()}doUpdateView(t){t.position.set(this.entity.position.x,this.entity.position.y),t.blades.setParticleCount(5);let e=0;for(const i of t.blades.particles)i.rotation=Math.sin((this.age+this.rng.next(0,5))*Math.PI*2/this.rng.next(4,8))*this.rng.next(Math.PI/16,Math.PI/4),i.position.x=e,i.blade.height=this.rng.next(5,30),i.blade.tint=ee(this.seasonTrait.season.grassColor,this.rng.next(.8,1.2)),i.flower.visible=this.rng.next(0,1)<this.seasonTrait.season.flowerDensity,i.flower.visible&&i.flower.position.set(0,-i.blade.height),e+=this.rng.next(5,15)}updateVisibilityRectangle(){this.visibilityRectangle.update(this.entity.position.x-15,this.entity.position.y-40,100,45)}}class yu extends f.Container{constructor(){super(),this.rocks=new tu((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.tint=ee(12632256,(0,wt.YR)(.5,1)),t.width=(0,wt.XU)(30,50),t.height=(0,wt.XU)(30,50),t.rotation=Math.PI/4+(0,wt.YR)(-1,1)*Math.PI/8,t})),this.maskShape=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.width=200,t.height=50,t})(),this.addChild(this.rocks,this.maskShape),this.rocks.mask=this.maskShape,this.cacheAsBitmapResolution=2,this.rocks.setParticleCount(5),this.cacheAsBitmap=!0;let t=0;for(const e of this.rocks.particles){const i=2*(t/(this.rocks.particles.length-1)-.5);e.position.x=20*i,e.position.y=(0,wt.XU)(-20,20),t++}for(const t of this.rocks.particles)t.position.x-=0}}class wu extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}createView(){const t=this.viewPool.take();return t.cacheAsBitmap=!1,t.cacheAsBitmap=!0,t}destroyView(t){super.destroyView(t),t.cacheAsBitmap=!1}updateView(t){t.position.set(this.entity.position.x,this.entity.position.y+5)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,150,150)}}class gu extends f.Container{constructor(){super(),this.shape=(()=>{const t=new f.Graphics;return t.beginFill(ee(10510416,(0,wt.YR)(.5,1))),t.moveTo(-5,0),t.lineTo(5,0),t.lineTo(5,-100),t.lineTo(0,-110),t.lineTo(-5,-100),t})(),this.addChild(this.shape);const t=new f.Sprite(f.Texture.WHITE);t.width=50,t.height=50,t.anchor.set(.5,1)}}class fu extends Rd{static pool(){return Hu(fu,(()=>new gu))}constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y)}updateVisibilityRectangle(){this.visibilityRectangle.update(this.entity.position.x-100,this.entity.position.y-300,200,300)}}class vu extends f.Container{constructor(){super(),this.blade=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.tint=10530944,t.width=4,t})(),this.addChild(this.blade)}}class bu extends f.Container{constructor(){super(),this.blades=new tu((()=>new vu)),this.addChild(this.blades)}shadowize(){return this.skew.x=Math.PI/4,this.scale.y=1/Math.cos(this.skew.x)/2,this}}class Tu extends lu{constructor(t){super(),this.viewPool=t}createView(){return this.viewPool.take()}doUpdateView(t){t.position.set(this.entity.position.x,this.entity.position.y),t.blades.setParticleCount(10);let e=0;for(const i of t.blades.particles)i.rotation=Math.sin((this.age+this.rng.next(0,5))*Math.PI*2/this.rng.next(4,8))*this.rng.next(Math.PI/16,Math.PI/4),i.position.x=e,i.blade.height=this.rng.next(30,50),i.blade.tint=ee(this.seasonTrait.season.grassColor,this.rng.next(.8,1.2)),e+=this.rng.next(5,15)}updateVisibilityRectangle(){this.visibilityRectangle.update(this.entity.position.x-15,this.entity.position.y-40,150,45)}}class ku extends f.Container{constructor(){super(),this.trunk=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,1),t.tint=10510416,t})(),this.bushRoot=new tu((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.tint=24576,t.width=30,t.height=30,t.rotation=Math.PI/4,t})),this.addChild(this.trunk,this.bushRoot),this.bushRoot.setParticleCount(ct()?3:5)}setTrunkSize(t,e){this.trunk.width=t,this.trunk.height=e,this.bushRoot.position.set(0,-this.trunk.height)}}class xu extends lu{constructor(t){super(),this.viewPool=t}createView(){return this.viewPool.take()}doUpdateView(t,e){const i=this.rng.next(100,250);t.position.set(this.entity.position.x,this.entity.position.y),t.setTrunkSize(this.rng.next(10,20),i),t.trunk.tint=ee(this.seasonTrait.season.treeTrunkColor,this.rng.next(.5,1));const s=this.rng.next(0,10),n=this.rng.next(4,16),a=this.rng.next(Math.PI/32,Math.PI/64);t.rotation=Math.sin((this.age+s)*Math.PI*2/n)*a;let r=0,o=0;for(const e of t.bushRoot.particles){const t=r/5*Math.PI*2,i=this.rng.next(20,50),s=Math.cos(t)*i,n=Math.sin(t)*i*.5,a=this.rng.next(20,40);e.tint=ee(this.seasonTrait.season.treeLeavesColor,this.rng.next(.8,1)),e.position.set(s,n),e.width=e.height=2*a,e.rotation=Math.PI/4+Math.sin((this.age+this.rng.next(0,10))*Math.PI*2/this.rng.next(2,8))*Math.PI/32,o=Math.max(o,a),r++}let h=!1;for(const t of this.worldViewController.world.entities.bucket(ln.key))Math.abs(t.position.x-this.entity.position.x)>100||t.position.y>this.entity.position.y||t.position.y<this.entity.position.y-i-o||(h=!0);const l=h?.2:1;t.alpha=t.alpha+(0,ft.Tq)(16*-e,l-t.alpha,16*e)}updateVisibilityRectangle(){this.visibilityRectangle.update(this.entity.position.x-100,this.entity.position.y-300,200,300)}}class Cu extends Cd.z{constructor(){super(...arguments),this.layerId=vd.OBSCURED_OUTLINES}for(t){return this.original=t,this}createView(){return this.original.createView()}updateView(t,e){this.original.updateView(t,e)}removeEmitter(){return this.original.removeEmitter()}isVisible(){return!0}updateVisibilityRectangle(){this.original.updateVisibilityRectangle(),this.visibilityRectangle.copy(this.original.visibilityRectangle)}}f.Container,f.Container;class Eu extends f.Container{constructor(t){super(),this.texturePool=t,this.track=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=0,t})(),this.fill=new f.Sprite(f.Texture.WHITE),this.fillTexture=(()=>{const t=new f.Sprite(this.texturePool.textures.gaugeContent.texture);return t.anchor.set(1,0),t})(),this.border=new f.Sprite(this.texturePool.textures.gaugeBorder.texture),this.diff=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=16777215,t})(),this.addChild(this.track,this.diff,this.fill,this.fillTexture,this.border)}update(t,e,i,s,n,a){this.track.width=t,this.track.height=e,this.track.alpha=.4,this.border.position.set(2,2),this.border.width=this.track.width-4,this.border.height=this.track.height-4,this.border.alpha=.2,this.fill.position.set(2,2),this.fill.width=Math.min(n,a)*(t-4),this.fill.height=e-4,this.fill.tint=i,this.fillTexture.position.set(this.fill.position.x+this.fill.width,this.fill.position.y),this.fillTexture.width=Math.min(this.fill.width,this.fillTexture.texture.width),this.fillTexture.height=this.fill.height,this.fillTexture.alpha=.5,this.diff.position.copyFrom(this.fill.position),this.diff.width=Math.max(n,a)*(t-4),this.diff.tint=s,this.diff.height=e-4}}class Su extends f.Container{constructor(t){super(),this.texturePool=t,this.healthGauge=new Eu(this.texturePool),this.staggerGauge=new Eu(this.texturePool),this.levelContainer=(()=>{const t=new f.Graphics;return t.beginFill(0),t.lineStyle({width:1,color:4210752}),t.drawCircle(0,0,15),t})(),this.levelValueLabel=(()=>{const t=new f.Text("1",{fill:16777215,fontFamily:g,fontSize:16});return t.resolution=2,t.anchor.set(.5,.5),t})(),this.addChild(this.healthGauge,this.staggerGauge,this.levelContainer),this.levelContainer.addChild(this.levelValueLabel)}updateLayout(){const t=this.levelContainer.visible?30:0,e=this.healthGauge.width+t;this.healthGauge.position.set(-e/2+t,-8),this.staggerGauge.position.set(this.healthGauge.position.x,0),this.levelContainer.position.set(-e/2+t/2,0)}}class Mu extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.HUD_UI,this.displayedHealth=1,this.playerLevel=0}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws),this.experienceHolderTrait=this.entity.traitOfType(Xs),this.invincibleTrait=this.entity.traitOfType(mh),this.staggerableTrait=this.entity.traitOfType(Qs),this.displayedHealth=this.healthTrait.healthRatio}isVisible(){var t,e;return!((null===(t=this.invincibleTrait)||void 0===t?void 0:t.enabled)||!super.isVisible()||!(null===(e=this.staggerableTrait)||void 0===e?void 0:e.recentlyChanged(.5))&&!this.healthTrait.recentlyDamaged(2)&&!this.healthTrait.recentlyHealed(2))}createView(){return new Su(this.texturePool)}get healthColor(){var t,e;const{level:i}=this.experienceHolderTrait;this.playerLevel=(null===(e=null===(t=Oi(this.entity.world.entities.bucket(ln.key)))||void 0===t?void 0:t.traitOfType(Xs))||void 0===e?void 0:e.level)||this.playerLevel;const s=i-this.playerLevel;return s>2?8528821:s>1?16744448:s>0?16776960:49152}updateView(t,e){var i,s;t.position.set(this.entity.position.x,this.entity.position.y+20),t.scale.set(1/this.camera.zoom,1/this.camera.zoom),this.displayedHealth+=(0,ft.Tq)(.5*-e,this.healthTrait.healthRatio-this.displayedHealth,.25*e);const n=this.healthTrait.maxHealth/50*50;t.healthGauge.update(n,10,this.healthColor,this.displayedHealth<this.healthTrait.healthRatio?49152:16777215,this.healthTrait.healthRatio,this.displayedHealth),t.staggerGauge.update(n,8,16777215,16777215,1-this.staggerableTrait.constitution,1-this.staggerableTrait.constitution),t.levelContainer.visible=!!this.experienceHolderTrait,t.levelValueLabel.text=null===(s=null===(i=this.experienceHolderTrait)||void 0===i?void 0:i.level)||void 0===s?void 0:s.toString(),t.updateLayout()}}function Pu(t){return 1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2)}class Iu extends Cd.z{constructor(t){super(),this.viewPool=t,this.layerId=vd.HUD_INDICATORS}for(t,e){return this.color=t,this.texture=e,this}createView(){const t=this.viewPool.take();return t.setup(this.color,this.texture),t}updateView(t,e){const{visibleRectangle:i}=this.camera;t.position.set((0,ft.Tq)(i.minX+50,this.entity.position.x,i.maxX-50),(0,ft.Tq)(i.minY+50,this.entity.position.y,i.maxY-50)),t.rotation=ls(t.position,this.entity.position),t.setOrientation(Math.atan2(this.entity.position.y-i.midY,this.entity.position.x-i.midX)),t.scale.set(Math.max(0,gt(-1,1,this.visibleAge/.3,Pu)))}isVisible(){const{visibleRectangle:t}=this.camera;return!(0,ft.Bt)(t.minX-50,this.entity.position.x,t.maxX+50)||!(0,ft.Bt)(t.minY-50,this.entity.position.y-50,t.maxY+50)}}class Au extends Rd{constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD}postBind(){super.postBind(),this.coinItemTrait=this.entity.traitOfType(dn)}createView(){const t=this.viewPool.take();return t.scale.set(1,1),t.setValue(this.coinItemTrait.amount,this.entity.id.charCodeAt(0)),t}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,50,50)}}class Ou extends Cd.z{static pool(t){const e=new ga.w((()=>{const e=new f.Sprite(t.textures.particles.cross.texture);return e.width=e.height=5,e.anchor.set(.5),e}));return new ga.w((()=>new Ou(e)))}constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD,this.particleParams=new Zi.I}postBind(){super.postBind();const{particles:t}=this.worldViewController;this.emitter=t.cross.emitter(((t,e)=>{t.x=e.x+(0,wt.XU)(-2,2),t.y=e.y+(0,wt.XU)(-2,2),t.deltaX=(0,wt.XU)(-15,15),t.deltaY=(0,wt.XU)(-15,-30),t.layerId=vd.PARTICLES,t.color=65280,t.duration=(0,wt.YR)(.3,.6),t.size=(0,wt.YR)(6,12),t.deltaSize=-t.size,t.alpha=1,t.deltaAlpha=0})).continuous(.05,this.particleParams)}createView(){return this.viewPool.take()}updateView(t){t.position.set(~~this.entity.x,~~this.entity.y-30),t.tint=65280}update(){this.particleParams.x=this.entity.x,this.particleParams.y=this.entity.y-30,this.emitter.emit=!0,this.emitter.cycle(this.age-this.lastUpdate),super.update()}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.x,this.entity.y,10,10)}}class Ru extends f.Container{constructor(){super();for(let t=0;t<2;t++){const t=new f.Sprite(f.Texture.WHITE);t.width=10,t.height=4,t.tint=0,t.anchor.set(.1,.5),t.position.y=-300,this.addChild(t)}}update(t){const e=Math.sin(t*Math.PI*2*4)*Math.PI/16;this.children[0].rotation=-Math.PI/4+e,this.children[1].rotation=3*-Math.PI/4-e}}class _u extends Rd{static pool(){return Hu(_u,(()=>new Ru))}constructor(t){super(),this.viewPool=t,this.layerId=vd.WORLD_AERIAL}createView(){return new Ru}destroyView(t){super.destroyView(t),t.destroy({children:!0})}updateView(t,e){t.position.set(this.entity.position.x+300,this.entity.position.y+300),t.update(this.age)}}var Bu=i(1438),Lu=i(1149);class Du extends Lu.b{constructor(t){super(),this.viewPool=t,this.layerId=vd.OVER_WORLD_UI,this.initialPosition=new Zi.I}createView(){const t=this.viewPool.take();return t.setValue(this.coinItemTrait.amount,this.entity.id.charCodeAt(0)),t}postBind(){super.postBind(),this.coinItemTrait=this.entity.traitOfType(dn),this.initialPosition.x=this.entity.position.x,this.initialPosition.y=this.entity.position.y}updateView(t,e){const{visibleRectangle:i}=this.camera,s=i.minX+100,n=i.minY+100;t.position.set(gt(this.initialPosition.x,s,this.age/this.coinItemTrait.delay,Bu.easeInQuint),gt(this.initialPosition.y,n,this.age/this.coinItemTrait.delay,Bu.easeInQuint)),t.scale.set(gt(1,2,this.age/this.coinItemTrait.delay,Bu.easeInQuint))}removeEmitter(){return this.whenAgeIs(this.coinItemTrait.delay)}}function Vu(t,e){const i=new ga.w(e),s=new ga.w((()=>new t(i)));return{viewPool:i,create:()=>[s.take()]}}function Hu(t,e,i=1/60){const s=new ga.w(e),n=new ga.w((()=>new t(s))),a=new ga.w((()=>new _d));return{viewPool:s,create(){const t=n.take();return[t,a.take().forViewController(t,i)]}}}class Fu{constructor(t){this.texturePool=t,this.coinPool=new ga.w((()=>new Ad(this.texturePool))),this.bird=_u.pool(),this.coin=new ga.w((()=>new Au(this.coinPool))),this.fireMark=au.pool(this.texturePool),this.fire=nu.pool(),this.tools=new Ca,this.coinPickup=new ga.w((()=>new Du(this.coinPool))),this.spike=fu.pool(),this.tree=Hu(xu,(()=>new ku),1/30),this.grass=Hu(mu,(()=>new pu),.05),this.tallGrass=Hu(Tu,(()=>new bu),.05),this.rock=Hu(wu,(()=>new yu),.2),this.bush=Hu(du,(()=>new cu),.1),this.pond=Vu(hu,(()=>new ou)),this.knight=Hu(Xd,(()=>new Ga(this.texturePool,this.tools)),1/120),this.wolf=Hu(Zd,(()=>new Jd)),this.horse=Hu(Nd,(()=>new Fd),1/120),this.merchant=Hu(Gd,(()=>new Ga(this.texturePool,this.tools)),.05),this.npc=Hu(zd,(()=>new Md),.05),this.dummy=Hu(Bd,(()=>new Sd),1),this.targetOutline=new ga.w((()=>new Yd)),this.characterOutline=new ga.w((()=>new Cu)),this.indicatorViewPool=new ga.w((()=>new Id)),this.enemyHudPool=new ga.w((()=>new Mu(this.texturePool))),this.indicatorPool=(()=>{const t=new ga.w((()=>new Id));return new ga.w((()=>new Iu(t)))})(),this.healingProjectile=Ou.pool(this.texturePool)}}class Nu{constructor(t,e,i){this.achievements=t,this.unlocker=e,this.eventCounter=i,this.watchedWorldStateAchievements=new Set,this.watchedWorldEventAchievements=new Set,this.worldEventMatchers=new Map}bind(t){this.world=t}postBind(){const t=this.achievements.filter((t=>!this.unlocker.isUnlocked(t.id)));console.log("Watching for achievements:",t.map((t=>t.id)));for(const e of t)e instanceof Bi?this.watchedWorldStateAchievements.add(e):e instanceof Li&&(this.worldEventMatchers.set(e.matcher.eventLabel||e.id,e.matcher),this.watchedWorldEventAchievements.add(e));this.world.events.subscribe((t=>this.onWorldEvent(t)))}update(){for(const t of this.watchedWorldStateAchievements)t.isAchieved(this.world)&&(this.watchedWorldStateAchievements.delete(t),this.unlocker.unlock(t.id))}onWorldEvent(t){for(const[e,i]of this.worldEventMatchers.entries())i.filterEvent(t)&&this.eventCounter.onEvent(e)}}class Uu extends zi.X{constructor(){super(...arguments),this.key=Uu.key}postBind(){super.postBind(),this.healthTrait=this.dependency(ws.key),this.healthTrait.maxHealth=1e3}cycle(t){this.healthTrait.health=this.healthTrait.maxHealth}}Uu.key="dummy";class Wu extends hh{createEntities(){return[(0,qi.EG)([new Uu,new Gr(20),new ws,new ks(10),new mh])]}}var Xu=i(5891);class Gu extends Sr{cycle(t){super.cycle(t);const{inputs:e}=this.controllableTrait;e.movement.force=0,e.lightStrike=!1,e.heavyStrike=!1,e.dash=!1,e.shield=!1,e.interact=!1}}class zu{entityAuthority(t){return t.traitOfType(us)||t.traitOfType(dn)?Xu.I4.NONE:Xu.I4.FULL}worldEventAuthority(t){return Xu.I4.FULL}entityEventAuthority(t,e){return Xu.I4.FULL}determinesRemoval(t,e){return!0}maxUpdateInterval(t){return 0}}class Ku extends Error{constructor(t="Challenge failed"){super(t)}}class Yu extends wd{createWorld(){const t=super.createWorld();return t.authority=new zu,t}postBind(){super.postBind(),this.configureWorld();const t=this.spawnEntity(this.playerTraits());t.traitOfType(mn).inventory=this.progression.inventory.clone(),this.configurePlayer(t),this.world.entities.additions.subscribe((t=>{const e=t.traitOfType(Xs);e&&(e.enabled=!1)}))}configureWorld(){}configurePlayer(t){t.traitOfType(Xs).enabled=!1}playerTraits(){return Dl()}async startChallenge(){const t=this.spawnEntity([new Ts]);t.traitOfType(Ts).message=this.description;let e=null;try{const e=this.setupChallenge();for(const t of this.world.entities.bucket(Ki.key))t.addEvent(new nl);await e,t.traitOfType(Ts).resolved=!0}catch(i){if(!(i instanceof Ku))throw i;e=i,t.traitOfType(Ts).failed=!0}for(const t of this.world.entities.bucket(Ki.key))t.traitOfType(Pr).setAI(new Gu);await this.wait(1);for(const t of Array.from(this.world.entities.bucket(Ki.key)))await this.wait(.05),t.addEvent(new nl),t.remove();await this.wait(1),this.triggerEnd(e?is.FAILED:is.COMPLETED,0,e?e.message:"Challenge completed")}}const qu=[new class extends Yu{constructor(t){super(),this.options=t,this.description="Kill all enemies without taking damage"}configureWorld(){const{absoluteBounds:t,bounds:e}=Oi(this.world.traitsOfType(xo));t.centerAround(0,0,1600,1600),e.copy(t),(new Xc).setup(this.world)}configurePlayer(t){super.configurePlayer(t),t.traitOfType(mn).inventory=this.progression.inventory.clone(),t.traitOfType(Xs).experience=this.progression.experience}async setupChallenge(){const t=(0,qi.EG)([new Hl(1.5,0)]);this.world.entities.add(t),await this.waitFor((()=>t.traitOfType(Hl).started));for(const t of this.configuration.waveComposition.entities(this.options.enemyCount))cl(t,Tt(this.progression.experience)),this.world.entities.add(t),t.addEvent(new nl);Array.from(this.world.entities.bucket(Ki.key)).forEach(((t,e,i)=>{const s=e/i.length*Math.PI*2;t.position.x=400*Math.cos(s),t.position.y=400*Math.sin(s)}));const e=(async()=>{await this.waitFor((()=>0===this.world.entities.bucketSize(Ki.key)))})(),i=(async()=>{throw await this.waitFor((()=>this.player.traitOfType(ws).healthRatio<1)),new Ku("You took damage")})();return Promise.race([e,i])}}({enemyCount:5}),new class extends Yu{constructor(t){super(),this.options=t,this.description=`Reach a X${this.options.targetCombo} combo within ${this.options.timeLimit} seconds`}configureWorld(){const{absoluteBounds:t,bounds:e}=Oi(this.world.traitsOfType(xo));t.centerAround(0,0,1600,1600),e.copy(t),(new Xc).setup(this.world)}playerTraits(){return super.playerTraits().concat([new mh])}configurePlayer(t){super.configurePlayer(t),t.traitOfType(mn).inventory=this.progression.inventory.clone(),t.traitOfType(Xs).experience=this.progression.experience}async setupChallenge(){const t=(0,qi.EG)([new Hl(1.5,this.options.timeLimit)]);this.world.entities.add(t),await this.waitFor((()=>t.traitOfType(Hl).started));const e=[],i=this.waitFor((()=>{const{player:i}=this;if(i&&t.world){if(this.world.entities.bucketSize(Ki.key)<=this.options.waveSize-2){if(0===e.length)for(const t of this.configuration.waveComposition.entityGroups(this.options.waveSize))e.push(t);const t=e.pop();for(const e of t)cl(e,Tt(this.progression.experience)),this.world.entities.add(e),e.position.x=i.position.x+(0,wt.XU)(200,400)*(0,wt.F5)([-1,1]),e.position.y=i.position.y+(0,wt.XU)(200,400)*(0,wt.F5)([-1,1]),e.addEvent(new nl)}return!1}})),s=(async()=>{await this.waitFor((()=>{var t;return(null===(t=this.player)||void 0===t?void 0:t.traitOfType(fn).combo)>=this.options.targetCombo})),t.remove()})(),n=(async()=>{throw await this.waitFor((()=>t.traitOfType(Hl).timeLeft<=0)),t.remove(),new Ku("You ran out of time")})();return Promise.race([s,n,i])}}({targetCombo:25,timeLimit:60,waveSize:5}),new class extends Yu{constructor(){super(...arguments),this.description="Hit all the dummies with your axe within the time limit"}configureWorld(){const{absoluteBounds:t,bounds:e}=Oi(this.world.traitsOfType(xo));t.centerAround(0,0,1600,1600),e.copy(t),(new Xc).setup(this.world)}configurePlayer(t){super.configurePlayer(t),t.traitOfType(mn).inventory=this.progression.inventory.clone(),t.traitOfType(mn).inventory.equip(ui.item),t.traitOfType(ws).maxHealth=1}async setupChallenge(){const t=(0,qi.EG)([new Hl(1.5,30)]);this.world.entities.add(t),await this.waitFor((()=>t.traitOfType(Hl).started));let e=12;const i=(async()=>{for(let t=0;t<4;t++){const t=[],i=[];for(let t=0;t<1;t+=.1)i.push(t*Math.PI*2);dc(i);for(let s=0;s<3;s++){const s=i.pop()||0;for(const i of(new Wu).createEntities()){const n=(0,wt.XU)(200,300);i.position.x=Math.cos(s)*n,i.position.y=Math.sin(s)*n,this.world.entities.add(i);const a=(0,qi.EG)([new xl]);a.position.x=i.position.x,a.position.y=i.position.y,this.world.entities.add(a);const r=(0,qi.EG)([new kr]);r.position.x=i.position.x,r.position.y=i.position.y,r.angle=Math.random()*Math.PI/4,r.traitOfType(kr).width=(0,wt.XU)(100,200),r.traitOfType(kr).height=(0,wt.XU)(100,200),this.world.entities.add(r),t.push((async()=>{await this.waitFor((()=>i.traitOfType(ws).recentlyDamaged(1))),e--,a.remove(),i.addEvent(new nl),i.remove(),r.remove()})())}}await Promise.all(t)}t.remove()})();this.repeatedTask(this.description,12,(()=>{const t=e;return this.waitFor((()=>e<t))}));const s=(async()=>{throw await this.waitFor((()=>t.traitOfType(Hl).timeLeft<=0)),t.remove(),new Ku("You ran out of time")})();return Promise.race([i,s])}playerTraits(){return super.playerTraits().concat([new on])}}];var ju=i(4761),$u=i(2957),Ju=i(8079),Zu=i(1153),Qu=i(1045),tp=i(676),ep=i(5398);const ip=i.p+"speech-bubbledbbdf975c5c0e2ee9a26.png",sp=i.p+"burger5eba882eb1b68f1e6a6a.png";var np=i(6672),ap=i(2849);const rp=i.p+"finger01b36444862c90e18fed.png";class op extends f.Container{constructor(t){super(),this.texturePool=t,this.finger=(()=>{const t=new f.Sprite(f.Texture.from(rp));return t.anchor.set(.47,.1),t.scale.y=-1,t})(),this.fingerTouch=(()=>{const t=new f.Sprite(this.texturePool.catalog.shapes.circle200x200);return t.width=t.height=40,t.alpha=0,t.anchor.set(.5,.5),t})(),this.addChild(this.fingerTouch,this.finger)}animate(t,e,i,s,n,a){if(this.destroyed)return;this.finger.position.set(t,e-40),this.fingerTouch.position.set(t,e-20),this.fingerTouch.scale.set(0,0),this.fingerTouch.alpha=.5;const r=(new np.K).wait(s);for(let t=0;t<n;t++)r.append((new np.K).add(0,new ap.X(this.finger.position).interpToOffset("y",20).during(.2).init().progress(a)).add(.1,(new np.K).add(0,new ap.X(this.fingerTouch).interpTo("width",40).during(.2).progress(a)).add(0,new ap.X(this.fingerTouch).interpTo("height",40).during(.2).progress(a)))).wait(i).append((new np.K).add(0,new ap.X(this.finger.position).interpToOffset("y",-20).during(.2).progress(a)).add(0,(new np.K).add(0,new ap.X(this.fingerTouch).interpTo("width",0).during(.2).progress(a)).add(0,new ap.X(this.fingerTouch).interpTo("height",0).during(.2).progress(a))));return r}}class hp extends f.Container{constructor(t){super(),this.texturePool=t,this.finger=(()=>{const t=new f.Sprite(f.Texture.from(rp));return t.anchor.set(.47,.1),t})(),this.fingerTouch=(()=>{const t=new f.Sprite(this.texturePool.catalog.shapes.circle200x200);return t.width=t.height=40,t.alpha=0,t.anchor.set(.5,.5),t})(),this.addChild(this.fingerTouch,this.finger)}animate(t,e,i){if(this.destroyed)return;this.finger.position.set(t,e),this.fingerTouch.position.copyFrom(this.finger.position),this.fingerTouch.scale.set(0,0),this.fingerTouch.alpha=.5;const s={center:{x:t,y:e},radius:0,angle:0},n=()=>{this.rotateAround(s.center,s.radius,s.angle),i()};return(new np.K).append(new ap.X(this.finger).interpTo("alpha",1).during(.2).progress(i)).append(new ap.X(this.finger.position).interpFromOffset("y",20).during(.3).init().progress(i)).add(.5,(new np.K).add(0,new ap.X(this.fingerTouch).interpTo("width",40,Pu).during(.2).progress(i)).add(0,new ap.X(this.fingerTouch).interpTo("height",40,Pu).during(.2).progress(i))).wait(.5).append((new np.K).append(new ap.X(s).interpTo("radius",20).during(.3).progress(n)).add(0,new ap.X(s).interp("angle",0,2*Math.PI,Bu.easeInOutQuad).during(1).progress(n)).add(.7,new ap.X(s).interpTo("radius",0).during(.3).progress(n))).wait(.5).append((new np.K).add(0,new ap.X(this.finger.position).interpToOffset("y",20).during(.3).progress(i)).add(0,new ap.X(this.fingerTouch).interpTo("alpha",0).during(.3).progress(i)).add(0,new ap.X(this.fingerTouch.scale).interpTo("x",0).during(.2).progress(i)).add(0,new ap.X(this.fingerTouch.scale).interpTo("y",0).during(.2).progress(i))).append(new ap.X(this.finger).interpTo("alpha",0).during(.2).progress(i))}rotateAround(t,e,i){this.finger.position.set(t.x+Math.cos(i)*e,t.y+Math.sin(i)*e),this.fingerTouch.position.copyFrom(this.finger.position)}}class lp extends Zu.p{constructor(t){super(),this.texturePool=t,this.joystick=new Qu.y,this.pauseButton=this.add(new tp.$(f.Texture.from(sp))),this.inventoryButton=this.add(new tp.$(f.Texture.from(na))),this.attackButton=new tp.$(f.Texture.from(rr)),this.shieldButton=new tp.$(f.Texture.from(la)),this.dashButton=new tp.$(f.Texture.from(ca)),this.interactButton=new tp.$(f.Texture.from(ip)),this.touchAnimation=new hp(this.texturePool),this.highlightAnimation=new op(this.texturePool)}setup(){super.setup(),this.inventoryButton.iconView.width=1.5*this.inventoryButton.radius,this.inventoryButton.iconView.height=1.5*this.inventoryButton.radius,this.interactButton.iconView.width=this.interactButton.radius,this.interactButton.iconView.height=this.interactButton.radius;for(const t of[this.inventoryButton,this.pauseButton])t.retainsTouches=!1;if(this.add(this.interactButton),ct())for(const t of[this.joystick,this.attackButton,this.shieldButton,this.dashButton])this.add(t);for(const t of[this.attackButton,this.shieldButton,this.dashButton])t.retainsTouches=!0,t.iconView.width=t.radius,t.iconView.height=t.radius}updateLayout(t,e){const i={x:t-100,y:e-100};(0,ep.F)([this.dashButton,this.attackButton,this.shieldButton],i,50,Math.PI/6),this.interactButton.position.x=t/2,this.interactButton.position.y=ct()?e/2+100:5*e/6-100,this.makeAreaLarger(this.dashButton,1.5),this.makeAreaLarger(this.attackButton,1.5),this.makeAreaLarger(this.shieldButton,1.5),this.makeAreaLarger(this.interactButton,1.5),this.joystick.position.x=this.joystick.radius+30,this.joystick.position.y=i.y,this.joystick.claimArea.update(0,0,this.attackButton.position.x-100,e);const s=t>e||!ct(),n={x:t-this.pauseButton.radius-20,y:ct()?this.pauseButton.radius+(s?20:50):50};(0,ep.Y)([this.pauseButton,this.inventoryButton],n,s?-(2*this.pauseButton.radius+20):0,s?0:2*this.pauseButton.radius+20)}makeAreaLarger(t,e){t.touchArea=t.touchArea||new Wr.M,t.touchArea.centerAround(t.position.x,t.position.y,t.width*e,t.height*e)}animateTouch(){if(!this.touchAnimation.destroyed&&ct())return this.stage.addChild(this.touchAnimation),this.touchAnimation.animate(this.joystick.claimArea.midX,(this.shieldButton.position.y+this.attackButton.position.y)/2,(()=>this.joystick.onChange.emit()))}highlight(t,e,i,s){if(!this.highlightAnimation.destroyed&&ct())return this.stage.addChild(this.highlightAnimation),this.highlightAnimation.animate(t.position.x,t.position.y,e,i,s,(()=>t.onChange.emit()))}}var cp=i(5342);class dp{constructor(t){this.soundPool=t}controllersForEvent(t,e){var i,s,n,a,r,o,h,l,c,d;if(t instanceof Ii.y){if(t.event instanceof sn){if(t.entity.traitOfType($h))return[new cp.D(this.soundPool.swingWolf).setPosition(t.entity.position).setCollapseGroup(t.entity.id)];const e=null===(n=null===(s=null===(i=t.entity.traitOfType(mn))||void 0===i?void 0:i.inventory)||void 0===s?void 0:s.tool)||void 0===n?void 0:n.description;return[new cp.D(e.isMetal?this.soundPool.swingMetal:this.soundPool.swing).setPosition(t.entity.position)]}if(t.event instanceof nn&&t.entity.traitOfType(Sh))return[new cp.D(this.soundPool.fireAttack).setPosition(t.entity.position)];if(t.event instanceof ps){const e=[];let i;switch(null===(h=null===(o=null===(r=null===(a=t.event.damager)||void 0===a?void 0:a.traitOfType(mn))||void 0===r?void 0:r.inventory)||void 0===o?void 0:o.tool)||void 0===h||h.description,t.event.type){case ss.HIT:case ss.FIRE:i=this.soundPool.damageWood;break;case ss.SLASH:i=this.soundPool.damage}return e.push(new cp.D(i).setPosition(t.entity.position)),t.entity.traitOfType(ln)&&e.push(new cp.D(this.soundPool.damagePlayer).setPosition(t.entity.position)),t.entity.traitOfType($h)&&e.push(new cp.D(this.soundPool.damageWolf).setPosition(t.entity.position).setCollapseGroup(t.entity.id)),t.entity.traitOfType(Qr)&&e.push(new cp.D(this.soundPool.damageHorse).setPosition(t.entity.position).setCollapseGroup(t.entity.id)),e}if(t.event instanceof Vi){const e=[];return t.entity.traitOfType(Qr)&&e.push(new cp.D(this.soundPool.damageHorse).setPosition(t.entity.position).setCollapseGroup(t.entity.id)),t.entity.traitOfType($h)&&e.push(new cp.D(this.soundPool.deathWolf).setPosition(t.entity.position)),t.entity.traitOfType(ko)&&e.push(new cp.D(this.soundPool.death).setPosition(t.entity.position)),t.entity.traitOfType(ln)&&e.push(new cp.D(this.soundPool.gameOver)),e}if(t.event instanceof Ar)return[new cp.D(t.event.isRollDash?this.soundPool.roll:this.soundPool.dash).setPosition(t.entity.position)];if(t.event instanceof Gs||t.event instanceof Wi){if(t.event instanceof Wi&&t.event.isPerfect)return[new cp.D(this.soundPool.perfectParry)];const e=null===(d=null===(c=null===(l=t.entity.traitOfType(mn))||void 0===l?void 0:l.inventory)||void 0===c?void 0:c.shield)||void 0===d?void 0:d.description;return[new cp.D(e.isMetal?this.soundPool.attackBlocked:this.soundPool.attackBlockedWood).setPosition(t.entity.position)]}if(t.event instanceof bo)return[new cp.D(this.soundPool.fallenDown).setPosition(t.entity.position)];if(t.event instanceof Vr){if(t.entity.traitOfType(Qr))return[new cp.D(this.soundPool.prepareAttackHorse).setPosition(t.entity.position)];if(t.entity.traitOfType(ln))return[];if(t.entity.traitOfType(wn))return[new cp.D(this.soundPool.prepareAttackWizard).setPosition(t.entity.position).setCollapseGroup(t.entity.id)];if(t.entity.traitOfType(ko))return[new cp.D(this.soundPool.prepareAttackHuman).setPosition(t.entity.position)];if(t.entity.traitOfType($h))return[new cp.D(this.soundPool.prepareAttackWolf).setPosition(t.entity.position).setCollapseGroup(t.entity.id)]}if(t.event instanceof Yi)return[new cp.D(this.soundPool.coin).setCollapseGroup("coin")];if(t.event instanceof es)return[new cp.D(this.soundPool.revived)];if(t.event instanceof wc)return[new cp.D(this.soundPool.thunder)];if(t.event instanceof Fi)return[new cp.D(this.soundPool.levelUp)]}return t instanceof ts?[new cp.D(this.soundPool.thunderAttack).setPosition(t.position)]:[]}}var up=i(9666),pp=i(48);class mp extends up.k{constructor(t){super(t),this.soundtrackTypeChange=new bc.u,this.onSoundtrackTypeChange=()=>{},this.isStarted=!1,this.soundPool=t.soundPool}stop(){super.stop(),this.isStarted=!1}start(){if(this.isStarted)return;this.isStarted=!0,super.start();const t=new pp.p(this.soundPool.rain,1,(()=>this.world.entities.bucketSize(mc.key)>0));t.setVolume(.5),this.addSoundEffectController(t);const e=new pp.p(this.soundPool.heartBeat,1,(()=>{var t,e;return(null===(e=null===(t=this.world.entities.bucket(ln.key)[0])||void 0===t?void 0:t.traitOfType(ws))||void 0===e?void 0:e.healthRatio)<.2}));this.addSoundEffectController(e)}update(t){super.update(t);for(const t of this.world.entities.bucket(fs.key)){const e=t.traitOfType(fs);if(e.enabled){e.enableSoundEffects?this.start():this.stop(),this.soundtrackTypeChange.requiresUpdate(e.soundtrackType)&&this.onSoundtrackTypeChange(e.soundtrackType);break}}}}class yp{constructor(t,e){this.width=t,this.height=e,this.view=new f.Container,this.extraWidth=200}createSwiper(){const t=new f.Graphics;return t.beginFill(0),t.moveTo(0,0),t.lineTo(this.width+this.extraWidth,0),t.lineTo(this.width,this.height),t.lineTo(-this.extraWidth,this.height),t.endFill(),t}animateIn(){const t=this.createSwiper();return(new np.K).append((()=>this.view.addChild(t))).append(new ap.X(t.position).interp("x",0,this.width+this.extraWidth).during(.3)).append((()=>t.destroy()))}animateOut(){const t=this.createSwiper();return(new np.K).append((()=>this.view.addChild(t))).append(new ap.X(t.position).interp("x",-(this.width+this.extraWidth),0).during(.3)).append((()=>t.destroy()))}destroy(){this.view.destroy()}}var wp=i(8365);class gp extends Cd.z{constructor(t){super(),this.wrapped=t,this.layerId=vd.DEATH_OVERLAY}bind(t,e,i){super.bind(t,e,i),this.wrapped.bind(t,e,i)}postBind(){super.postBind(),this.wrapped.postBind()}createView(){const t=new f.Container,e=this.wrapped.getOrCreateView();return e&&t.addChild(e),t}isVisible(){return this.wrapped.isVisible()}tearDown(){super.tearDown(),this.wrapped.tearDown()}update(){super.update(),this.wrapped.update()}updateView(t){}}class fp extends wp.G{constructor(t){super(),this.wrapped=t,this.layerId=vd.DEATH_OVERLAY}bind(t,e,i){super.bind(t,e,i),this.wrapped.bind(t,e,i)}postBind(){super.postBind(),this.wrapped.postBind()}createView(){const t=new f.Container,e=this.wrapped.getOrCreateView();return e&&t.addChild(e),t}isVisible(){return this.wrapped.isVisible()}tearDown(){super.tearDown(),this.wrapped.tearDown()}update(){super.update(),this.wrapped.update()}updateView(t){}removeEmitter(){return this.wrapped.removeEmitter()}}class vp extends Lu.b{constructor(t,e){super(),this.entityViewControllerFactory=t,this.eventViewControllerFactory=e,this.layerId=vd.DEATH_OVERLAY,this.viewControllers=[]}createView(){const t=new f.Sprite(f.Texture.WHITE);t.tint=0;for(const t of this.eventViewControllerFactory.viewControllersForEvent(this.event,this.worldViewController.world)){if(t.layerId===vd.SHADOWS)continue;const e=new fp(t);e.bind(this.worldViewController,this.interpolationPool,this.event),e.postBind(),this.viewControllers.push(e),e.removeEmitter().then((()=>{this.viewControllers=this.viewControllers.filter((t=>t!==e))}))}for(const t of this.worldViewController.world.entities.items()){if(!t.traitOfType(hn))continue;const e=this.entityViewControllerFactory.viewControllersForEntity(t);for(const i of e){if(i.layerId===vd.SHADOWS)continue;const e=new gp(i);e.bind(this.worldViewController,this.interpolationPool,t),e.postBind(),this.viewControllers.push(e)}}const e=new f.Text(pt("youDied"),{fill:"#f00",stroke:"#000",strokeThickness:4,align:"center",fontFamily:g,fontSize:108});e.resolution=2,e.anchor.set(.5,.5);const i=new f.Container;return i.addChild(t,e),i}update(){super.update();for(const t of this.viewControllers)t.update()}tearDown(){super.tearDown();for(const t of this.viewControllers)t.tearDown();this.viewControllers=[]}updateView(t,e){const[i,s]=t.children,{visibleRectangle:n}=this.camera;t.position.set(n.x,n.y),t.scale.set(1/this.camera.zoom,1/this.camera.zoom),i.width=this.camera.width,i.height=this.camera.height,s.position.set(this.camera.width/2,.25*this.camera.height),t.alpha=Math.min(gt(0,1,this.age/.3),gt(1,0,(this.age-2)/1))}isVisible(){return!0}removeEmitter(){return this.whenAgeIs(3)}}var bp=i(8143),Tp=i(748),kp=i(9499);class xp{constructor(){this.cellSize=50,this.absoluteBounds=new Wr.M,this.obstacles=[],this.lastPathFinderResult=null}setBounds(t){this.absoluteBounds.copy(t),this.obstacles=[];for(let t=0;t<this.absoluteBounds.height;t+=this.cellSize){const t=[];this.obstacles.push(t);for(let e=0;e<this.absoluteBounds.width;e+=this.cellSize)t.push(!1)}this.pathFinder=new kp.A({hash:([t,e])=>`${t}-${e}`,neighbors:([t,e])=>[[t,e+1],[t,e-1],[t-1,e],[t+1,e],[t+1,e+1],[t+1,e-1],[t-1,e+1],[t-1,e-1]].filter((([t,e])=>this.isWalkableRowCol(t,e))),heuristic:([t,e],[i,s])=>(0,ft.cK)(t,e,i,s),isTarget:(t,e)=>t[0]===e[0]&&t[1]===e[1],distance:([t,e],[i,s])=>(0,ft.cK)(t,e,i,s)})}markObstacle(t,e,i){for(let s=t-i;s<=t+i;s+=this.cellSize)for(let t=e-i;t<=e+i;t+=this.cellSize){const[e,i]=this.xyToRowCol(s,t);this.isWalkableRowCol(e,i)&&(this.obstacles[e][i]=!0)}}isWalkableRowCol(t,e){return!(t<0||e<0||t>=this.obstacles.length||e>=this.obstacles[t].length||this.obstacles[t][e])}xyToRowCol(t,e){return[Math.floor((e-this.absoluteBounds.minY)/this.cellSize),Math.floor((t-this.absoluteBounds.minX)/this.cellSize)]}rowColToXY(t,e,i){return(i=i||new Zi.I).x=this.absoluteBounds.minX+e*this.cellSize+this.cellSize/2,i.y=this.absoluteBounds.minY+t*this.cellSize+this.cellSize/2,i}findPath(t,e){const i=this.pathFinder.findPath([this.xyToRowCol(t.x,t.y)],this.xyToRowCol(e.x,e.y),20);return this.lastPathFinderResult=i,i.found?i.steps.map((([t,e])=>this.rowColToXY(t,e))):null}}class Cp extends zi.X{constructor(){super(...arguments),this.key=Cp.key,this.lazyNavGraph=(0,xn.R)((()=>this.makeNavGraph()))}get navGraph(){return this.lazyNavGraph.value()}cycle(t){}makeNavGraph(){const{absoluteBounds:t,bounds:e}=Oi(this.world.traitsOfType(xo)),i=new xp;i.setBounds(t);for(const t of this.world.traitsOfType(Gr)){if(t.entity.traitOfType(hn))continue;const{x:e,y:s}=t.entity.position,{maxRadius:n}=t;i.markObstacle(e,s,n)}return i}}Cp.key="nav-graph";class Ep extends Cd.z{constructor(){super(...arguments),this.layerId=vd.BACKGROUND_FILL}postBind(){super.postBind(),this.seasonTrait=this.entity.traitOfType(Ul)}createView(){return new f.Sprite(f.Texture.WHITE)}updateView(t){const{visibleRectangle:e}=this.camera;t.tint=this.seasonTrait.season.groundColor,t.position.set(e.x,e.y),t.width=e.width,t.height=e.height}isVisible(){return!0}}const Sp=[16776960,16711680,16746496];class Mp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.PARTICLES,this.particleParams=new Zi.I}postBind(){super.postBind(),this.burnableTrait=this.entity.traitOfType(Rr);const{particles:t}=this.worldViewController;this.emitter=t.square.emitter(((t,e)=>{t.x=e.x+(0,wt.XU)(-10,10),t.y=e.y+(0,wt.XU)(-15,15),t.deltaX=(0,wt.XU)(-15,15),t.deltaY=(0,wt.XU)(-50,-100),t.layerId=this.layerId,t.color=(0,wt.F5)(Sp),t.duration=(0,wt.YR)(.5,1.5),t.size=(0,wt.YR)(8,16),t.deltaSize=-t.size,t.alpha=1,t.deltaAlpha=0,t.rotation=Math.PI/4,t.deltaRotation=0})).continuous(1/30,this.particleParams)}createView(){return null}updateView(t){}update(){this.particleParams.x=this.entity.x,this.particleParams.y=this.entity.y-30,this.emitter.emit=this.burnableTrait.burning,this.emitter.cycle(this.age-this.lastUpdate),super.update()}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.x,this.entity.y,10,10)}}class Pp extends f.Container{constructor(t){super(),this.characterView=t,this.createdAge=0,this.addChild(t)}}class Ip extends Cd.z{constructor(t){super(),this.characterViewPool=t,this.layerId=vd.WORLD,this.reusableParticleParm={x:0,y:0},this.lastAddedPrint=0}postBind(){super.postBind(),this.dasherTrait=this.entity.traitOfType(Lr),this.emitter=this.worldViewController.particles.square.emitter(((t,e)=>{t.x=e.x+(0,wt.XU)(-10,10),t.deltaX=(0,wt.XU)(-10,10),t.y=e.y+(0,wt.XU)(-10,10),t.deltaY=(0,wt.XU)(-10,10),t.size=(0,wt.XU)(5,10),t.color=16777215,t.duration=(0,wt.YR)(.5,1),t.alpha=1,t.deltaAlpha=-t.alpha,t.rotation=Math.PI/4,t.layerId=this.layerId})).continuous(1/60,this.reusableParticleParm)}createView(){return new f.Container}destroyView(t){for(const e of t.children)this.characterViewPool.give(e.characterView);super.destroyView(t)}updateView(t,e){if(this.dasherTrait.dashing&&this.entity.age-this.lastAddedPrint>1/30){this.lastAddedPrint=this.entity.age;const e=this.characterViewPool.take();this.updateCharacterView(e);const i=new Pp(e);i.createdAge=this.entity.age,i.parent!==t&&(i.removeFromParent(),t.addChild(i))}for(const e of t.children)e.alpha=gt(.5,0,(this.entity.age-e.createdAge)/.3),e.alpha<=0&&(e.removeFromParent(),this.characterViewPool.give(e.characterView));this.reusableParticleParm.x=this.entity.position.x,this.reusableParticleParm.y=this.entity.position.y,this.emitter.emit=this.dasherTrait.dashing,this.emitter.cycle(e)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,20,20)}}class Ap extends Ip{updateCharacterView(t){Wd(t,this.entity.traitOfType(Rs),this.entity.traitOfType(ko),this.entity.traitOfType(Ws),this.entity.traitOfType(ws),this.entity.traitOfType(Us),this.entity.traitOfType(mn),this.entity.traitOfType(Lr),this.entity.traitOfType(Qs),this.entity.traitOfType(Br),this.entity.traitOfType(to))}}class Op extends Ip{updateCharacterView(t){qd(t,this.entity.traitOfType(Ws),this.entity.traitOfType(ws),this.entity.traitOfType(Us),this.entity.traitOfType(Qs))}}class Rp extends Ip{updateCharacterView(t){Ld(t,this.entity.traitOfType(Ws),this.entity.traitOfType(ws),this.entity.traitOfType(Us),null)}}class _p extends f.Container{constructor(t){super(),this.texturePool=t,this.bubble=(()=>{const t=new f.Sprite(this.texturePool.catalog.speechBubbleExclamation);return t.width=80,t.scale.y=t.scale.x,t.anchor.set(.5,.55),t})(),this.exclamation=(()=>{const t=new f.Text("",{fill:"#fff",fontFamily:"Arial",fontSize:24,fontWeight:"800"});return t.anchor.set(.5,.5),t})(),this.addChild(this.bubble,this.exclamation)}}class Bp extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.OVER_WORLD_UI,this.attackingVisibleTime=0}postBind(){super.postBind(),this.meleeAttackerTrait=this.entity.traitOfType(tn)}update(){super.update(),this.isVisible()||(this.attackingVisibleTime=0)}createView(){return new _p(this.texturePool)}updateView(t,e){t.position.set(this.entity.x,this.entity.y-110+(0,wt.XU)(-2,2)),this.attackingVisibleTime+=e;const i=gt(0,1,this.attackingVisibleTime,Pu);t.scale.set(i,i),t.exclamation.tint=16711680,t.exclamation.tint=0,t.exclamation.text=this.meleeAttackerTrait.preparingAttack===Ls.HEAVY?"!!!":"!!"}isVisible(){return super.isVisible()&&this.meleeAttackerTrait.preparingAttack!==Ls.NONE}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}class Lp extends tu{constructor(){super((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.anchor.set(.5,.5),t.width=t.height=4,t.tint=16776960,t.rotation=Math.PI/4,t}))}}class Dp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.PARTICLES}postBind(){super.postBind(),this.staminaTrait=this.entity.traitOfType(Ys),this.staggerableTrait=this.entity.traitOfType(Qs)}createView(){return new Lp}updateView(t,e){t.position.set(this.entity.x,this.entity.y+5),t.setParticleCount(7);let i=0;const s=this.age*Math.PI;for(const e of t.particles){const n=i/t.particles.length*Math.PI*2+s;e.position.set(15*Math.cos(n),7*Math.sin(n)-75*(this.entity.traitOfType(Br)?1.4:1)),i++}}isVisible(){return super.isVisible()&&this.staminaTrait.exhausted&&!this.staggerableTrait.staggered}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}class Vp extends f.Container{constructor(t){super(),this.texturePool=t,this.bubble=(()=>{const t=new f.Sprite(this.texturePool.catalog.speechBubble4);return t.width=60,t.scale.y=t.scale.x,t.scale.x*=-1,t.anchor.set(.5,.45),t})(),this.icon=(()=>{const t=new f.Sprite(this.texturePool.catalog.shop2);return t.width=25,t.scale.y=t.scale.x,t.anchor.set(.5,.5),t.tint=0,t})(),this.addChild(this.bubble,this.icon)}}class Hp extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.OVER_WORLD_UI}postBind(){super.postBind(),this.merchantTrait=this.entity.traitOfType(Tr)}createView(){return new Vp(this.texturePool)}updateView(t,e){t.position.set(this.entity.x,this.entity.y-110)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-110,100,100)}isVisible(){return super.isVisible()&&this.merchantTrait.enabled}}class Fp extends f.Container{constructor(t){super(),this.texturePool=t,this.bubble=(()=>{const t=new f.Sprite(this.texturePool.catalog.speechBubble4);return t.width=60,t.scale.y=t.scale.x,t.scale.x*=-1,t.anchor.set(.5,.45),t})(),this.icon=(()=>{const t=new f.Sprite(this.texturePool.catalog.questionMark);return t.width=25,t.scale.y=t.scale.x,t.anchor.set(.5,.5),t.tint=0,t})(),this.addChild(this.bubble,this.icon)}}class Np extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.OVER_WORLD_UI}postBind(){super.postBind(),this.npcTrait=this.entity.traitOfType(al)}createView(){return new Fp(this.texturePool)}updateView(t,e){t.position.set(this.entity.x,this.entity.y-110)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-110,100,100)}isVisible(){return super.isVisible()&&this.npcTrait.enabled}}class Up extends Cd.z{constructor(){super(...arguments),this.layerId=vd.WORLD,this.reusableParticleParm={x:0,y:0},this.staggerChange=new bc.u}postBind(){super.postBind(),this.knightTrait=this.entity.traitOfType(ko),this.dasherTrait=this.entity.traitOfType(Lr),this.staggerableTrait=this.entity.traitOfType(Qs),this.staggerChange.reset(),this.emitter=this.worldViewController.particles.square.emitter(((t,e)=>{const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(0,40);t.x=e.x+Math.cos(i)*s,t.deltaX=Math.cos(i)*(0,wt.XU)(0,50),t.y=e.y+Math.sin(i)*s/2,t.deltaY=Math.sin(i)*(0,wt.XU)(0,50)/2,t.size=(0,wt.XU)(5,10),t.color=16777215,t.duration=(0,wt.YR)(.4,.6),t.alpha=1,t.deltaAlpha=-t.alpha,t.rotation=Math.PI/4,t.layerId=this.layerId}))}createView(){return null}update(){super.update();const t=this.staggerableTrait.staggered&&this.staggerableTrait.staggeredAge>.2;if(this.staggerChange.requiresUpdate(t)&&t)for(let t=0;t<50;t++)this.emitter.emit(this.entity.position)}updateView(t,e){}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,20,20)}}class Wp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.HUD_UI}postBind(){super.postBind(),this.characterTrait=this.entity.traitOfType(hn),this.knightTrait=this.entity.traitOfType(ko),this.wolfTrait=this.entity.traitOfType($h),this.healthTrait=this.entity.traitOfType(ws),this.parrierTrait=this.entity.traitOfType($s),this.aiTrait=this.entity.traitOfType(Pr),this.staggerableTrait=this.entity.traitOfType(Qs),this.staminaTrait=this.entity.traitOfType(Ys),this.horseTrait=this.entity.traitOfType(Qr)}createView(){const t=new f.Text("",{fill:"#fff",stroke:"#000",strokeThickness:2,align:"center",fontFamily:"Times New Roman",fontSize:12});return t.anchor.set(.5,0),t.resolution=2,t}updateView(t,e){var i,s,n,a,r,o,h,l,c,d,u,p,m,y,w;t.position.set(this.entity.position.x,this.entity.position.y);const{stats:g}=this.characterTrait,f=["defense","damage","mobility"].map((t=>`${t}: ${Math.round(100*g[t])}`));f.push(`health: ${Math.round(this.healthTrait.health)} / ${Math.round(this.healthTrait.maxHealth)}`),this.staminaTrait&&f.push(`stamina: ${Math.round(100*this.staminaTrait.stamina)}%`),this.staggerableTrait&&f.push(`constitution: ${Math.round(100*this.staggerableTrait.constitution)}%`),f.push(null===(a=null===(n=null===(s=null===(i=this.knightTrait)||void 0===i?void 0:i.stateMachine)||void 0===s?void 0:s.currentState)||void 0===n?void 0:n.constructor)||void 0===a?void 0:a.name),f.push(null===(l=null===(h=null===(o=null===(r=this.wolfTrait)||void 0===r?void 0:r.stateMachine)||void 0===o?void 0:o.currentState)||void 0===h?void 0:h.constructor)||void 0===l?void 0:l.name),f.push(null===(p=null===(u=null===(d=null===(c=this.horseTrait)||void 0===c?void 0:c.stateMachine)||void 0===d?void 0:d.currentState)||void 0===u?void 0:u.constructor)||void 0===p?void 0:p.name),f.push(((null===(m=this.parrierTrait)||void 0===m?void 0:m.canParry)?"PARRY":"")+((null===(y=this.parrierTrait)||void 0===y?void 0:y.canPerfectParry)?"++":"")),f.push(null===(w=this.aiTrait)||void 0===w?void 0:w.description),t.text=f.filter((t=>t)).join("\n")}}class Xp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.HUD_UI}postBind(){super.postBind(),this.eventTriggerTrait=this.entity.traitOfType(bp.L)}createView(){const t=new f.Container,e=new f.Sprite(f.Texture.WHITE);e.alpha=.2,e.tint=16711680,e.anchor.set(.5,.5),t.addChild(e);const i=new f.Sprite(f.Texture.WHITE);return i.width=4,i.height=4,i.tint=16711680,i.anchor.set(.5,.5),t.addChild(i),t}updateView(t){t.position.set(this.entity.position.x,this.entity.position.y);const e=t.getChildAt(0);e.width=2*this.eventTriggerTrait.radiusX,e.height=2*this.eventTriggerTrait.radiusY}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.x,this.entity.y,2*this.eventTriggerTrait.radiusX,2*this.eventTriggerTrait.radiusY)}}class Gp extends f.Container{constructor(){super(),this.cells=new f.Container,this.path=new f.Graphics,this.expansion=new f.Graphics,this.addChild(this.cells,this.path,this.expansion)}regenPath(t,e,i){this.path.clear(),this.expansion.clear();const s=new Zi.I;if(i){this.expansion.beginFill(16711680,.5);for(const[e,n]of i){const{x:i,y:a}=t.rowColToXY(e,n,s);this.expansion.drawRect(i-2,a-2,5,5)}this.expansion.endFill()}if(e){this.path.lineStyle(2,65280);const i=new Zi.I;let s=!0;for(const[n,a]of e){const{x:e,y:r}=t.rowColToXY(n,a,i);s?(s=!1,this.path.moveTo(e,r)):this.path.lineTo(e,r)}}}regen(t){this.cells.removeChildren();const e=new Zi.I;for(let i=0;i<t.obstacles.length;i++)for(let s=0;s<t.obstacles[i].length;s++){if(!t.obstacles[i][s])continue;const{x:n,y:a}=t.rowColToXY(i,s,e),r=new f.Sprite(f.Texture.WHITE);r.position.set(n,a),r.tint=16711680,r.width=r.height=t.cellSize,r.anchor.set(.5,.5),this.cells.addChild(r)}}}class zp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.UNDER_WORLD_UI,this.navGraphUpdate=new bc.u,this.pathUpdate=new bc.u}postBind(){super.postBind(),this.navGraphTrait=this.entity.traitOfType(Cp)}createView(){return new Gp}updateView(t,e){var i,s,n;this.navGraphUpdate.requiresUpdate(this.navGraphTrait.navGraph)&&t.regen(this.navGraphTrait.navGraph),this.pathUpdate.requiresUpdate(null===(i=this.navGraphTrait.navGraph.lastPathFinderResult)||void 0===i?void 0:i.steps)&&t.regenPath(this.navGraphTrait.navGraph,null===(s=this.navGraphTrait.navGraph.lastPathFinderResult)||void 0===s?void 0:s.steps,null===(n=this.navGraphTrait.navGraph.lastPathFinderResult)||void 0===n?void 0:n.expandedOrder)}}class Kp extends Cd.z{constructor(){super(...arguments),this.layerId=vd.PATH}postBind(){super.postBind(),this.dirtPatchTrait=this.entity.traitOfType(kr)}createView(){const t=new f.Sprite(f.Texture.WHITE);return t.tint=13680784,t.anchor.set(.5,.5),t}updateView(t,e){t.rotation=this.entity.angle,t.position.copyFrom(this.entity.position),t.width=this.dirtPatchTrait.width,t.height=this.dirtPatchTrait.height}}const Yp=(0,xn.R)((()=>{const t=document.createElement("canvas");t.width=100,t.height=1;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,100,0);return i.addColorStop(0,"rgba(0, 0, 0, 0)"),i.addColorStop(.5,"rgba(0, 0, 0, 1)"),i.addColorStop(1,"rgba(0, 0, 0, 1)"),e.fillStyle=i,e.fillRect(0,0,t.width,t.height),f.Texture.from(t)}));class qp extends f.Sprite{constructor(){super(Yp.get()),this.anchor.set(0,.5)}update(t,e){this.width=t,this.height=e}}class jp extends f.Container{constructor(){super(),this.top=(()=>{const t=new qp;return t.rotation=-Math.PI/2,t})(),this.bottom=(()=>{const t=new qp;return t.rotation=Math.PI/2,t})(),this.left=(()=>{const t=new qp;return t.rotation=Math.PI,t})(),this.right=new qp,this.addChild(this.left,this.right,this.top,this.bottom)}update(t,e){this.left.update(Math.abs(e.minX-t.minX),e.height),this.right.update(Math.abs(e.maxX-t.maxX),e.height),this.top.update(Math.abs(e.minY-t.minY),e.width),this.bottom.update(Math.abs(e.maxY-t.maxY),e.width),this.left.position.set(t.minX,t.midY),this.right.position.set(t.maxX,t.midY),this.top.position.set(t.midX,t.minY),this.bottom.position.set(t.midX,t.maxY)}}class $p extends Cd.z{constructor(){super(...arguments),this.layerId=vd.WEATHER,this.reusableOuterRectangle=new Wr.M,this.reusableInnerRectangle=new Wr.M}postBind(){super.postBind(),this.worldBoundsTrait=this.entity.traitOfType(xo)}createView(){return new jp}isVisible(){return this.alpha>0}get alpha(){const{target:t}=this.camera.entity.traitOfType(dd.F);if(!t)return 0;const{bounds:e}=this.worldBoundsTrait;return gt(1,0,Math.min(Math.abs(t.x-e.minX),Math.abs(t.x-e.maxX),Math.abs(t.y-e.minY),Math.abs(t.y-e.maxY))/200)}updateView(t,e){const{visibleRectangle:i}=this.camera,{bounds:s}=this.worldBoundsTrait;t.alpha=this.alpha,this.reusableInnerRectangle.copy(s),this.reusableInnerRectangle.shrink(100,100);const n=Math.max(i.width,i.height)/2+30;this.reusableOuterRectangle.copy(s),this.reusableOuterRectangle.grow(n,n),t.update(this.reusableInnerRectangle,this.reusableOuterRectangle)}}class Jp extends f.Container{constructor(t){super();const e=new f.Sprite(t.textures.stand.texture);e.anchor.set(.5,1),this.addChild(e)}}class Zp extends Rd{constructor(t){super(),this.texturePool=t,this.layerId=vd.WORLD}createView(){return new Jp(this.texturePool)}updateView(t){t.position.set(this.entity.position.x,this.entity.position.y)}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,200,200)}}const Qp=300,tm={width:70,color:13680784};class em extends Cd.z{constructor(){super(...arguments),this.layerId=vd.PATH,this.pathEntityY=0,this.bounds=new f.Rectangle}postBind(){super.postBind(),this.pathTrait=this.entity.traitOfType(yl)}createView(){return this.pathEntityY=0,new f.Graphics}updateView(t,e){t.getLocalBounds(this.bounds,!0);const{visibleRectangle:i}=this.camera,s=Math.floor((i.minX-tm.width)/Qp)*Qp,n=Math.ceil((i.maxX+tm.width)/Qp)*Qp;let a=this.bounds.x>s||this.bounds.x+this.bounds.width<n;if(this.pathEntityY!==this.entity.position.y&&(a=!0),a){t.clear(),t.lineStyle(tm),t.moveTo(s,this.pathTrait.pathY(s));for(let e=s+Qp;e<=n;e+=Qp)t.lineTo(e,this.pathTrait.pathY(e));this.pathEntityY=this.entity.position.y}}}class im extends f.Container{constructor(t){super(),this.fov=t,this.sprite=(()=>{const t=document.createElement("canvas");t.width=100,t.height=100;const e=t.getContext("2d"),i=e.createRadialGradient(0,0,0,0,0,t.width/2);i.addColorStop(0,"rgba(255, 255, 255, 0.1)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.save(),e.translate(t.width/2,t.height/2),e.beginPath(),e.moveTo(0,0),e.arc(0,0,t.width/2,-this.fov/2,this.fov/2),e.fill(),e.restore();const s=f.Texture.from(t),n=new f.Sprite(s);return n.anchor.set(.5,.5),n})(),this.addChild(this.sprite)}update(t,e){this.sprite.width=2*t,this.sprite.scale.y=this.sprite.scale.x,this.sprite.tint=e}}class sm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.UNDER_WORLD_UI}postBind(){super.postBind(),this.meleeAttackerTrait=this.entity.traitOfType(tn),this.controllableTrait=this.entity.traitOfType(Rs)}createView(){return new im(this.meleeAttackerTrait.fov)}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),t.rotation=ls(this.entity.position,this.controllableTrait.inputs.aim),t.update(this.meleeAttackerTrait.magnetRadius,this.meleeAttackerTrait.lungeVictim?this.meleeAttackerTrait.lungeVictim.traitOfType(Ki)?16711680:65280:0)}isVisible(){return this.controllableTrait.aimMode===Is.INDEPENDENT}}class nm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.HUD_UI}postBind(){super.postBind(),this.announcementTrait=this.entity.traitOfType(bs),this.disappearingTrait=this.entity.traitOfType(en.K)}createView(){const t=new f.Text("",{fill:"#fff",stroke:"#000",strokeThickness:4,align:"left",fontFamily:g,fontSize:108,wordWrap:!0});return t.resolution=2,t}updateView(t,e){var i;const{visibleRectangle:s}=this.camera;ct()?(t.anchor.set(.5,.5),t.position.set(s.midX,s.minY+.3*s.height),t.style.align="center"):(t.anchor.set(0,1),t.position.set(s.minX+20/this.camera.zoom,s.maxY-20/this.camera.zoom)),t.text=this.announcementTrait.message,t.scale.set(1/this.camera.zoom,1/this.camera.zoom),t.alpha=(0,ft.Tq)(0,this.entity.age<1?this.entity.age:1-(this.entity.age-((null===(i=this.disappearingTrait)||void 0===i?void 0:i.maxAge)||9999999)+1),1),t.style.wordWrapWidth=.8*this.camera.width}}class am extends f.Graphics{constructor(){super(),this.beginFill(16777215,.5),this.drawEllipse(0,0,100,50)}}class rm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.UNDER_WORLD_UI}postBind(){super.postBind(),this.meleeAttackerTait=this.entity.traitOfType(tn)}createView(){return new am}updateView(t,e){const i=this.meleeAttackerTait.preparationRatio;t.alpha=.5*(1-i),t.position.set(this.entity.x,this.entity.y),t.scale.set(1-i,1-i),t.tint=this.meleeAttackerTait.preparingAttack===Ls.HEAVY?16711680:16776960}isVisible(){return super.isVisible()&&this.meleeAttackerTait.preparingAttack!==Ls.NONE}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y-50,100,120)}}var om=i(6652);function hm(t,e){t.filters?t.filters.push(e):t.filters=[e]}class lm extends f.Container{constructor(t){super(),this.texturePool=t,this.healthGauge=new Eu(this.texturePool),this.staminaGauge=new Eu(this.texturePool),this.levelContainer=(()=>{const t=new f.Graphics;return t.beginFill(0),t.lineStyle({width:5,color:4210752}),t.drawCircle(0,0,35),t})(),this.levelFillMask=(()=>{const t=new f.Graphics;return t.beginFill(0),t.drawCircle(0,0,35),t})(),this.levelFill=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.alpha=.5,t.anchor.set(.5,1),t})(),this.levelValueLabel=(()=>{const t=new f.Text("",{fill:16777215,fontFamily:g,fontSize:48});return t.resolution=2,t.anchor.set(.5,.5),t})(),this.levelLabel=(()=>{const t=new f.Text("LVL",{fill:16777215,fontFamily:g,fontSize:12});return t.resolution=2,t.anchor.set(.5,.5),t})(),this.comboCounter=(()=>{const t=new f.Text("",{fill:"#fff",fontFamily:g,fontSize:36,fontWeight:"bold",stroke:"#000",strokeThickness:4,align:"right"});return t.anchor.set(1,.5),t.rotation=-Math.PI/32,t.resolution=2,t})(),this.extraDamage=(()=>{const t=new f.Text("EXTRA DMG!",{fill:"#f80",fontFamily:g,fontSize:24,fontWeight:"bold",stroke:"#000",strokeThickness:4,align:"right"});return t.anchor.set(.5,.5),t.resolution=2,t})(),this.moneyIcon=(()=>{const t=new f.Sprite(this.texturePool.catalog.coins);t.width=40,t.scale.y=t.scale.x,t.anchor.set(.5,.5);const e=new f.Container;return e.addChild(t),e})(),this.moneyLabel=(()=>{const t=new f.Text("",{fill:"#fff",fontFamily:g,fontSize:24,fontWeight:"bold",stroke:"#000",strokeThickness:4});return t.resolution=2,t.anchor.set(0,.5),t})(),this.addChild(this.healthGauge,this.staminaGauge,this.extraDamage,this.comboCounter,this.levelContainer,this.levelValueLabel,this.levelLabel,this.levelFillMask,this.levelFill,this.moneyIcon,this.moneyLabel),this.levelFill.mask=this.levelFillMask,ct()||hm(this,new om.G({blur:2,color:0,offset:new f.Point(2,2)}))}updateLayout(t,e){this.levelContainer.position.set(100,100),this.levelFill.position.set(this.levelContainer.position.x,this.levelContainer.position.y+this.levelContainer.height/2),this.levelFill.width=this.levelContainer.width,this.levelFill.height=this.levelContainer.height/2,this.levelFillMask.position.copyFrom(this.levelContainer.position),this.levelValueLabel.position.set(this.levelContainer.position.x,this.levelContainer.position.y-5),this.levelLabel.position.set(this.levelValueLabel.position.x,this.levelValueLabel.position.y+this.levelValueLabel.height/2),this.healthGauge.position.set(this.levelContainer.position.x+45,this.levelContainer.position.y-20-2),this.staminaGauge.position.set(this.healthGauge.position.x,this.levelContainer.position.y+2),this.comboCounter.position.set(this.healthGauge.position.x+this.healthGauge.width+10,this.levelContainer.position.y),this.extraDamage.position.set(this.comboCounter.position.x-80-this.extraDamage.width/2,this.comboCounter.position.y+5),this.moneyIcon.position.set(this.healthGauge.position.x+20,this.staminaGauge.position.y+this.staminaGauge.height+20),this.moneyLabel.position.set(this.moneyIcon.position.x+this.moneyIcon.width/2+5,this.moneyIcon.position.y)}}class cm extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.HUD_UI,this.displayedHealth=1,this.displayedStamina=1,this.relevantStartAge=0,this.relevantEndAge=0}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws),this.staminaTrait=this.entity.traitOfType(Ys),this.comboTrackerTrait=this.entity.traitOfType(fn),this.experienceHolderTrait=this.entity.traitOfType(Xs),this.inventoryTrait=this.entity.traitOfType(mn),this.meleeAttackerTrait=this.entity.traitOfType(tn),this.relevantStartAge=0,this.relevantEndAge=0}get relevant(){return this.entity.age<this.relevantEndAge}update(){var t,e;const i=this.relevant;(this.meleeAttackerTrait.preparingAttack!==Ls.NONE||(null===(e=null===(t=this.entity.world)||void 0===t?void 0:t.entities)||void 0===e?void 0:e.bucketSize(Ki.key))>0||this.entity.age-this.inventoryTrait.lastMoneyReceived<1)&&(i||(this.relevantStartAge=this.entity.age),this.relevantEndAge=this.entity.age+3),super.update()}createView(){return new lm(this.texturePool)}updateView(t,e){const i=Math.min(gt(0,1,(this.entity.age-this.relevantStartAge)/.2),gt(0,1,(this.relevantEndAge-this.entity.age)/.2));if(t.alpha=i,t.alpha<=0)return;const{visibleRectangle:s}=this.camera;t.position.set(s.minX,s.minY+gt(-30,0,i)),t.scale.set(1/this.camera.zoom,1/this.camera.zoom),t.updateLayout(this.camera.width,this.camera.height),this.displayedHealth+=(0,ft.Tq)(.5*-e,this.healthTrait.healthRatio-this.displayedHealth,.5*e),this.displayedStamina+=(0,ft.Tq)(.5*-e,this.staminaTrait.stamina-this.displayedStamina,.5*e);const n=.7*this.camera.width,a=this.healthTrait.healthRatio<.2&&this.entity.age%1<.5?16711680:49152;t.healthGauge.update(gt(50,n,this.healthTrait.maxHealth/200),20,a,16711680,this.healthTrait.healthRatio,this.displayedHealth),t.staminaGauge.update(250,20,28912,16777215,this.staminaTrait.stamina,this.displayedStamina);const r=Et(this.comboTrackerTrait.combo)>1;if(t.comboCounter.visible=this.comboTrackerTrait.combo>0,t.extraDamage.visible=!1,t.comboCounter.visible){t.comboCounter.text="X"+this.comboTrackerTrait.combo;const e=1+2*(0,ft.Tq)(0,1-(this.entity.age-this.comboTrackerTrait.lastComboIncrease)/.1,1);t.comboCounter.scale.set(e,e),t.comboCounter.style.fill=r?"#f80":"#fff"}t.extraDamage.visible=r;const o=gt(1.3,1,(this.entity.age-this.comboTrackerTrait.lastComboIncrease)/.2);t.extraDamage.scale.set(o,o),t.levelValueLabel.text=this.experienceHolderTrait.level.toString(),t.levelFill.height=this.experienceHolderTrait.levelRatio*t.levelContainer.height,t.moneyLabel.text=this.inventoryTrait.inventory.money.toLocaleString(),t.moneyLabel.scale.set(gt(1.5,1,(this.entity.age-this.inventoryTrait.lastMoneyReceived)/.3)),t.moneyIcon.scale.set(gt(1.5,1,(this.entity.age-this.inventoryTrait.lastMoneyReceived)/.3))}}var dm=i(5035);class um extends Cd.z{constructor(){super(...arguments),this.layerId=vd.OVER_WORLD_UI,this.filter=(()=>{const t=new dm.F({maxKernelSize:1});return t.resolution=.5,t})(),this.filterCenter=[0,0]}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws)}createView(){const t=new f.Sprite(f.Texture.WHITE);return t.tint=9764864,t.alpha=.5,t}updateView(t,e){const{visibleRectangle:i}=this.camera;t.position.set(i.x,i.y),t.width=i.width,t.height=i.height,t.alpha=gt(.5,0,(this.entity.age-this.healthTrait.lastDamaged)/.5),this.filter.innerRadius=this.worldViewController.renderer.width/5,this.filter.radius=this.worldViewController.renderer.width,this.filterCenter[0]=this.worldViewController.renderer.width/2,this.filterCenter[1]=this.worldViewController.renderer.height/2,this.filter.center=this.filterCenter,this.filter.strength=gt(.2,0,(this.entity.age-this.healthTrait.lastDamaged)/.2)}installView(){super.installView(),hm(this.worldViewController.viewsAffectedByFilters,this.filter)}destroyView(t){super.destroyView(t),function(t,e){if(!t.filters)return;const i=t.filters.indexOf(e);i>=0&&t.filters.splice(i,1),t.filters.length||(t.filters=null)}(this.worldViewController.viewsAffectedByFilters,this.filter)}isVisible(){return this.healthTrait.recentlyDamaged(.5)}update(){super.update(),this.filter.enabled=this.isVisible()}}class pm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.OVER_WORLD_UI}postBind(){super.postBind(),this.healthTrait=this.entity.traitOfType(ws)}createView(){const t=new f.Sprite(f.Texture.WHITE);return t.tint=9764864,t}updateView(t,e){const{visibleRectangle:i}=this.camera;t.position.set(i.x,i.y),t.width=i.width,t.height=i.height,t.alpha=Math.max(0,.1*Math.sin(this.visibleAge*Math.PI*2)+.1)}isVisible(){return this.healthTrait.healthRatio<.2}}class mm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.HUD_UI}createView(){return new Pd}updateView(t,e){const i=Oi(this.entity.world.entities.bucket(ln.key)),s=ls(i.position,this.entity.position),n=gt(0,1,((0,ft.Io)(i.position,this.entity.position)-400)/200),a=gt(80,160,n),r=(this.entity.age%2/2-.5)/.5,o=gt(0,100,r,Bu.easeOutCubic),h=1-r;t.rotation=s,t.alpha=n*h,t.position.set(this.camera.entity.position.x+Math.cos(s)*(a+o),this.camera.entity.position.y+Math.sin(s)*(a+o)-30)}isVisible(){return!!this.entity.world.entities.bucketSize(ln.key)}}class ym extends Cd.z{constructor(){super(...arguments),this.layerId=vd.UNDER_WORLD_UI}postBind(){super.postBind(),this.meleeAttackerTrait=this.entity.traitOfType(tn)}createView(){return new f.Graphics}updateView(t,e){const i=this.meleeAttackerTrait.lungeVictim;i?(t.visible=!0,t.clear(),t.lineStyle({width:5,color:i.traitOfType(Ki)?16711680:65280}),t.moveTo(this.entity.position.x,this.entity.position.y),function(t,e,i,s=16,n=8){const a=t.currentPath.points;let r=a[a.length-2],o=a[a.length-1];const h=Math.atan2(i-o,e-r);let l=(0,ft.cK)(r,o,e,i);for(;l>0;){const e=Math.min(l,s);t.moveTo(r,o),t.lineTo(r+Math.cos(h)*e,o+Math.sin(h)*e),r+=Math.cos(h)*(s+n),o+=Math.sin(h)*(s+n),l-=s+n}}(t,i.position.x,i.position.y,10,10)):t.visible=!1}}function wm(t){const e=Math.floor(t%60);return Math.floor(t/60).toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")}class gm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.HUD_UI}postBind(){super.postBind(),this.timerTrait=this.entity.traitOfType(Hl)}createView(){const t=new f.Text("",{fill:"#fff",stroke:"#000",strokeThickness:4,align:"center",fontFamily:g,fontSize:24});return t.resolution=2,t.anchor.set(.5,.5),t}updateView(t,e){var i;const{visibleRectangle:s}=this.camera;t.position.set(s.midX,s.minY+.25*s.height);const n=null===(i=this.entity.traitOfType(Ts))||void 0===i?void 0:i.message;if(this.timerTrait.started)if(this.timerTrait.elapsed<1&&!n)t.scale.set(gt(3,1,this.timerTrait.elapsed/.2)),t.text=pt("go!");else{const e=n?n+"\n":"";t.scale.set(1),t.text=e+wm(Math.max(0,this.timerTrait.timeLeft)),t.visible=this.timerTrait.timeLeft>0}else t.scale.set(gt(3,1,this.entity.age%.5/.2)),t.text=Math.ceil(this.timerTrait.countdown).toString();t.style.fill=this.timerTrait.duration>0&&this.timerTrait.timeLeft<10?"#f00":"#fff"}}const fm=[16776960,16711680,16746496];class vm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.WORLD,this.particleParams=new Zi.I}postBind(){super.postBind();const{particles:t}=this.worldViewController;this.emitter=t.square.emitter(((t,e)=>{t.x=e.x+(0,wt.XU)(-2,2),t.y=e.y+(0,wt.XU)(-2,2),t.deltaX=(0,wt.XU)(-15,15),t.deltaY=(0,wt.XU)(-50,-100),t.layerId=vd.PARTICLES,t.color=(0,wt.F5)(fm),t.duration=(0,wt.YR)(.5,1.5),t.size=(0,wt.YR)(6,12),t.deltaSize=-t.size,t.alpha=1,t.deltaAlpha=0,t.rotation=Math.PI/4,t.deltaRotation=0})).continuous(1/60,this.particleParams)}createView(){const t=new f.Sprite(f.Texture.WHITE);return t.width=t.height=5,t.anchor.set(.5),t.rotation=Math.PI/4,t}updateView(t){t.position.set(~~this.entity.x,~~this.entity.y-30),t.tint=(0,wt.F5)(fm)}update(){this.particleParams.x=this.entity.x,this.particleParams.y=this.entity.y-30,this.emitter.emit=!0,this.emitter.cycle(this.age-this.lastUpdate),super.update()}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.x,this.entity.y,10,10)}}class bm extends f.Container{constructor(){super(),this.toolView=new Pa(new Ca),this.addChild(this.toolView),this.toolView.position.set(0,-30)}setToolDescription(t){this.toolView.setToolDescription(t);const e=this.toolView.getLocalBounds();this.toolView.pivot.set(e.x+e.width/2,e.y+e.height/2)}}class Tm extends Rd{constructor(){super(...arguments),this.layerId=vd.WORLD}postBind(){super.postBind(),this.projectileTrait=this.entity.traitOfType(Ss),this.toolProjectileTrait=this.entity.traitOfType(rn)}createView(){const t=new bm;return t.setToolDescription(this.toolProjectileTrait.description),t}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y),t.toolView.scale.x=Math.sign(Math.cos(this.entity.angle))||1,t.toolView.rotation=t.toolView.scale.x*this.entity.age*Math.PI*4*this.projectileTrait.speed/200}updateVisibilityRectangle(){this.visibilityRectangle.centerAround(this.entity.position.x,this.entity.position.y,50,50)}}class km extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.WEATHER,this.random=new Qd("",500)}postBind(){super.postBind(),this.fogTrait=this.entity.traitOfType(pc)}createView(){return new tu((()=>{const t=new f.Sprite(this.texturePool.textures.fog.texture);return t.scale.y=.5,t.anchor.set(.5,.5),t}))}updateView(t){this.random.reset(),t.position.set(this.entity.position.x,this.entity.position.y),t.setParticleCount(this.fogTrait.density);const e=this.random.next(150,200),i=this.random.next(.4,.6);for(const s of t.particles){const t=this.random.next(0,2*Math.PI),n=this.random.next(0,e);s.scale.set(1,.5),s.scale.x*=this.random.next(0,1)<.5?1:-1,s.scale.y*=this.random.next(0,1)<.5?1:-1,s.alpha=this.random.next(.3,.8),s.position.set(Math.cos(t)*n+Math.sin(this.age*Math.PI*2/this.random.next(10,20))*this.random.next(50,100),Math.sin(t)*n*i+Math.sin(this.age*Math.PI*2/this.random.next(10,20))*this.random.next(20,40)),s.rotation=Math.sin(this.age*Math.PI*2/this.random.next(10,20))*this.random.next(0,Math.PI/16),s.scale.x*=1+Math.sin(this.age*Math.PI*2/this.random.next(10,20))*this.random.next(0,Math.PI/16),s.scale.y*=1+Math.sin(this.age*Math.PI*2/this.random.next(10,20))*this.random.next(0,Math.PI/16)}}}class xm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.WEATHER,this.random=new Qd("",500)}postBind(){super.postBind(),this.rainTrait=this.entity.traitOfType(mc)}createView(){return new tu((()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=4838134,t.width=2,t.height=20,t}))}updateView(t){const{visibleRectangle:e}=this.camera,i=e.width*e.height;t.position.set(e.x,e.y),t.setParticleCount(Math.round(i/144e4*this.rainTrait.density));const{width:s,height:n}=e;this.random.reset();for(const e of t.particles){const i=this.random.next(0,s),a=i,r=this.random.next(.3,1),o=this.random.next(0,r),h=(this.entity.age+o)/r%1;e.position.set(i+h*(a-i),h*n),e.position.set((0,ft.xP)(e.position.x-t.position.x,s),(0,ft.xP)(e.position.y-t.position.y,n))}}}class Cm extends Cd.z{constructor(t){super(),this.texturePool=t,this.layerId=vd.WEATHER,this.random=new Qd("",500)}postBind(){super.postBind(),this.snowTrait=this.entity.traitOfType(yc)}createView(){return new tu((()=>{const t=new f.Sprite(this.texturePool.textures.particles.circle.texture);return t.tint=16777215,t.width=t.height=(0,wt.XU)(4,10),t.anchor.set(.5,.5),t}))}updateView(t){const{visibleRectangle:e}=this.camera,i=e.width*e.height;t.position.set(e.x,e.y),t.setParticleCount(Math.floor(i/144e4*this.snowTrait.density));const{width:s,height:n}=e;this.random.reset();for(const e of t.particles){const i=this.random.next(0,s),a=this.random.next(4,8),r=this.random.next(0,a),o=(this.entity.age+r)/a%1,h=this.random.next(10,20),l=Math.round(this.random.next(1,3));e.position.set(i+Math.sin(o*Math.PI*2*l)*h,o*n),e.position.set((0,ft.xP)(e.position.x-t.position.x,s),(0,ft.xP)(e.position.y-t.position.y,n))}}}const Em=300;class Sm extends f.Container{constructor(){super(),this.water=this.addChild(new Mm(Em)),this.waterOver=this.addChild(new Mm(150)),this.ripples=this.addChild(new tu((()=>{const t=new ru;return t.age=Math.random(),t}))),this.water.tint=32928,this.waterOver.tint=ee(32928,.8)}}class Mm extends f.Graphics{constructor(t){super(),this.interval=t}regenerate(t,e,i,s){this.clear(),this.beginFill(16777215),this.moveTo(e,t.seaY(e));for(let s=e+this.interval;s<=i;s+=this.interval)this.lineTo(s,t.seaY(s));this.lineTo(i,s.maxY+100),this.lineTo(e,s.maxY+100)}}class Pm extends Cd.z{constructor(){super(...arguments),this.layerId=vd.WATER,this.seaEntityY=0,this.bounds=new f.Rectangle}postBind(){super.postBind(),this.seaTrait=this.entity.traitOfType(Ns),this.seaEntityY=0}isVisible(){const{visibleRectangle:t}=this.camera;return t.maxY>this.entity.position.y-150}createView(){return this.seaEntityY=0,new Sm}updateView(t,e){t.getLocalBounds(this.bounds,!0);const{visibleRectangle:i}=this.camera;i.grow(100,200);const s=Math.floor(i.minX/Em)*Em,n=Math.ceil(i.maxX/Em)*Em;let a=this.bounds.x>s||this.bounds.x+this.bounds.width<n||this.bounds.y+this.bounds.height<i.maxY;this.seaEntityY!==this.entity.position.y&&(a=!0),t.position.set(0,-20),t.waterOver.position.y=10*Math.sin(this.entity.age*Math.PI*2/3)+100,t.ripples.setParticleCount(this.entity.world.entities.bucketSize(mc.key)>0?10:0);let r=this.entity.id.charCodeAt(0);for(const s of t.ripples.particles){r+=this.entity.id.charCodeAt(0)/255,s.age+=e,s.age>1&&(s.age=0,s.position.x=(0,wt.XU)(i.minX,i.maxX),s.position.y=(0,wt.XU)(this.seaTrait.seaY(s.position.x),i.maxY));const t=s.age%1/1;s.alpha=1-t,s.scale.set(t,t/2)}a&&(t.water.regenerate(this.seaTrait,s,n,i),t.waterOver.regenerate(this.seaTrait,s,n,i),this.seaEntityY=this.entity.position.y)}}const Im=300;class Am extends f.Graphics{regenerate(t,e,i,s){this.clear(),this.beginFill(13680784),this.moveTo(e,t.sandY(e));for(let s=e+Im;s<=i;s+=Im)this.lineTo(s,t.sandY(s));this.lineTo(i,s.maxY+100),this.lineTo(e,s.maxY+100)}}class Om extends Cd.z{constructor(){super(...arguments),this.layerId=vd.PATH,this.beachEntityY=0,this.bounds=new f.Rectangle}postBind(){super.postBind(),this.beachTrait=this.entity.traitOfType(Ic),this.beachEntityY=0}isVisible(){const{visibleRectangle:t}=this.camera;return t.maxY>this.entity.position.y-150}createView(){return this.beachEntityY=0,new Am}updateView(t,e){t.getLocalBounds(this.bounds,!0);const{visibleRectangle:i}=this.camera;i.grow(100,200);const s=Math.floor(i.minX/Im)*Im,n=Math.ceil(i.maxX/Im)*Im;let a=this.bounds.x>s||this.bounds.x+this.bounds.width<n||this.bounds.y+this.bounds.height<i.maxY;this.beachEntityY!==this.entity.position.y&&(a=!0),a&&(t.regenerate(this.beachTrait,s,n,i),this.beachEntityY=this.entity.position.y)}}class Rm{constructor(t,e){this.texturePool=t,this.pools=e}}class _m extends Rm{viewControllersForEntity(t){const e=[];if(t.traitOfType(Ul)&&e.push(new Ep),t.traitOfType(tn)&&(t.traitOfType(ln)||t.traitOfType(Qr)||(e.push(new Bp(this.texturePool)),e.push(new rm))),t.traitOfType(Cr)){const t=new Zp(this.texturePool),i=(new _d).forViewController(t);e.push(t,i)}return t.traitOfType(Ys)&&e.push(new Dp),t.traitOfType(yl)&&e.push(new em),t.traitOfType(Ns)&&e.push(new Pm),t.traitOfType(Ic)&&e.push(new Om),t.traitOfType(kr)&&e.push(new Kp),t.traitOfType(dn)&&e.push(this.pools.coin.take()),t.traitOfType(pd),t.traitOfType(Fs)||t.traitOfType(vc)||t.traitOfType(kc)||t.traitOfType(fc)||t.traitOfType(xc),t.traitOfType(Ah)&&(e.push(...this.pools.fire.create()),e.push(...this.pools.fireMark.create())),e}}class Bm extends Rm{viewControllersForEntity(t){const e=[];if(t.traitOfType(Ss)){if(t.traitOfType(rn)){const t=new Tm;e.push(t),e.push((new _d).forViewController(t,1/60))}t.traitOfType(Eh)&&e.push(new vm),t.traitOfType(Mh)&&e.push(this.pools.healingProjectile.take())}return e}}class Lm extends Rm{viewControllersForEntity(t){const e=[];return t.traitOfType(mc)&&e.push(new xm),t.traitOfType(yc)&&e.push(new Cm(this.texturePool)),t.traitOfType(pc)&&e.push(new km(this.texturePool)),t.traitOfType(xo)&&e.push(new $p),e}}class Dm extends Rm{viewControllersForEntity(t){const e=[];return t.traitOfType(md)&&e.push(...this.pools.bird.create()),t.traitOfType(xc)&&e.push(...this.pools.tree.create()),t.traitOfType(vc)&&e.push(...this.pools.grass.create()),t.traitOfType(Cc)&&e.push(...this.pools.tallGrass.create()),t.traitOfType(fc)&&e.push(...this.pools.bush.create()),t.traitOfType(kc)&&e.push(...this.pools.rock.create()),t.traitOfType(Fs)&&e.push(...this.pools.pond.create()),e}}class Vm extends Rm{viewControllersForEntity(t){const e=[];if(t.traitOfType(Uu)){const t=this.pools.dummy.create();e.push(...t),e.push(this.pools.targetOutline.take().for(t[0]))}if(t.traitOfType(Tr)){const t=this.pools.merchant.create();e.push(...t),e.push(new Hp(this.texturePool)),e.push(new Iu(this.pools.indicatorViewPool).for(16123,this.texturePool.textures.shop2.texture)),e.push(this.pools.targetOutline.take().for(t[0]))}if(t.traitOfType(al)){const t=this.pools.npc.create();e.push(...t),e.push(new Np(this.texturePool)),e.push(new Iu(this.pools.indicatorViewPool).for(16123,this.texturePool.textures.questionMark.texture)),e.push(this.pools.targetOutline.take().for(t[0]))}if(t.traitOfType(Qs)&&e.push(new Up),t.traitOfType($h)){const i=this.pools.wolf.create();e.push(...i),t.traitOfType(Lr)&&e.push(new Op(this.pools.wolf.viewPool)),e.push(this.pools.targetOutline.take().for(i[0]))}if(t.traitOfType(Qr)){const i=this.pools.horse.create();e.push(...i),t.traitOfType(Lr)&&e.push(new Rp(this.pools.horse.viewPool)),e.push(this.pools.targetOutline.take().for(i[0]))}if(t.traitOfType(ko)){const i=this.pools.knight.create();e.push(...i),t.traitOfType(Lr)&&e.push(new Ap(this.pools.knight.viewPool)),t.traitOfType(ln)?(e.push(new um),e.push(new sm),e.push(new ym)):e.push(this.pools.targetOutline.take().for(i[0]))}return t.traitOfType(Rr)&&e.push(new Mp),e}}class Hm extends Rm{viewControllersForEntity(t){const e=[];return t.traitOfType(bs)&&e.push(new nm),t.traitOfType(Ts),t.traitOfType(ln)&&(ct(),e.push(new cm(this.texturePool)),e.push(new pm)),t.traitOfType(Ki)&&e.push(this.pools.indicatorPool.take().for(16711680,this.texturePool.textures.crossingSwords.texture)),t.traitOfType(Ki)&&e.push(this.pools.enemyHudPool.take()),t.traitOfType(xl)&&e.push(new mm),t.traitOfType(Hl)&&e.push(new gm),e}}class Fm{constructor(t){this.texturePool=t}viewControllersForEntity(t){const e=[];return t.traitOfType(bp.L)&&e.push(new Xp),t.traitOfType(hn)&&e.push(new Wp),t.traitOfType(ln),t.traitOfType(Cp)&&e.push(new zp),t.traitOfType(Ss)&&e.push(new Tp.e(5,5)),e}}class Nm extends f.Text{constructor(){super("",{fontFamily:"Knights Quest",fontSize:18,fill:"#fff",align:"center",dropShadow:!0,dropShadowColor:"#000",dropShadowAngle:Math.PI/2,dropShadowDistance:1}),this.resolution=2,this.anchor.set(.5,.5)}}class Um extends f.Container{constructor(t){super(),this.knightViewPool=t,this.background=(()=>{const t=new f.Sprite(f.Texture.WHITE);return t.tint=0,t})(),this.knightView=this.knightViewPool.take(),this.label=(()=>{const t=new f.Text("Level Up!",{fill:"#fff",stroke:"#000",strokeThickness:4,align:"left",fontFamily:g,fontSize:108});return t.resolution=2,t.anchor.set(.5,.5),t})(),this.addChild(this.background,this.knightView,this.label)}destroy(t){this.knightView.removeFromParent(),this.knightViewPool.give(this.knightView),super.destroy(t)}}class Wm extends Lu.b{constructor(t){super(),this.knightViewPool=t,this.layerId=vd.DEATH_OVERLAY}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws),this.knightTrait=this.entity.traitOfType(ko),this.healthTrait=this.entity.traitOfType(ws),this.waterAffectedTrait=this.entity.traitOfType(Us),this.inventoryTrait=this.entity.traitOfType(mn),this.dasherTrait=this.entity.traitOfType(Lr),this.staggerableTrait=this.entity.traitOfType(Qs),this.controllableTrait=this.entity.traitOfType(Rs)}createView(){return new Um(this.knightViewPool)}updateView(t,e){const{visibleRectangle:i}=this.camera;t.background.position.set(i.x,i.y),t.background.width=i.width,t.background.height=i.height,t.background.alpha=Math.min(gt(0,1,this.age/.3),gt(1,0,(this.age-2)/1)),t.label.position.set(i.midX,i.minY+.25*i.height),t.label.scale.set(1/this.camera.zoom,1/this.camera.zoom),Wd(t.knightView,this.controllableTrait,this.knightTrait,this.walkerTrait,this.healthTrait,this.waterAffectedTrait,this.inventoryTrait,this.dasherTrait,this.staggerableTrait,null,null)}removeEmitter(){return this.whenAgeIs(3)}}class Xm extends f.Graphics{constructor(){super(),this.lineStyle({width:10,color:16777215}),this.drawCircle(0,0,80)}}const Gm=.25;class zm extends Lu.b{static pool(){return Vu(zm,(()=>new Xm))}constructor(t){super(),this.viewPool=t,this.layerId=vd.DEBUG_FOREGROUND}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x,this.entity.position.y-30),t.alpha=1-this.age/Gm,t.scale.x=t.scale.y=this.age/Gm}async removeEmitter(){return this.whenAgeIs(Gm)}}class Km extends f.Container{constructor(t){super(),this.texturePool=t,this.playerView=(()=>{const t=new Ga(this.texturePool,new Ca);t.update(0,0,0,0,0,!0,!1,oe.item,Oe.item,Je.item,ri.item,fe.item),t.filters=[new Kd.f(1,0)];const e=t.chest.getBounds();return t.pivot.set(e.x+e.width/2,e.y+e.height/2),t})(),this.kingView=(()=>{const t=new Ga(this.texturePool,new Ca);t.update(0,0,0,0,0,!0,!1,oe.item,Ye.item,Je.item,ri.item,fe.item),t.scale.set(-1,1),t.filters=[new Kd.f(1,0)];const e=t.chest.getBounds();return t.pivot.set(e.x+e.width/2,e.y+e.height/2),t})(),this.line=(()=>new Eu(this.texturePool))(),this.progress=0,this.filters=[new om.G({color:0,distance:2,rotation:Math.PI/2})],this.addChild(this.line,this.kingView,this.playerView)}layout(t,e){this.line.position.set(-t/2,0),this.line.update(t,e,16777215,16777215,this.progress,this.progress),this.playerView.position.set(t*this.progress-t/2,10),this.kingView.position.set(.5*t,10)}animateProgress(t,e){return(new np.K).append((()=>this.alpha=0)).append((()=>this.progress=t)).append(new ap.X(this).interpTo("alpha",1)).wait(1).append((new np.K).append(new ap.X(this).interpTo("progress",e).during(1))).wait(1).append(new ap.X(this).interpTo("alpha",0))}}class Ym extends wp.G{constructor(t){super(),this.texturePool=t,this.layerId=vd.HUD_UI}createView(){const t=new Km(this.texturePool);return t.animateProgress(this.event.fromProgress,this.event.toProgress).append((()=>this.removeCallback())).run(this.interpolationPool),t}updateView(t,e){const{visibleRectangle:i,zoom:s}=this.camera;t.scale.set(1/s),t.position.set(i.midX,i.y+3*i.height/4),t.layout(3*this.camera.width/4,20)}removeEmitter(){return new Promise((t=>this.removeCallback=t))}}class qm extends Lu.b{constructor(t){super(),this.viewPool=t,this.layerId=vd.HUD_UI,this.position=new Zi.I,this.amount=0}postBind(){super.postBind(),this.position.x=this.entity.position.x+(0,wt.XU)(-10,10),this.position.y=this.entity.position.y-30+(0,wt.XU)(-10,10),this.amount=this.entityEvent.amount}createView(){const t=this.viewPool.take();t.text=Math.round(this.amount);const e=this.entity.traitOfType(ln)?16711680:this.entityEvent.color;return t.style.fill="#"+e.toString(16).padStart(6,"0"),t}updateView(t,e){t.position.set(this.position.x,this.position.y+-70*Pu(1-this.age/.5)+70),t.alpha=(0,ft.Tq)(0,(.5-this.age)/.16666666666666666,1)}async removeEmitter(){return this.whenAgeIs(.5)}}class jm extends Lu.b{constructor(){super(...arguments),this.layerId=vd.PARTICLES}createView(){return null}update(){super.update();const t={x:this.entity.position.x+(0,wt.XU)(-30,30),y:this.entity.position.y-30+(0,wt.XU)(-30,30)};for(let e=0;e<20;e++)this.emitter.emit(t)}updateView(t,e){}postBind(){super.postBind(),this.emitter=this.worldViewController.particles.square.emitter(((t,e)=>{const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(0,10),n=s+(0,wt.XU)(0,10);t.x=e.x+Math.cos(i)*s,t.y=e.y+Math.sin(i)*s,t.color=9764864,t.deltaX=Math.cos(i)*n,t.deltaY=Math.sin(i)*n,t.duration=(0,wt.YR)(.3,.5),t.rotation=Math.PI/4,t.size=(0,wt.XU)(2,5),t.deltaSize=-t.size/2,t.layerId=this.layerId}))}async removeEmitter(){}}class $m extends Lu.b{constructor(){super(...arguments),this.layerId=vd.PARTICLES}createView(){return null}update(){super.update();for(let t=0;t<40;t++)this.emitter.emit(this.entity.position)}updateView(t,e){}postBind(){super.postBind(),this.emitter=this.worldViewController.particles.square.emitter(((t,e)=>{const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(0,40);t.x=e.x+Math.cos(i)*s,t.y=e.y-30+Math.sin(i)*s,t.color=16777215,t.deltaX=(0,wt.XU)(-20,20),t.deltaY=(0,wt.XU)(-20,20),t.duration=(0,wt.YR)(.3,1),t.rotation=Math.PI/4,t.size=(0,wt.XU)(5,15),t.deltaSize=-t.size/2,t.layerId=this.layerId}))}async removeEmitter(){}}class Jm extends Lu.b{constructor(){super(...arguments),this.layerId=vd.PARTICLES}createView(){return null}update(){super.update();const t={x:this.entity.position.x,y:this.entity.position.y-30};for(let e=0;e<3;e++)this.emitter.emit(t)}updateView(t,e){}postBind(){super.postBind(),this.emitter=this.worldViewController.particles.cross.emitter(((t,e)=>{t.x=e.x+(0,wt.XU)(-10,10),t.y=e.y+(0,wt.XU)(0,-20),t.color=65280,t.deltaX=(0,wt.XU)(-20,20),t.deltaY=(0,wt.XU)(-70,-100),t.duration=(0,wt.YR)(.5,1),t.size=(0,wt.XU)(5,10),t.deltaSize=(0,wt.XU)(5,10),t.deltaAlpha=-t.alpha,t.layerId=this.layerId}))}async removeEmitter(){}}class Zm extends f.Graphics{constructor(){super(),this.lineStyle({width:10,color:16776960}),this.drawCircle(0,0,80)}}const Qm=.25;class ty extends Lu.b{static pool(){return Vu(ty,(()=>new Zm))}constructor(t){super(),this.viewPool=t,this.layerId=vd.DEBUG_FOREGROUND}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws)}createView(){return this.viewPool.take()}updateView(t,e){t.position.set(this.entity.position.x-20*this.walkerTrait.facing,this.entity.position.y-60),t.alpha=1-this.age/Qm,t.scale.x=t.scale.y=this.age/Qm}async removeEmitter(){return this.whenAgeIs(Qm)}}function ey(t,e=[]){const i=new f.Container,s=new f.Point,n=new f.Point,a=r=>{if(r instanceof f.Container&&!e.includes(r))for(const t of Array.from(r.children))a(t);(r instanceof f.Sprite||r instanceof f.Graphics||e.includes(r))&&(r.getGlobalPosition(s,!1),t.toLocal(s,null,n),r.removeFromParent(),r.position.set(n.x*t.scale.x,n.y*t.scale.y),i.addChild(r))};return a(t),i}class iy extends Lu.b{constructor(t){super(),this.viewPool=t,this.layerId=vd.UNDER_WORLD_UI,this.reusableBloodParams={position:null},this.bitParams=new Map}createView(){const t=this.viewPool.take();t.pool=null,Wd(t,this.controllableTrait,this.knightTrait,this.walkerTrait,null,this.waterAffectedTrait,this.inventoryTrait,this.dasherTrait,this.staggerableTrait,this.bruteTrait,this.horseRiderTrait);const e=ey(t,[t.toolContainer]);for(const t of e.children)t.position.x+=this.entity.position.x,t.position.y+=this.entity.position.y,(t instanceof f.Sprite||t instanceof f.Graphics)&&(t.tint=ee(t.tint,.8)),this.bitParams.set(t,{start:new Zi.I(t.position.x,t.position.y),duration:(0,wt.YR)(.4,.8),timeLeft:(0,wt.YR)(.2,.4),angle:(0,wt.YR)(0,2*Math.PI),speed:(0,wt.XU)(50,100),rotationSpeed:(0,wt.YR)(4*-Math.PI,4*Math.PI)});return e}tearDown(){super.tearDown(),this.bitParams.clear()}postBind(){super.postBind(),this.knightTrait=this.entity.traitOfType(ko),this.walkerTrait=this.entity.traitOfType(Ws),this.waterAffectedTrait=this.entity.traitOfType(Us),this.inventoryTrait=this.entity.traitOfType(mn),this.dasherTrait=this.entity.traitOfType(Lr),this.staggerableTrait=this.entity.traitOfType(Qs),this.bruteTrait=this.entity.traitOfType(Br),this.horseRiderTrait=this.entity.traitOfType(to),this.controllableTrait=this.entity.traitOfType(Rs),this.bloodEmitter=this.worldViewController.particles.square.emitter(((t,e)=>{t.x=e.position.x+(0,wt.XU)(-5,5),t.y=e.position.y+(0,wt.XU)(-5,5),t.color=9764864;const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(5,10);t.deltaX=Math.cos(i)*s,t.deltaY=Math.sin(i)*s,t.duration=(0,wt.YR)(.8,1.5),t.rotation=Math.PI/4,t.size=(0,wt.XU)(2,5),t.deltaSize=0,t.layerId=this.layerId})).continuous(1/30,this.reusableBloodParams)}updateView(t,e){e*=this.worldViewController.world.entityTimeFactorProvider(this.entity);const{age:i}=this;if(t.visible=this.age<2||this.age%.2/.2<.5,t.visible)for(const s of t.children){const t=this.bitParams.get(s),{angle:n,rotationSpeed:a,speed:r,start:o,duration:h}=t,l=i/h;l>1||(s.position.set(gt(o.x,o.x+Math.cos(n)*r*h,l,Bu.easeOutQuint),gt(o.y,o.y+Math.sin(n)*r*h,l,Bu.easeOutQuint)),s.rotation=gt(0,a*h,l,Bu.easeOutQuint),this.reusableBloodParams.position=s,this.bloodEmitter.cycle(e))}}async removeEmitter(){return this.whenAgeIs(3)}}class sy extends f.Graphics{constructor(t,e){super(),this.texturePool=t,this.toolPools=e,this.points=[],this.knightView=new Ga(this.texturePool,this.toolPools),this.reset()}reset(){return this.points=[],this.clear(),this}add(t){this.clear(),this.points.push({x:t.x,y:t.y}),this.lineStyle({width:30,color:16777215,join:f.LINE_JOIN.ROUND});for(let t=0;t<this.points.length;t++)t?this.lineTo(this.points[t].x,this.points[t].y):this.moveTo(this.points[t].x,this.points[t].y)}}class ny extends Lu.b{static pool(t,e){return Vu(ny,(()=>new sy(t,e)))}constructor(t){super(),this.viewPool=t,this.layerId=vd.DEBUG_FOREGROUND,this.reusableOut=new f.Point,this.startedStriking=!1,this.doneStriking=!1}createView(){var t;const e=this.viewPool.take().reset();if(this.entity.traitOfType(ln)){const i=Et((null===(t=this.comboTrackerTrait)||void 0===t?void 0:t.combo)||0)>1;e.tint=this.entityEvent.heavy?16711680:i?16744448:16777215}else e.tint=this.entityEvent.heavy?16711680:16777215;return e}postBind(){super.postBind(),this.knightTrait=this.entity.traitOfType(ko),this.controllableTrait=this.entity.traitOfType(Rs),this.inventoryTrait=this.entity.traitOfType(mn),this.walkerTrait=this.entity.traitOfType(Ws),this.dasherTrait=this.entity.traitOfType(Lr),this.bruteTrait=this.entity.traitOfType(Br),this.staggerableTrait=this.entity.traitOfType(Qs),this.comboTrackerTrait=this.entity.traitOfType(fn),this.horseRiderTrait=this.entity.traitOfType(to),this.waterAffectedTrait=this.entity.traitOfType(Us),this.doneStriking=!1,this.startedStriking=!1}update(){super.update(),this.startedStriking=this.startedStriking||this.knightTrait.stateMachine.currentState.striking,this.doneStriking=this.doneStriking||!this.knightTrait.stateMachine.currentState.striking&&this.startedStriking}updateView(t,e){Wd(t.knightView,this.controllableTrait,this.knightTrait,this.walkerTrait,null,this.waterAffectedTrait,this.inventoryTrait,this.dasherTrait,this.staggerableTrait,this.bruteTrait,this.horseRiderTrait),t.knightView.toolCenterPosition(this.reusableOut),this.startedStriking&&!this.doneStriking&&t.add(this.reusableOut),t.position.set(this.entity.position.x,this.entity.position.y),t.alpha=gt(0,1,(.2-this.age)/.05),t.scale.x=Math.sign(this.controllableTrait.inputs.aim.x-this.entity.position.x)||1}async removeEmitter(){return this.whenAgeIs(.2)}}class ay extends f.Graphics{constructor(){super(),this.beginFill(16777215);for(let t=0;t<=1;t+=.025){const e=t*Math.PI*2,i=(0,wt.XU)(140,200);0===t?this.moveTo(Math.cos(e)*i,Math.sin(e)*i):this.lineTo(Math.cos(e)*i,Math.sin(e)*i)}this.endFill()}}class ry extends Lu.b{constructor(){super(...arguments),this.layerId=vd.HUD_UI,this.position=new Zi.I}postBind(){super.postBind(),this.position.x=this.entity.position.x,this.position.y=this.entity.position.y-30}createView(){return new ay}updateView(t,e){t.position.set(this.position.x,this.position.y);const i=this.age/1;t.alpha=1-i,t.scale.set(i,i),t.rotation=(0,wt.YR)(0,2*Math.PI)}async removeEmitter(){return this.whenAgeIs(1)}}class oy extends Lu.b{constructor(){super(...arguments),this.layerId=vd.PARTICLES}createView(){return null}update(){super.update();const t={x:this.entity.position.x,y:this.entity.position.y-30};for(let e=0;e<50;e++)this.emitter.emit(t)}updateView(t,e){}postBind(){super.postBind(),this.emitter=this.worldViewController.particles.square.emitter(((t,e)=>{const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(0,30),n=s+(0,wt.XU)(0,10);t.x=e.x+Math.cos(i)*s,t.y=e.y+Math.sin(i)*s,t.color=16777215,t.deltaX=Math.cos(i)*n,t.deltaY=Math.sin(i)*n,t.duration=(0,wt.YR)(.3,1),t.rotation=Math.PI/4,t.size=(0,wt.XU)(10,20),t.deltaSize=-t.size/2,t.layerId=this.layerId}))}async removeEmitter(){}}class hy extends Lu.b{constructor(t){super(),this.viewPool=t,this.layerId=vd.HUD_UI,this.position=new Zi.I}postBind(){super.postBind(),this.position.x=this.entity.position.x,this.position.y=this.entity.position.y-60}tearDown(){super.tearDown(),this.label=null,this.color=0,this.duration=1,this.collapseGroup=null}for(t,e,i=3,s=null){return this.label=t,this.color=e,this.duration=i,this.collapseGroup=s,this}createView(){const t=this.viewPool.take();return t.text=this.label,t.style.fill=this.color,t}updateView(t,e){t.position.set(this.position.x,this.position.y+gt(0,-20,this.age/this.duration));const i=this.duration/3;t.alpha=(0,ft.Tq)(0,(this.duration-this.age)/i,1)}async removeEmitter(){return this.whenAgeIs(this.duration)}}class ly extends f.Graphics{update(t,e){this.clear(),this.lineStyle({color:16777215,width:6}),this.moveTo(0,0);for(let i=.1;i<1;i+=.1){const s=gt(t.x,e.x,i)-t.x,n=gt(t.y,e.y,i)-t.y;this.lineTo(s+(0,wt.XU)(-20,20),n+(0,wt.XU)(-20,20))}this.lineTo(e.x-t.x,e.y-t.y)}}class cy extends wp.G{constructor(){super(...arguments),this.layerId=vd.WORLD,this.lastRegen=0,this.reusableDestination=new Zi.I,this.reusableSource=new Zi.I}postBind(){super.postBind(),this.lastRegen=0}createView(){return new ly}updateView(t,e){if(t.position.x=this.event.position.x,t.position.y=this.event.position.y,this.reusableSource.x=0,this.reusableSource.y=0,this.event.source)this.reusableDestination.x=this.event.source.x-this.event.position.x,this.reusableDestination.y=this.event.source.y-this.event.position.y;else{const{visibleRectangle:t}=this.camera;this.reusableDestination.x=0,this.reusableDestination.y=t.minY-50-this.event.position.y}this.visibleAge-this.lastRegen<1/30||(this.lastRegen=this.visibleAge,t.update(this.reusableSource,this.reusableDestination))}removeEmitter(){return this.whenAgeIs(.3)}}class dy extends Lu.b{constructor(){super(...arguments),this.layerId=vd.BACKGROUND_FILL}createView(){const t=new f.Sprite(f.Texture.WHITE);return t.alpha=.3,t}updateView(t){const{visibleRectangle:e}=this.camera;t.position.set(e.x,e.y),t.width=e.width,t.height=e.height,t.visible=this.entity.age%.2<.1}removeEmitter(){return this.whenAgeIs(.3)}}class uy extends Lu.b{constructor(){super(...arguments),this.layerId=vd.UNDER_WORLD_UI,this.reusableBloodParams={position:null},this.bitParams=new Map}createView(){const t=new Jd;qd(t,this.walkerTrait,null,this.waterAffectedTrait,this.staggerableTrait);const e=ey(t);for(const t of e.children)t.position.x+=this.entity.position.x,t.position.y+=this.entity.position.y,(t instanceof f.Sprite||t instanceof f.Graphics)&&(t.tint=ee(t.tint,.8)),this.bitParams.set(t,{timeLeft:(0,wt.YR)(.2,.4),angle:(0,wt.YR)(0,2*Math.PI),speed:(0,wt.XU)(150,250),rotationSpeed:(0,wt.YR)(2*-Math.PI,2*Math.PI)});return e}tearDown(){super.tearDown(),this.bitParams.clear()}postBind(){super.postBind(),this.walkerTrait=this.entity.traitOfType(Ws),this.waterAffectedTrait=this.entity.traitOfType(Us),this.staggerableTrait=this.entity.traitOfType(Qs),this.bloodEmitter=this.worldViewController.particles.square.emitter(((t,e)=>{t.x=e.position.x+(0,wt.XU)(-5,5),t.y=e.position.y+(0,wt.XU)(-5,5),t.color=9764864;const i=(0,wt.YR)(0,2*Math.PI),s=(0,wt.XU)(5,10);t.deltaX=Math.cos(i)*s,t.deltaY=Math.sin(i)*s,t.duration=(0,wt.YR)(.8,1.5),t.rotation=Math.PI/4,t.size=(0,wt.XU)(2,5),t.deltaSize=0,t.layerId=this.layerId})).continuous(1/30,this.reusableBloodParams)}updateView(t,e){if(e*=this.worldViewController.world.entityTimeFactorProvider(this.entity),t.visible=this.age<2||this.age%.2/.2<.5,t.visible)for(const i of t.children){const t=this.bitParams.get(i),{angle:s,rotationSpeed:n,speed:a,timeLeft:r}=t;r<=0||(i.position.x+=Math.cos(s)*e*a,i.position.y+=Math.sin(s)*e*a,i.rotation+=e*n,t.timeLeft-=e,this.reusableBloodParams.position=i,this.bloodEmitter.cycle(e))}}async removeEmitter(){return this.whenAgeIs(3)}}class py{constructor(t,e){this.texturePool=t,this.pools=e,this.inGameLabelPool=new ga.w((()=>new Nm)),this.thunderClapPool=new ga.w((()=>new cy)),this.thunderFlashPool=new ga.w((()=>new dy)),this.meleeAttack=ny.pool(this.texturePool,this.pools.tools),this.attackBlocked=zm.pool(),this.heavyAttackedCharged=ty.pool(),this.slowLabelPool=new ga.w((()=>new hy(this.inGameLabelPool)))}viewControllersForEvent(t,e){const i=[];return t instanceof Ii.y&&(t.event instanceof sn&&t.entity.traitOfType(ko)&&i.push(...this.meleeAttack.create()),(t.event instanceof Gs||t.event instanceof Wi)&&i.push(...this.attackBlocked.create()),t.event instanceof Dr&&i.push(...this.heavyAttackedCharged.create()),t.event instanceof Vi&&(t.entity.traitOfType(ko)&&i.push(new iy(this.pools.knight.viewPool)),t.entity.traitOfType($h)&&i.push(new uy),i.push(new $m),t.entity.traitOfType(ln)||i.push(this.slowLabelPool.take().for("SLAIN!",16777215))),t.event instanceof ps&&(i.push(new jm),i.push(new qm(this.inGameLabelPool))),t.event instanceof Fi&&t.entity.traitOfType(ln)&&i.push(new Wm(this.pools.knight.viewPool)),t.event instanceof $i&&t.entity.traitOfType(dn)&&i.push(this.pools.coinPickup.take()),t.event instanceof nl&&i.push(new oy),t.event instanceof gn&&i.push(this.slowLabelPool.take().for("COMBO\nRESET",16777215,3,t.entity.id)),t.event instanceof eo&&i.push(this.slowLabelPool.take().for("DEFENSE\nBROKEN",16777215,3,t.entity.id)),t.event instanceof Wi&&(t.event.isPerfect&&i.push(new ry),i.push(this.slowLabelPool.take().for(t.event.isPerfect?"PERFECT\nPARRY":"PARRIED",16777215,3,t.entity.id))),t.event instanceof Ks&&t.entity.traitOfType(ln)&&i.push(this.slowLabelPool.take().for("EXHAUSTED",16777215,3,t.entity.id)),t.event instanceof wc&&i.push(this.thunderFlashPool.take()),t.event instanceof Or&&i.push(this.slowLabelPool.take().for("FIRE!",16711680,3,t.entity.id)),t.event instanceof Ui&&i.push(this.slowLabelPool.take().for(t.event.statKey+"\n+10",65280,2)),t.event instanceof ys&&(t.entity.traitOfType(ln)||i.push(this.slowLabelPool.take().for("HEAL",65280)),i.push(new Jm))),t instanceof ts&&i.push(this.thunderClapPool.take()),t instanceof Pl&&i.push(new Ym(this.texturePool)),i}}var my=i(3338);class yy extends f.Filter{constructor(t=1){super("\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n}\n","\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float uAlpha;\n\nvoid main(void)\n{\n   gl_FragColor = vec4(0.0, 0.0, 0.0, texture2D(uSampler, vTextureCoord).a * uAlpha);\n}\n"),this.alpha=t}get alpha(){return this.uniforms.uAlpha}set alpha(t){this.uniforms.uAlpha=t}}var wy=i(5974);class gy extends wy.Particle{constructor(t){super(),this.layerProvider=t,this.options=new wy.ParticleOptions2D}install(){var t;const e=this.layerProvider(this.options.layerId),i=this.getOrCreateView();i.visible=!0,i.parent!==e&&(null===(t=i.parent)||void 0===t||t.removeChild(i),e.addChild(i))}uninstall(){var t;const{view:e}=this;e&&(e.visible=!1),null===(t=this.pool)||void 0===t||t.give(this)}updateView(t){t.position.x=this.interpolated(this.options.x,this.options.deltaX,this.options.easingX),t.position.y=this.interpolated(this.options.y,this.options.deltaY,this.options.easingY),t.rotation=this.interpolated(this.options.rotation,this.options.deltaRotation,Bu.linear),t.alpha=this.interpolated(this.options.alpha,this.options.deltaAlpha,Bu.linear)}}class fy extends gy{constructor(t,e){super(e),this.texture=t}createView(){const t=new f.Sprite(this.texture);return t.anchor.set(.5,.5),t}updateView(t){super.updateView(t),t.tint=this.options.color;const e=this.interpolated(this.options.size,this.options.deltaSize,Bu.linear);t.width=e,t.height=e}}class vy extends wy.ParticlesManager{constructor(t,e,i){super(),this.texturePool=t,this.layerProvider=e,this.isVisible=i,this.particlesFactor=1,this.circle=this.add(new wy.ParticleEmitterProvider((()=>new fy(this.texturePool.catalog.particles.circle,(t=>this.layerProvider(t)))),(()=>new wy.ParticleOptions2D),(t=>this.isVisible(t)&&Math.random()<this.particlesFactor))),this.square=this.add(new wy.ParticleEmitterProvider((()=>new fy(f.Texture.WHITE,(t=>this.layerProvider(t)))),(()=>new wy.ParticleOptions2D),(t=>this.isVisible(t)&&Math.random()<this.particlesFactor))),this.cross=this.add(new wy.ParticleEmitterProvider((()=>new fy(this.texturePool.catalog.particles.cross,(t=>this.layerProvider(t)))),(()=>new wy.ParticleOptions2D),(t=>this.isVisible(t)&&Math.random()<this.particlesFactor)))}}class by extends f.Container{sortStep(){for(let t=0;t<this.children.length;t++){const e=this.getChildAt(t);if(!e.visible||e.alpha<=0)continue;const i=~~(e.position.y/2);i!==e.zIndex&&(e.zIndex=i)}}}class Ty extends my.U{constructor(t){super(t),this.shadowsFilter=new yy(.2),this.outlinesFilter=new Kd.f(2,0,2,.5,!0),this.filterArea=new f.Rectangle,this.particles=new vy(t.texturePool,(t=>this.provideLayer(t)),(t=>this.camera.isVisible(t,0)));const e=this.provideLayer(vd.SHADOWS);e.filterArea=this.filterArea,hm(e,this.shadowsFilter);const i=this.provideLayer(vd.OBSCURED_OUTLINES);ct(),i.visible=!1,this.provideLayer(vd.WORLD).sortableChildren=!0}createLayer(t){return t===vd.WORLD?new by:super.createLayer(t)}update(t){super.update(t),this.particles.update(t);const{camera:e}=this;this.filterArea.x=0,this.filterArea.y=0,this.filterArea.width=e.width*e.zoom,this.filterArea.height=e.height*e.zoom,this.shadowsFilter.resolution=t>1/30?.5:1,this.outlinesFilter.resolution=t>1/30?.5:1,this.provideLayer(vd.WORLD).sortStep()}get viewsAffectedByFilters(){return this.provideLayer(vd.WORLD)}}class ky{constructor(){this.root=(()=>{const t=document.createElement("div");return t.innerHTML='<div class="instruction-screen">\n            <div class="instruction-filler"></div>\n            <div class="instruction-label"></div>\n        </div>',t.firstChild})(),this.label=this.root.querySelector(".instruction-label")}}class xy extends Bn{constructor(){super(...arguments),this.id="instruction",this.currentInstruction=new bc.u}setup(){super.setup(),this.instructionView=new ky,this.view.appendChild(this.instructionView.root)}cycle(t){if(super.cycle(t),!this.world)return;let e;for(const t of this.world.traitsOfType(Ts))if(!(!t.enabled||t.entity.age<.1||t.entity.traitOfType(Hl))){e=t;break}const i=null==e?void 0:e.message;var s;this.currentInstruction.requiresUpdate(i)&&(this.instructionView.root.style.visibility=i?"visible":"hidden",i&&(console.log("Instruction: "+i),this.instructionView.label.innerHTML=this.game.strings.htmlMessage(i),(s=this.instructionView.label).style.animation="none",s.offsetHeight,s.style.animation=null)),(null==e?void 0:e.resolved)?this.instructionView.root.classList.add("resolved"):this.instructionView.root.classList.remove("resolved"),(null==e?void 0:e.failed)?this.instructionView.root.classList.add("failed"):this.instructionView.root.classList.remove("failed")}}class Cy extends _n{get world(){return this.level.world}constructor(t){super(),this.level=t,this.readyToPlayAudio=new ju.t(!1),this.cursorType="none",this.controlHighlightChange=new bc.u,this.touchAnimationTimeline=null,this.lastMouseInteraction=-99,this.pointerLockChangeListener=(()=>{let t=!1;return()=>{const e=t;if(t=!!document.pointerLockElement,e&&!t&&this.isForeground&&this.onPause(),t&&!e){const{position:t}=this.inputs.mouse;0===t.x&&0===t.y&&(t.x=this.width/2,t.y=this.height/2)}}})(),this.instructionScreen=new xy,this.mobileControlsCursor=ct()?null:new Ed,this.level.mobile=ct(),this.addSubscreen(this.instructionScreen)}get needsMobileControls(){return!1}entityViewControllerFactory(t){const e=new Td.u([new _m(this.texturePool,this.factoryPools),new Dm(this.texturePool,this.factoryPools),new Lm(this.texturePool,this.factoryPools),new Vm(this.texturePool,this.factoryPools),new Bm(this.texturePool,this.factoryPools),new Hm(this.texturePool,this.factoryPools),this.game.params.debug?new Fm(this.texturePool):null].filter((t=>!!t)));return this.game.params.showBounds?new kd.T(e):e}eventViewControllerFactory(t){return new py(this.texturePool,this.factoryPools)}soundEffectControllerFactory(t){return new dp(this.game.soundPool)}setup(){super.setup(),window.addEventListener("pointerlockchange",this.pointerLockChangeListener),this.factoryPools=new Fu(this.texturePool),this.inputs.gamepad.onButtonDown=t=>{const{keyBindings:e}=this.game;(0,kn.gamepadButtonMatches)(t,e.binding("pause"))&&this.onPause()},this.inputs.gamepad.onButtonDown=t=>{const{keyBindings:e}=this.game;(0,kn.gamepadButtonMatches)(t,e.binding("inventory"))&&this.onInventory()},this.view.addChild(this.worldContainer=new f.Container),this.level.bind(new Nu(this.game.achievements.achievements,this.game.achievements,this.game.achievements)),this.level.postBind(),this.worldViewController=this.createWorldViewController(this.world),this.worldContainer.addChild(this.worldViewController.view),this.worldSoundController=new mp({world:this.world,soundEffectControllerFactory:this.soundEffectControllerFactory(this.world),soundPool:this.game.soundPool});const t=new ju.t(Mi.GAMEPLAY);this.worldSoundController.onSoundtrackTypeChange=e=>{t.next(e)},this.worldSoundController.setVolume(1),this.readyToPlayAudio.pipe((0,ud.p)((t=>t)),(0,$u.F)(),(0,Ju.n)((()=>t)),(0,$u.F)()).subscribe((t=>{this.game.plugin(w.p).soundtrack.start(t)})),this.worldViewController.start(),this.world.cyclePerformanceTracker=new bd.h,this.world.events.pipe((0,ud.p)((t=>t instanceof hl))).subscribe((t=>{this.game.pokiBridge.gameplayStop(),this.navigator.commercialBreak()})),this.world.events.pipe((0,ud.p)((t=>t instanceof hs))).subscribe((t=>this.onLevelEnd(t.outcome))),this.world.events.pipe((0,ud.p)((t=>t instanceof Ii.y&&t.event instanceof Vi&&!!t.entity.traitOfType(ln)))).subscribe((t=>{const e=new Td.u([new Vm(this.texturePool,this.factoryPools),new Bm(this.texturePool,this.factoryPools)]),i=new vp(e,this.eventViewControllerFactory(this.world));i.bind(this.worldViewController,this.interpolationPool,t),i.postBind(),this.worldViewController.addViewController(i)})),this.world.events.pipe((0,ud.p)((t=>t instanceof Ii.y&&t.event instanceof Ni))).subscribe((async t=>{const{resolve:e,baseStats:i}=t.event,s=await this.navigator.upgradeStat(i);await this.navigator.commercialBreak(),e(s)})),this.world.events.pipe((0,ud.p)((t=>t instanceof Ii.y&&t.event instanceof wr))).subscribe((async t=>{const e=t.event,i=e.player.traitOfType(hn),s=e.player.traitOfType(mn),n=await this.navigator.merchant(e.shop,i.baseStats,s.inventory.clone());await this.navigator.commercialBreak(),e.resolve(n)})),this.level.world.entities.add((0,qi.EG)([new us((async()=>(await new Promise((t=>setTimeout(t,4e3))),await this.navigator.confirmRevive())))])),this.level.world.entities.add((0,qi.EG)([new il((async t=>await this.navigator.confirmChallenge(t)))])),this.level.world.entities.add((0,qi.EG)([new sl((async t=>{const e=(0,wt.F5)(qu);return e.configuration=t,new Promise((t=>{this.animateOut().append((async()=>{const i=await this.navigator.challenge(e);t(i===is.COMPLETED)})).append(this.animateIn()).run(this.interpolationPool)}))}))])),this.animateIn().run(this.interpolationPool),this.level.triggerStart(),this.instructionScreen.world=this.level.world,this.mobileControls=new lp(this.texturePool),this.mobileControls.setup(),this.mobileControls.pauseButton.onClick.listen((()=>this.onPause())),this.mobileControls.inventoryButton.onClick.listen((()=>this.onInventory())),this.mobileControls.interactButton.onClick.listen((()=>{var t,e;null===(e=null===(t=this.level.player)||void 0===t?void 0:t.traitOfType(vr))||void 0===e||e.interact()})),this.mobileControlsRenderer=new xd.z(this.mobileControls,!ct()),this.mobileControlsRenderer.setResolution(window.devicePixelRatio),this.mobileControlsRenderer.setup(),document.body.appendChild(this.mobileControlsRenderer.view),this.mobileControlsCursor&&this.mobileControls.stage.addChild(this.mobileControlsCursor)}createWorldViewController(t){return new Ty({world:t,texturePool:this.texturePool,renderer:this.game.plugin(m.W).renderer,interpolationPool:this.interpolationPool,eventViewControllerFactory:this.eventViewControllerFactory(t),entityViewControllerFactory:this.entityViewControllerFactory(t),layers:Object.values(vd)})}get controllableTrait(){const{player:t}=this.level;return t?t.traitOfType(Rs):null}get camera(){return this.worldViewController.camera}cycle(t){var e;super.cycle(t),this.readyToPlayAudio.next(this.game.plugin(w.p).isReadyToPlayAudio),Oi(this.world.traitsOfType(nc)).inFocus=this.isForeground,this.worldSoundController.setRate(this.timeFactor),this.updateControls(),this.game.plugin(p.PerformanceGamePlugin).gameStats.begin("GAME_LOOP","yellow"),this.level.cycleSafe(t),this.game.plugin(p.PerformanceGamePlugin).gameStats.end("GAME_LOOP"),this.game.plugin(p.PerformanceGamePlugin).gameStats.begin("UPDATE_VIEWS","red"),this.updateWorldViewController(this.worldViewController,t,this.width,this.height),this.game.plugin(p.PerformanceGamePlugin).gameStats.end("UPDATE_VIEWS"),this.worldSoundController.update(t),null===(e=this.mobileControlsRenderer)||void 0===e||e.render();const{player:i}=this.level;if(i&&this.isForeground){const{inputs:t}=i.traitOfType(Rs);(t.movement.force>0||t.lightStrike||t.heavyStrike||t.dash||t.shield)&&this.game.pokiBridge.gameplayStart()}else this.game.pokiBridge.gameplayStop()}updateWorldViewController(t,e,i,s){const{camera:n}=t;n.width=i,n.height=s;const{visibleRectangle:a}=n;t.update(e);const r=n.zoom,o=r-n.zoom;t.view.parent.position.set(-a.x*r-o*a.width/2,-a.y*r-o*a.height/2),t.view.parent.scale.set(r,r),t.provideLayer(vd.HUD_INDICATORS).visible=this.isForeground,t.provideLayer(vd.HUD_UI).visible=this.isForeground,t.provideLayer(vd.OVER_HUD_UI).visible=this.isForeground}updateControls(){var t,e,i,s,n;const{player:a}=this.level;this.mobileControls&&(this.mobileControls.inventoryButton.enabled=!!a,this.mobileControls.joystick.enabled=!!a,this.mobileControls.attackButton.enabled=!!a,this.mobileControls.dashButton.enabled=!!a,this.mobileControls.shieldButton.enabled=!!a,this.mobileControls.interactButton.enabled=(null===(e=null===(t=null==a?void 0:a.traitOfType(vr))||void 0===t?void 0:t.currentInteractables)||void 0===e?void 0:e.size)>0),a&&this.updateControlsFor(this.level.player),this.updateControlHighlight(null==a?void 0:a.traitOfType(Rs));const r=!((null===(s=null===(i=this.mobileControlsRenderer)||void 0===i?void 0:i.mouseHandler)||void 0===s?void 0:s.hoveringControl)&&!document.pointerLockElement||(null===(n=null==a?void 0:a.traitOfType(Rs))||void 0===n?void 0:n.aimMode)!==Is.INDEPENDENT);this.mobileControlsCursor&&this.mobileControlsCursor.visible!==r&&(this.mobileControlsCursor.visible=r,this.mobileControlsRenderer.setNeedsRerender())}updateControlsFor(t){var e,i;const s=t.traitOfType(Rs),{inputs:n}=this,{keyBindings:a}=this.game;s.aimMode=this.age-this.lastMouseInteraction<2?Is.INDEPENDENT:Is.MOVEMENT_BASED;let r=0,o=0;(0,kn.isDown)(this.inputs,a.binding("left"))&&(r=-1),(0,kn.isDown)(this.inputs,a.binding("right"))&&(r=1),(0,kn.isDown)(this.inputs,a.binding("up"))&&(o=-1),(0,kn.isDown)(this.inputs,a.binding("down"))&&(o=1),s.inputs.movement.force=0!==r||0!==o?1:0;const[h,l]=n.gamepad.leftJoystick();this.inputs.gamepad.isActive&&Math.abs(l)>.2&&(r=Math.cos(h),o=Math.sin(h),s.inputs.movement.force=l*Math.abs(Math.cos(h))),s.inputs.movement.force&&(s.inputs.movement.angle=Math.atan2(o,r)||0),s.inputs.dash=(0,kn.isDown)(this.inputs,a.binding("dash")),s.inputs.shield=(0,kn.isDown)(this.inputs,a.binding("shield")),s.inputs.lightStrike=(0,kn.isDown)(this.inputs,a.binding("tool"))&&!(null===(i=null===(e=this.mobileControlsRenderer)||void 0===e?void 0:e.mouseHandler)||void 0===i?void 0:i.hoveringControl),s.inputs.heavyStrike=s.inputs.lightStrike,s.inputs.interact=(0,kn.isDown)(this.inputs,a.binding("interact"));const c=(this.inputs.mouse.position.x-this.game.params.width/2)/(this.game.params.width/2),d=(this.inputs.mouse.position.y-this.game.params.height/2)/(this.game.params.height/2),u=this.game.params.width/this.camera.zoom/2,p=this.game.params.height/this.camera.zoom/2,m=this.camera.entity.traitOfType(dd.F).offset;s.inputs.aim.x=s.entity.position.x+c*u+m.x,s.inputs.aim.y=s.entity.position.y+d*p+m.y,s.inputs.mouse.x=this.camera.entity.position.x+c*u,s.inputs.mouse.y=this.camera.entity.position.y+d*p,this.mobileControls&&ct()&&(s.inputs.aim.x=t.position.x+100*Math.cos(this.mobileControls.joystick.angle),s.inputs.aim.y=t.position.y+100*Math.sin(this.mobileControls.joystick.angle),s.inputs.movement.angle=this.mobileControls.joystick.angle,s.inputs.movement.force=this.mobileControls.joystick.force,s.inputs.dash=this.mobileControls.dashButton.isDown,s.inputs.lightStrike=this.mobileControls.attackButton.isDown,s.inputs.heavyStrike=this.mobileControls.attackButton.isDown,s.inputs.shield=this.mobileControls.shieldButton.isDown)}get absorbCycle(){return!0}get absorbInputs(){return!0}onInventory(){const{player:t}=this.level,e=null==t?void 0:t.traitOfType(mn),i=null==t?void 0:t.traitOfType(hn);e&&i&&(0,Za.n)((async()=>{const t=await this.navigator.inventory(i.baseStats,e.inventory.clone());await this.navigator.commercialBreak(),e.inventory=t}))}animateIn(){const t=new yp(this.width,this.height);return this.view.addChild(t.view),t.animateIn()}animateOut(){const t=new yp(this.width,this.height);return this.view.addChild(t.view),t.animateOut()}onLevelEnd(t){this.saveProgression()}keyDown(t){super.keyDown(t);const{keyBindings:e}=this.game;(0,kn.keyCodeMatches)(t,e.binding("pause"))&&this.onPause(),(0,kn.keyCodeMatches)(t,e.binding("inventory"))&&this.onInventory()}addDebugValues(t){super.addDebugValues(t);const{player:e}=this.level;e&&(t.Player=`${~~e.x},${~~e.y}`);const i=this.worldViewController;t.Entities=`${this.world.entities.size}/${this.world.chunked.entities.size}`,t["View controllers"]=`${i.viewControllerCount}/${i.visibleViewControllerCount}/${i.viewControllerWithViewCount}`}foreground(){super.foreground(),this.mobileControls&&(this.mobileControlsRenderer.visible=!0)}background(){super.background(),Oi(this.world.traitsOfType(nc)).inFocus=this.isForeground,this.updateWorldViewController(this.worldViewController,0,this.width,this.height),this.mobileControls&&(this.mobileControlsRenderer.visible=!1),document.exitPointerLock&&document.exitPointerLock(),this.saveProgression(),this.game.pokiBridge.gameplayStop()}destroy(){var t,e;this.worldSoundController.stop(),this.worldViewController.destroy(),null===(t=this.mobileControlsRenderer)||void 0===t||t.destroy(),this.mobileControlsRenderer=null,null===(e=this.mobileControls)||void 0===e||e.destroy(),this.mobileControls=null,window.removeEventListener("pointerlockchange",this.pointerLockChangeListener),super.destroy()}saveProgression(){this.game.progression.setProgression(this.level.progression)}onBackNavigation(){}updateControlHighlight(t){var e;if(!this.mobileControls||!ct())return;const i=null==t?void 0:t.highlight;if(this.controlHighlightChange.requiresUpdate(i)){null===(e=this.touchAnimationTimeline)||void 0===e||e.cancel(),this.touchAnimationTimeline=null,this.mobileControls.touchAnimation.removeFromParent(),this.mobileControls.highlightAnimation.removeFromParent();for(const t of[this.mobileControls.attackButton,this.mobileControls.shieldButton,this.mobileControls.dashButton])t.view.alpha=1;if(i)if(i===Ps.MOVEMENT){const t=()=>{var e,i,s;this.touchAnimationTimeline=null===(s=null===(i=null===(e=this.mobileControls.animateTouch())||void 0===e?void 0:e.wait(1))||void 0===i?void 0:i.append(t))||void 0===s?void 0:s.run(this.interpolationPool)};t()}else{const{highlight:e}=t;let i,s=0,n=0,a=3;switch(e){case Ps.DASH:i=this.mobileControls.dashButton,a=1,n=1,s=0;break;case Ps.DOUBLE_DASH:i=this.mobileControls.dashButton,a=2,n=1,s=0;break;case Ps.ATTACK:i=this.mobileControls.attackButton,a=3,n=1,s=0;break;case Ps.ATTACK_CHARGED:i=this.mobileControls.attackButton,a=1,n=1,s=1;break;case Ps.SHIELD:i=this.mobileControls.shieldButton,a=1,n=1,s=1}for(const t of[this.mobileControls.attackButton,this.mobileControls.shieldButton,this.mobileControls.dashButton])t.view.alpha=t===i?1:.2;const r=()=>{var t,e;this.touchAnimationTimeline=null===(e=null===(t=this.mobileControls.highlight(i,s,n,a))||void 0===t?void 0:t.append(r))||void 0===e?void 0:e.run(this.interpolationPool)};r()}}}mouseDown(t,e,i){var s;super.mouseDown(t,e,i),this.lastMouseInteraction=this.age,!ct()&&document.pointerLockElement,document.pointerLockElement&&(this.mobileControls.updateTouches([this.xyToTouch(e,i)]),null===(s=this.mobileControlsRenderer.mouseHandler)||void 0===s||s.hoveringControl)}mouseMove(t,e,i,s){var n,a;super.mouseMove(t,e,i,s),this.lastMouseInteraction=this.age;const r=this.xyToTouch(t,e);document.pointerLockElement&&this.inputs.mouse.isDown(kn.MouseButton.RIGHT_BUTTON)&&this.mobileControls.updateTouches([r]),this.mobileControlsCursor&&(document.pointerLockElement&&(null===(a=null===(n=this.mobileControlsRenderer)||void 0===n?void 0:n.mouseHandler)||void 0===a||a.updateHoverState(r.position)),this.mobileControlsCursor.position.copyFrom(r.position),this.mobileControlsRenderer.setNeedsRerender())}mouseUp(t,e,i){super.mouseUp(t,e,i),this.lastMouseInteraction=this.age,document.pointerLockElement&&this.mobileControls.updateTouches([])}xyToTouch(t,e){const i=this.game.plugin(m.W).renderer.view.getBoundingClientRect(),s=t/this.width,n=e/this.height,a=i.x+s*i.width,r=i.y+n*i.height;return{identifier:0,position:new Zi.I(a,r),claimedBy:null}}}class Ey extends Cy{constructor(t){super(new fd(function(t){const{waves:e,name:i}=t,s=t.levelId%hd()/(hd()-1),n=new El([new ml(16e3,1600),new Ml(t.environment),new Vl]),a=`merch-${t.levelId}`;let r;if(0===t.levelId){const t=new ki;t.add(ri),t.add(oe),t.add(Ve),t.add(Je),t.add(be),r=new El([new hc(2),new Kl("mvt",Er("tutorialMovement")),new tl("Path to Glory"),new ec(200),new hc(1),new Yl("mvt"),new tc,new vl(new bl([new rc(0),new gl(a,t,wl.NEAR_PLAYER),new Tl(a),new rc(500)]))])}else r=new bl([new tc,new El([new ac,new tl(i),new sc(1),new Il(s,s)]),new vl(new bl([new rc(0),new gl(a,null,wl.NEAR_PLAYER),new rc(500)]))]);const o=[];for(const t of e){let e;const i=`walk-${t.waveId}`;let s=500;0===t.waveId?e=new Kl(i,Er("tutorialFollowPath")):2===t.waveId&&(e=new vl(new El([new zl(Ps.DASH),new $l(i,Er("tutorialDash"),3),new zl(null),new Yl(i)])),s=1e3);const n=`fi-${t.waveId}`;let a;0===t.waveId?a=new vl(new El([new zl(Ps.ATTACK),new Jl(n,Er("tutorialLightStrike"),5),new zl(null),new Yl(n)])):5===t.waveId?a=new vl(new El([new zl(Ps.ATTACK_CHARGED),new Zl(n,Er("tutorialHeavyStrike"),3),new zl(null),new Yl(n)])):3===t.waveId&&(a=new vl(new El([new zl(Ps.SHIELD),new Ql(n,Er("tutorialShield"),3),new zl(null),new Yl(n)])));const r=t.composition.hasKing(),h=r?new Yc:new ic,l=r?new El([new oc(pt("kingSlain")),new ul]):new oc(pt("waveCleared"));o.push(new El([new Gl(new bl([e,new rc(s),new Sl].filter((t=>!!t)))),new zl(null),new Cl,new ql(i),new bl([a,new El([new dl(t),h])].filter((t=>!!t))),new ql(n),new zl(null),l]))}if(t.levelId>0){const t=(0,wt.XU)(0,e.length-1);o.splice(t,0,new Gl(new bl([new rc,new rl({waveComposition:(0,wt.F5)(e).composition}),new rc])))}const h=new El(o),l=(t.levelId+1)%hd()/(hd()-1),c=od(t.levelId+1).season,d=new Gl(new El([new bl([new Xl(c),new Il(s,l)]),new sc(2),new ul]));return new El([n,r,h,d])}(od(t)))),this.levelIndex=t,this.id="gameplay"}setup(){this.level.progression=this.game.progression.progression,super.setup()}async onLevelEnd(t){t===is.COMPLETED&&this.level.progression.levelIndex++,super.onLevelEnd(t),od(this.levelIndex).waves.some((t=>t.composition.hasKing()))&&await this.navigator.gameComplete(),this.animateOut().append((()=>this.resolver.resolve(t))).run(this.interpolationPool)}async onPause(){switch(await this.navigator.gameplayPause()){case tr.RESUME:return;case tr.INVENTORY:this.onInventory();break;case tr.MAIN_MENU:this.resolver.reject(new Sn.r("User exited to main menu"))}}}class Sy extends Xn{constructor(){super(...arguments),this.id="main-menu"}async rootComponent(){let t=0;const e=this.game.progression.progression.levelIndex>0,i=(0,Za.Z)((async()=>{await this.animateOut();const t=this.game.screenStack.findByType(Ey);t?this.game.screenStack.popTo(t,!1):await Pn({navigator:this.navigator,progressionRepository:this.progression})})),s=(0,Za.Z)((async()=>{if(e){if(!await this.navigator.confirm({title:pt("startANewGame?"),message:pt("yourProgressWillBeLost"),positiveButtonLabel:pt("yes"),positiveButtonActionType:$a.DESTRUCTIVE,negativeButtonLabel:pt("cancel"),negativeButtonActionType:$a.NEUTRAL}))return;await this.game.progression.clear(),await this.animateOut(),await Pn({navigator:this.navigator,progressionRepository:this.progression})}else i()})),a=(0,Za.Z)((async()=>{await this.animateOut();const t=this.game.screenStack.findByType(Ey);t&&this.game.screenStack.popTo(t,!0),await async function(t){const{navigator:e}=t;for(;;){await e.survivalLeaderboard();try{await e.survival()}catch(e){if(e instanceof Sn.r)return void Mn(t)}await e.commercialBreak()}}({navigator:this.navigator,progressionRepository:this.progression})})),r=(0,Za.Z)((async()=>{await this.navigator.settings()})),o=(0,Za.Z)((async()=>{await this.navigator.achievements()})),h=(0,Za.Z)((async()=>{await this.navigator.credits()}));return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,null,An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,null,"Path to Glory"))),An.default.createElement(Zn,null,e?An.default.createElement(n.MainButton,{onClick:i,tabIndex:t++},An.default.createElement("img",{src:aa}),pt("continue")):null,An.default.createElement(n.MainButton,{onClick:s,tabIndex:t++},An.default.createElement("img",{src:aa}),pt("newGame")),An.default.createElement(n.MainButton,{onClick:a,tabIndex:t++},An.default.createElement("img",{src:T}),pt("survival")),this.game.pokiBridge.isPoki?null:An.default.createElement(n.MainButton,{onClick:r,tabIndex:t++},pt("settings")),An.default.createElement(n.MainButton,{onClick:o,tabIndex:t++},An.default.createElement("img",{src:Qa}),pt("achievements")),An.default.createElement(n.MainButton,{onClick:h,tabIndex:t++},An.default.createElement("img",{src:mr}),pt("credits"))),An.default.createElement(qn,null)))}get absorbCycle(){return!1}async animateOut(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut())}}class My extends Error{}function Py(t){const{shopItem:e,baseStats:i,inventory:s,ownedItems:n,tabIndex:a,previewMaker:r,onClick:o}=t;return An.default.createElement("div",{key:e.item.id},An.default.createElement(lr,{baseStats:i.clone(),tabIndex:a,shopItem:e,inventory:s,owned:n.has(e.item.id),equipped:s.itemIds().has(e.item.id),previewMaker:r,onClick:o}))}function Iy(t){let e=0;const{baseStats:i,shop:s,previewMaker:a}=t,[r,o]=(0,Un.J0)(t.inventory),[h,l]=(0,Un.J0)(t.ownedItems),c=(0,Un.Kr)((()=>Array.from(s.items()).filter((t=>!t.rewardedBreak))),[s]),d=(0,Un.Kr)((()=>Array.from(s.items()).filter((t=>t.rewardedBreak))),[s]),u=async e=>{if(r.itemIds().has(e.item.id));else if(h.has(e.item.id)){const i=r.clone();i.equip(e.item),o(i),t.onInventoryChanged(i)}else try{await t.onPurchaseItem(e);const i=r.clone();i.equip(e.item),e.rewardedBreak||(i.money-=e.price),o(i),l(new Set(h).add(e.item.id)),t.onInventoryChanged(i)}catch(t){if(t instanceof Sn.r)return;if(t instanceof My)return;throw t}};return An.default.createElement(Kn,{isModal:!0},An.default.createElement(Yn,null,An.default.createElement(jn,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:t.onBackClicked,style:{backgroundImage:`url(${or})`,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"20px 20px",minWidth:"50px",minHeight:"50px"}})),An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},An.default.createElement("img",{src:it}),pt("shop"))),An.default.createElement(Jn,null,An.default.createElement(n.MediumLabel,null,An.default.createElement("img",{src:b,style:{height:"2em",verticalAlign:"middle",marginRight:n.Spacing.s}}),r.money.toLocaleString("en")))),An.default.createElement(Zn,null,An.default.createElement(n.ScrollableContent,{style:{flex:"1 0 0",padding:n.Spacing.m,background:"#111"}},An.default.createElement(cr,null,c.map((t=>An.default.createElement(Py,{shopItem:t,inventory:r,baseStats:i,ownedItems:h,tabIndex:e++,previewMaker:a,onClick:()=>u(t)})))),d.length?An.default.createElement(An.default.Fragment,null,An.default.createElement(n.MainTitle,null,pt("premiumItems")),An.default.createElement(cr,null,d.map((t=>An.default.createElement(Py,{shopItem:t,inventory:r,baseStats:i,ownedItems:h,tabIndex:e++,previewMaker:a,onClick:()=>u(t)}))))):null)))}class Ay extends Xn{constructor(t,e,i){super(),this.shop=t,this.baseStats=e,this.inventory=i,this.id="merchant"}async rootComponent(){const t=this.game.progression.progression.ownedItems;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Iy,{shop:this.shop,baseStats:this.baseStats.clone(),inventory:this.inventory,previewMaker:new za(this.texturePool,this.game.plugin(m.W).renderer),ownedItems:t,onPurchaseItem:async t=>this.purchase(t),onInventoryChanged:t=>{var e;null===(e=this.game.plugin(w.p))||void 0===e||e.playSoundEffect((0,wt.F5)(this.game.soundPool.equipArmor)),this.inventory=t},onBackClicked:()=>this.onBackKeyPressed()}))}async onBackKeyPressed(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve(this.inventory)}async purchase(t){var e;if(t.rewardedBreak){if(!await this.navigator.rewardedBreak())return;await this.navigator.confirm({title:pt("itemUnlocked"),positiveButtonLabel:pt("ok"),positiveButtonActionType:$a.NEUTRAL})}else{let{money:e}=this.inventory;if(e<t.price)throw await this.navigator.confirm({title:pt("notEnoughMoney"),positiveButtonLabel:pt("ok"),positiveButtonActionType:$a.NEUTRAL}),new My("Not enough money");try{await this.navigator.confirmPurchase(t,this.baseStats,this.inventory)}catch(t){throw t}this.inventory=this.inventory.clone(),this.inventory.money-=t.price,this.game.achievements.performAction(Pi.BUY)}const i=this.game.progression.progression.ownedItems;i.add(t.item.id),await this.game.progression.setProgression({ownedItems:i,inventory:this.inventory}),null===(e=this.game.plugin(w.p))||void 0===e||e.playSoundEffect((0,wt.F5)(this.game.soundPool.purchase))}}function Oy(t){let e=0;const[i,s]=(0,Un.J0)(t.settings.performance);return An.default.createElement(n.ScreenColumnLayout,null,An.default.createElement(n.ScreenColumnLayoutMainColumn,null,An.default.createElement(n.ScreenColumnLayoutMainColumnHeader,null,An.default.createElement(n.MainTitle,null,pt("settings"))),An.default.createElement(n.ScreenColumnLayoutMainColumnContent,null,An.default.createElement(n.StackList,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:()=>{s(!i),t.onSettingChanged({performance:!i})}},"Performance: ",pt(i?"yes":"no")))),An.default.createElement(n.ScreenColumnLayoutMainColumnFooter,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:()=>t.onBackClicked()},pt("back")))))}class Ry extends Xn{constructor(){super(...arguments),this.id="settings"}async rootComponent(){return An.default.createElement(Oy,{settings:this.game.settings.settings,onBackClicked:()=>this.onBackKeyPressed(),onSettingChanged:t=>this.game.settings.setSettings(t)})}async onBackKeyPressed(){this.resolver.resolve()}}function _y(t){let e=0;const[i,s]=(0,Un.J0)(null),a=e=>{i||(s(e),t.onStatClicked(e))},r=new n.AnimateInSequence;r.interval=.3;const o=[[da,"damage",pt("tooltipDamage")],[la,"defense",pt("tooltipDefense")],[ca,"mobility",pt("tooltipMobility")]];return An.default.createElement("div",{style:{display:"flex",flexDirection:"column",height:"100%"}},An.default.createElement("div",{style:{flex:"0 0 60%"}}),An.default.createElement("div",{style:{flex:"0 0 40%",display:"flex",flexDirection:"column",alignItems:"center"}},An.default.createElement(n.LargeLabel,{...r.next({textAlign:"center"})},"Choose an upgrade"),An.default.createElement("div",{style:{display:"flex",flexDirection:"row",justifyContent:"center",gap:n.Spacing.m,alignItems:"center",marginTop:n.Spacing.m}},o.map((([t,s,o])=>An.default.createElement(n.Frame,{key:s,tabIndex:e++,onClick:()=>a([s]),...r.next({textAlign:"center",visibility:i&&!i.includes(s)?"hidden":"visible"})},An.default.createElement(ma,{icon:t,tooltip:o,statDiff:vt}))))),An.default.createElement(n.Frame,{tabIndex:e++,...r.next({textAlign:"center",marginTop:n.Spacing.m,visibility:i?"hidden":"visible",backgroundColor:"#019cff"}),onClick:async()=>{await t.onSuperUpgradeClicked(),a(St)}},An.default.createElement(n.MediumLabel,null,An.default.createElement("img",{src:qa,style:{verticalAlign:"middle",marginRight:n.Spacing.xs,display:"inline-block",maxHeight:"20px"}}),pt("upgradeAll")))))}class By extends Xn{constructor(t){super(),this.baseStats=t,this.id="upgrade-stat-screen"}async rootComponent(){return An.default.createElement(_y,{onSuperUpgradeClicked:async()=>{if(!await this.navigator.rewardedBreak())throw new Error("User did not watch ad")},onStatClicked:t=>this.onStatPicked(t)})}async onStatPicked(t){this.game.plugin(w.p).playSoundEffect((0,wt.F5)(this.game.soundPool.upgradeStat)),setTimeout((()=>{const e=new Mt;for(const i of t)e.addStat(i,vt);this.resolver.resolve(e)}),1e3)}onBackKeyPressed(){}background(){super.background(),this.view.style.display="block"}}class Ly extends _n{constructor(t){super(),this.message=t,this.id="message"}setup(){super.setup();const t=new f.Text(this.message,{fill:"#fff",stroke:"#000",strokeThickness:4,align:"center",fontFamily:g,fontSize:108,wordWrap:!0,wordWrapWidth:.8*this.width});t.resolution=2,t.anchor.set(.5,.5),t.position.set(this.width/2,this.height/2),this.view.addChild(t),(new np.K).append(new ap.X(t).interp("alpha",0,1).during(.3)).wait(1).append(new ap.X(t).interp("alpha",1,0).during(.3)).append((()=>this.resolver.resolve())).run(this.interpolationPool)}}class Dy extends _n{constructor(){super(...arguments),this.id="rewarded-break"}get absorbCycle(){return!0}get absorbInputs(){return!0}}class Vy extends Cy{constructor(t){super(t),this.id="challenge"}setup(){this.level.progression=this.game.progression.progression,super.setup(),(async()=>{for(;;){if(await this.navigator.challengeDescription(this.level.description))return void this.level.startChallenge();if(await this.navigator.confirm({title:pt("exitChallenge?"),message:pt("youWontGetTheReward"),positiveButtonLabel:pt("exit"),positiveButtonActionType:$a.DESTRUCTIVE,negativeButtonLabel:pt("keepTrying"),negativeButtonActionType:$a.NEUTRAL}))return void this.animateOut().append((()=>this.resolver.resolve(is.FAILED))).run(this.interpolationPool)}})()}async onLevelEnd(t){super.onLevelEnd(t),this.animateOut().append((async()=>{if(t===is.COMPLETED)await this.navigator.commercialBreak(),this.resolver.resolve(t);else if(await this.navigator.challengeFailed()){await this.navigator.commercialBreak();const t=await this.navigator.challenge(this.level);this.resolver.resolve(t)}else await this.navigator.commercialBreak(),this.resolver.resolve(is.FAILED)})).run(this.interpolationPool)}async onPause(){switch(await this.navigator.challengePause()){case ra.RESUME:return;case ra.INVENTORY:this.onInventory();break;case ra.EXIT:if(!await this.navigator.confirm({title:pt("exitChallenge?"),message:pt("youWontGetTheReward"),positiveButtonLabel:pt("exit"),positiveButtonActionType:$a.DESTRUCTIVE,negativeButtonLabel:pt("stay"),negativeButtonActionType:$a.NEUTRAL}))return;this.resolver.resolve(is.FAILED)}}saveProgression(){}}class Hy extends wd{postBind(){super.postBind(),console.log(ld().map((t=>t.description())).join("\n\n"));const{absoluteBounds:t,bounds:e}=Oi(this.world.traitsOfType(xo));t.centerAround(0,0,5e4,5e4),e.copy(t),(new Vc).setup(this.world),(new Nc).setup(this.world);{const t=this.spawnEntity(Dl().concat([]));t.traitOfType(mn).inventory=Si(),setTimeout((()=>t.traitOfType(ws).maxHealth=1),0)}const i=(0,qi.EG)([new Ts]);i.traitOfType(Ts).message="Welcome to the game!",this.world.entities.add(i),(async()=>{const t=new lh;for(let e=0;e<1;e++)for(const e of t.createEntities())e.position.x=(0,wt.XU)(-400,400),e.position.y=(0,wt.XU)(-400,400),e.position.x=500,e.position.y=0,this.world.entities.add(e),e.traitOfType(mn).inventory.money=200,e.traitOfType(Pr).setAI(new Sr),cl(e,1)})();for(let t=0;t<0;t++){const t=this.spawnEntity(ah().concat());t.position.x=(0,wt.XU)(-200,200),t.position.y=(0,wt.XU)(-200,200),this.world.entities.add(t),t.traitOfType(mn).inventory=Si(),t.traitOfType(Pr).setAI(nh()),cl(t,1)}}}class Fy extends Cy{constructor(){super(new Hy),this.id="test"}setup(){this.level.progression=this.game.progression.progression,super.setup()}async onPause(){switch(await this.navigator.gameplayPause()){case tr.RESUME:return;case tr.INVENTORY:this.onInventory();break;case tr.MAIN_MENU:Mn({navigator:this.navigator,progressionRepository:this.game.progression})}}saveProgression(){}}var Ny,Uy=i(6214),Wy=i.n(Uy);class Xy{entityAuthority(t){return t.traitOfType(us)?Xu.I4.NONE:Xu.I4.FULL}worldEventAuthority(t){return Xu.I4.FULL}entityEventAuthority(t,e){return Xu.I4.FULL}determinesRemoval(t,e){return!0}maxUpdateInterval(t){return 0}}class Gy extends wd{createWorld(){const t=super.createWorld();return t.authority=new Xy,t}triggerStart(){super.triggerStart(),(async()=>{const t=new gd(this.world),e=function(){const t=[],e=(0,wt.F5)(Gc),i=new _c,s=(0,wt.F5)([new Hc,new Lc,new Fc,new Wc,new Uc]),n=new El([new Ml(new Oc([e,i,s])),new Vl,new ac]),a=new El([new tl(pt("survival")),new sc(5)]),r=ld(50);for(const e of r){const i=[];i.push(new tl(Ai.A.render(pt("waveX"),{x:e.levelId+1})));for(const t of e.waves)i.push(new dl(t)),t!==e.waves[e.waves.length-1]&&i.push(new kl([new ic,new sc(30)]));const s=`merch-${e.levelId}`;t.push(new El([...i,new ic,new oc(pt("waveCleared")),new pl(new Gi(e.levelId)),new gl(s,null,wl.NEAR_PLAYER),new Fl(pt("nextWaveIn:"),20),new ol(Ts.key),new ol(Tr.key),new ol(kr.key),new ol(Cr.key),new ll]))}const o=new bl([new el(2e3,2e3)]);return new bl([o,new El([n,a,...t])])}();await e.start(this,t)})()}}function zy(){return`${(0,wt.F5)(["Trusty","Happy","Precise","Tall","Confident","Generous","Fast","Brave","Clumsy","Witty","Chatty","Charming","Bold"])} ${(0,wt.F5)(["Human","Bear","Squirrel","Doggo","Raccoon","Kangaroo","Wolf","Fox","Chicken","Lion","Gorilla","Croc","Meerkat","Bobcat","Cat"])}`}!function(t){t[t.MAIN_MENU=0]="MAIN_MENU",t[t.TRY_AGAIN=1]="TRY_AGAIN"}(Ny||(Ny={}));class Ky extends Xn{constructor(t){super(),this.runStats=t,this.id="survival-game-over"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("youDied")))),An.default.createElement(Zn,null,An.default.createElement("div",{style:{padding:n.Spacing.s}},An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.MediumLabel,null,pt("totalTime")),An.default.createElement(n.MediumLabel,null,wm(this.runStats.totalTime))),An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.MediumLabel,null,pt("clearedWaves")),An.default.createElement(n.MediumLabel,null,this.runStats.clearedWaves.toLocaleString())),An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.MediumLabel,null,pt("killedEnemies")),An.default.createElement(n.MediumLabel,null,this.runStats.killedEnemies.toLocaleString())),An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.MediumLabel,null,pt("collectedMoney")),An.default.createElement(n.MediumLabel,null,this.runStats.collectedMoney.toLocaleString())),An.default.createElement(n.KeyValueLayout,null,An.default.createElement(n.MediumLabel,null,pt("maxCombo")),An.default.createElement(n.MediumLabel,null,this.runStats.maxCombo.toLocaleString())))),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,"data-positive":!0,onClick:()=>this.onOptionCLicked(Ny.TRY_AGAIN)},An.default.createElement("img",{src:ia})," ",pt("tryAgain")),An.default.createElement(n.MainButton,{tabIndex:t++,"data-negative":!0,onClick:()=>this.onOptionCLicked(Ny.MAIN_MENU)},An.default.createElement("img",{src:ea})," ",pt("quit"))))))}get absorbCycle(){return!1}async onOptionCLicked(t){var e;await(null===(e=this.component)||void 0===e?void 0:e.animateOut()),this.resolver.resolve(t)}}function Yy(){const t=new Date;t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0);const e=t.getDate()-t.getDay();return new Date(t.setDate(e)).getTime()}function qy(){return["mp-xp",Yy()].join("-")}class jy{constructor(t,e,i){this.pokiBridge=t,this.storage=e,this.bucketKey=i}async submit(t,e){const i=this.bucketKey,s=await this.storage.pokiLeaderboardItem(i).get();if(s){const{id:n,secret:a}=s,r=await this.getLeaderboardEntry();await this.pokiBridge.updateUserData({bucket:i,id:n,secret:a,values:{killedEnemies:Math.max(r.values.killedEnemies||0,t.killedEnemies||0),clearedWaves:Math.max(r.values.clearedWaves||0,t.clearedWaves||0),maxCombo:Math.max(r.values.maxCombo||0,t.maxCombo||0)},data:e})}else{const{id:s,secret:n}=await this.pokiBridge.setUserData({bucket:i,values:t,data:e});await this.storage.pokiLeaderboardItem(i).set({id:s,secret:n})}}async getLeaderboard(){return(await this.pokiBridge.listUserData({bucket:this.bucketKey,sort:"-xp"})).items.sort(((t,e)=>e.values.killedEnemies-t.values.killedEnemies))}async getLeaderboardEntry(){const t=this.bucketKey,e=await this.storage.pokiLeaderboardItem(t).get();if(!e)return null;const{id:i}=e;return await this.pokiBridge.getUserData({bucket:t,id:i})}async getLeaderboardEntryId(){return await this.storage.pokiLeaderboardItem(this.bucketKey).get()}}class $y extends Cy{constructor(){super(new Gy),this.id="survival"}setup(){this.level.progression=this.game.progression.progression,super.setup()}async onLevelEnd(t){super.onLevelEnd(t);const e=Oi(this.level.world.traitsOfType(_l)).stats,{identity:i}=this.game.identity;let{displayName:s}=i;if(!s){s=await this.navigator.prompt({message:pt("whatNameWouldYouLikeToUse"),title:null,positiveButtonLabel:pt("confirm"),negativeButtonLabel:pt("cancel"),initialValue:zy()})||zy();const t=new(Wy());try{s=t.clean(s)}catch(t){}this.game.identity.setIdentity({displayName:s})}(async()=>{const t=new jy(this.game.pokiBridge,this.game.storage,qy());await t.submit({killedEnemies:e.killedEnemies,clearedWaves:e.clearedWaves,maxCombo:e.maxCombo},{displayName:s,armor:this.level.progression.inventory.armor.id,shield:this.level.progression.inventory.shield.id,helmet:this.level.progression.inventory.helmet.id,cape:this.level.progression.inventory.cape.id,tool:this.level.progression.inventory.tool.id}),console.log("Submitted to leaderboard!")})();const n=await this.navigator.survivalGameOver(e);switch(this.animateOut().append((()=>this.resolver.resolve(t))).run(this.interpolationPool),n){case Ny.TRY_AGAIN:this.resolver.resolve(t);break;case Ny.MAIN_MENU:this.resolver.reject(new Sn.r("User exited to main menu"))}}async onPause(){switch(await this.navigator.gameplayPause()){case tr.RESUME:return;case tr.INVENTORY:this.onInventory();break;case tr.MAIN_MENU:this.resolver.reject(new Sn.r("User exited to main menu"))}}}function Jy(t){let e=["achievement-cell"];return t.unlocked&&e.push("unlocked"),An.default.createElement(n.Frame,null,An.default.createElement("div",{className:e.join(" ")},An.default.createElement("div",{className:"achievement-cell-trophy"}),An.default.createElement("div",{className:"achievement-cell-content"},An.default.createElement("h1",null,t.label),void 0!==t.progress?An.default.createElement(n.Gauge,{value:t.progress}):null)))}function Zy(t){return An.default.createElement("div",{key:t.achievement.id},An.default.createElement(Jy,{label:t.achievement.label,progress:t.progress,unlocked:t.unlocked}))}function Qy(t){let e=0,i=0,s=0;for(const e of t.achievements)i++,t.unlockedAchievements.has(e.id)&&s++;return An.default.createElement(Kn,{isModal:!0},An.default.createElement(Yn,null,An.default.createElement(jn,null,An.default.createElement(n.MainButton,{tabIndex:e++,onClick:t.onBackClicked,style:{backgroundImage:`url(${or})`,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"20px 20px",minWidth:"50px",minHeight:"50px"}})),An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},An.default.createElement("img",{src:Qa}),pt("achievements")," (",s,"/",i,")")),An.default.createElement(Jn,null)),An.default.createElement(Zn,null,An.default.createElement(n.ScrollableContent,{style:{flex:"1 0 0",padding:n.Spacing.m,background:"#111"}},An.default.createElement(cr,null,t.achievements.map((e=>An.default.createElement(Zy,{achievement:e,unlocked:t.unlockedAchievements.has(e.id),progress:t.progress.get(e.id)})))))))}class tw extends Xn{constructor(){super(...arguments),this.id="achievements"}async rootComponent(){const t=new Map;for(const e of this.game.achievements.achievements){let i;(e instanceof Li&&e.eventCount>1||e instanceof _i&&e.eventCount>1)&&(i=this.game.achievements.progress(e.id)),t.set(e.id,i)}return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Qy,{achievements:this.game.achievements.achievements,unlockedAchievements:this.game.achievements.unlockedAchievements,progress:t,onBackClicked:()=>this.onBackKeyPressed()}))}async onBackKeyPressed(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve()}}class ew extends Xn{constructor(){super(...arguments),this.id="game-complete"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isPacked:!0},An.default.createElement(Yn,null,An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("congratulations")))),An.default.createElement(Zn,null,An.default.createElement(n.TextBlock,null,An.default.createElement("p",null,pt("gameCompleteDescription")))),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,"data-positive":!0,onClick:()=>this.onOptionCLicked()},An.default.createElement("img",{src:aa})," ",pt("continue"))))))}get absorbCycle(){return!0}async onOptionCLicked(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve()}}function iw(t){let e=0;const[i,s]=(0,Un.J0)(t.options.initialValue);return An.default.createElement(n.Dim,null,An.default.createElement(n.ScreenStackLayout,null,An.default.createElement(n.VerticalCenter,null,An.default.createElement(n.Frame,{style:{width:"400px",maxWidth:"80%",margin:"auto"}},An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},t.options.title),An.default.createElement(n.MediumLabel,{style:{textAlign:"center"}},t.options.message),An.default.createElement("input",{tabIndex:e++,onKeyUp:function(e){"Enter"===e.key&&t.onConfirmClicked(i),"Escape"===e.key&&t.onCancelClicked()},type:"text",value:i,style:{marginTop:"20px",marginBottom:"20px"},onChange:t=>s(t.target.value)}),An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{style:{textAlign:"center"},tabIndex:e++,onClick:()=>t.onConfirmClicked(i)},t.options.positiveButtonLabel),An.default.createElement(n.MainButton,{style:{textAlign:"center"},tabIndex:e++,onClick:()=>t.onCancelClicked()},t.options.negativeButtonLabel))))))}class sw extends Xn{constructor(t){super(),this.options=t,this.id="prompt"}async rootComponent(){return An.default.createElement(iw,{options:this.options,onCancelClicked:()=>this.onBackKeyPressed(),onConfirmClicked:t=>this.resolver.resolve(t)})}get absorbCycle(){return!0}onBackKeyPressed(){this.resolver.reject(new Sn.r)}}function nw(t){const{index:e,item:i,previewMaker:s,playerShop:n,isSelf:a}=t,[r,o]=(0,Un.J0)("");return(0,Un.vJ)((()=>{var t,e,a,r,h;const{tool:l,armor:c,shield:d,helmet:u,cape:p}=i.data,m=new te;m.tool=(null===(t=n.tools.item(l))||void 0===t?void 0:t.item)||m.tool,m.armor=(null===(e=n.armors.item(c))||void 0===e?void 0:e.item)||m.armor,m.shield=(null===(a=n.shields.item(d))||void 0===a?void 0:a.item)||m.shield,m.helmet=(null===(r=n.helmets.item(u))||void 0===r?void 0:r.item)||m.helmet,m.cape=(null===(h=n.capes.item(p))||void 0===h?void 0:h.item)||m.cape,(async()=>{const t=await s.previewFull(m);o(t)})()}),[i.id]),An.default.createElement("tr",{className:a?"self-row":null},An.default.createElement("td",null,(e+1).toLocaleString()),An.default.createElement("td",null,An.default.createElement("img",{src:r}),"  ",i.data.displayName),An.default.createElement("td",null,i.values.clearedWaves.toLocaleString()),An.default.createElement("td",null,i.values.killedEnemies.toLocaleString()),An.default.createElement("td",null,"X",i.values.maxCombo.toLocaleString()))}function aw(t){const{leaderboard:e,onClose:i,previewMaker:s,playerShop:a}=t,[r,o]=(0,Un.J0)([]),[h,l]=(0,Un.J0)(!0);(0,Un.Kr)((async()=>{l(!0);const t=await e.getLeaderboard();o(t),l(!1)}),[t.leaderboard]);let c=0;return An.default.createElement(Kn,{isModal:!0},An.default.createElement(Yn,null,An.default.createElement(jn,null,An.default.createElement(n.MainButton,{tabIndex:c++,onClick:i,style:{backgroundImage:`url(${or})`,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"20px 20px",minWidth:"50px",minHeight:"50px"}})),An.default.createElement($n,null,An.default.createElement(n.MainTitle,{style:{textAlign:"center"}},pt("leaderboardTitle"))),An.default.createElement(Jn,null)),An.default.createElement(Zn,null,An.default.createElement(n.ScrollableContent,null,An.default.createElement("table",{className:"leaderboard"},An.default.createElement("thead",null,An.default.createElement("tr",null,An.default.createElement("th",null,"#"),An.default.createElement("th",null),An.default.createElement("th",null,pt("leaderboardWaves")),An.default.createElement("th",null,pt("leaderboardKills")),An.default.createElement("th",null,pt("leaderboardMaxCombo")))),An.default.createElement("tbody",null,r.map(((e,i)=>{var n;return An.default.createElement(nw,{isSelf:(null===(n=t.selfRow)||void 0===n?void 0:n.id)===e.id,playerShop:a,index:i,item:e,previewMaker:s})})),h?An.default.createElement("tr",null,An.default.createElement("td",{colSpan:5},pt("loading"))):null)))),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{"data-positive":!0,tabIndex:c++,onClick:i},An.default.createElement("img",{src:T})," ",pt("joinTheFight")))))}class rw extends Xn{constructor(){super(...arguments),this.id="survival-leaderboard"}async rootComponent(){const t=new jy(this.game.pokiBridge,this.game.storage,qy()),e=new za(this.texturePool,this.game.plugin(m.W).renderer);return e.setResolution(.25),An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(aw,{selfRow:await t.getLeaderboardEntryId(),playerShop:xi(),previewMaker:e,onClose:()=>this.onBackKeyPressed(),leaderboard:t}))}async onBackKeyPressed(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve()}}class ow extends Xn{constructor(){super(...arguments),this.id="credits"}async rootComponent(){let t=0;return An.default.createElement(Qn,{ref:t=>this.component=t},An.default.createElement(Kn,{isModal:!0},An.default.createElement(Yn,null,An.default.createElement(jn,null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.animateOut(),style:{backgroundImage:`url(${or})`,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"20px 20px",minWidth:"50px",minHeight:"50px"}})),An.default.createElement($n,null,An.default.createElement(n.MainTitle,null,"Credits")),An.default.createElement(Jn,null)),An.default.createElement(Zn,null,An.default.createElement(n.TextBlock,null,"Game by Rémi Vansteelandt"),An.default.createElement(n.TextBlock,null,"Music: Battlefield by Alexander Nakarada (www.creatorchords.com)",An.default.createElement("br",null),"Licensed under Creative Commons BY Attribution 4.0 License",An.default.createElement("br",null),"https://creativecommons.org/licenses/by/4.0/"),An.default.createElement(n.TextBlock,null,"Music: Borgar by Alexander Nakarada (www.creatorchords.com)",An.default.createElement("br",null),"Licensed under Creative Commons BY Attribution 4.0 License",An.default.createElement("br",null),"https://creativecommons.org/licenses/by/4.0/"),An.default.createElement(n.TextBlock,null,"Music: The Great Battle by Alexander Nakarada (www.creatorchords.com)",An.default.createElement("br",null),"Licensed under Creative Commons BY Attribution 4.0 License",An.default.createElement("br",null),"https://creativecommons.org/licenses/by/4.0/"),An.default.createElement(n.TextBlock,null,"Wolf sound effects: ",An.default.createElement("br",null),"https://www.youtube.com/watch?v=cyVGtCs1cug ",An.default.createElement("br",null),"https://www.youtube.com/watch?v=gfGjNl7hAyc ",An.default.createElement("br",null)),An.default.createElement(n.TextBlock,null,"Clothes sound effects: ",An.default.createElement("br",null),"https://jochi.bandcamp.com/album/free-youtube-sfx-pack"),An.default.createElement(n.TextBlock,null,"Thunderclap sound effects: ",An.default.createElement("br",null),"https://www.youtube.com/watch?v=xJjsGmOTT-Y"),An.default.createElement(n.TextBlock,null,"Sword sound effects: ",An.default.createElement("br",null),"https://www.youtube.com/watch?v=TAe0P6uDax4")),An.default.createElement(qn,null,An.default.createElement(n.FlowList,null,An.default.createElement(n.MainButton,{tabIndex:t++,onClick:()=>this.animateOut()},"Back")))))}async animateOut(){var t;await(null===(t=this.component)||void 0===t?void 0:t.animateOut()),this.resolver.resolve()}}class hw{constructor(t,e){this.screenStack=t,this.pokiBridge=e}confirm(t){return this.screenStack.resolvableScreen(new Ja(t))}loadAssets(){return this.screenStack.resolvableScreen(new Fn)}test(){this.screenStack.reset(new Fy)}settings(){return this.screenStack.resolvableScreen(new Ry)}mainMenu(){this.screenStack.push(new Sy)}credits(){return this.screenStack.resolvableScreen(new ow)}gameplay(t){return this.screenStack.resolvableScreen(new Ey(t),In.b.RESET)}survival(){return this.screenStack.resolvableScreen(new $y,In.b.RESET)}survivalLeaderboard(){return this.screenStack.resolvableScreen(new rw)}gameplayPause(){return this.screenStack.resolvableScreen(new er,In.b.PUSH)}challenge(t){return this.screenStack.resolvableScreen(new Vy(t),In.b.REPLACE_EXISTING)}confirmChallenge(t){return this.screenStack.resolvableScreen(new ha(t),In.b.PUSH)}challengeDescription(t){return this.screenStack.resolvableScreen(new ta(t),In.b.PUSH)}challengeFailed(){return this.screenStack.resolvableScreen(new sa,In.b.PUSH)}challengePause(){return this.screenStack.resolvableScreen(new oa,In.b.PUSH)}setCharacterStats(t){return this.screenStack.resolvableScreen(new zn(t))}upgradeStat(t){return this.screenStack.resolvableScreen(new By(t))}inventory(t,e){return this.screenStack.resolvableScreen(new pr(t,e))}confirmRevive(){return this.screenStack.resolvableScreen(new ja)}survivalGameOver(t){return this.screenStack.resolvableScreen(new Ky(t))}merchant(t,e,i){return this.screenStack.resolvableScreen(new Ay(t,e,i),In.b.REPLACE_EXISTING)}confirmPurchase(t,e,i){return this.screenStack.resolvableScreen(new Ya(t,e,i))}message(t){return this.screenStack.resolvableScreen(new Ly(t),In.b.RESET)}achievements(){return this.screenStack.resolvableScreen(new tw)}gameComplete(){return this.screenStack.resolvableScreen(new ew)}prompt(t){return this.screenStack.resolvableScreen(new sw(t))}async commercialBreak(){let t,e=!1;try{await this.pokiBridge.commercialBreak((()=>{t=new Nn,this.screenStack.push(t),e=!0}))}finally{t&&this.screenStack.popTo(t,!0)}return e}async rewardedBreak(){let t;try{return await this.pokiBridge.rewardedBreak((()=>{t=new Dy,this.screenStack.push(t)}))}finally{t&&this.screenStack.popTo(t,!0)}}}class lw{get label(){return this.view.querySelector("span")}constructor(){const t=document.createElement("div");t.innerHTML=`\n            <div class="achievement-card">\n                <div class="achievement-card-trophy"></div>\n\n                <div class="achievement-card-content">\n                    <h1>${pt("achievementUnlocked")}</h1>\n                    <span></span>\n                </div>\n            </div>\n        `,this.view=t.firstElementChild}fadeIn(){return new Promise((t=>{this.view.addEventListener("animationend",(()=>t()),{once:!0}),this.view.classList.remove("fade-out"),this.view.classList.add("fade-in")}))}fadeOut(){return new Promise((t=>{this.view.addEventListener("animationend",(()=>t()),{once:!0}),this.view.classList.remove("fade-in"),this.view.classList.add("fade-out")}))}}class cw extends Bn{constructor(){super(...arguments),this.id="achievement-unlocked"}get cardsContainer(){return this.view.querySelector(".achievement-cards-container")}setup(){super.setup(),this.view.classList.add("achievement-unlocked-screen"),this.view.innerHTML='<div class="achievement-cards-container"></div>',this.game.achievements.achievementUnlocked.subscribe((t=>this.addAchievement(t)))}addAchievement(t){const e=new lw;e.label.innerHTML=t.label,e.view.addEventListener("click",(0,Za.Z)((async()=>{this.cardsContainer.removeChild(e.view),await this.navigator.achievements()})),{once:!0}),this.cardsContainer.appendChild(e.view),(async()=>{await e.fadeIn(),await new Promise((t=>setTimeout(t,5e3))),await e.fadeOut(),this.cardsContainer.removeChild(e.view)})(),this.game.plugin(w.p).playSoundEffect((0,wt.F5)(this.game.soundPool.achievement))}}var dw=i(4196);const uw=i.p+"PUZZLE_Success_Brass_Fanfare_Bright_Wet_stereo010d412403d25dfdd142.ogg",pw=i.p+"PUZZLE_Success_Brass_Fanfare_Bright_Wet_stereo84efab7c55249d059304.mp3",mw=i.p+"SWORD_Hit_Armor_Hard_RR10_monoe80ae7bb0e5cfcaae197.ogg",yw=i.p+"SWORD_Hit_Armor_Hard_RR10_mono3521c6e3a8f8cfe670ef.mp3",ww=i.p+"SWORD_Hit_Armor_Hard_RR1_mono658151829815c9b1a632.ogg",gw=i.p+"SWORD_Hit_Armor_Hard_RR1_monoa91e3db40764db22339d.mp3",fw=i.p+"SWORD_Hit_Armor_Hard_RR2_mono22d790b1d6264aad57a7.ogg",vw=i.p+"SWORD_Hit_Armor_Hard_RR2_monoe828823417dd2a4615ad.mp3",bw=i.p+"SWORD_Hit_Armor_Hard_RR3_monoa451a95e10443ac7f3ec.ogg",Tw=i.p+"SWORD_Hit_Armor_Hard_RR3_mono958af4eb930dde5b30ee.mp3",kw=i.p+"SWORD_Hit_Armor_Hard_RR4_mono585a286c7819dd1cd69d.ogg",xw=i.p+"SWORD_Hit_Armor_Hard_RR4_mono701cbb4810f78cc9c067.mp3",Cw=i.p+"SWORD_Hit_Armor_Hard_RR5_mono643f68668a7f7082d6c7.ogg",Ew=i.p+"SWORD_Hit_Armor_Hard_RR5_mono6ef52f4fe0ce902f074d.mp3",Sw=i.p+"SWORD_Hit_Armor_Hard_RR6_mono597c797ed186bbd5a869.ogg",Mw=i.p+"SWORD_Hit_Armor_Hard_RR6_monodfc1dc2fe75190958ae4.mp3",Pw=i.p+"SWORD_Hit_Armor_Hard_RR7_monobabe33f43cf441b52405.ogg",Iw=i.p+"SWORD_Hit_Armor_Hard_RR7_mono78ac271b4fc0cebe283c.mp3",Aw=i.p+"SWORD_Hit_Armor_Hard_RR8_mono4387b391dab4ee23ea11.ogg",Ow=i.p+"SWORD_Hit_Armor_Hard_RR8_mono0dca71617ee6629edcee.mp3",Rw=i.p+"SWORD_Hit_Armor_Hard_RR9_monocdb3bd71f887f039ee0c.ogg",_w=i.p+"SWORD_Hit_Armor_Hard_RR9_mono7c85af52ef5fb8dffc55.mp3",Bw=i.p+"THUD_Noisy_03_monof5780bad5a2db3d3a8e9.ogg",Lw=i.p+"THUD_Noisy_03_mono8717244b450cc5e15fa2.mp3",Dw=i.p+"attack34fc98d633acbc65d1783.ogg",Vw=i.p+"attack36df28a67e58aa4827e70.mp3",Hw=i.p+"attack52f9c3dcf3a33968e06c6.ogg",Fw=i.p+"attack597e5a4973a7434470a96.mp3",Nw=i.p+"attack6b2a164ed78474c07bf37.ogg",Uw=i.p+"attack61ed9bf41a4382960d06e.mp3",Ww=(i.p,i.p,i.p,i.p,i.p,i.p,i.p+"UI_Click_Snappy_mono595cd42dda5b5c990d37.ogg"),Xw=i.p+"UI_Click_Snappy_mono664d75118e908f28a0ef.mp3",Gw=i.p+"COINS_Rattle_01_monof4752822cf1f13335193.ogg",zw=i.p+"COINS_Rattle_01_mono1a52a47f9c121b1b741a.mp3",Kw=i.p+"COINS_Rattle_02_monobb32264d7eafc1af1c08.ogg",Yw=i.p+"COINS_Rattle_02_mono67a130f1e652e02f8cda.mp3",qw=i.p+"COINS_Rattle_03_monod91f1fe631cbcccf8615.ogg",jw=i.p+"COINS_Rattle_03_monob97712edfa376553ea36.mp3",$w=i.p+"COINS_Rattle_04_mono0323019c73a13b06b99b.ogg",Jw=i.p+"COINS_Rattle_04_mono1329f00fe99fa899d021.mp3",Zw=i.p+"Sword Cut Through Flesh - Sound Effect (3)6f4d47cf6109b22fec2a.ogg",Qw=i.p+"Sword Cut Through Flesh - Sound Effect (3)b65d3462242efac358c8.mp3",tg=i.p+"ANIMAL_Horse_Snort_01_Dry_mono2cab142450c73138b0f6.ogg",eg=i.p+"ANIMAL_Horse_Snort_01_Dry_monof2ad8df41845242ac7da.mp3",ig=i.p+"ANIMAL_Horse_Snort_02_Dry_mono6e08d32bb1c4a239f893.ogg",sg=i.p+"ANIMAL_Horse_Snort_02_Dry_mono1fbe4ec48cb56b8d8cfc.mp3",ng=i.p+"ANIMAL_Horse_Snort_03_Dry_mono6a8c8bc30b45998481c5.ogg",ag=i.p+"ANIMAL_Horse_Snort_03_Dry_mono45fc277ee38292295e73.mp3",rg=i.p+"ANIMAL_Horse_Snort_04_Dry_monobda2daf0a7531b3637df.ogg",og=i.p+"ANIMAL_Horse_Snort_04_Dry_monobf567c4ef1523b16b177.mp3",hg=i.p+"GRUNT_Male_B_Hurt_Medium_01_mono7dd034450792a3fee27f.ogg",lg=i.p+"GRUNT_Male_B_Hurt_Medium_01_monob67bde1cecfc181911d2.mp3",cg=i.p+"GRUNT_Male_B_Hurt_Short_01_monob7c9c624ea40000352d4.ogg",dg=i.p+"GRUNT_Male_B_Hurt_Short_01_mono41486820631ea988b307.mp3",ug=i.p+"GRUNT_Male_B_Hurt_Short_02_mono4b26df6210d6bf956f23.ogg",pg=i.p+"GRUNT_Male_B_Hurt_Short_02_monoe2f1ccb70a4bbbad9d27.mp3",mg=i.p+"GRUNT_Male_B_Hurt_Short_03_mono782ec64f9de7409aed82.ogg",yg=i.p+"GRUNT_Male_B_Hurt_Short_03_mono56e7c3b08465990e8b36.mp3",wg=i.p+"damage1949588d57bde72e5e1bf.ogg",gg=i.p+"damage15b1dd47253d53b1016bb.mp3",fg=i.p+"8BIT_RETRO_Hit_Bump_Thump_monof21fed38514718ef7e7a.ogg",vg=i.p+"8BIT_RETRO_Hit_Bump_Thump_mono77fd3066141bbfb5f778.mp3",bg=i.p+"MARTIAL_ARTS_Kick_Punch_RR11_mono671d0f492e99ba269d53.ogg",Tg=i.p+"MARTIAL_ARTS_Kick_Punch_RR11_mono59c1df243c5818fd6d47.mp3",kg=i.p+"GROAN_Male_Hurt_Long_Pain_monoeaec92ba2b41bdb2947b.ogg",xg=i.p+"GROAN_Male_Hurt_Long_Pain_mono8155e1b85fca0996dc47.mp3",Cg=i.p+"GROAN_Male_Hurt_Long_mono13069f5849cb50928d17.ogg",Eg=i.p+"GROAN_Male_Hurt_Long_mono0c90d544f1e00e7067ac.mp3",Sg=i.p+"death326a5835a5a43cf0638ed.ogg",Mg=i.p+"death35af3256bc642257604e4.mp3",Pg=(i.p,i.p,i.p,i.p,i.p,i.p,i.p+"equip01f590cd9553f2dd133bcb.ogg"),Ig=i.p+"equip019ed36bae11a1e0d395d2.mp3",Ag=i.p+"IMPACT_Energy_Solid_03_mono4ff0e983c49529166d95.ogg",Og=i.p+"IMPACT_Energy_Solid_03_mono3b53f5da78f0d029924c.mp3",Rg=i.p+"IMPACT_Generic_09_mono0b3327f2ce30b1683b9c.ogg",_g=i.p+"IMPACT_Generic_09_mono2e1ec572555717bedf94.mp3",Bg=i.p+"MAGIC_SPELL_Power_mono6f31d8b6a56170c5f4bc.ogg",Lg=i.p+"MAGIC_SPELL_Power_monob0463a667e4d8d3bdc13.mp3",Dg=i.p+"MUSIC_EFFECT_Orchestral_Battle_Negative_stereofa6815b409641d8e5e3e.ogg",Vg=i.p+"MUSIC_EFFECT_Orchestral_Battle_Negative_stereo70e8fecc42ea220fc67c.mp3",Hg=i.p+"Jochi - Free Youtube SFX Pack - 37 Heartbeata08a72d14c571b323e43.ogg",Fg=i.p+"Jochi - Free Youtube SFX Pack - 37 Heartbeat6e62e5c44e95630f74a4.mp3",Ng=i.p+"MAGIC_SPELL_Morphing_Synth_Harp_Scales_Deep_stereoefa1d2a0c738c37e4a88.ogg",Ug=i.p+"MAGIC_SPELL_Morphing_Synth_Harp_Scales_Deep_stereof07fe34a37086e3a9e64.mp3",Wg=i.p+"MAGIC_SPELL_Morphing_Synth_Harp_Scales_stereo15b21e94f84abe23c91e.ogg",Xg=i.p+"MAGIC_SPELL_Morphing_Synth_Harp_Scales_stereoee30cca21d055dbd852c.mp3",Gg=i.p+"EXPLOSION_Long_Bright_with_Smooth_Tail_stereo3a0dacaefb7b6ac655ce.ogg",zg=i.p+"EXPLOSION_Long_Bright_with_Smooth_Tail_stereob58a978d32f68cdefa8d.mp3",Kg=i.p+"ANIMAL_Horse_Neigh_02_Dry_monobd2ee86e34e48f44cfe1.ogg",Yg=i.p+"ANIMAL_Horse_Neigh_02_Dry_mono659be074ebaee8bd98bf.mp3",qg=i.p+"VOICE_Martial_Art_Shout_06_mono01c26ced1059960f3c1f.ogg",jg=i.p+"VOICE_Martial_Art_Shout_06_mono1775573e843897e9abb3.mp3",$g=i.p+"VOICE_Martial_Art_Shout_07_mono9806626bbdbe26592379.ogg",Jg=i.p+"VOICE_Martial_Art_Shout_07_monoe051173d09db41825cf6.mp3",Zg=i.p+"VOICE_Martial_Art_Shout_08_mono91a753be74cd30d0e22d.ogg",Qg=i.p+"VOICE_Martial_Art_Shout_08_monobf8af516ab5700e81ed3.mp3",tf=i.p+"VOICE_Martial_Art_Shout_09_monofcb5d453e5210ada9ba7.ogg",ef=i.p+"VOICE_Martial_Art_Shout_09_mono0b2077ffeea6165e0963.mp3",sf=i.p+"VOICE_Male_Haha_Mocking_02_mono27d38ddcb2a18a7b4a80.ogg",nf=i.p+"VOICE_Male_Haha_Mocking_02_monoe41a1924ee2e7c91b705.mp3",af=i.p+"VOICE_Male_Haha_Mocking_03_mono2ba4e37821c17d9599ab.ogg",rf=i.p+"VOICE_Male_Haha_Mocking_03_monoc8523d594f4a2ac2ce10.mp3",of=(i.p,i.p,i.p,i.p,i.p,i.p,i.p+"prepare3015641cc4d347976faaa.ogg"),hf=i.p+"prepare3f2ef7039827a03e659bc.mp3",lf=i.p+"sound-effects-library-cash-register-sound289c6f048d690dc1bd2c.ogg",cf=i.p+"sound-effects-library-cash-register-sound04dd1eb8f2130cc8c039.mp3",df=i.p+"RAIN_Loop_01_loop_stereocdfc2782cd99b039141a.ogg",uf=i.p+"RAIN_Loop_01_loop_stereocc4a8310f0ff6f68d4d2.mp3",pf=i.p+"MUSIC_EFFECT_Orchestral_Battle_Neutral_stereo779e310cfa1e33103e73.ogg",mf=i.p+"MUSIC_EFFECT_Orchestral_Battle_Neutral_stereoaf21938ec8d419800f1b.mp3",yf=i.p+"VOICE_Martial_Art_Male_B_Shout_03_monoda02b6245246f1a88703.ogg",wf=i.p+"VOICE_Martial_Art_Male_B_Shout_03_mono5cb5063b65dff69ca54e.mp3",gf=i.p+"VOICE_Martial_Art_Male_B_Shout_04_mono8f0e44e1e6eeec409fc0.ogg",ff=i.p+"VOICE_Martial_Art_Male_B_Shout_04_mono700501425ceabba65572.mp3",vf=i.p+"Battlefield4b3d33c1e2f4541217ae.ogg",bf=i.p+"Battlefield1d5463bef5ad92020b1b.mp3",Tf=i.p+"Borgar_2023ebe3f36cb5e55defdbf5.ogg",kf=i.p+"Borgar_20235bcc49f16079fff5ffa8.mp3",xf=i.p+"The_Great_Battle548efb7cd12abb3397e7.ogg",Cf=i.p+"The_Great_Battle59172a4e2f58879d839a.mp3",Ef=i.p+"MARTIAL_ARTS_Kick_Punch_RR11_monof9e8139690d1f9626e81.ogg",Sf=i.p+"MARTIAL_ARTS_Kick_Punch_RR11_mono59c1df243c5818fd6d47.mp3",Mf=i.p+"MARTIAL_ARTS_Kick_Punch_RR12_monoc917f893c61c663a22f2.ogg",Pf=i.p+"MARTIAL_ARTS_Kick_Punch_RR12_monoe351e0535c6fb10c2519.mp3",If=i.p+"Jochi - Sword Swings1b7c69303e79d45156f29.ogg",Af=i.p+"Jochi - Sword Swings1a0a49be1f75d2dc844ca.mp3",Of=i.p+"Jochi - Sword Swings24ccab20a403fbb2bb6c6.ogg",Rf=i.p+"Jochi - Sword Swings2af99f2bed5dc39b6a3d4.mp3",_f=i.p+"Jochi - Sword Swings338e7e43c60776d71ecab.ogg",Bf=i.p+"Jochi - Sword Swings3d91b0a8ad89e3998d922.mp3",Lf=(i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p,i.p+"THUNDER_Clap_Rumble_02_stereo128010ea2058427d978c.ogg"),Df=i.p+"THUNDER_Clap_Rumble_02_stereo4766d6ddf2cb80a67009.mp3",Vf=i.p+"THUNDER_Clap_Rumble_03_stereo02ad20d693bd7b8f55fd.ogg",Hf=i.p+"THUNDER_Clap_Rumble_03_stereocd3e941ca29d433e9d7d.mp3",Ff=i.p+"THUNDER_Clap_Rumble_04_stereo65bdcf4f9090943dd95e.ogg",Nf=i.p+"THUNDER_Clap_Rumble_04_stereof0d2eb41cedc6ee95212.mp3",Uf=i.p+"Copyright free sound ( ThunderClap ) [TubeRipper.com]a828e1cf58bd71d9bd2e.ogg",Wf=i.p+"Copyright free sound ( ThunderClap ) [TubeRipper.com]cf0ee2dbe79e4921cbeb.mp3",Xf=i.p+"MAGIC_SPELL_Fade_In_Metallic_Pingpong_Fade_stereofaba7daebbb896d76dff.ogg",Gf=i.p+"MAGIC_SPELL_Fade_In_Metallic_Pingpong_Fade_stereo1dc5fbabbbad6d9c85aa.mp3";class zf{constructor(t,e,i,s){this.basename=t,this.files=e,this.sprite=i,this.averageFileSize=s}}class Kf{constructor(){this.allHowls=[],this.howlToDefinition=new Map,this.spritesheet=null,this.click=this.howls([new zf("UI_Click_Snappy_mono",[Ww,Xw],null,2896)]),this.swing=this.howls([new zf("MARTIAL_ARTS_Kick_Punch_RR11_mono",[Ef,Sf],null,4370),new zf("MARTIAL_ARTS_Kick_Punch_RR12_mono",[Mf,Pf],null,4370)]),this.swingMetal=this.howls([new zf("Jochi - Sword Swings1",[If,Af],null,21726),new zf("Jochi - Sword Swings2",[Of,Rf],null,26646),new zf("Jochi - Sword Swings3",[_f,Bf],null,14755)]),this.swingWolf=this.howls([new zf("attack3",[Dw,Vw],null,14573),new zf("attack5",[Hw,Fw],null,14232),new zf("attack6",[Nw,Uw],null,18373)]),this.damage=this.howls([new zf("Sword Cut Through Flesh - Sound Effect (3)",[Zw,Qw],null,8984)]),this.damagePlayer=this.howls([new zf("GRUNT_Male_B_Hurt_Medium_01_mono",[hg,lg],null,7970),new zf("GRUNT_Male_B_Hurt_Short_01_mono",[cg,dg],null,5500),new zf("GRUNT_Male_B_Hurt_Short_02_mono",[ug,pg],null,7889),new zf("GRUNT_Male_B_Hurt_Short_03_mono",[mg,yg],null,4470)]),this.damageWood=this.howls([new zf("8BIT_RETRO_Hit_Bump_Thump_mono",[fg,vg],null,2919)]),this.damageWolf=this.howls([new zf("damage1",[wg,gg],null,6641)]),this.damageHorse=this.howls([new zf("ANIMAL_Horse_Snort_01_Dry_mono",[tg,eg],null,10006),new zf("ANIMAL_Horse_Snort_02_Dry_mono",[ig,sg],null,10284),new zf("ANIMAL_Horse_Snort_03_Dry_mono",[ng,ag],null,7675),new zf("ANIMAL_Horse_Snort_04_Dry_mono",[rg,og],null,8545)]),this.death=this.howls([new zf("GROAN_Male_Hurt_Long_Pain_mono",[kg,xg],null,10811),new zf("GROAN_Male_Hurt_Long_mono",[Cg,Eg],null,11245)]),this.deathWolf=this.howls([new zf("death3",[Sg,Mg],null,7542)]),this.dash=this.howls([new zf("MARTIAL_ARTS_Kick_Punch_RR11_mono",[bg,Tg],null,4370)]),this.roll=this.howls([new zf("VOICE_Martial_Art_Male_B_Shout_03_mono",[yf,wf],null,4853),new zf("VOICE_Martial_Art_Male_B_Shout_04_mono",[gf,ff],null,4846)]),this.attackBlocked=this.howls([new zf("SWORD_Hit_Armor_Hard_RR10_mono",[mw,yw],null,9508),new zf("SWORD_Hit_Armor_Hard_RR1_mono",[ww,gw],null,11788),new zf("SWORD_Hit_Armor_Hard_RR2_mono",[fw,vw],null,10569),new zf("SWORD_Hit_Armor_Hard_RR3_mono",[bw,Tw],null,11277),new zf("SWORD_Hit_Armor_Hard_RR4_mono",[kw,xw],null,11762),new zf("SWORD_Hit_Armor_Hard_RR5_mono",[Cw,Ew],null,11549),new zf("SWORD_Hit_Armor_Hard_RR6_mono",[Sw,Mw],null,10434),new zf("SWORD_Hit_Armor_Hard_RR7_mono",[Pw,Iw],null,10786),new zf("SWORD_Hit_Armor_Hard_RR8_mono",[Aw,Ow],null,10866),new zf("SWORD_Hit_Armor_Hard_RR9_mono",[Rw,_w],null,10710)]),this.attackBlockedWood=this.howls([new zf("THUD_Noisy_03_mono",[Bw,Lw],null,4804)]),this.perfectParry=this.howls([new zf("EXPLOSION_Long_Bright_with_Smooth_Tail_stereo",[Gg,zg],null,79598)]),this.prepareAttackHuman=this.howls([new zf("VOICE_Martial_Art_Shout_06_mono",[qg,jg],null,4974),new zf("VOICE_Martial_Art_Shout_07_mono",[$g,Jg],null,5790),new zf("VOICE_Martial_Art_Shout_08_mono",[Zg,Qg],null,4010),new zf("VOICE_Martial_Art_Shout_09_mono",[tf,ef],null,4724)]),this.prepareAttackWolf=this.howls([new zf("prepare3",[of,hf],null,22361)]),this.prepareAttackWizard=this.howls([new zf("VOICE_Male_Haha_Mocking_02_mono",[sf,nf],null,16614),new zf("VOICE_Male_Haha_Mocking_03_mono",[af,rf],null,15962)]),this.prepareAttackHorse=this.howls([new zf("ANIMAL_Horse_Neigh_02_Dry_mono",[Kg,Yg],null,15843)]),this.purchase=this.howls([new zf("sound-effects-library-cash-register-sound",[lf,cf],null,34164)]),this.fallenDown=this.howls([new zf("IMPACT_Energy_Solid_03_mono",[Ag,Og],null,17343),new zf("IMPACT_Generic_09_mono",[Rg,_g],null,7175)]),this.rain=this.howls([new zf("RAIN_Loop_01_loop_stereo",[df,uf],null,161083)],{loop:!0}),this.thunder=this.howls([new zf("THUNDER_Clap_Rumble_02_stereo",[Lf,Df],null,163949),new zf("THUNDER_Clap_Rumble_03_stereo",[Vf,Hf],null,173719),new zf("THUNDER_Clap_Rumble_04_stereo",[Ff,Nf],null,244120)]),this.thunderAttack=this.howls([new zf("Copyright free sound ( ThunderClap ) [TubeRipper.com]",[Uf,Wf],null,127504)]),this.fireAttack=this.howls([new zf("MAGIC_SPELL_Power_mono",[Bg,Lg],null,8345)]),this.coin=this.howls([new zf("COINS_Rattle_01_mono",[Gw,zw],null,8579),new zf("COINS_Rattle_02_mono",[Kw,Yw],null,3797),new zf("COINS_Rattle_03_mono",[qw,jw],null,6072),new zf("COINS_Rattle_04_mono",[$w,Jw],null,6456)]),this.equipArmor=this.howls([new zf("equip01",[Pg,Ig],null,20225)]),this.gameOver=this.howls([new zf("MUSIC_EFFECT_Orchestral_Battle_Negative_stereo",[Dg,Vg],null,82801)]),this.revived=this.howls([new zf("MUSIC_EFFECT_Orchestral_Battle_Neutral_stereo",[pf,mf],null,77946)]),this.levelUp=this.howls([new zf("MAGIC_SPELL_Morphing_Synth_Harp_Scales_Deep_stereo",[Ng,Ug],null,66290),new zf("MAGIC_SPELL_Morphing_Synth_Harp_Scales_stereo",[Wg,Xg],null,69429)]),this.upgradeStat=this.howls([new zf("MAGIC_SPELL_Fade_In_Metallic_Pingpong_Fade_stereo",[Xf,Gf],null,51643)]),this.heartBeat=this.howls([new zf("Jochi - Free Youtube SFX Pack - 37 Heartbeat",[Hg,Fg],null,184200)],{loop:!0}),this.achievement=this.howls([new zf("PUZZLE_Success_Brass_Fanfare_Bright_Wet_stereo",[uw,pw],null,20498)]),this.soundtrackGameplay=this.soundtrackHowls([new zf("Battlefield",[vf,bf],null,3483141),new zf("Borgar_2023",[Tf,kf],null,5130610),new zf("The_Great_Battle",[xf,Cf],null,2948984)]),this.onFirstSoundPlayed=()=>{}}soundtrackHowls(t){return t.map((t=>this.howl(t,{html5:!0,pool:1}))).map((([t,e])=>t))}howls(t,e={}){return t.map((t=>this.howl(t,e)))}howl(t,e={}){if(t.sprite)return[this.spritesheet,t.sprite];const i=new dw.Howl({src:t.files,autoplay:!1,preload:!1,...e});return i.on("play",(()=>{const{onFirstSoundPlayed:t}=this;this.onFirstSoundPlayed=()=>{},t()})),this.allHowls.push(i),this.howlToDefinition.set(i,t),[i,null]}load(t){return t.map((([t,e])=>{const i=this.howlToDefinition.get(t);return{label:i.files[0].replace(document.location.href,""),load:()=>this.loadHowl(t),size:i.averageFileSize,mandatory:!1}}))}loadAll(){return this.load(this.allHowls.map((t=>[t,null])))}loadHowl(t){return new Promise(((e,i)=>{"loaded"!==t.state()?(t.once("load",e),t.once("loaderror",i),t.load()):e()}))}}var Yf=i(3094);class qf{constructor(t,e){this.storage=t,this.achievements=e,this.cachedUnlockedAchievements=new Set,this.cachedEventCount=new Map,this.achievementUnlocked=new Yf.B,this.achievementMap=(()=>{const t=new Map;for(const e of this.achievements)t.set(e.id,e);return t})()}get unlockedAchievements(){return new Set(this.cachedUnlockedAchievements)}async load(){this.cachedUnlockedAchievements=new Set(await this.storage.achievements.get()),this.cachedEventCount=new Map(Object.entries(await this.storage.events.get()||{}))}async save(){this.storage.achievements.set(Array.from(this.cachedUnlockedAchievements)),this.storage.events.set(Object.fromEntries(this.cachedEventCount.entries()))}isUnlocked(t){return this.cachedUnlockedAchievements.has(t)}unlock(t){this.cachedUnlockedAchievements.has(t)||this.achievements.find((e=>e.id===t))&&(console.log("Achievement!",t),this.achievementUnlocked.next(this.achievements.find((e=>e.id===t))),this.cachedUnlockedAchievements.add(t),this.save())}progress(t){const e=this.achievementMap.get(t);return e instanceof _i?this.eventCount(e.eventLabel)/e.eventCount:e instanceof Li?this.eventCount(e.matcher.eventLabel||e.id)/e.eventCount:0}performAction(t){this.onEvent(t);for(const t of this.achievements)this.progress(t.id)<1||this.unlock(t.id);this.save()}eventCount(t){return this.cachedEventCount.get(t)||0}onEvent(t){const e=this.eventCount(t)+1;this.cachedEventCount.set(t,e),this.save();for(const t of this.achievements)this.progress(t.id)>=1&&this.unlock(t.id)}}function jf(){return{inventory:Si(),experience:0,baseStats:new Mt,ownedItems:new Set,levelIndex:0}}class $f{constructor(t){this.storage=t,this.cachedProgression=jf()}get progression(){return{inventory:this.cachedProgression.inventory.clone(),experience:this.cachedProgression.experience,baseStats:this.cachedProgression.baseStats.clone(),ownedItems:new Set(this.cachedProgression.ownedItems),levelIndex:this.cachedProgression.levelIndex}}setProgression(t){if(void 0!==t.inventory&&(this.cachedProgression.inventory=t.inventory.clone()),void 0!==t.experience&&(this.cachedProgression.experience=t.experience),void 0!==t.baseStats&&(this.cachedProgression.baseStats=t.baseStats.clone()),void 0!==t.ownedItems)for(const e of t.ownedItems)this.cachedProgression.ownedItems.add(e);return void 0!==t.levelIndex&&(this.cachedProgression.levelIndex=t.levelIndex),this.save()}async load(){var t,e,i,s,n;const[a,r,o,h,l,c,d,u,p,m]=await Promise.all([this.storage.money.get(),this.storage.experience.get(),this.storage.tool.get(),this.storage.shield.get(),this.storage.armor.get(),this.storage.helmet.get(),this.storage.cape.get(),this.storage.baseStats.get(),this.storage.ownedItems.get(),this.storage.levelIndex.get()]),y=xi(),w=Si();w.money=null===a?w.money:a||0,w.tool=(null===(t=y.tools.item(o))||void 0===t?void 0:t.item)||w.tool,w.armor=(null===(e=y.armors.item(l))||void 0===e?void 0:e.item)||w.armor,w.shield=(null===(i=y.shields.item(h))||void 0===i?void 0:i.item)||w.shield,w.helmet=(null===(s=y.helmets.item(c))||void 0===s?void 0:s.item)||w.helmet,w.cape=(null===(n=y.capes.item(d))||void 0===n?void 0:n.item)||w.cape,this.setProgression({inventory:w,experience:r,baseStats:new Mt(u||{damage:0,defense:0,mobility:.5}),ownedItems:new Set(p||[]),levelIndex:m||0})}async save(){const{inventory:t,experience:e,baseStats:i,ownedItems:s,levelIndex:n}=this.cachedProgression;await Promise.all([this.storage.money.set(t.money),this.storage.tool.set(t.tool.id),this.storage.shield.set(t.shield.id),this.storage.armor.set(t.armor.id),this.storage.helmet.set(t.helmet.id),this.storage.cape.set(t.cape.id),this.storage.experience.set(e),this.storage.baseStats.set(i.toJSON()),this.storage.ownedItems.set(Array.from(s)),this.storage.levelIndex.set(n)])}async clear(){this.cachedProgression=jf(),await Promise.all([this.storage.money.delete(),this.storage.tool.delete(),this.storage.shield.delete(),this.storage.armor.delete(),this.storage.helmet.delete(),this.storage.cape.delete(),this.storage.experience.delete(),this.storage.baseStats.delete(),this.storage.ownedItems.delete(),this.storage.levelIndex.delete()])}}class Jf{constructor(t,e){this.storage=t,this.onSettingsUpdated=e,this.cachedSettings={performance:!1}}get settings(){return{performance:this.cachedSettings.performance}}setSettings(t){return void 0!==t.performance&&(this.cachedSettings.performance=t.performance),this.onSettingsUpdated(this.settings),this.save()}async load(){const[t]=await Promise.all([this.storage.performance.get()]);this.setSettings({performance:t})}async save(){const{performance:t}=this.cachedSettings;await Promise.all([this.storage.performance.set(t)])}async clear(){this.cachedSettings={performance:!1},await Promise.all([this.storage.performance.delete()])}}class Zf{constructor(t){this.jsonStore=t,this.ownedItems=this.jsonStore.item("unlocked-items"),this.money=this.jsonStore.item("money"),this.experience=this.jsonStore.item("xp"),this.tool=this.jsonStore.item("tool"),this.shield=this.jsonStore.item("shield"),this.armor=this.jsonStore.item("armor"),this.helmet=this.jsonStore.item("helmet"),this.cape=this.jsonStore.item("cape"),this.baseStats=this.jsonStore.item("baseStats"),this.levelIndex=this.jsonStore.item("levelIndex"),this.displayName=this.jsonStore.item("displayName"),this.achievements=this.jsonStore.item("achievements"),this.events=this.jsonStore.item("events"),this.performance=this.jsonStore.item("performance")}pokiLeaderboardItem(t){return this.jsonStore.item(`poki-lb-${t}`)}}var Qf=i(8831),tv=i(8561);class ev extends Qf.S{constructor(){super(...arguments),this.key=ev.key,this.resolutionAdjustment=1,this.averageFramerate=new tv.r(300),this.nextResolutionCheck=0}setup(){super.setup(),window.addEventListener("resize",(()=>this.resize()),!1),this.resize(),this.nextResolutionCheck=this.game.age+5}adjustResolution(t){const e=this.resolutionAdjustment;this.resolutionAdjustment=(0,ft.Tq)(.5,e+t,1),e!==this.resolutionAdjustment&&this.resize()}addDebugValues(t){super.addDebugValues(t),t["resizing.averageFramerate"]=this.averageFramerate.average.toFixed(2),t["resizing.resolutionAdjustment"]=this.resolutionAdjustment.toFixed(2)}cycle(t){super.cycle(t),this.averageFramerate.record(this.game.age,1/t),this.game.age>=this.nextResolutionCheck&&(this.nextResolutionCheck=this.game.age+5,this.averageFramerate.average>=40?this.adjustResolution(.1):this.averageFramerate.average<30&&this.adjustResolution(-.1))}async resize(){document.querySelector(":root").style.setProperty("--aspect-ratio",`${window.innerWidth} / ${window.innerHeight}`);const{params:t}=this.game;if(CSS.supports(`aspect-ratio: ${window.innerWidth} / ${window.innerHeight}`)||(document.querySelector("#aspect-ratio").style.paddingTop=100*window.innerHeight/window.innerHeight+"%"),t.width=1600,t.height=900,ct()){if(window.innerHeight>window.innerWidth){const{width:e}=t;t.width=t.height,t.height=e}const e=t.width/t.height,i=window.innerWidth/window.innerHeight;e<i?t.height=t.width/i:t.width=t.height*i}t.width=Math.round(t.width),t.height=Math.round(t.height),t.width%2&&t.width--,t.height%2&&t.height--;const e=window.innerWidth/t.width*Math.min(3,window.devicePixelRatio),i=(0,ft.wx)((0,ft.Tq)(.1,e,2),.1);this.game.plugin(m.W).setOptions({width:t.width,height:t.height,resolution:i,antialias:!0}),this.game.plugin(m.W).updateRenderer()}}ev.key="resizing";class iv extends Qf.S{constructor(){super(...arguments),this.key="screen-logging"}onCurrentScreenChanged(t){super.onCurrentScreenChanged(t),console.log("Screen stack: ",this.game.screenStack.screens.map((t=>t.id)).join(", "))}}const sv=i.p+"mouse-left6dbdd839cb0b5ab987b3.png",nv=i.p+"mouse-rightb160b266350d004ec3ae.png",av=i.p+"shift37e9df30c7ffec41e8c7.png";class rv{constructor(t){this.game=t}htmlMessage(t){return(t=(t=(t=t.replace(/<localized:([a-z]+)>/gi,((t,...e)=>pt(e[0])))).replace(/\*\*(.+?)\*\*(?!\*)/g,"<b>$1</b>")).replace(/\*([^*><]+)\*/g,"<i>$1</i>")).replace(/<binding:([a-z]+)>/gi,((t,...e)=>{const i=e[0];if(ct()){if("tool"===i)return`<img src="${rr}" />`;if("dash"===i)return`<img src="${ca}" />`;if("shield"===i)return`<img src="${la}" />`;if("interact"===i)return`<img src="${ip}" />`;if("movement"===i)return pt("theJoystick")}if("movement"===i){if(this.game.inputs.gamepad.isActive)return"the left joystick";{const t=["up","left","down","right"];return[this.htmlBindingLabelSet(t,0),this.htmlBindingLabelSet(t,1)].join(" / ")}}const s=this.relevantBindings(i);return s.length?s.map((t=>this.htmlBindingLabel(t))).join(pt("or")):"UNBOUND"}))}relevantBindings(t){const{keyBindings:e}=this.game;return e.binding(t).bindings.filter((t=>this.game.inputs.gamepad.isActive?t.isGamepadBinding:!t.isGamepadBinding))}htmlBindingLabelSet(t,e){let i=[];for(const s of t){const t=this.relevantBindings(s)[e];t&&i.push(this.htmlBindingLabel(t))}return i.join("")}htmlBindingLabel(t){let e=t.label;return t instanceof kn.KeyboardBind&&(t.keyCode===kn.Keyboard.LEFT&&(e="←"),t.keyCode===kn.Keyboard.RIGHT&&(e="→"),t.keyCode===kn.Keyboard.UP&&(e="↑"),t.keyCode===kn.Keyboard.DOWN&&(e="↓"),t.keyCode===kn.Keyboard.SPACE&&(e="&nbsp;&nbsp;␣&nbsp;&nbsp;"),t.keyCode===kn.Keyboard.SHIFT&&(e=`<img src="${av}" /> ${e}`),e=`<kbd>${e}</kbd>`),t instanceof kn.MouseButtonBind&&(t.button===kn.MouseButton.LEFT_BUTTON&&(e=`<img src="${sv}" />`),t.button===kn.MouseButton.RIGHT_BUTTON&&(e=`<img src="${nv}" />`)),e}bindingLabel(t,e){var i;const{keyBindings:s}=this.game,n=null===(i=s.binding(t).bindings.filter((t=>this.game.inputs.gamepad.isActive?t.isGamepadBinding:!t.isGamepadBinding)))||void 0===i?void 0:i.map((t=>t.label));return(e?n.join(" / "):n[0])||"UNBOUND"}}class ov{constructor(t){this.storage=t,this.cachedIdentity={displayName:null}}get identity(){return{displayName:this.cachedIdentity.displayName}}setIdentity(t){return void 0!==t.displayName&&(this.cachedIdentity.displayName=t.displayName),this.save()}async load(){const[t]=await Promise.all([this.storage.displayName.get()]);this.setIdentity({displayName:t})}async save(){const{displayName:t}=this.cachedIdentity;await Promise.all([this.storage.displayName.set(t)])}async clear(){this.cachedIdentity={displayName:null},await Promise.all([this.storage.displayName.delete()])}}class hv extends a.Z{constructor(){super(...arguments),this.texturePool=new ht,this.soundPool=new Kf,this.keyBindings=new En,this.pokiBridge=new Tn("14fa6511-bc98-460b-b2e0-943b62ca2f22"),this.strings=new rv(this),this.container=document.getElementById("screen-container"),this.plugins=[new r.x,new ev,new m.W(document.querySelector("#canvas-container"),{width:this.params.width,height:this.params.height,resolution:this.params.resolution||Math.floor(window.devicePixelRatio),antialias:!0}),new u.HTMLGamePlugin(document.querySelector("#html-container")),new p.PerformanceGamePlugin(document.querySelector("#performance-renderer-container")),new y.ReactGamePlugin,this.pokiBridge.isPoki?null:new o.O,new iv,this.params.timeKeys?new h.p({speedUpFactor:4,slowDownFactor:.1}):null,ct()||this.pokiBridge.isPoki?null:new l.X(document.querySelector("#html-container")),(()=>{const t=new w.p(new Map([[Mi.GAMEPLAY,this.soundPool.soundtrackGameplay]]));return t.soundtrack.fadeDuration=0,t})(),new c.Z,ct()?null:new d.w(document.querySelector("#html-container"),`${yt.current.version} ${yt.current.commitHash}`,`\n                font-family: ${g};\n                font-size: ${n.Typography.s};\n                `)].filter((t=>t))}setup(){var t;super.setup(),t=this.params.locale,ut=t.split("-")[0],this.plugin(w.p).watchHowls(this.soundPool.allHowls),window.addEventListener("blur",(()=>this.updateMuteStatus()),!1),window.addEventListener("focus",(()=>this.updateMuteStatus()),!1),ct()&&document.body.classList.add("mobile"),this.storage=new Zf(this.plugin(r.x).localJsonStore),this.progression=new $f(this.storage),this.settings=new Jf(this.storage,(t=>this.applySettings(t))),this.achievements=new qf(this.storage,function(){const t=new Li({id:"perfect-parry",label:pt("achievementPerfectParry"),matcher:{filterEvent:t=>{var e;return null===(e=vn(t,Wi))||void 0===e?void 0:e.isPerfect}}}),e=new Li({id:"level-up",label:pt("achievementLevelUp"),matcher:{filterEvent:t=>!!vn(t,Fi)}}),i=new Li({id:"kill-wizard",label:pt("achievementKillWizard"),matcher:{filterEvent:t=>t instanceof Ii.y&&t.event instanceof Vi&&!!t.entity.traitOfType(wn)}}),s=new Li({id:"kill-king",label:pt("achievementKillKing"),matcher:{filterEvent:t=>t instanceof Ii.y&&t.event instanceof Vi&&!!t.entity.traitOfType(yn)}}),n=new Li({id:"knock-off-horse",label:pt("achievementKnockOffHorse"),matcher:{filterEvent:t=>!!vn(t,Hi)}}),a=new Li({id:"return-axe",label:pt("achievementReturnAxe"),matcher:{filterEvent:t=>{const e=vn(t,Cs);return!!e&&!e.victim.traitOfType(ln)}}}),r=new Li({id:"cancel-burn",label:pt("achievementCancelBurn"),matcher:{filterEvent:t=>!!vn(t,Di)&&t instanceof Ii.y&&!!t.entity.traitOfType(ln)}}),o=new Bi({id:"combo-25x",label:Ai.A.render(pt("achievementComboX"),{x:25}),isAchieved:t=>{var e;return(null===(e=bn(t))||void 0===e?void 0:e.traitOfType(fn).combo)>=25}}),h=new Bi({id:"combo-50x",label:Ai.A.render(pt("achievementComboX"),{x:50}),isAchieved:t=>{var e;return(null===(e=bn(t))||void 0===e?void 0:e.traitOfType(fn).combo)>=50}}),l=new Bi({id:"combo-100x",label:Ai.A.render(pt("achievementComboX"),{x:100}),isAchieved:t=>{var e;return(null===(e=bn(t))||void 0===e?void 0:e.traitOfType(fn).combo)>=100}}),c=Si(),d=new Bi({id:"customize-all-categories",label:pt("achievementCustomizeAllCategories"),isAchieved:t=>{var e,i;const s=null===(i=null===(e=bn(t))||void 0===e?void 0:e.traitOfType(mn))||void 0===i?void 0:i.inventory;return!!s&&s.tool.id!==c.tool.id&&s.armor.id!==c.armor.id&&s.shield.id!==c.shield.id&&s.helmet.id!==c.helmet.id}}),u=new Bi({id:"level-10",label:Ai.A.render(pt("achievementLevelX"),{x:10}),isAchieved:t=>{var e;return(null===(e=bn(t))||void 0===e?void 0:e.traitOfType(Xs).level)>=10}}),p=new Bi({id:"level-20",label:Ai.A.render(pt("achievementLevelX"),{x:20}),isAchieved:t=>{var e;return(null===(e=bn(t))||void 0===e?void 0:e.traitOfType(Xs).level)>=20}}),m=new _i({id:"buy-something",label:pt("achievementBuySomething"),eventLabel:Pi.BUY,eventCount:1}),y={eventLabel:Pi.KILL,filterEvent:t=>t instanceof Ii.y&&t.event instanceof Vi&&!!t.entity.traitOfType(Ki)},w=new Li({id:"kill-enemy-50",label:Ai.A.render(pt("killXEnemies"),{x:50}),matcher:y,eventCount:50}),g=new Li({id:"kill-enemy-100",label:Ai.A.render(pt("killXEnemies"),{x:100}),matcher:y,eventCount:100}),f=new Li({id:"kill-enemy-250",label:Ai.A.render(pt("killXEnemies"),{x:250}),matcher:y,eventCount:250});return[m,t,e,u,p,new Li({id:"survival-wave-5",label:Ai.A.render(pt("reachWaveXInSurvival"),{x:5}),matcher:{filterEvent:t=>t instanceof Gi&&t.waveId>=5}}),o,h,l,i,s,n,a,r,d,w,g,f]}()),this.identity=new ov(this.storage),this.navigator=new hw(this.screenStack,this.pokiBridge),document.addEventListener("focusin",(t=>this.plugin(w.p).playSoundEffect((0,wt.F5)(this.soundPool.click),.2))),this.plugin(m.W).setDebugVisible(this.params.debug),this.pokiBridge.isPoki&&this.pokiBridge.playtestSetCanvas(this.plugin(m.W).renderer.view),this.plugin(p.PerformanceGamePlugin).gameStats.enableExtension("pixi",[f,this.plugin(m.W).app]),this.plugin(p.PerformanceGamePlugin).setRendererVisible(!1),this.plugin(w.p).soundtrack.fadeDuration=0,this.plugin(w.p).setMasterVolume(.5),this.plugin(w.p).soundtrack.setVolume(1),this.start()}applySettings(t){this.plugin(p.PerformanceGamePlugin).setRendererVisible(t.performance)}async start(){await Promise.all([this.pokiBridge.initialize(),this.navigator.loadAssets(),this.progression.load(),this.settings.load(),this.achievements.load(),this.identity.load()]);const t=new Set(this.progression.progression.ownedItems),e=Ci();for(const i of e.items())0===i.price&&t.add(i.item.id);this.progression.setProgression({ownedItems:t});const i=new cw;i.bind(this),i.setup(),this.params.test?this.navigator.test():this.progression.progression.levelIndex<=0?await Pn({navigator:this.navigator,progressionRepository:this.progression}):await Mn({navigator:this.navigator,progressionRepository:this.progression})}onCurrentScreenChanged(){super.onCurrentScreenChanged(),window.S=this.screenStack.current(),this.updateMuteStatus()}updateMuteStatus(){const t=!!this.screenStack.findByType(Nn)||!!this.screenStack.findByType(Dy);this.plugin(w.p).setMuted(!document.hasFocus()&&!this.pokiBridge.isPoki||t)}}s.A1g.curves.maxLength=5;const lv={width:1600,height:900,debug:!1,maxFrameInterval:.2,locale:navigator.language};window.addEventListener("load",(async()=>{"http:"!==location.protocol||location.port?(window.G=new hv(lv),window.G.setup()):location.href=location.href.replace("http://","https://")}),!1)},2634:()=>{}},i={};function s(t){var n=i[t];if(void 0!==n)return n.exports;var a=i[t]={exports:{}};return e[t].call(a.exports,a,a.exports,s),a.exports}s.m=e,t=[],s.O=(e,i,n,a)=>{if(!i){var r=1/0;for(c=0;c<t.length;c++){for(var[i,n,a]=t[c],o=!0,h=0;h<i.length;h++)(!1&a||r>=a)&&Object.keys(s.O).every((t=>s.O[t](i[h])))?i.splice(h--,1):(o=!1,a<r&&(r=a));if(o){t.splice(c--,1);var l=n();void 0!==l&&(e=l)}}return e}a=a||0;for(var c=t.length;c>0&&t[c-1][2]>a;c--)t[c]=t[c-1];t[c]=[i,n,a]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.e=()=>Promise.resolve(),s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=i[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t})(),(()=>{var t={524:0};s.O.j=e=>0===t[e];var e=(e,i)=>{var n,a,[r,o,h]=i,l=0;if(r.some((e=>0!==t[e]))){for(n in o)s.o(o,n)&&(s.m[n]=o[n]);if(h)var c=h(s)}for(e&&e(i);l<r.length;l++)a=r[l],s.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return s.O(c)},i=self.webpackChunkp2g_client=self.webpackChunkp2g_client||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n=s.O(void 0,[881],(()=>s(289)));n=s.O(n)})();