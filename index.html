<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SHS Gamesite</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3290829368025891"
     crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    color: #ffffff;
    position: relative;
    overflow-x: hidden;
    min-height: 100vh;
    line-height: 1.6;
}

/* Visitor Counter Top Bar */
#visitorCounter {
    width: 100%;
    text-align: center;
    background: rgba(15, 15, 25, 0.8);
    backdrop-filter: blur(20px);
    padding: 10px 0;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.9);
    position: relative;
    z-index: 1000;
    font-weight: 500;
    border-bottom: 1px solid rgba(255, 215, 0, 0.15);
    letter-spacing: 0.5px;
}

/* Header */
header {
    background: rgba(15, 15, 25, 0.6);
    backdrop-filter: blur(20px);
    color: #ffffff;
    padding: 20px 40px;
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

header .headerText { 
    line-height: 1.5; 
    text-align: center; 
    letter-spacing: -0.5px;
}
header small { 
    font-size: 12px; 
    font-weight: 400; 
    display: block; 
    margin-top: 6px; 
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.3px;
}

#adminBtn, #replayTutorialBtn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    font-weight: 500;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid rgba(255, 215, 0, 0.3);
    background: rgba(255, 215, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s ease;
    color: #FFD700;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

#adminBtn {
    left: 20px;
}

#replayTutorialBtn {
    right: 20px;
}

#adminBtn:hover, #replayTutorialBtn:hover { 
    background: rgba(255, 215, 0, 0.2);
    border-color: rgba(255, 215, 0, 0.5);
    transform: translateY(-50%) scale(1.05);
}

/* Controls - Modern Collapsible Design */
.controls {
    background: rgba(15, 15, 25, 0.4);
    backdrop-filter: blur(20px);
    padding: 0;
    margin: 30px auto;
    max-width: 1400px;
    border-radius: 20px;
    border: 1px solid rgba(255, 215, 0, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.control-section {
    border-bottom: 1px solid rgba(255, 215, 0, 0.08);
}

.control-section:last-child {
    border-bottom: none;
}

.control-section-header {
    padding: 18px 24px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
    background: rgba(255, 215, 0, 0.03);
}

.control-section-header:hover {
    background: rgba(255, 215, 0, 0.06);
}

.control-section-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.control-section-header i {
    transition: transform 0.3s ease;
    color: rgba(255, 215, 0, 0.6);
}

.control-section.active .control-section-header i {
    transform: rotate(180deg);
}

.control-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0;
    padding: 0 24px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                padding-bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                gap 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.control-section.active .control-group {
    max-height: 800px;
    padding: 20px 24px;
    gap: 12px;
}

/* Ensure closed sections are completely hidden */
.control-section:not(.active) .control-group {
    max-height: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    gap: 0 !important;
}

.controls button {
    padding: 14px 18px;
    border: 1px solid rgba(255, 215, 0, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    border-radius: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    letter-spacing: 0.3px;
}

.controls button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,215,0,0.15), transparent);
    transition: left 0.5s ease;
}

.controls button:hover::before {
    left: 100%;
}

.controls button:hover {
    background: rgba(255, 215, 0, 0.15);
    border-color: rgba(255, 215, 0, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.2);
    color: #FFD700;
}

.controls button:active {
    transform: translateY(0);
}

/* Iframe */
#iframeContainer {
    position: relative;
    margin: 30px auto;
    max-width: 1400px;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 215, 0, 0.1);
    background: rgba(15, 15, 25, 0.3);
    backdrop-filter: blur(10px);
}

#embeddedSite {
    width: 100%;
    height: calc(100vh - 450px);
    min-height: 600px;
    border: none;
    border-radius: 24px;
    box-sizing: border-box;
    transition: all 0.3s ease;
    background: #ffffff;
    display: block;
}

/* Tutorial Bubble */
#tutorialOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter:blur(3px); z-index:9999; display:none; }
.tutorialBubble {
    position: absolute; max-width:350px; background: rgba(255, 255, 255, 0.95); backdrop-filter:blur(15px); color:#333;
    padding:25px; border-radius: 15px; border: 1px solid rgba(255, 215, 0, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    text-align:center; font-size:16px; opacity:0;
    transform: translate(-50%, -20px); transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.tutorialBubble.show { opacity:1; transform: translate(-50%,0); }
.tutorialBubble button { margin-top:15px; padding:10px 20px; border: none; background: rgba(255, 215, 0, 0.8); color:#000000; border-radius: 10px; cursor:pointer; font-weight: 600; backdrop-filter:blur(10px); }
.tutorialBubble button:hover { background: rgba(255, 215, 0, 1); }

#tutorialArrow {
    position:absolute; width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent;
    border-bottom:18px solid #ffffff; z-index:10000; transition: all 0.4s ease;
}

/* Fullscreen Popup */
#fullscreenPopup {
    position: fixed; top:0; left:0; width:100%; height:100%; display:flex;
    justify-content:center; align-items:center; z-index:10001; opacity:0; pointer-events:none;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(255,215,0,0.1)); backdrop-filter:blur(8px);
    flex-direction: column; color:#ffffff; text-align:center;
}
#fullscreenPopup.show { opacity:1; pointer-events:auto; }
#fullscreenPopup .popupContent {
    max-width: 600px; padding: 60px; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,215,0,0.05)); backdrop-filter:blur(25px); border-radius: 25px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 215, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.3);
    color: #2c3e50; position: relative; overflow: hidden;
}
#fullscreenPopup .popupContent::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #FFD700, #000000, #FFFFFF, #FFD700);
}
#fullscreenPopup h1 { font-size:36px; margin:0 0 30px 0; font-weight: 800; color: #FFD700; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
#fullscreenPopup p { font-size:20px; margin:0; line-height: 1.6; color: #000000; font-weight: 400; }
#fullscreenPopup .closeBtn {
    position:absolute; top:20px; right:20px; border: none; background: rgba(255, 215, 0, 0.8); color:#000000;
    font-size:20px; cursor:pointer; width: 45px; height: 45px; border-radius: 50%; backdrop-filter:blur(10px); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
}
#fullscreenPopup .closeBtn:hover { background: rgba(255, 215, 0, 1); transform: scale(1.1); }

/* Close button hover effects */
#closeThemeBtn:hover, #closeAchievementsBtn:hover, #closeStatsBtn:hover, #closeAdminBtn:hover {
  background: rgba(255, 215, 0, 0.2) !important;
  transform: scale(1.05);
}


/* Stars */
#starCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

/* Sparkles */
#sparkleCanvas {
    position: absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    pointer-events: none; /* <<< add this */
}

/* Custom Context Menu */
#customContextMenu {
    position: fixed;
    background: rgba(255, 215, 0, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    padding: 8px 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    display: none;
    min-width: 120px;
}

#customContextMenu .menu-item {
    display: block;
    width: 100%;
    padding: 8px 16px;
    background: none;
    border: none;
    color: #000000;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s ease;
}

#customContextMenu .menu-item:hover {
    background: rgba(255, 215, 0, 0.8);
}

/* Chat Box */
#chatContainer {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 380px;
    max-height: 500px;
    overflow: hidden;
    background: rgba(15, 15, 25, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 215, 0, 0.2);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
}

#chatContainer header {
    font-weight: 600;
    padding: 18px 20px;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: rgba(255, 255, 255, 0.95);
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
    background: rgba(255, 215, 0, 0.05);
}

#chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    min-height: 200px;
}

#chatContainer input {
    width: calc(100% - 40px);
    margin: 16px 20px;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 215, 0, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.9);
    font-size: 14px;
    transition: all 0.3s ease;
}

#chatContainer input:focus {
    outline: none;
    border-color: rgba(255, 215, 0, 0.5);
    background: rgba(255, 255, 255, 0.08);
}

#chatContainer input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

#changeNameBtn {
    font-size: 12px;
    cursor: pointer;
    color: #FFD700;
    transition: color 0.3s ease;
    font-weight: 500;
}

#changeNameBtn:hover {
    color: #ffed4e;
}

/* Drawing Modal */
#drawingModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  z-index: 20000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
#drawingModal .modalInner {
   width: min(1200px, 96%);
   max-height: 92%;
   overflow: auto;
   border-radius: 24px;
   background: rgba(15, 15, 25, 0.95);
   backdrop-filter: blur(30px);
   border: 1px solid rgba(255, 215, 0, 0.2);
   box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
   padding: 30px;
   position: relative;
   color: rgba(255, 255, 255, 0.9);
}
#drawingModal .closeDrawing {
  position: absolute;
  top: 10px; right: 10px;
  border: none; background: #007bff; color:#ffffff; font-size: 20px; cursor: pointer;
  width:30px; height:30px; border-radius:4px;
}
#sharedCanvasContainer {
  width: 100%;
  background: #f9f9f9;
  border-radius: 4px;
  padding:15px;
  box-sizing:border-box;
}
#canvasArea { border: 1px solid #ccc; border-radius: 4px; overflow:hidden; background: #ffffff; display:block; }
#sharedCanvas { width:100%; height:500px; display:block; background: #ffffff; touch-action:none; }
#toggleCanvasBtn { padding: 8px 16px; border-radius: 4px; cursor:pointer; border: 1px solid #007bff; background: #007bff; color: #ffffff; font-weight: 500; transition: all 0.2s ease; }
#toggleCanvasBtn:hover { background: #0056b3; }

/* ================= THEME STYLES ================= */

/* Light Theme */
.theme-light body {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  color: #212529;
  animation: none;
}
.theme-light #visitorCounter {
  background: linear-gradient(90deg, #ffffff, #f8f9fa);
  color: #007bff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-bottom: 1px solid #dee2e6;
  text-shadow: none;
}
.theme-light header {
  background: linear-gradient(135deg, #ffffff, #f8f9fa);
  color: #007bff;
  border-bottom: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-shadow: none;
}
.theme-light .controls {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-bottom: 1px solid #dee2e6;
}
.theme-light .controls button {
  border-color: #007bff;
  background: #007bff;
  color: #ffffff;
}
.theme-light .controls button:hover {
  background: #0056b3;
}
.theme-light #chatContainer {
  background: #ffffff;
  border: 1px solid #dee2e6;
  color: #212529;
}
.theme-light #drawingModal .modalInner {
  background: #ffffff;
  border: 1px solid #dee2e6;
}

/* Neon Theme */
.theme-neon body {
  background: linear-gradient(135deg, #0a0e27, #1a1a3e);
  color: #ffffff;
  animation: neonPulse 3s ease-in-out infinite;
}
@keyframes neonPulse {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.1); }
}
.theme-neon #visitorCounter {
  background: linear-gradient(90deg, #1a1a3e, #2a2a5e);
  color: #ff00ff;
  box-shadow: 0 0 20px rgba(255,0,255,0.5);
  border-bottom: 2px solid #ff00ff;
  text-shadow: 0 0 10px rgba(255,0,255,0.8);
}
.theme-neon header {
  background: linear-gradient(135deg, #1e1e4e, #2a2a6e);
  color: #00ffff;
  border-bottom: 2px solid #00ffff;
  box-shadow: 0 0 30px rgba(0,255,255,0.4);
  text-shadow: 0 0 15px rgba(0,255,255,0.8);
}
.theme-neon .controls {
  background: linear-gradient(135deg, #1a1a3e, #2a2a5e);
  border-bottom: 1px solid #00ffff;
}
.theme-neon .controls button {
  border-color: #ff00ff;
  background: rgba(255,0,255,0.2);
  color: #ff00ff;
  box-shadow: 0 0 10px rgba(255,0,255,0.3);
}
.theme-neon .controls button:hover {
  background: rgba(255,0,255,0.4);
  box-shadow: 0 0 20px rgba(255,0,255,0.6);
}
.theme-neon #iframeContainer #embeddedSite {
  border-color: #00ffff;
  box-shadow: 0 0 30px rgba(0,255,255,0.5);
}
.theme-neon #chatContainer {
  background: rgba(26,26,62,0.95);
  border: 1px solid #00ffff;
  box-shadow: 0 0 20px rgba(0,255,255,0.3);
  color: #ffffff;
}
.theme-neon #drawingModal .modalInner {
  background: #1a1a3e;
  border: 1px solid #00ffff;
  box-shadow: 0 0 30px rgba(0,255,255,0.3);
  color: #ffffff;
}

/* Ocean Theme */
.theme-ocean body {
  background: linear-gradient(135deg, #001122, #003344);
  color: #00ffff;
  animation: oceanWave 8s ease-in-out infinite;
}
@keyframes oceanWave {
  0%, 100% { background: linear-gradient(135deg, #001122, #003344); }
  50% { background: linear-gradient(135deg, #002233, #004455); }
}
.theme-ocean #visitorCounter {
  background: linear-gradient(90deg, #002244, #003355);
  color: #00ffff;
  box-shadow: 0 0 15px rgba(0,255,255,0.4);
  border-bottom: 1px solid #00ffff;
  text-shadow: 0 0 8px rgba(0,255,255,0.6);
}
.theme-ocean header {
  background: linear-gradient(135deg, #001133, #002244);
  color: #00ffff;
  border-bottom: 2px solid #00ffff;
  box-shadow: 0 0 25px rgba(0,255,255,0.3);
  text-shadow: 0 0 12px rgba(0,255,255,0.7);
}
.theme-ocean .controls {
  background: linear-gradient(135deg, #001122, #002233);
  border-bottom: 1px solid #00ffff;
}
.theme-ocean .controls button {
  border-color: #00ffff;
  background: rgba(0,255,255,0.1);
  color: #00ffff;
}
.theme-ocean .controls button:hover {
  background: rgba(0,255,255,0.3);
  box-shadow: 0 0 15px rgba(0,255,255,0.5);
}

/* Forest Theme */
.theme-forest body {
  background: linear-gradient(135deg, #0a1a0a, #1a2a1a);
  color: #00ff88;
}
.theme-forest #visitorCounter {
  background: linear-gradient(90deg, #1a2a1a, #2a3a2a);
  color: #00ff88;
  box-shadow: 0 0 15px rgba(0,255,136,0.4);
  border-bottom: 1px solid #00ff88;
  text-shadow: 0 0 8px rgba(0,255,136,0.6);
}
.theme-forest header {
  background: linear-gradient(135deg, #0a1a0a, #1a2a1a);
  color: #00ff88;
  border-bottom: 2px solid #00ff88;
  box-shadow: 0 0 25px rgba(0,255,136,0.3);
  text-shadow: 0 0 12px rgba(0,255,136,0.7);
}
.theme-forest .controls {
  background: linear-gradient(135deg, #1a2a1a, #2a3a2a);
  border-bottom: 1px solid #00ff88;
}
.theme-forest .controls button {
  border-color: #00ff88;
  background: rgba(0,255,136,0.1);
  color: #00ff88;
}
.theme-forest .controls button:hover {
  background: rgba(0,255,136,0.3);
  box-shadow: 0 0 15px rgba(0,255,136,0.5);
}

/* Sunset Theme */
.theme-sunset body {
  background: linear-gradient(135deg, #2a1810, #3a2415);
  color: #ffaa00;
}
.theme-sunset #visitorCounter {
  background: linear-gradient(90deg, #3a2415, #4a301a);
  color: #ffaa00;
  box-shadow: 0 0 15px rgba(255,170,0,0.4);
  border-bottom: 1px solid #ffaa00;
  text-shadow: 0 0 8px rgba(255,170,0,0.6);
}
.theme-sunset header {
  background: linear-gradient(135deg, #2a1810, #3a2415);
  color: #ffaa00;
  border-bottom: 2px solid #ffaa00;
  box-shadow: 0 0 25px rgba(255,170,0,0.3);
  text-shadow: 0 0 12px rgba(255,170,0,0.7);
}
.theme-sunset .controls {
  background: linear-gradient(135deg, #3a2415, #4a301a);
  border-bottom: 1px solid #ffaa00;
}
.theme-sunset .controls button {
  border-color: #ffaa00;
  background: rgba(255,170,0,0.1);
  color: #ffaa00;
}
.theme-sunset .controls button:hover {
  background: rgba(255,170,0,0.3);
  box-shadow: 0 0 15px rgba(255,170,0,0.5);
}

/* Seasonal Themes */
.seasonal-christmas body {
  background: linear-gradient(135deg, #1a0a0a, #2a1a1a);
}
.seasonal-christmas body::before {
  content: 'üéÑ‚ùÑÔ∏èüéÖ';
  position: fixed;
  top: 10px;
  right: 10px;
  font-size: 24px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1000;
}
.seasonal-halloween body {
  background: linear-gradient(135deg, #1a0a0a, #2a1a0a);
}
.seasonal-halloween body::before {
  content: 'üéÉüëªüï∑Ô∏è';
  position: fixed;
  top: 10px;
  right: 10px;
  font-size: 24px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1000;
}
.seasonal-spring body {
  background: linear-gradient(135deg, #0a1a0a, #1a2a1a);
}
.seasonal-spring body::before {
  content: 'üå∏üåºüåª';
  position: fixed;
  top: 10px;
  right: 10px;
  font-size: 24px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1000;
}
.seasonal-summer body {
  background: linear-gradient(135deg, #1a2a0a, #2a3a1a);
}
.seasonal-summer body::before {
  content: '‚òÄÔ∏èüèñÔ∏èüå¥';
  position: fixed;
  top: 10px;
  right: 10px;
  font-size: 24px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1000;
}

/* Responsive design */
@media (max-width: 768px) {
  .controls {
    margin: 20px 10px;
    border-radius: 16px;
  }
  .control-group {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    padding: 16px 18px;
  }
  .control-section-header {
    padding: 16px 18px;
  }
  .controls button {
    font-size: 12px;
    padding: 12px 14px;
  }
  #chatContainer {
    width: calc(100% - 20px);
    right: 10px;
    bottom: 10px;
    max-height: 60vh;
  }
  #iframeContainer {
    margin: 20px 10px;
    border-radius: 16px;
  }
  #embeddedSite {
    height: calc(100vh - 500px);
    min-height: 400px;
  }
  header {
    padding: 16px 20px;
    font-size: 20px;
  }
  header small {
    font-size: 11px;
  }
  #adminBtn, #replayTutorialBtn {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
  #adminBtn {
    left: 12px;
  }
  #replayTutorialBtn {
    right: 12px;
  }
  #sharedCanvas { height: 400px; }
}
@media (max-width: 480px) {
  .control-group {
    grid-template-columns: 1fr;
  }
  #chatContainer {
    width: calc(100% - 16px);
    right: 8px;
    bottom: 8px;
  }
  #sharedCanvas { height: 300px; }
  header {
    font-size: 18px;
    padding: 14px 16px;
  }
}
</style>
</head>
<body>
<canvas id="starCanvas"></canvas>
<!-- Cool Intro Loading Screen -->
<div id="introScreen">
  <div class="introParticles"></div>
  <div class="introContent">
    <div class="logoBounce">
      <img src="logoshs.png" alt="Logo" />
    </div>
    <div class="introText">Welcome to gooner gamesite</div>
    <div class="typingDots"><span></span><span></span><span></span></div>
  </div>
</div>

<style>
/* Fullscreen intro */
#introScreen {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: linear-gradient(135deg, #000000, #1a1a1a);
    display:flex; justify-content:center; align-items:center;
    z-index:99999; overflow:hidden;
    flex-direction: column;
}

.introContent {
    text-align:center;
    color:#ffffff;
    font-family:'Segoe UI', sans-serif;
}

.logoBounce img {
    width:120px;
    animation: bounce 1.5s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

.introText {
    font-size: 2rem;
    margin-top:15px;
    animation: fadeIn 2s ease-in-out forwards;
    opacity:0;
    color: #ffffff;
}

.typingDots {
    margin-top:15px;
    display:flex; justify-content:center; gap:8px;
}

.typingDots span {
    width:10px; height:10px; border-radius: 2px;
    background: #FFD700; opacity:0.3;
    animation: blink 1.5s infinite;
}

.typingDots span:nth-child(1){ animation-delay:0s; }
.typingDots span:nth-child(2){ animation-delay:0.3s; }
.typingDots span:nth-child(3){ animation-delay:0.6s; }

@keyframes blink {
    0%, 80%, 100% { opacity:0.3; }
    40% { opacity:1; }
}

@keyframes fadeIn { 0% {opacity:0;} 100% {opacity:1;} }

/* Particle effect background */
.introParticles {
    position:absolute; top:0; left:0; width:100%; height:100%;
    pointer-events:none;
}
</style>

<div id="visitorCounter">Visitors Online: 0 | Total Visitors: 0</div>

<header>
    <button id="adminBtn" title="Admin Panel" style="position:absolute; top:15px; left:15px; width:35px; height:35px; font-weight:bold; font-size:16px; border-radius: 4px; border: 1px solid #FFD700; background: #FFD700; cursor:pointer; transition: all 0.3s ease; color: #000000;">‚öô</button>
    <div class="headerText">
        SHS - Gooner Gamesite <br>
        <small>SPS-devices Wi-Fi Password: 7&UI0)jk</small>
    </div>
    <button id="replayTutorialBtn" title="Replay Tutorial">T</button>
</header>

<div class="controls">
    <div class="control-section active">
        <div class="control-section-header">
            <h3><i class="fas fa-gamepad"></i> Game Controls</h3>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="control-group">
            <button id="reloadBtn"><i class="fas fa-redo"></i> Reload</button>
            <button id="fullscreenBtn"><i class="fas fa-expand"></i> Fullscreen</button>
            <button id="zoomInBtn"><i class="fas fa-search-plus"></i> Zoom In</button>
            <button id="zoomOutBtn"><i class="fas fa-search-minus"></i> Zoom Out</button>
            <button id="hideIframeBtn"><i class="fas fa-eye-slash"></i> Hide</button>
            <button id="showIframeBtn"><i class="fas fa-eye"></i> Show</button>
        </div>
    </div>
    <div class="control-section active">
        <div class="control-section-header">
            <h3><i class="fas fa-globe"></i> Sites & Browser</h3>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="control-group">
            <button id="extraSiteBtn"><i class="fas fa-gamepad"></i> Extra Site</button>
            <button id="privacyBtn"><i class="fas fa-shield-alt"></i> Browser</button>
        </div>
    </div>
    <div class="control-section active">
        <div class="control-section-header">
            <h3><i class="fas fa-tools"></i> Features</h3>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="control-group">
            <button id="openDrawingBtn"><i class="fas fa-paint-brush"></i> Drawing</button>
            <button id="toggleChatBtn"><i class="fas fa-comments"></i> Chat</button>
            <button id="themeBtn"><i class="fas fa-palette"></i> Themes</button>
            <button id="achievementsBtn"><i class="fas fa-trophy"></i> Achievements</button>
            <button id="statsBtn"><i class="fas fa-chart-bar"></i> Stats</button>
        </div>
    </div>
</div>

<div id="iframeContainer">
    <iframe id="embeddedSite" src="https://slopegame.online"></iframe>
</div>

<div id="tutorialOverlay">
    <div class="tutorialBubble" id="tutorialBubble">Tutorial text here
        <br><button id="nextTutorialBtn">Next</button>
    </div>
</div>
<div id="tutorialArrow" style="display:none;"></div>

<div id="fullscreenPopup">
    <div class="popupContent" id="popupContent">
        <button class="closeBtn">&times;</button>
        <h1>Welcome to SHS Gamesite</h1>
        <p>Discover unblocked games, browse freely, and enjoy our interactive features.<br>Let's get started!</p>
        <canvas id="sparkleCanvas"></canvas>
    </div>
</div>

<div id="chatContainer" style="display:none;">
    <header>
        Chat <span id="changeNameBtn" style="color:#000000;">Change Name/Color</span>
        <span id="typingIndicator" style="font-size:12px;color:#555;float:right;"></span>
    </header>
    <div id="chatMessages" style="max-height:300px; overflow-y:auto; padding:5px;"></div>
    <input type="text" id="chatInput" placeholder="Type a message...">
</div>



<div id="chatNameColorPopup" style="display:none; position:fixed; bottom:80px; right:10px; width:280px; background:#ffffff; padding:15px; border-radius: 8px; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index:10000; color: #333;">
    <label style="font-weight:bold;">Name:</label>
    <input type="text" id="chatPopupUsername" style="width:100%; padding:8px; margin-bottom:10px; border-radius: 4px; border: 1px solid #ccc; background: #f9f9f9;" placeholder="Enter name">

    <label style="font-weight:bold;">Color:</label>
    <input type="color" id="chatPopupColor" value="#007bff" style="width:100%; padding:8px; border-radius: 4px; border: 1px solid #ccc;">

    <button id="chatSaveNameColor" style="margin-top:10px; width:100%; padding:10px; background: #007bff; color:#ffffff; border: none; border-radius: 4px; cursor:pointer; font-weight: 500;">Save</button>
</div>


<!-- Admin Panel -->
<div id="adminModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:20001; align-items:center; justify-content:center;">
  <div style="width:min(550px, 96%); background:rgba(15,15,25,0.95); backdrop-filter:blur(30px); border:1px solid rgba(255,215,0,0.2); border-radius:24px; padding:30px; box-shadow:0 25px 60px rgba(0,0,0,0.5); color:rgba(255,255,255,0.9);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid rgba(255,215,0,0.1);">
      <h2 style="margin:0; color:#FFD700; font-weight:600; font-size:20px;">Admin Panel</h2>
      <button id="closeAdminBtn" style="border:none; background:rgba(255,215,0,0.1); color:#FFD700; font-size:20px; cursor:pointer; width:38px; height:38px; border-radius:12px; transition:all 0.3s ease; border:1px solid rgba(255,215,0,0.2);">&times;</button>
    </div>
    <div id="adminContent" style="display:none;">
      <div style="display:grid; gap:10px;">
        <button id="deleteChatHistoryBtn" style="padding:10px; background:#dc3545; border:1px solid #dc3545; color:#ffffff; border-radius:4px; cursor:pointer; font-weight:500;">Delete All Chat History</button>
        <button id="clearCanvasAdminBtn" style="padding:10px; background:#ffc107; border:1px solid #ffc107; color:#000; border-radius:4px; cursor:pointer; font-weight:500;">Clear Canvas</button>
        <button id="resetVisitorsBtn" style="padding:10px; background:#007bff; border:1px solid #007bff; color:#ffffff; border-radius:4px; cursor:pointer; font-weight:500;">Reset Total Visitors Count</button>
        <button id="logoutAdminBtn" style="padding:10px; background:#6c757d; border:1px solid #6c757d; color:#ffffff; border-radius:4px; cursor:pointer; font-weight:500;">Logout</button>
      </div>
    </div>
    <div id="adminPassword">
      <label style="display:block; margin-bottom:8px;">Enter Admin Password:</label>
      <input type="password" id="adminPasswordInput" placeholder="Password" style="width:100%; padding:8px; border:1px solid #ccc; background:#f9f9f9; border-radius:4px; box-sizing:border-box; margin-bottom:10px;">
      <button id="adminLoginBtn" style="width:100%; padding:10px; background:#007bff; border:1px solid #007bff; color:#ffffff; border-radius:4px; cursor:pointer; font-weight:500;">Login</button>
    </div>
  </div>
</div>

<!-- ================ NEW: drawing modal (hidden by default) ================ -->
<div id="drawingModal" aria-hidden="true">
  <div class="modalInner" role="dialog" aria-modal="true" aria-label="Shared Drawing Canvas">
    <button class="closeDrawing" id="closeDrawingBtn" title="Close Drawing">&times;</button>

    <!-- Shared Drawing Canvas UI (drop-in) -->
    <div id="sharedCanvasContainer" style="position:relative;">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
        <button id="toggleCanvasBtn">Open/Close Canvas</button>

        <div style="display:flex; gap:6px; align-items:center; padding:6px 8px; background:#f0f0f0; border-radius:4px; border:1px solid #ccc;">
          <button id="brushToolBtn" title="Brush Tool" style="padding:6px 10px; border:1px solid #007bff; background:#007bff; color:#ffffff; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">‚úè Brush</button>
          <button id="eraserToolBtn" title="Eraser Tool" style="padding:6px 10px; border:1px solid #ccc; background:#ffffff; color:#333; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">üóë Eraser</button>
          <button id="rectangleToolBtn" title="Rectangle Tool" style="padding:6px 10px; border:1px solid #ccc; background:#ffffff; color:#333; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">‚ñ≠ Rectangle</button>
          <button id="circleToolBtn" title="Circle Tool" style="padding:6px 10px; border:1px solid #ccc; background:#ffffff; color:#333; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">‚óã Circle</button>
          <button id="lineToolBtn" title="Line Tool" style="padding:6px 10px; border:1px solid #ccc; background:#ffffff; color:#333; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">‚îÅ Line</button>
          <button id="textToolBtn" title="Text Tool" style="padding:6px 10px; border:1px solid #ccc; background:#ffffff; color:#333; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.2s ease;">T Text</button>
        </div>

        <label style="display:flex;align-items:center;gap:6px;">
          <input id="colorPicker" type="color" value="#007bff" title="Brush Color">
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:12px; color:#999;">Size:</span>
          <input id="sizeSlider" type="range" min="1" max="50" value="4">
          <small id="sizeLabel" style="min-width:25px;">4</small>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:12px; color:#999;">Opacity:</span>
          <input id="opacitySlider" type="range" min="0.1" max="1" step="0.1" value="1">
          <small id="opacityLabel" style="min-width:25px;">1</small>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input id="fillCheckbox" type="checkbox" title="Fill Shapes">
          <span style="font-size:12px; color:#999;">Fill</span>
        </label>
        <button id="undoBtn" title="Undo" style="padding:6px 8px;border-radius:4px;border:1px solid #28a745;background:#28a745;color:#ffffff;cursor:pointer;font-weight:500;">‚Ü∂ Undo</button>
        <button id="eyedropperBtn" title="Eyedropper" style="padding:6px 8px;border-radius:4px;border:1px solid #ccc;background:#ffffff;color:#333;cursor:pointer;font-weight:500;">üíß Eyedropper</button>
        <button id="saveBtn" title="Save Drawing" style="padding:6px 8px;border-radius:4px;border:1px solid #007bff;background:#007bff;color:#ffffff;cursor:pointer;font-weight:500;">üíæ Save</button>
        <button id="loadBtn" title="Load Drawing" style="padding:6px 8px;border-radius:4px;border:1px solid #ccc;background:#ffffff;color:#333;cursor:pointer;font-weight:500;">üìÅ Load</button>
        <button id="zoomInBtn" title="Zoom In" style="padding:6px 8px;border-radius:4px;border:1px solid #28a745;background:#28a745;color:#ffffff;cursor:pointer;font-weight:500;">üîç+</button>
        <button id="zoomOutBtn" title="Zoom Out" style="padding:6px 8px;border-radius:4px;border:1px solid #28a745;background:#28a745;color:#ffffff;cursor:pointer;font-weight:500;">üîç-</button>
        <button id="clearCanvasBtn" style="padding:6px 8px;border-radius:4px;border:1px solid #dc3545;background:#dc3545;color:#ffffff;cursor:pointer;font-weight:500;">Clear</button>
        <div style="margin-left:auto; font-size:12px; color:#777;">Shared canvas (Realtime)</div>
      </div>

      <div id="canvasArea" style="position:relative;">
        <canvas id="sharedCanvas" width="800" height="500" style="display:block; touch-action:none;"></canvas>
        <canvas id="cursorOverlay" width="800" height="500" style="position:absolute; top:0; left:0; cursor:crosshair; background:transparent;"></canvas>
        <div style="padding:8px; font-size:12px; color:#777;">Draw and everyone currently connected will see it. Cursors show where others are drawing.</div>
      </div>
    </div>
    <!-- end shared UI -->
  </div>
</div>
<!-- ====================================================================== -->

<!-- ================ Theme Customizer Modal ================ -->
<div id="themeModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:15000; align-items:center; justify-content:center;">
  <div style="width:min(650px, 95%); background:rgba(15,15,25,0.95); backdrop-filter:blur(30px); border-radius:24px; padding:30px; box-shadow:0 25px 60px rgba(0,0,0,0.5); border:1px solid rgba(255,215,0,0.2); color:rgba(255,255,255,0.9);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,215,0,0.1);">
      <h2 style="margin:0; color:#FFD700; font-weight:600; font-size:20px;"><i class="fas fa-palette"></i> Theme Customizer</h2>
      <button id="closeThemeBtn" style="border:none; background:rgba(255,215,0,0.1); color:#FFD700; font-size:20px; cursor:pointer; width:38px; height:38px; border-radius:12px; transition:all 0.3s ease; border:1px solid rgba(255,215,0,0.2);">&times;</button>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:25px;">
      <button class="theme-option" data-theme="default" style="padding:15px; border:2px solid #007bff; background:linear-gradient(135deg, #0f0f1a, #1a1a2a); color:#00d4ff; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;">
        <div style="font-size:18px; margin-bottom:5px;">üåô</div>
        Default Dark
      </button>
      <button class="theme-option" data-theme="light" style="padding:15px; border:2px solid #ccc; background:linear-gradient(135deg, #f8f9fa, #e9ecef); color:#333; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;">
        <div style="font-size:18px; margin-bottom:5px;">‚òÄÔ∏è</div>
        Light Mode
      </button>
      <button class="theme-option" data-theme="neon" style="padding:15px; border:2px solid #ff00ff; background:linear-gradient(135deg, #0a0e27, #1a1a3e); color:#00ffff; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease; box-shadow:0 0 15px rgba(255,0,255,0.3);">
        <div style="font-size:18px; margin-bottom:5px;">‚ö°</div>
        Neon Glow
      </button>
      <button class="theme-option" data-theme="ocean" style="padding:15px; border:2px solid #00ffff; background:linear-gradient(135deg, #001122, #003344); color:#00ffff; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;">
        <div style="font-size:18px; margin-bottom:5px;">üåä</div>
        Ocean Blue
      </button>
      <button class="theme-option" data-theme="forest" style="padding:15px; border:2px solid #00aa00; background:linear-gradient(135deg, #0a1a0a, #1a2a1a); color:#00ff88; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;">
        <div style="font-size:18px; margin-bottom:5px;">üå≤</div>
        Forest Green
      </button>
      <button class="theme-option" data-theme="sunset" style="padding:15px; border:2px solid #ff6600; background:linear-gradient(135deg, #2a1810, #3a2415); color:#ffaa00; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;">
        <div style="font-size:18px; margin-bottom:5px;">üåÖ</div>
        Sunset Orange
      </button>
    </div>

    <div style="border-top:1px solid #eee; padding-top:20px;">
      <h3 style="margin:0 0 15px 0; color:#007bff;">Seasonal Themes</h3>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="seasonal-theme" data-season="christmas" style="padding:10px 15px; background:#c41e3a; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">
          üéÑ Christmas
        </button>
        <button class="seasonal-theme" data-season="halloween" style="padding:10px 15px; background:#ff6600; color:black; border:none; border-radius:6px; cursor:pointer; font-weight:500;">
          üéÉ Halloween
        </button>
        <button class="seasonal-theme" data-season="spring" style="padding:10px 15px; background:#98fb98; color:#333; border:none; border-radius:6px; cursor:pointer; font-weight:500;">
          üå∏ Spring
        </button>
        <button class="seasonal-theme" data-season="summer" style="padding:10px 15px; background:#ffd700; color:#333; border:none; border-radius:6px; cursor:pointer; font-weight:500;">
          ‚òÄÔ∏è Summer
        </button>
      </div>
    </div>
  </div>
</div>
<!-- ====================================================================== -->

<!-- ================ Achievements Modal ================ -->
<div id="achievementsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:14000; align-items:center; justify-content:center;">
  <div style="width:min(750px, 95%); max-height:80%; overflow-y:auto; background:rgba(15,15,25,0.95); backdrop-filter:blur(30px); border-radius:24px; padding:30px; box-shadow:0 25px 60px rgba(0,0,0,0.5); border:1px solid rgba(255,215,0,0.2); color:rgba(255,255,255,0.9);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,215,0,0.1);">
      <h2 style="margin:0; color:#FFD700; font-weight:600; font-size:20px;"><i class="fas fa-trophy"></i> Achievements</h2>
      <button id="closeAchievementsBtn" style="border:none; background:rgba(255,215,0,0.1); color:#FFD700; font-size:20px; cursor:pointer; width:38px; height:38px; border-radius:12px; transition:all 0.3s ease; border:1px solid rgba(255,215,0,0.2);">&times;</button>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:25px;">
      <div class="achievement-card" id="chatBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üí¨</div>
        <h3 style="margin:5px 0; color:#333;">Chat Master</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Send 10 chat messages</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="chatProgress" style="height:100%; background:#007bff; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="chatCount" style="color:#666;">0/10</small>
      </div>

      <div class="achievement-card" id="drawBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üé®</div>
        <h3 style="margin:5px 0; color:#333;">Artist</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Draw for 30 minutes</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="drawProgress" style="height:100%; background:#28a745; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="drawCount" style="color:#666;">0/30 min</small>
      </div>

      <div class="achievement-card" id="gameBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üéÆ</div>
        <h3 style="margin:5px 0; color:#333;">Gamer</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Play games for 1 hour</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="gameProgress" style="height:100%; background:#ffc107; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="gameCount" style="color:#666;">0/60 min</small>
      </div>

      <div class="achievement-card" id="socialBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üë•</div>
        <h3 style="margin:5px 0; color:#333;">Social Butterfly</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Be online for 2 hours</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="socialProgress" style="height:100%; background:#e83e8c; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="socialCount" style="color:#666;">0/120 min</small>
      </div>

      <div class="achievement-card" id="explorerBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üó∫Ô∏è</div>
        <h3 style="margin:5px 0; color:#333;">Explorer</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Visit all game sites</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="explorerProgress" style="height:100%; background:#17a2b8; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="explorerCount" style="color:#666;">0/2</small>
      </div>

      <div class="achievement-card" id="themeBadge" style="padding:20px; border:2px solid #ccc; border-radius:8px; text-align:center; background:#f8f9fa;">
        <div style="font-size:48px; margin-bottom:10px;">üé®</div>
        <h3 style="margin:5px 0; color:#333;">Stylist</h3>
        <p style="margin:5px 0; font-size:14px; color:#666;">Try 3 different themes</p>
        <div class="progress-bar" style="width:100%; height:8px; background:#e9ecef; border-radius:4px; margin-top:10px;">
          <div class="progress-fill" id="themeProgress" style="height:100%; background:#6f42c1; border-radius:4px; width:0%; transition:width 0.3s ease;"></div>
        </div>
        <small id="themeCount" style="color:#666;">0/3</small>
      </div>
    </div>

    <div style="border-top:1px solid #eee; padding-top:20px;">
      <h3 style="margin:0 0 15px 0; color:#007bff;">Daily Challenges</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:10px;">
        <div class="daily-challenge" style="padding:15px; border:1px solid #dee2e6; border-radius:8px; background:#f8f9fa;">
          <h4 style="margin:0 0 10px 0; color:#007bff;">Today's Goal</h4>
          <p style="margin:0; font-size:14px;">Send 5 messages in chat</p>
          <div class="progress-bar" style="width:100%; height:6px; background:#e9ecef; border-radius:3px; margin-top:10px;">
            <div class="progress-fill" id="dailyProgress" style="height:100%; background:#28a745; border-radius:3px; width:0%; transition:width 0.3s ease;"></div>
          </div>
          <small id="dailyCount" style="color:#666;">0/5</small>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ====================================================================== -->

<!-- ================ Stats Dashboard Modal ================ -->
<div id="statsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:13000; align-items:center; justify-content:center;">
  <div style="width:min(850px, 95%); max-height:80%; overflow-y:auto; background:rgba(15,15,25,0.95); backdrop-filter:blur(30px); border-radius:24px; padding:30px; box-shadow:0 25px 60px rgba(0,0,0,0.5); border:1px solid rgba(255,215,0,0.2); color:rgba(255,255,255,0.9);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,215,0,0.1);">
      <h2 style="margin:0; color:#FFD700; font-weight:600; font-size:20px;"><i class="fas fa-chart-bar"></i> Your Statistics</h2>
      <button id="closeStatsBtn" style="border:none; background:rgba(255,215,0,0.1); color:#FFD700; font-size:20px; cursor:pointer; width:38px; height:38px; border-radius:12px; transition:all 0.3s ease; border:1px solid rgba(255,215,0,0.2);">&times;</button>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:25px;">
      <div class="stat-card" style="background:#f8f9fa; padding:20px; border-radius:8px; text-align:center; border:1px solid #dee2e6;">
        <div style="font-size:36px; color:#007bff; margin-bottom:10px;"><i class="fas fa-clock"></i></div>
        <h3 style="margin:5px 0; color:#333;">Online Time</h3>
        <div style="font-size:24px; font-weight:bold; color:#007bff;" id="onlineTimeStat">0 min</div>
        <small style="color:#666;">Total time spent online</small>
      </div>

      <div class="stat-card" style="background:#f8f9fa; padding:20px; border-radius:8px; text-align:center; border:1px solid #dee2e6;">
        <div style="font-size:36px; color:#28a745; margin-bottom:10px;"><i class="fas fa-comments"></i></div>
        <h3 style="margin:5px 0; color:#333;">Chat Messages</h3>
        <div style="font-size:24px; font-weight:bold; color:#28a745;" id="chatMessagesStat">0</div>
        <small style="color:#666;">Messages sent</small>
      </div>

      <div class="stat-card" style="background:#f8f9fa; padding:20px; border-radius:8px; text-align:center; border:1px solid #dee2e6;">
        <div style="font-size:36px; color:#ffc107; margin-bottom:10px;"><i class="fas fa-gamepad"></i></div>
        <h3 style="margin:5px 0; color:#333;">Gaming Time</h3>
        <div style="font-size:24px; font-weight:bold; color:#ffc107;" id="gamingTimeStat">0 min</div>
        <small style="color:#666;">Time playing games</small>
      </div>

      <div class="stat-card" style="background:#f8f9fa; padding:20px; border-radius:8px; text-align:center; border:1px solid #e83e8c;">
        <div style="font-size:36px; color:#e83e8c; margin-bottom:10px;"><i class="fas fa-paint-brush"></i></div>
        <h3 style="margin:5px 0; color:#333;">Drawing Time</h3>
        <div style="font-size:24px; font-weight:bold; color:#e83e8c;" id="drawingTimeStat">0 min</div>
        <small style="color:#666;">Time spent drawing</small>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
      <div style="background:#f8f9fa; padding:20px; border-radius:8px; border:1px solid #dee2e6;">
        <h3 style="margin:0 0 15px 0; color:#007bff;"><i class="fas fa-trophy"></i> Achievement Progress</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Chat Master</span>
            <span id="chatProgressText">0/10</span>
          </div>
          <div style="width:100%; height:8px; background:#e9ecef; border-radius:4px;">
            <div style="height:100%; background:#007bff; border-radius:4px; width:0%; transition:width 0.3s ease;" id="chatProgressBar"></div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Artist</span>
            <span id="drawProgressText">0/30 min</span>
          </div>
          <div style="width:100%; height:8px; background:#e9ecef; border-radius:4px;">
            <div style="height:100%; background:#28a745; border-radius:4px; width:0%; transition:width 0.3s ease;" id="drawProgressBar"></div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Gamer</span>
            <span id="gameProgressText">0/60 min</span>
          </div>
          <div style="width:100%; height:8px; background:#e9ecef; border-radius:4px;">
            <div style="height:100%; background:#ffc107; border-radius:4px; width:0%; transition:width 0.3s ease;" id="gameProgressBar"></div>
          </div>
        </div>
      </div>

      <div style="background:#f8f9fa; padding:20px; border-radius:8px; border:1px solid #dee2e6;">
        <h3 style="margin:0 0 15px 0; color:#007bff;"><i class="fas fa-calendar-day"></i> Today's Activity</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div style="display:flex; justify-content:space-between;">
            <span>Messages Today:</span>
            <span id="dailyMessagesStat">0</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Time Online Today:</span>
            <span id="dailyOnlineStat">0 min</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Sites Visited:</span>
            <span id="sitesVisitedStat">0</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Themes Tried:</span>
            <span id="themesTriedStat">0</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:20px; padding:15px; background:#e7f3ff; border-radius:8px; border:1px solid #b3d9ff;">
      <h4 style="margin:0 0 10px 0; color:#007bff;"><i class="fas fa-lightbulb"></i> Tips</h4>
      <p style="margin:0; font-size:14px; color:#333;">
        Keep using the site to unlock achievements! Try different themes, chat with friends, and explore all the features.
        Your progress is automatically saved and synced across devices.
      </p>
    </div>
  </div>
</div>
<!-- ====================================================================== -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBn1apVsFafY2-2a2QPeslX17XR0gWE9qs",
  authDomain: "shsproject-d60d0.firebaseapp.com",
  databaseURL: "https://shsproject-d60d0-default-rtdb.firebaseio.com",
  projectId: "shsproject-d60d0",
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('Firebase initialized successfully');
} catch (error) {
  console.error('Firebase initialization error:', error);
  alert('Failed to connect to Firebase. Please check your internet connection.');
  db = null;
}

// Generate a unique visitor ID (per session)
const visitorId = 'visitor_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
console.log('Visitor ID:', visitorId);

// Online presence
if (db) {
  const onlineRef = db.ref('online/' + visitorId);
  onlineRef.set({online:true, timestamp: Date.now()}).catch(error => {
    console.error('Error setting online status:', error);
  });
  onlineRef.onDisconnect().remove();
}

// UI element
const visitorCounter = document.getElementById('visitorCounter');

// Increment total visitors only once per user (use localStorage to avoid duplicates)
if (db && !localStorage.getItem('visitorCounted')) {
    db.ref('totalVisitors').transaction(val => (val || 0) + 1).catch(error => {
      console.error('Error updating visitor count:', error);
    });
    localStorage.setItem('visitorCounted', 'yes');
}

// Listen for online users and total visitors
const totalRef = db ? db.ref('totalVisitors') : null;
const onlineDbRef = db ? db.ref('online') : null;

function updateCounter() {
    if (!onlineDbRef || !totalRef) return;
    onlineDbRef.once('value').then(snap => {
        const online = snap.numChildren();
        totalRef.once('value').then(snap2 => {
            const total = snap2.val() || 0;
            visitorCounter.innerText = `Visitors Online: ${online} | Total Visitors: ${total}`;
        });
    }).catch(error => {
        console.error('Error updating counter:', error);
    });
}

// Update counter live when online users change
if (onlineDbRef && totalRef) {
  onlineDbRef.on('value', updateCounter);
  totalRef.on('value', updateCounter);
}

// ---------------- Chat ----------------
let username = 'Guest' + Math.floor(Math.random()*1000);
let userColor = ['#007bff','#ff4500','#32cd32','#ffa500','#9932cc'][Math.floor(Math.random()*5)];

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const typingIndicator = document.getElementById('typingIndicator');

// Typing indicator
let typing = false;
chatInput.addEventListener('input', () => {
    if (!db) return;
    if(!typing){
        typing = true;
        db.ref('chatTyping/'+visitorId).set(username).catch(error => console.error('Error setting typing:', error));
        setTimeout(stopTyping, 2000);
    } else {
        clearTimeout(stopTyping.timeout);
        stopTyping.timeout = setTimeout(stopTyping, 2000);
    }
});
function stopTyping(){
    if (!db) return;
    typing = false;
    db.ref('chatTyping/'+visitorId).remove().catch(error => console.error('Error removing typing:', error));
}

// Send message
chatInput.addEventListener('keypress', e => {
    if (!db) return;
    if(e.key === 'Enter' && chatInput.value.trim() !== ''){
        const msgData = {
            user: username,
            text: chatInput.value,
            color: userColor,
            time: Date.now(),
            uid: visitorId
        };
        db.ref('chat').push(msgData).catch(error => console.error('Error sending message:', error));
        trackActivity('chat', 1);
        chatInput.value='';
    }
});

// Listen to chat messages
if (db) {
  db.ref('chat').limitToLast(100).on('child_added', snapshot => {
      const msg = snapshot.val();
      const msgDiv = document.createElement('div');
      msgDiv.style.marginBottom='6px';
      msgDiv.style.display='flex';
      msgDiv.style.justifyContent = 'space-between';
      
      const leftDiv = document.createElement('div');
      leftDiv.innerHTML = `<span style="color:${msg.color}; font-weight:bold;">${msg.user}</span>: ${msg.text} 
                           <small style="color:#888; font-size:11px;">${new Date(msg.time).toLocaleTimeString()}</small>`;
      leftDiv.style.maxWidth='85%';
      leftDiv.style.wordWrap='break-word';
      
      // Delete button if owner
      if(msg.uid === visitorId){
          const delBtn = document.createElement('button');
          delBtn.innerHTML='‚úñ';
          delBtn.style.border='none';
          delBtn.style.background='transparent';
          delBtn.style.color='#888';
          delBtn.style.cursor='pointer';
          delBtn.title='Delete';
          delBtn.onclick = () => snapshot.ref.remove();
          leftDiv.appendChild(delBtn);
      }

      msgDiv.appendChild(leftDiv);
      chatMessages.appendChild(msgDiv);

      // Auto-scroll if near bottom
      if(chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 50){
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }
  });

  // Typing indicators
  db.ref('chatTyping').on('value', snap => {
      const typingUsers = Object.values(snap.val()||{}).filter(u => u!==username);
      if(typingUsers.length>0){
          typingIndicator.innerText = typingUsers.join(', ') + ' is typing...';
      } else {
          typingIndicator.innerText = '';
      }
  });
}

// Change Name/Color popup
const changeNameBtn = document.getElementById('changeNameBtn');
const chatNameColorPopup = document.getElementById('chatNameColorPopup');
const chatPopupUsername = document.getElementById('chatPopupUsername');
const chatPopupColor = document.getElementById('chatPopupColor');
const chatSaveNameColor = document.getElementById('chatSaveNameColor');

// Open popup
changeNameBtn.addEventListener('click', () => {
    chatPopupUsername.value = username;
    chatPopupColor.value = userColor;
    chatNameColorPopup.style.display = 'block';
});

// Save changes
chatSaveNameColor.addEventListener('click', () => {
    if(chatPopupUsername.value.trim() !== '') username = chatPopupUsername.value.trim();
    userColor = chatPopupColor.value;
    chatNameColorPopup.style.display = 'none';
});

// ---------------- Collapsible Control Sections ----------------
document.querySelectorAll('.control-section-header').forEach(header => {
  header.addEventListener('click', () => {
    const section = header.parentElement;
    section.classList.toggle('active');
  });
});

// ---------------- Buttons ----------------
const iframe = document.getElementById('embeddedSite');
let zoomLevel = 1;
let originalSrc = iframe.src;
const extraBtn = document.getElementById('extraSiteBtn');
const privacyBtn = document.getElementById('privacyBtn');
let onExtra = false;
let onPrivacy = false;

document.getElementById('reloadBtn').addEventListener('click', ()=>iframe.src = iframe.src);

document.getElementById("fullscreenBtn").addEventListener("click", () => {
    const frame = document.getElementById("embeddedSite");
    frame.requestFullscreen?.();
});

document.getElementById('zoomInBtn').addEventListener('click', ()=>{ zoomLevel += 0.1; iframe.style.transform = `scale(${zoomLevel})`; iframe.style.transformOrigin='top left'; });
document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ zoomLevel = Math.max(0.5, zoomLevel - 0.1); iframe.style.transform = `scale(${zoomLevel})`; iframe.style.transformOrigin='top left'; });
document.getElementById('hideIframeBtn').addEventListener('click', ()=>iframe.style.display='none');
document.getElementById('showIframeBtn').addEventListener('click', ()=>iframe.style.display='block');

extraBtn.addEventListener('click', ()=>{ if(!onExtra){ iframe.src='https://funfrinew.neocities.org/'; extraBtn.innerHTML='<i class="fas fa-arrow-left"></i> Go Back'; onExtra=true; } else { iframe.src=originalSrc; extraBtn.innerHTML='<i class="fas fa-gamepad"></i> Extra Site'; onExtra=false; } });
privacyBtn.addEventListener('click', ()=>{ if(!onPrivacy){ iframe.src="https://webtoppings.bar/browse?url=https://wikipedia.org&region=us-west&mode=privacy"; privacyBtn.innerHTML='<i class="fas fa-arrow-left"></i> Go Back'; onPrivacy=true; } else { iframe.src=originalSrc; privacyBtn.innerHTML='<i class="fas fa-shield-alt"></i> Browser'; onPrivacy=false; } });

// ---------------- Tutorial ----------------
const steps = [
    {text:"Welcome! This tutorial guides you through the buttons.", target:null},
    {text:"Reload: Reloads the embedded site.", target:document.getElementById('reloadBtn')},
    {text:"Fullscreen: Make the site fullscreen.", target:document.getElementById('fullscreenBtn')},
    {text:"Zoom: Scale the site for better view.", target:document.getElementById('zoomInBtn')},
    {text:"Hide/Show: Hide or show the embedded site.", target:document.getElementById('hideIframeBtn')},
    {text:"Extra Site: Open a fun game site.", target:extraBtn},
    {text:"Browser: Browse UNBLOCKED!", target:privacyBtn}
];
let currentStep = 0;
const overlay = document.getElementById('tutorialOverlay');
const bubble = document.getElementById('tutorialBubble');
const arrow = document.getElementById('tutorialArrow');

function showStep(step){
    overlay.style.display='block';
    const s = steps[step];
    bubble.innerHTML = s.text + '<br>' +
        '<button id="nextTutorialBtn">Next</button> ' +
        '<button id="skipTutorialBtn">Skip</button>';

    // Next button
    document.getElementById('nextTutorialBtn').addEventListener('click', ()=>{
        currentStep++;
        if(currentStep >= steps.length){
            overlay.style.display='none';
            arrow.style.display='none';
            showPopup();
        } else showStep(currentStep);
    });

    // Skip button
    document.getElementById('skipTutorialBtn').addEventListener('click', ()=>{
        overlay.style.display='none';
        arrow.style.display='none';
        localStorage.setItem('tutorialShown','true'); // mark tutorial as seen
        showPopup();
    });

    if(s.target){
        const rect = s.target.getBoundingClientRect();
        bubble.style.top = (rect.bottom + 20 + window.scrollY) + 'px';
        bubble.style.left = (rect.left + rect.width/2) + 'px';
        arrow.style.display='block';
        arrow.style.top = (rect.bottom + window.scrollY) + 'px';
        arrow.style.left = (rect.left + rect.width/2 - 12) + 'px';
    } else {
        bubble.style.top='30%';
        bubble.style.left='50%';
        arrow.style.display='none';
    }

    setTimeout(()=>bubble.classList.add('show'),50);
}

function startTutorial(){ currentStep=0; showStep(currentStep); localStorage.setItem('tutorialShown','true'); }
document.getElementById('replayTutorialBtn').addEventListener('click', startTutorial);

// ---------------- Popup ----------------
const popup = document.getElementById('fullscreenPopup');
// Close when clicking the X button
popup.querySelector('.closeBtn').addEventListener('click', () => {
    popup.classList.remove('show');
});

// Close when clicking *anywhere* outside the popupContent
popup.addEventListener('click', (e) => {
        popup.classList.remove('show');
});

function showPopup(){
    popup.classList.add('show');
}

// ================= Admin Panel =================
const adminBtn = document.getElementById('adminBtn');
const adminModal = document.getElementById('adminModal');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminPasswordInput = document.getElementById('adminPasswordInput');
const adminContent = document.getElementById('adminContent');
const adminPassword = document.getElementById('adminPassword');
const deleteChatHistoryBtn = document.getElementById('deleteChatHistoryBtn');
const clearCanvasAdminBtn = document.getElementById('clearCanvasAdminBtn');
const resetVisitorsBtn = document.getElementById('resetVisitorsBtn');
const logoutAdminBtn = document.getElementById('logoutAdminBtn');

const ADMIN_PASSWORD = '12344321';
let isAdminAuthenticated = false;

adminBtn.addEventListener('click', () => {
  adminModal.style.display = 'flex';
  adminPasswordInput.focus();
});

closeAdminBtn.addEventListener('click', () => {
  adminModal.style.display = 'none';
  isAdminAuthenticated = false;
  adminContent.style.display = 'none';
  adminPassword.style.display = '';
  adminPasswordInput.value = '';
});

adminModal.addEventListener('click', (e) => {
  if(e.target === adminModal) {
    adminModal.style.display = 'none';
    isAdminAuthenticated = false;
    adminContent.style.display = 'none';
    adminPassword.style.display = '';
    adminPasswordInput.value = '';
  }
});

adminLoginBtn.addEventListener('click', () => {
  if(adminPasswordInput.value === ADMIN_PASSWORD) {
    isAdminAuthenticated = true;
    adminPassword.style.display = 'none';
    adminContent.style.display = 'block';
  } else {
    alert('Incorrect password');
    adminPasswordInput.value = '';
  }
});

adminPasswordInput.addEventListener('keypress', (e) => {
  if(e.key === 'Enter') {
    adminLoginBtn.click();
  }
});

deleteChatHistoryBtn.addEventListener('click', () => {
  if(confirm('Delete all chat history? This cannot be undone.')) {
    db.ref('chat').remove().then(() => {
      alert('Chat history deleted');
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
    }).catch(err => alert('Error: ' + err.message));
  }
});

clearCanvasAdminBtn.addEventListener('click', () => {
  if(confirm('Clear the drawing canvas? This cannot be undone.')) {
    db.ref('canvas/strokes').remove().then(() => {
      db.ref('canvas/meta/clear').set({ by: 'admin', time: Date.now() });
      setTimeout(() => { db.ref('canvas/meta/clear').remove(); }, 1500);
      alert('Canvas cleared');
    }).catch(err => alert('Error: ' + err.message));
  }
});

resetVisitorsBtn.addEventListener('click', () => {
  if(confirm('Reset total visitors count to 0?')) {
    db.ref('totalVisitors').set(1).then(() => {
      alert('Visitors count reset');
    }).catch(err => alert('Error: ' + err.message));
  }
});

logoutAdminBtn.addEventListener('click', () => {
  isAdminAuthenticated = false;
  adminContent.style.display = 'none';
  adminPassword.style.display = '';
  adminPasswordInput.value = '';
  alert('Logged out');
});

// ---------------- Sparkles ----------------
const canvas = document.getElementById('sparkleCanvas');
const ctx = canvas.getContext('2d');
let sparkles=[];
function resizeCanvas(){ canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight; }
window.addEventListener('resize',resizeCanvas); resizeCanvas();
function createSparkle(){ return { x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*3+1, vx:(Math.random()-0.5)*0.5, vy:(Math.random()-0.5)*0.5, alpha:Math.random(), color:['#007bff','#cccccc','#ffffff'][Math.floor(Math.random()*3)] }; }
for(let i=0;i<150;i++) sparkles.push(createSparkle());
function animateSparkles(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let s of sparkles){
        ctx.beginPath();
        ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
        ctx.fillStyle=`rgba(${parseInt(s.color.slice(1,3),16)},${parseInt(s.color.slice(3,5),16)},${parseInt(s.color.slice(5,7),16)},${s.alpha})`;
        ctx.fill();
        s.x+=s.vx; s.y+=s.vy;
        if(s.x<0||s.x>canvas.width)s.vx*=-1;
        if(s.y<0||s.y>canvas.height)s.vy*=-1;
    }
    requestAnimationFrame(animateSparkles);
}
animateSparkles();

// ---------------- Stars ----------------
const starCanvas = document.getElementById('starCanvas');
const starCtx = starCanvas.getContext('2d');
let stars = [];
let mouseX = 0, mouseY = 0;

function resizeStarCanvas() {
    starCanvas.width = window.innerWidth;
    starCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeStarCanvas);
resizeStarCanvas();

function createStar() {
    return {
        x: Math.random() * starCanvas.width,
        y: Math.random() * starCanvas.height,
        size: Math.random() * 2 + 1,
        brightness: Math.random() * 0.5 + 0.5,
        twinkle: Math.random() * 0.02,
        baseBrightness: Math.random() * 0.5 + 0.5,
        depth: Math.random() * 0.9 + 0.1 // Parallax depth factor
    };
}
for (let i = 0; i < 200; i++) {
    stars.push(createStar());
}

function animateStars() {
    starCtx.clearRect(0, 0, starCanvas.width, starCanvas.height);
    const centerX = starCanvas.width / 2;
    const centerY = starCanvas.height / 2;
    for (let star of stars) {
        // Parallax offset based on mouse position and depth
        const offsetX = (mouseX - centerX) * star.depth * 0.02;
        const offsetY = (mouseY - centerY) * star.depth * 0.02;
        let drawX = star.x + offsetX;
        let drawY = star.y + offsetY;

        // Wrap around edges for seamless parallax
        if (drawX < 0) drawX += starCanvas.width;
        if (drawX > starCanvas.width) drawX -= starCanvas.width;
        if (drawY < 0) drawY += starCanvas.height;
        if (drawY > starCanvas.height) drawY -= starCanvas.height;

        // Calculate distance to mouse for brightness effect
        const dx = mouseX - drawX;
        const dy = mouseY - drawY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        // Increase brightness if close to mouse
        const mouseEffect = Math.max(0, 1 - distance / 100); // within 100px
        star.brightness = star.baseBrightness + mouseEffect * 0.5;
        // Twinkle
        star.brightness += Math.sin(Date.now() * star.twinkle) * 0.1;
        star.brightness = Math.max(0, Math.min(1, star.brightness));

        starCtx.beginPath();
        starCtx.arc(drawX, drawY, star.size, 0, Math.PI * 2);
        starCtx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
        starCtx.fill();
    }
    requestAnimationFrame(animateStars);
}
animateStars();

// Track mouse
document.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
});

// Add floating particles that follow mouse
const floatingParticles = [];
for (let i = 0; i < 50; i++) {
    floatingParticles.push({
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        size: Math.random() * 3 + 1,
        color: ['#FFD700', '#FFFFFF', '#000000'][Math.floor(Math.random() * 3)],
        life: Math.random() * 100 + 50
    });
}

function animateFloatingParticles() {
    const particleCanvas = document.createElement('canvas');
    particleCanvas.id = 'floatingParticlesCanvas';
    particleCanvas.style.position = 'fixed';
    particleCanvas.style.top = '0';
    particleCanvas.style.left = '0';
    particleCanvas.style.width = '100%';
    particleCanvas.style.height = '100%';
    particleCanvas.style.pointerEvents = 'none';
    particleCanvas.style.zIndex = '0';
    document.body.appendChild(particleCanvas);

    const ctx = particleCanvas.getContext('2d');
    particleCanvas.width = window.innerWidth;
    particleCanvas.height = window.innerHeight;

    function drawParticles() {
        ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

        for (let p of floatingParticles) {
            // Attract to mouse
            const dx = mouseX - p.x;
            const dy = mouseY - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
                p.vx += dx * 0.0001;
                p.vy += dy * 0.0001;
            }

            // Update position
            p.x += p.vx;
            p.y += p.vy;

            // Bounce off edges
            if (p.x < 0 || p.x > particleCanvas.width) p.vx *= -1;
            if (p.y < 0 || p.y > particleCanvas.height) p.vy *= -1;

            // Draw
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life / 150;
            ctx.fill();

            p.life--;
            if (p.life <= 0) {
                p.x = Math.random() * particleCanvas.width;
                p.y = Math.random() * particleCanvas.height;
                p.life = Math.random() * 100 + 50;
            }
        }

        requestAnimationFrame(drawParticles);
    }

    drawParticles();
}

animateFloatingParticles();

// ================= Custom Context Menu =================
const contextMenu = document.createElement('div');
contextMenu.id = 'customContextMenu';
contextMenu.innerHTML = `
    <button class="menu-item" id="menuHome">üè† Home</button>
    <button class="menu-item" id="menuRefresh">üîÑ Refresh</button>
    <button class="menu-item" id="menuBack">‚¨ÖÔ∏è Back</button>
    <button class="menu-item" id="menuForward">‚û°Ô∏è Forward</button>
`;
document.body.appendChild(contextMenu);

// Context menu event listeners
document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    contextMenu.style.left = e.clientX + 'px';
    contextMenu.style.top = e.clientY + 'px';
    contextMenu.style.display = 'block';
});

document.addEventListener('click', () => {
    contextMenu.style.display = 'none';
});

// Menu actions
document.getElementById('menuHome').addEventListener('click', () => {
    window.location.href = window.location.origin + window.location.pathname;
});

document.getElementById('menuRefresh').addEventListener('click', () => {
    window.location.reload();
});

document.getElementById('menuBack').addEventListener('click', () => {
    window.history.back();
});

document.getElementById('menuForward').addEventListener('click', () => {
    window.history.forward();
});

// ---------------- Chat Toggle ----------------
const chatContainer = document.getElementById('chatContainer');
const toggleChatBtn = document.getElementById('toggleChatBtn');

toggleChatBtn.addEventListener('click', () => {
    if(chatContainer.style.display === 'none' || chatContainer.style.display === '') {
        chatContainer.style.display = 'block';
        // Auto-scroll to bottom when opening
        setTimeout(() => {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    } else {
        chatContainer.style.display = 'none';
    }
});

// ================= Theme Customizer =================
const themeBtn = document.getElementById('themeBtn');
const themeModal = document.getElementById('themeModal');
const closeThemeBtn = document.getElementById('closeThemeBtn');
const themeOptions = document.querySelectorAll('.theme-option');
const seasonalThemes = document.querySelectorAll('.seasonal-theme');

let currentTheme = localStorage.getItem('selectedTheme') || 'default';
let currentSeasonal = localStorage.getItem('selectedSeasonal') || '';

function applyTheme(theme) {
  // Remove all theme classes
  document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
  document.body.className = document.body.className.replace(/seasonal-\w+/g, '').trim();

  // Apply new theme
  if (theme !== 'default') {
    document.body.classList.add(`theme-${theme}`);
  }

  // Apply seasonal theme if exists
  if (currentSeasonal) {
    document.body.classList.add(`seasonal-${currentSeasonal}`);
  }

  localStorage.setItem('selectedTheme', theme);
}

function applySeasonal(season) {
  // Remove existing seasonal classes
  document.body.className = document.body.className.replace(/seasonal-\w+/g, '').trim();

  // Apply new seasonal theme
  if (season) {
    document.body.classList.add(`seasonal-${season}`);
  }

  currentSeasonal = season;
  localStorage.setItem('selectedSeasonal', season);
}

// Theme button click
themeBtn.addEventListener('click', () => {
  themeModal.style.display = 'flex';
  themeModal.setAttribute('aria-hidden', 'false');
});

// Close theme modal
closeThemeBtn.addEventListener('click', () => {
  themeModal.style.display = 'none';
  themeModal.setAttribute('aria-hidden', 'true');
});

// Theme selection
themeOptions.forEach(option => {
  option.addEventListener('click', () => {
    const theme = option.dataset.theme;
    applyTheme(theme);

    // Update selected state
    themeOptions.forEach(opt => opt.style.borderColor = opt.dataset.theme === theme ? '#28a745' : '');
  });
});

// Seasonal theme selection
seasonalThemes.forEach(theme => {
  theme.addEventListener('click', () => {
    const season = theme.dataset.season;
    applySeasonal(season === currentSeasonal ? '' : season);

    // Update selected state
    seasonalThemes.forEach(t => t.style.opacity = t.dataset.season === currentSeasonal ? '1' : '0.6');
  });
});

// Apply saved theme on load
applyTheme(currentTheme);
applySeasonal(currentSeasonal);

// ================= Achievement System =================
const achievementsBtn = document.getElementById('achievementsBtn');
const achievementsModal = document.getElementById('achievementsModal');
const closeAchievementsBtn = document.getElementById('closeAchievementsBtn');

// Achievement tracking
let userStats = JSON.parse(localStorage.getItem('userStats')) || {
  chatMessages: 0,
  drawTime: 0,
  gameTime: 0,
  onlineTime: 0,
  sitesVisited: [],
  themesTried: [],
  dailyMessages: 0,
  lastDailyReset: Date.now()
};

// Reset daily challenge if it's a new day
const now = Date.now();
const lastReset = userStats.lastDailyReset;
const oneDay = 24 * 60 * 60 * 1000;
if (now - lastReset > oneDay) {
  userStats.dailyMessages = 0;
  userStats.lastDailyReset = now;
}

function updateAchievements() {
  // Chat Master (10 messages)
  const chatProgress = Math.min((userStats.chatMessages / 10) * 100, 100);
  document.getElementById('chatProgress').style.width = chatProgress + '%';
  document.getElementById('chatCount').textContent = userStats.chatMessages + '/10';
  if (userStats.chatMessages >= 10) {
    document.getElementById('chatBadge').style.borderColor = '#28a745';
    document.getElementById('chatBadge').style.background = '#d4edda';
  }

  // Artist (30 minutes drawing)
  const drawProgress = Math.min((userStats.drawTime / 30) * 100, 100);
  document.getElementById('drawProgress').style.width = drawProgress + '%';
  document.getElementById('drawCount').textContent = Math.floor(userStats.drawTime) + '/30 min';
  if (userStats.drawTime >= 30) {
    document.getElementById('drawBadge').style.borderColor = '#28a745';
    document.getElementById('drawBadge').style.background = '#d4edda';
  }

  // Gamer (60 minutes gaming)
  const gameProgress = Math.min((userStats.gameTime / 60) * 100, 100);
  document.getElementById('gameProgress').style.width = gameProgress + '%';
  document.getElementById('gameCount').textContent = Math.floor(userStats.gameTime) + '/60 min';
  if (userStats.gameTime >= 60) {
    document.getElementById('gameBadge').style.borderColor = '#28a745';
    document.getElementById('gameBadge').style.background = '#d4edda';
  }

  // Social Butterfly (120 minutes online)
  const socialProgress = Math.min((userStats.onlineTime / 120) * 100, 100);
  document.getElementById('socialProgress').style.width = socialProgress + '%';
  document.getElementById('socialCount').textContent = Math.floor(userStats.onlineTime) + '/120 min';
  if (userStats.onlineTime >= 120) {
    document.getElementById('socialBadge').style.borderColor = '#28a745';
    document.getElementById('socialBadge').style.background = '#d4edda';
  }

  // Explorer (visit all sites)
  const explorerProgress = Math.min((userStats.sitesVisited.length / 2) * 100, 100);
  document.getElementById('explorerProgress').style.width = explorerProgress + '%';
  document.getElementById('explorerCount').textContent = userStats.sitesVisited.length + '/2';
  if (userStats.sitesVisited.length >= 2) {
    document.getElementById('explorerBadge').style.borderColor = '#28a745';
    document.getElementById('explorerBadge').style.background = '#d4edda';
  }

  // Stylist (try 3 themes)
  const themeProgress = Math.min((userStats.themesTried.length / 3) * 100, 100);
  document.getElementById('themeProgress').style.width = themeProgress + '%';
  document.getElementById('themeCount').textContent = userStats.themesTried.length + '/3';
  if (userStats.themesTried.length >= 3) {
    document.getElementById('themeBadge').style.borderColor = '#28a745';
    document.getElementById('themeBadge').style.background = '#d4edda';
  }

  // Daily Challenge
  const dailyProgress = Math.min((userStats.dailyMessages / 5) * 100, 100);
  document.getElementById('dailyProgress').style.width = dailyProgress + '%';
  document.getElementById('dailyCount').textContent = userStats.dailyMessages + '/5';

  localStorage.setItem('userStats', JSON.stringify(userStats));
}

// Track user activity
function trackActivity(type, value = 1) {
  switch(type) {
    case 'chat':
      userStats.chatMessages += value;
      userStats.dailyMessages += value;
      break;
    case 'draw':
      userStats.drawTime += value; // value in minutes
      break;
    case 'game':
      userStats.gameTime += value; // value in minutes
      break;
    case 'online':
      userStats.onlineTime += value; // value in minutes
      break;
    case 'site':
      if (!userStats.sitesVisited.includes(value)) {
        userStats.sitesVisited.push(value);
      }
      break;
    case 'theme':
      if (!userStats.themesTried.includes(value)) {
        userStats.themesTried.push(value);
      }
      break;
  }
  updateAchievements();
}

// Achievements button
achievementsBtn.addEventListener('click', () => {
  updateAchievements();
  achievementsModal.style.display = 'flex';
  achievementsModal.setAttribute('aria-hidden', 'false');
});

// Close achievements modal
closeAchievementsBtn.addEventListener('click', () => {
  achievementsModal.style.display = 'none';
  achievementsModal.setAttribute('aria-hidden', 'true');
});

// Track online time
let onlineStartTime = Date.now();
setInterval(() => {
  const minutes = (Date.now() - onlineStartTime) / (1000 * 60);
  trackActivity('online', minutes - userStats.onlineTime);
  onlineStartTime = Date.now();
}, 60000); // Update every minute

// Track drawing time
let drawingStartTime = null;
document.getElementById('openDrawingBtn').addEventListener('click', () => {
  drawingStartTime = Date.now();
});
document.getElementById('closeDrawingBtn').addEventListener('click', () => {
  if (drawingStartTime) {
    const minutes = (Date.now() - drawingStartTime) / (1000 * 60);
    trackActivity('draw', minutes);
    drawingStartTime = null;
  }
});

// Track game time (simplified - tracks time on main game)
let gameStartTime = Date.now();
setInterval(() => {
  const minutes = (Date.now() - gameStartTime) / (1000 * 60);
  trackActivity('game', minutes - userStats.gameTime);
  gameStartTime = Date.now();
}, 60000);

// Track site visits
document.getElementById('extraSiteBtn').addEventListener('click', () => {
  trackActivity('site', 'extra');
});
document.getElementById('privacyBtn').addEventListener('click', () => {
  trackActivity('site', 'privacy');
});

// Track theme changes
themeOptions.forEach(option => {
  option.addEventListener('click', () => {
    trackActivity('theme', option.dataset.theme);
  });
});

// Initial update
updateAchievements();

// ================= Keyboard Shortcuts =================
document.addEventListener('keydown', (e) => {
  // Don't trigger shortcuts when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  switch(e.key.toLowerCase()) {
    case 'r':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('reloadBtn').click();
      }
      break;
    case 'f':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('fullscreenBtn').click();
      }
      break;
    case '+':
    case '=':
      e.preventDefault();
      document.getElementById('zoomInBtn').click();
      break;
    case '-':
      e.preventDefault();
      document.getElementById('zoomOutBtn').click();
      break;
    case 'h':
      e.preventDefault();
      document.getElementById('hideIframeBtn').click();
      break;
    case 's':
      e.preventDefault();
      document.getElementById('showIframeBtn').click();
      break;
    case 'c':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('toggleChatBtn').click();
      }
      break;
    case 'd':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('openDrawingBtn').click();
      }
      break;
    case 't':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('themeBtn').click();
      }
      break;
    case 'a':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        document.getElementById('achievementsBtn').click();
      }
      break;
    case 'escape':
      // Close modals
      document.getElementById('themeModal').style.display = 'none';
      document.getElementById('achievementsModal').style.display = 'none';
      document.getElementById('drawingModal').style.display = 'none';
      break;
  }
});

// Show keyboard shortcuts hint
const shortcutsHint = document.createElement('div');
shortcutsHint.innerHTML = `
  <div style="position:fixed; bottom:10px; left:10px; background:rgba(0,0,0,0.8); color:#fff; padding:10px; border-radius:8px; font-size:12px; max-width:200px; display:none;" id="shortcutsHint">
    <strong>Keyboard Shortcuts:</strong><br>
    Ctrl+R: Reload<br>
    Ctrl+F: Fullscreen<br>
    +/-: Zoom<br>
    H/S: Hide/Show<br>
    Ctrl+C: Chat<br>
    Ctrl+D: Drawing<br>
    Ctrl+T: Themes<br>
    Ctrl+A: Achievements<br>
    Esc: Close modals
  </div>
`;

// Add to body
document.body.appendChild(shortcutsHint);

// Show hints on ? key
document.addEventListener('keydown', (e) => {
  if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    const hint = document.getElementById('shortcutsHint');
    hint.style.display = hint.style.display === 'none' ? 'block' : 'none';
  }
});

// Auto-save user preferences every 30 seconds
setInterval(() => {
  localStorage.setItem('userStats', JSON.stringify(userStats));
  localStorage.setItem('selectedTheme', currentTheme);
  localStorage.setItem('selectedSeasonal', currentSeasonal);
}, 30000);

// ================= Stats Dashboard =================
const statsBtn = document.getElementById('statsBtn');
const statsModal = document.getElementById('statsModal');
const closeStatsBtn = document.getElementById('closeStatsBtn');

function updateStatsDisplay() {
  // Main stats
  document.getElementById('onlineTimeStat').textContent = Math.floor(userStats.onlineTime) + ' min';
  document.getElementById('chatMessagesStat').textContent = userStats.chatMessages;
  document.getElementById('gamingTimeStat').textContent = Math.floor(userStats.gameTime) + ' min';
  document.getElementById('drawingTimeStat').textContent = Math.floor(userStats.drawTime) + ' min';

  // Achievement progress bars
  const chatProgress = Math.min((userStats.chatMessages / 10) * 100, 100);
  document.getElementById('chatProgressBar').style.width = chatProgress + '%';
  document.getElementById('chatProgressText').textContent = userStats.chatMessages + '/10';

  const drawProgress = Math.min((userStats.drawTime / 30) * 100, 100);
  document.getElementById('drawProgressBar').style.width = drawProgress + '%';
  document.getElementById('drawProgressText').textContent = Math.floor(userStats.drawTime) + '/30 min';

  const gameProgress = Math.min((userStats.gameTime / 60) * 100, 100);
  document.getElementById('gameProgressBar').style.width = gameProgress + '%';
  document.getElementById('gameProgressText').textContent = Math.floor(userStats.gameTime) + '/60 min';

  // Daily stats
  document.getElementById('dailyMessagesStat').textContent = userStats.dailyMessages;
  document.getElementById('dailyOnlineStat').textContent = Math.floor(userStats.onlineTime) + ' min';
  document.getElementById('sitesVisitedStat').textContent = userStats.sitesVisited.length;
  document.getElementById('themesTriedStat').textContent = userStats.themesTried.length;
}

// Stats button
statsBtn.addEventListener('click', () => {
  updateStatsDisplay();
  statsModal.style.display = 'flex';
  statsModal.setAttribute('aria-hidden', 'false');
});

// Close stats modal
closeStatsBtn.addEventListener('click', () => {
  statsModal.style.display = 'none';
  statsModal.setAttribute('aria-hidden', 'true');
});

// ================= Drawing Modal =================
const drawingModal = document.getElementById('drawingModal');
const openDrawingBtn = document.getElementById('openDrawingBtn');
const closeDrawingBtn = document.getElementById('closeDrawingBtn');
openDrawingBtn.addEventListener('click', () => {
  drawingModal.style.display = 'flex';
  drawingModal.setAttribute('aria-hidden','false');
});
closeDrawingBtn.addEventListener('click', () => {
  drawingModal.style.display = 'none';
  drawingModal.setAttribute('aria-hidden','true');
});
// click outside to close
drawingModal.addEventListener('click', (e) => {
  if(e.target === drawingModal) {
    drawingModal.style.display = 'none';
    drawingModal.setAttribute('aria-hidden','true');
  }
});

// ================= Shared Drawing Canvas Script =================
(function(){
  const container = document.getElementById('sharedCanvasContainer');
  const toggleBtn = document.getElementById('toggleCanvasBtn');
  const canvasWrapper = document.getElementById('canvasArea');
  const canvasEl = document.getElementById('sharedCanvas');
  const ctx2 = canvasEl.getContext('2d');
  const colorPicker = document.getElementById('colorPicker');
  const sizeSlider = document.getElementById('sizeSlider');
  const sizeLabel = document.getElementById('sizeLabel');
  const clearBtn = document.getElementById('clearCanvasBtn');
  const brushToolBtn = document.getElementById('brushToolBtn');
  const eraserToolBtn = document.getElementById('eraserToolBtn');

  // Tool state
  let currentTool = 'brush'; // 'brush' or 'eraser' or 'rectangle' etc
  let drawing = false;
  let currentStroke = [];
  let brushColor = colorPicker.value;
  let brushSize = parseInt(sizeSlider.value,10);
  let brushOpacity = 1;
  let fillShapes = false;
  let shapeStart = null;
  let undoHistory = [];
  let zoomLevel = 1;
  let panX = 0, panY = 0;
  let pushedStrokes = [];
  const drawnIds = new Set(); // stroke IDs already rendered
  const strokesRef = db.ref('canvas/strokes');
  const metaRef = db.ref('canvas/meta');
  const strokesCache = {}; // local cache of strokes by id to allow redraw on resize

  // Tool switching
  function resetToolStyles() {
    const tools = ['brushToolBtn', 'eraserToolBtn', 'rectangleToolBtn', 'circleToolBtn', 'lineToolBtn', 'textToolBtn', 'eyedropperBtn'];
    tools.forEach(id => {
      const btn = document.getElementById(id);
      btn.style.background = '#ffffff';
      btn.style.border = '1px solid #ccc';
      btn.style.color = '#333';
    });
  }

  function selectTool(tool) {
    currentTool = tool;
    resetToolStyles();
    if(tool === 'brush') {
      brushToolBtn.style.background = '#007bff';
      brushToolBtn.style.border = '1px solid #007bff';
      brushToolBtn.style.color = '#ffffff';
      canvasEl.style.cursor = 'crosshair';
    } else if(tool === 'eraser') {
      eraserToolBtn.style.background = '#ffc107';
      eraserToolBtn.style.border = '1px solid #ffc107';
      eraserToolBtn.style.color = '#000';
      canvasEl.style.cursor = 'cell';
    } else if(tool === 'rectangle') {
      document.getElementById('rectangleToolBtn').style.background = '#28a745';
      document.getElementById('rectangleToolBtn').style.border = '1px solid #28a745';
      document.getElementById('rectangleToolBtn').style.color = '#ffffff';
      canvasEl.style.cursor = 'crosshair';
    } else if(tool === 'circle') {
      document.getElementById('circleToolBtn').style.background = '#17a2b8';
      document.getElementById('circleToolBtn').style.border = '1px solid #17a2b8';
      document.getElementById('circleToolBtn').style.color = '#ffffff';
      canvasEl.style.cursor = 'crosshair';
    } else if(tool === 'line') {
      document.getElementById('lineToolBtn').style.background = '#6c757d';
      document.getElementById('lineToolBtn').style.border = '1px solid #6c757d';
      document.getElementById('lineToolBtn').style.color = '#ffffff';
      canvasEl.style.cursor = 'crosshair';
    } else if(tool === 'text') {
      document.getElementById('textToolBtn').style.background = '#dc3545';
      document.getElementById('textToolBtn').style.border = '1px solid #dc3545';
      document.getElementById('textToolBtn').style.color = '#ffffff';
      canvasEl.style.cursor = 'text';
    } else if(tool === 'eyedropper') {
      document.getElementById('eyedropperBtn').style.background = '#e83e8c';
      document.getElementById('eyedropperBtn').style.border = '1px solid #e83e8c';
      document.getElementById('eyedropperBtn').style.color = '#ffffff';
      canvasEl.style.cursor = 'copy';
    }
  }

  function undoLast() {
    if(pushedStrokes.length > 0) {
      const lastKey = pushedStrokes.pop();
      strokesRef.child(lastKey).remove();
    }
  }

  function saveDrawing() {
    const dataURL = canvasEl.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'drawing.png';
    a.click();
  }

  function loadDrawing() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if(file) {
        const img = new Image();
        img.onload = () => {
          ctx2.clearRect(0,0,canvasEl.width,canvasEl.height);
          ctx2.drawImage(img, 0, 0, canvasEl.width, canvasEl.height);
        };
        img.src = URL.createObjectURL(file);
      }
    };
    input.click();
  }

  function applyZoom() {
    ctx2.setTransform(zoomLevel, 0, 0, zoomLevel, panX, panY);
    redrawAllStrokes();
  }

  function rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
  }

  brushToolBtn.addEventListener('click', () => selectTool('brush'));
  eraserToolBtn.addEventListener('click', () => selectTool('eraser'));
  document.getElementById('rectangleToolBtn').addEventListener('click', () => selectTool('rectangle'));
  document.getElementById('circleToolBtn').addEventListener('click', () => selectTool('circle'));
  document.getElementById('lineToolBtn').addEventListener('click', () => selectTool('line'));
  document.getElementById('textToolBtn').addEventListener('click', () => selectTool('text'));
  document.getElementById('fillCheckbox').addEventListener('change', (e) => fillShapes = e.target.checked);
  document.getElementById('opacitySlider').addEventListener('input', (e) => { brushOpacity = parseFloat(e.target.value); document.getElementById('opacityLabel').textContent = brushOpacity; });
  document.getElementById('undoBtn').addEventListener('click', undoLast);
  document.getElementById('eyedropperBtn').addEventListener('click', () => selectTool('eyedropper'));
  document.getElementById('saveBtn').addEventListener('click', saveDrawing);
  document.getElementById('loadBtn').addEventListener('click', loadDrawing);
  document.getElementById('zoomInBtn').addEventListener('click', () => { zoomLevel *= 1.2; applyZoom(); });
  document.getElementById('zoomOutBtn').addEventListener('click', () => { zoomLevel /= 1.2; applyZoom(); });
  selectTool('brush');

  // Resize helper
  function resizeCanvasToDisplay() {
    const ratio = window.devicePixelRatio || 1;
    const styleW = Math.min(window.innerWidth - 60, 1000);
    const styleH = Math.min(window.innerHeight * 0.7, 700);
    canvasEl.width = styleW * ratio;
    canvasEl.height = styleH * ratio;
    canvasEl.style.width = styleW + 'px';
    canvasEl.style.height = styleH + 'px';
    ctx2.setTransform(ratio, 0, 0, ratio, 0, 0);
    // After resizing the canvas (which clears its bitmap), redraw cached strokes
    redrawAllStrokes();
  }
  window.addEventListener('resize', resizeCanvasToDisplay);
  resizeCanvasToDisplay();

  // Show/hide canvas area toggle
  toggleBtn.addEventListener('click', () => {
    if (canvasWrapper.style.display === 'none' || canvasWrapper.style.display === '') {
      canvasWrapper.style.display = 'block';
      toggleBtn.textContent = 'Close Canvas';
      resizeCanvasToDisplay();
    } else {
      canvasWrapper.style.display = 'none';
      toggleBtn.textContent = 'Open Canvas';
    }
  });

  // UI bindings
  colorPicker.addEventListener('input', (e) => brushColor = e.target.value);
  sizeSlider.addEventListener('input', (e) => { brushSize = parseInt(e.target.value,10); sizeLabel.textContent = brushSize; });

  // Convert screen coords to canvas coords
  function getCanvasPoint(e) {
    const rect = canvasEl.getBoundingClientRect();
    const clientX = (e.clientX !== undefined) ? e.clientX : (e.touches && e.touches[0].clientX);
    const clientY = (e.clientY !== undefined) ? e.clientY : (e.touches && e.touches[0].clientY);
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    return { x: Math.round(x), y: Math.round(y) };
  }

  function drawStrokeLocally(stroke, opts={}) {
    if(!stroke || !stroke.points || stroke.points.length===0) return;
    
    if(stroke.type === 'erase') {
      ctx2.save();
      ctx2.globalCompositeOperation = 'destination-out';
      ctx2.strokeStyle = 'rgba(0,0,0,1)';
      ctx2.lineJoin = 'round';
      ctx2.lineCap = 'round';
      ctx2.lineWidth = stroke.size;
      ctx2.beginPath();
      const pts = stroke.points;
      ctx2.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){
        ctx2.lineTo(pts[i].x, pts[i].y);
      }
      ctx2.stroke();
      ctx2.restore();
    } else if(stroke.type === 'rectangle') {
      ctx2.globalAlpha = stroke.opacity || 1;
      ctx2.strokeStyle = stroke.color;
      ctx2.lineWidth = stroke.size || 1;
      const x = Math.min(stroke.points[0].x, stroke.points[1].x);
      const y = Math.min(stroke.points[0].y, stroke.points[1].y);
      const width = Math.abs(stroke.points[1].x - stroke.points[0].x);
      const height = Math.abs(stroke.points[1].y - stroke.points[0].y);
      if(stroke.fill) {
        ctx2.fillStyle = stroke.color;
        ctx2.fillRect(x, y, width, height);
      } else {
        ctx2.strokeRect(x, y, width, height);
      }
    } else if(stroke.type === 'circle') {
      ctx2.globalAlpha = stroke.opacity || 1;
      ctx2.strokeStyle = stroke.color;
      ctx2.lineWidth = stroke.size || 1;
      const centerX = stroke.points[0].x;
      const centerY = stroke.points[0].y;
      const radius = Math.sqrt((stroke.points[1].x - centerX)**2 + (stroke.points[1].y - centerY)**2);
      ctx2.beginPath();
      ctx2.arc(centerX, centerY, radius, 0, Math.PI * 2);
      if(stroke.fill) {
        ctx2.fillStyle = stroke.color;
        ctx2.fill();
      } else {
        ctx2.stroke();
      }
    } else if(stroke.type === 'line') {
      ctx2.globalAlpha = stroke.opacity || 1;
      ctx2.strokeStyle = stroke.color;
      ctx2.lineWidth = stroke.size || 1;
      ctx2.beginPath();
      ctx2.moveTo(stroke.points[0].x, stroke.points[0].y);
      ctx2.lineTo(stroke.points[1].x, stroke.points[1].y);
      ctx2.stroke();
    } else if(stroke.type === 'text') {
      ctx2.globalAlpha = stroke.opacity || 1;
      ctx2.fillStyle = stroke.color;
      ctx2.font = `${stroke.fontSize || 16}px Arial`;
      ctx2.fillText(stroke.text, stroke.x, stroke.y);
    } else {
      // default brush
      ctx2.globalAlpha = stroke.opacity || 1;
      ctx2.lineJoin = 'round';
      ctx2.lineCap = 'round';
      ctx2.strokeStyle = stroke.color;
      ctx2.lineWidth = stroke.size;
      ctx2.beginPath();
      const pts = stroke.points;
      ctx2.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){
        ctx2.lineTo(pts[i].x, pts[i].y);
      }
      ctx2.stroke();
    }
  }

  // Redraw all strokes from the in-memory cache (sorted by time)
  function redrawAllStrokes() {
    try {
      ctx2.clearRect(0,0,canvasEl.width,canvasEl.height);
      drawnIds.clear();
      // Sort strokes by timestamp so order is preserved
      const strokes = Object.keys(strokesCache).map(k => ({ id: k, s: strokesCache[k] }));
      strokes.sort((a,b) => (a.s.time || 0) - (b.s.time || 0));
      for(const item of strokes) {
        drawStrokeLocally(item.s);
        drawnIds.add(item.id);
      }
    } catch (err) {
      console.warn('redrawAllStrokes failed', err);
    }
  }

  // Pointer events
  canvasEl.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    canvasEl.setPointerCapture?.(e.pointerId);
    const p = getCanvasPoint(e);
    if(currentTool === 'brush' || currentTool === 'eraser') {
      drawing = true;
      currentStroke = [];
      currentStroke.push(p);
      if(currentTool === 'brush') {
        ctx2.globalAlpha = brushOpacity;
        ctx2.fillStyle = brushColor;
        ctx2.beginPath();
        ctx2.arc(p.x, p.y, Math.max(1, brushSize/2), 0, Math.PI*2);
        ctx2.fill();
      } else if(currentTool === 'eraser') {
        ctx2.save();
        ctx2.globalCompositeOperation = 'destination-out';
        ctx2.fillStyle = 'rgba(0,0,0,1)';
        ctx2.beginPath();
        ctx2.arc(p.x, p.y, Math.max(1, brushSize/2), 0, Math.PI*2);
        ctx2.fill();
        ctx2.restore();
      }
    } else if(currentTool === 'rectangle' || currentTool === 'circle' || currentTool === 'line') {
      shapeStart = p;
    } else if(currentTool === 'text') {
      const text = prompt('Enter text:');
      if(text) {
        const strokeObj = {
          user: visitorId || ('anon_'+Date.now()),
          type: 'text',
          text: text,
          x: p.x,
          y: p.y,
          color: brushColor,
          fontSize: brushSize,
          opacity: brushOpacity,
          time: Date.now()
        };
        strokesRef.push(strokeObj).then(pushRef => pushedStrokes.push(pushRef.key));
      }
    } else if(currentTool === 'eyedropper') {
      const imageData = ctx2.getImageData(p.x, p.y, 1, 1);
      const data = imageData.data;
      const hex = rgbToHex(data[0], data[1], data[2]);
      colorPicker.value = hex;
      brushColor = hex;
    }
  });

  canvasEl.addEventListener('pointermove', (e) => {
    if(!drawing && !shapeStart) return;
    e.preventDefault();
    const p = getCanvasPoint(e);
    if(currentTool === 'brush' || currentTool === 'eraser') {
      const last = currentStroke[currentStroke.length-1];
      if(!last || last.x !== p.x || last.y !== p.y) {
        currentStroke.push(p);

        if(currentTool === 'brush') {
          ctx2.globalAlpha = brushOpacity;
          ctx2.lineJoin = 'round';
          ctx2.lineCap = 'round';
          ctx2.strokeStyle = brushColor;
          ctx2.lineWidth = brushSize;
          ctx2.beginPath();
          ctx2.moveTo(last.x, last.y);
          ctx2.lineTo(p.x, p.y);
          ctx2.stroke();
        } else if(currentTool === 'eraser') {
          ctx2.save();
          ctx2.globalCompositeOperation = 'destination-out';
          ctx2.strokeStyle = 'rgba(0,0,0,1)';
          ctx2.lineJoin = 'round';
          ctx2.lineCap = 'round';
          ctx2.lineWidth = brushSize;
          ctx2.beginPath();
          ctx2.moveTo(last.x, last.y);
          ctx2.lineTo(p.x, p.y);
          ctx2.stroke();
          ctx2.restore();
        }
      }
    }
    // For shapes, preview
    if(shapeStart && (currentTool === 'rectangle' || currentTool === 'circle' || currentTool === 'line')) {
      redrawAllStrokes(); // clear and redraw all
      // then draw preview
      ctx2.globalAlpha = brushOpacity;
      if(currentTool === 'rectangle') {
        const x = Math.min(shapeStart.x, p.x);
        const y = Math.min(shapeStart.y, p.y);
        const width = Math.abs(p.x - shapeStart.x);
        const height = Math.abs(p.y - shapeStart.y);
        ctx2.strokeStyle = brushColor;
        ctx2.lineWidth = 1;
        if(fillShapes) {
          ctx2.fillStyle = brushColor;
          ctx2.fillRect(x, y, width, height);
        } else {
          ctx2.strokeRect(x, y, width, height);
        }
      } else if(currentTool === 'circle') {
        const centerX = shapeStart.x;
        const centerY = shapeStart.y;
        const radius = Math.sqrt((p.x - centerX)**2 + (p.y - centerY)**2);
        ctx2.strokeStyle = brushColor;
        ctx2.lineWidth = 1;
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, 0, Math.PI * 2);
        if(fillShapes) {
          ctx2.fillStyle = brushColor;
          ctx2.fill();
        } else {
          ctx2.stroke();
        }
      } else if(currentTool === 'line') {
        ctx2.strokeStyle = brushColor;
        ctx2.lineWidth = brushSize;
        ctx2.beginPath();
        ctx2.moveTo(shapeStart.x, shapeStart.y);
        ctx2.lineTo(p.x, p.y);
        ctx2.stroke();
      }
    }
  });

  canvasEl.addEventListener('pointerup', async (e) => {
    if(!drawing && !shapeStart) return;
    drawing = false;
    if(currentTool === 'brush' || currentTool === 'eraser') {
      if(currentStroke.length > 0) {
        const strokeObj = {
          user: visitorId || ('anon_'+Date.now()),
          size: brushSize,
          points: currentStroke,
          time: Date.now()
        };

        if(currentTool === 'brush') {
          strokeObj.color = brushColor;
          strokeObj.type = 'brush';
          strokeObj.opacity = brushOpacity;
        } else if(currentTool === 'eraser') {
          strokeObj.type = 'erase';
        }

        try {
          const pushRef = await strokesRef.push(strokeObj);
          pushedStrokes.push(pushRef.key);
        } catch (err) {
          console.error('Failed to push stroke', err);
        }
      }
    } else if(shapeStart) {
      const p = getCanvasPoint(e);
      const strokeObj = {
        user: visitorId || ('anon_'+Date.now()),
        size: brushSize,
        points: [shapeStart, p],
        color: brushColor,
        opacity: brushOpacity,
        fill: fillShapes,
        time: Date.now()
      };
      if(currentTool === 'rectangle') {
        strokeObj.type = 'rectangle';
      } else if(currentTool === 'circle') {
        strokeObj.type = 'circle';
      } else if(currentTool === 'line') {
        strokeObj.type = 'line';
      }
      try {
        const pushRef = await strokesRef.push(strokeObj);
        pushedStrokes.push(pushRef.key);
      } catch (err) {
        console.error('Failed to push shape', err);
      }
      shapeStart = null;
      redrawAllStrokes(); // to remove preview
    }
    currentStroke = [];
  });

  canvasEl.addEventListener('pointercancel', () => { drawing=false; currentStroke=[]; });

  // Listen for strokes added by anyone
  strokesRef.on('child_added', snapshot => {
    const strokeId = snapshot.key;
    const stroke = snapshot.val();
    if(!stroke) return;
    // Cache the stroke
    strokesCache[strokeId] = stroke;
    // If not already drawn on current canvas, draw it
    if(!drawnIds.has(strokeId)){
      drawStrokeLocally(stroke);
      drawnIds.add(strokeId);
    }
  });

  // When a stroke is removed (e.g., clear), update cache and redraw
  strokesRef.on('child_removed', snapshot => {
    const id = snapshot.key;
    if(id && strokesCache[id]) delete strokesCache[id];
    redrawAllStrokes();
  });

  // Listen for clear events
  metaRef.child('clear').on('value', snap => {
    const v = snap.val();
    if(v) {
      // Clear visible canvas and local caches so redraw won't restore cleared strokes
      ctx2.clearRect(0,0,canvasEl.width,canvasEl.height);
      drawnIds.clear();
      for(const k in strokesCache) delete strokesCache[k];
    }
  });

  // Clear button
  clearBtn.addEventListener('click', async () => {
    try {
      // Remove all strokes from DB so the clear persists across reloads
      await strokesRef.remove();
      // Notify other clients with a transient clear flag
      await metaRef.child('clear').set({ by: visitorId || 'anon', time: Date.now() });
      // Remove transient clear flag shortly after so new clients don't auto-clear forever
      setTimeout(() => { metaRef.child('clear').remove().catch(()=>{}); }, 1500);
    } catch (err) {
      console.warn('Failed to clear strokes', err);
    }
  });

  // Presence
  const userId = visitorId || ('anon_'+Date.now());
  const presenceRef = db.ref('canvas/presence/' + userId);
  presenceRef.set({online:true, color: colorPicker.value, lastSeen: Date.now()});
  presenceRef.onDisconnect().remove();

  // ================= Cursor Tracking =================
  const cursorOverlay = document.getElementById('cursorOverlay');
  const ctxCursor = cursorOverlay.getContext('2d');
  const cursorsRef = db.ref('canvas/cursors');
  let activeCursors = {}; // { userId: { x, y, color, username, timestamp } }
  
  // Sync cursor overlay to main canvas size
  function syncCursorOverlay() {
    // Match the overlay to the main canvas device pixel dimensions
    // canvasEl.width/height are in device pixels (after resize helper sets them)
    const ratio = window.devicePixelRatio || 1;
    cursorOverlay.width = canvasEl.width;    // device pixels
    cursorOverlay.height = canvasEl.height;  // device pixels
    // Keep CSS size the same as the visible canvas so boundingClientRect coords match
    cursorOverlay.style.width = canvasEl.style.width;
    cursorOverlay.style.height = canvasEl.style.height;
    // Reset transform and scale so we can draw using CSS pixel coordinates (same units as getCanvasPoint)
    ctxCursor.setTransform(1, 0, 0, 1, 0, 0);
    ctxCursor.scale(ratio, ratio);
    // Ensure overlay doesn't block pointer events on the main canvas
    cursorOverlay.style.pointerEvents = 'none';
  }
  window.addEventListener('resize', syncCursorOverlay);
  syncCursorOverlay();

  // Track mouse movement and broadcast cursor
  let lastCursorUpdate = 0;
  canvasEl.addEventListener('pointermove', (e) => {
    const now = Date.now();
    if(now - lastCursorUpdate > 100) { // Throttle to 100ms
      const p = getCanvasPoint(e);
      cursorsRef.child(userId).set({
        x: p.x,
        y: p.y,
        color: brushColor,
        username: username,
        timestamp: Date.now()
      }).catch(err => console.warn('Cursor update failed', err));
      lastCursorUpdate = now;
    }
  });

  // Listen for other users' cursors
  cursorsRef.on('value', snap => {
    const data = snap.val() || {};
    activeCursors = data;
  });

  // Draw cursors on overlay
  function drawCursorsFrame() {
    // Clear using device pixel dimensions ‚Äî ctx transform is already scaled to device pixels
    ctxCursor.clearRect(0, 0, cursorOverlay.width, cursorOverlay.height);

    for(const uid in activeCursors) {
      if(uid === userId) continue; // Don't draw own cursor
      const cursor = activeCursors[uid];
      if(!cursor || (typeof cursor.x !== 'number') || (typeof cursor.y !== 'number')) continue;

      // Don't show stale cursors (older than 2 seconds)
      if(Date.now() - cursor.timestamp > 2000) continue;

      // cursor.x/y are stored in CSS pixels (getCanvasPoint uses boundingClientRect)
      // ctxCursor is scaled so drawing with CSS coordinates works correctly
      const x = cursor.x;
      const y = cursor.y;
      const color = cursor.color || '#00ffff';

      // Draw cursor dot
      ctxCursor.save();
      ctxCursor.fillStyle = color;
      ctxCursor.beginPath();
      ctxCursor.arc(x, y, 5, 0, Math.PI * 2);
      ctxCursor.fill();

      // Draw cursor glow
      ctxCursor.strokeStyle = color;
      ctxCursor.lineWidth = 2;
      ctxCursor.globalAlpha = 0.5;
      ctxCursor.beginPath();
      ctxCursor.arc(x, y, 8, 0, Math.PI * 2);
      ctxCursor.stroke();
      ctxCursor.globalAlpha = 1;

      // Draw username label
      ctxCursor.fillStyle = color;
      ctxCursor.font = 'bold 11px Arial';
      ctxCursor.textBaseline = 'top';
      ctxCursor.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctxCursor.shadowBlur = 3;
      ctxCursor.fillText(cursor.username, x + 12, y + 2);
      ctxCursor.restore();
    }

    requestAnimationFrame(drawCursorsFrame);
  }
  drawCursorsFrame();

  // Clean up own cursor on canvas exit
  canvasEl.addEventListener('pointerleave', () => {
    cursorsRef.child(userId).remove().catch(err => console.warn('Cursor cleanup failed', err));
  });

  canvasEl.addEventListener('pointerenter', () => {
    presenceRef.update({lastSeen: Date.now()});
  });

  // Ensure presence and cursor entries are removed when the connection disconnects
  try {
    presenceRef.onDisconnect().remove();
    cursorsRef.child(userId).onDisconnect().remove();
  } catch (err) {
    console.warn('onDisconnect setup failed', err);
  }

  // Update presence color when user changes brush color
  colorPicker.addEventListener('input', (e) => {
    brushColor = e.target.value;
    try { presenceRef.update({ color: brushColor }); } catch (err) { /* ignore */ }
  });

  // Initial load of existing strokes
  // Initial load of existing strokes: populate local cache then redraw
  strokesRef.limitToFirst(5000).once('value').then(snap => {
    const data = snap.val();
    if(!data) return;
    try {
      Object.keys(data).forEach(k => {
        strokesCache[k] = data[k];
      });
      // Draw cached strokes once (preserves order)
      redrawAllStrokes();
    } catch (err) {
      console.warn('initial strokes processing failed', err);
    }
  }).catch(err => console.warn('initial strokes load failed', err));
})();

// ================= Loading Screen Removal =================
// Remove loading screen after 3 seconds (don't wait for window load)
setTimeout(function() {
    const introScreen = document.getElementById('introScreen');
    if (introScreen) {
        console.log('Removing loading screen...');
        introScreen.style.transition = 'opacity 1s ease';
        introScreen.style.opacity = '0';
        setTimeout(function() {
            if (introScreen && introScreen.parentNode) {
                introScreen.remove();
                console.log('Loading screen removed');
            }
        }, 1000);
    }
}, 2000);

// Safety fallback - remove loading screen after max 5 seconds
setTimeout(function() {
    const introScreen = document.getElementById('introScreen');
    if (introScreen && introScreen.parentNode) {
        console.log('Safety fallback: Removing loading screen');
        introScreen.style.transition = 'opacity 0.5s ease';
        introScreen.style.opacity = '0';
        setTimeout(function() {
            if (introScreen && introScreen.parentNode) {
                introScreen.remove();
            }
        }, 500);
    }
}, 5000);

// ================= Page Initialization =================
// Initialize tutorial/popup when page loads
window.addEventListener('load', function() {
    console.log('Page fully loaded');
    if(!localStorage.getItem('tutorialShown')) {
        startTutorial();
    } else {
        showPopup();
    }
});

// ================= Intro Screen Particles =================
const particleCanvas = document.createElement('canvas');
particleCanvas.width = window.innerWidth;
particleCanvas.height = window.innerHeight;
document.querySelector('.introParticles').appendChild(particleCanvas);
const particleCtx = particleCanvas.getContext('2d');

let particles = [];
for(let i=0;i<100;i++){
    particles.push({
        x:Math.random()*particleCanvas.width,
        y:Math.random()*particleCanvas.height,
        r:Math.random()*3+1,
        vx:(Math.random()-0.5)*0.5,
        vy:(Math.random()-0.5)*0.5,
        color:['#ffffff','#FFD700','#000000'][Math.floor(Math.random()*3)]
    });
}

function animateParticles(){
    particleCtx.clearRect(0,0,particleCanvas.width,particleCanvas.height);
    for(let p of particles){
        particleCtx.beginPath();
        particleCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
        particleCtx.fillStyle=p.color;
        particleCtx.fill();
        p.x += p.vx; p.y += p.vy;
        if(p.x<0||p.x>particleCanvas.width)p.vx*=-1;
        if(p.y<0||p.y>particleCanvas.height)p.vy*=-1;
    }
    requestAnimationFrame(animateParticles);
}
animateParticles();

window.addEventListener('resize', ()=>{
    particleCanvas.width = window.innerWidth;
    particleCanvas.height = window.innerHeight;
});
</script>

</body>
</html>
